# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ HTTP 500 –æ—à–∏–±–æ–∫ –≤ Telegram API

## ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞**
–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Telegram API (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞, –æ—Ç–ø—Ä–∞–≤–∫–∞ SMS –∫–æ–¥–∞) –≤–æ–∑–Ω–∏–∫–∞–ª–∏ HTTP 500 –æ—à–∏–±–∫–∏:

```
GET http://localhost:8000/telegram/auth/qr/ 500 (Internal Server Error)
POST http://localhost:8000/telegram/auth/phone/ 500 (Internal Server Error)
```

## üîç **–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã**

### **1. –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è AnonymousUser –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**
```python
# –ü—Ä–æ–±–ª–µ–º–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –≤ views.py
def get(self, request):
    client = get_client(request.user)  # ‚Üê request.user = AnonymousUser –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    # ...

def get_client(user):
    session = DBSessions(user)  # ‚Üê –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å AnonymousUser –≤ –ë–î
    # ...

class DBSessions:
    def __init__(self, user):
        tg_sess, created = TelegramSession.objects.get_or_create(
            user=user,  # ‚Üê AnonymousUser –Ω–µ –∏–º–µ–µ—Ç user.id
            defaults={'name': f'tg_{user.id}'}  # ‚Üê user.id –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É
        )
```

**–û—à–∏–±–∫–∞ Django ORM:**
```
TypeError: Field 'id' expected a number but got <django.contrib.auth.models.AnonymousUser object at 0x109364050>.
```

### **2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**
Views –ø—ã—Ç–∞–ª–∏—Å—å —Å–æ–∑–¥–∞—Ç—å Telegram –∫–ª–∏–µ–Ω—Ç –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—à–∏–±–∫–∞–º –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

## ‚úÖ **–†–µ—à–µ–Ω–∏–µ**

### **1. –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤–æ –≤—Å–µ views**

#### **QRStartView:**
```python
def get(self, request):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Django
    if not request.user.is_authenticated:
        return JsonResponse({
            'error': 'Not authenticated in Django',
            'requires_django_auth': True
        }, status=401)
    
    # –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç
    client = get_client(request.user)
    # ...
```

#### **AuthPhoneView:**
```python
def post(self, request):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Django
    if not request.user.is_authenticated:
        return JsonResponse({
            'error': 'Not authenticated in Django',
            'requires_django_auth': True
        }, status=401)
    
    # –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç
    client = get_client(request.user)
    # ...
```

#### **AuthVerifyView:**
```python
def post(self, request):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Django
    if not request.user.is_authenticated:
        return JsonResponse({
            'error': 'Not authenticated in Django',
            'requires_django_auth': True
        }, status=401)
    
    # –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç
    client = get_client(request.user)
    # ...
```

### **2. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**

#### **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚ùå **HTTP 500** - Internal Server Error
- ‚ùå **–ù–µ–ø–æ–Ω—è—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–Ω–∏–º–∞–ª, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
- ‚ùå **–ö—Ä–∞—à –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** - JavaScript –Ω–µ –º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—à–∏–±–∫—É

#### **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ **HTTP 401** - Unauthorized (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å)
- ‚úÖ **JSON –æ—Ç–≤–µ—Ç** - `{"error": "Not authenticated in Django", "requires_django_auth": true}`
- ‚úÖ **–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É

### **3. JavaScript –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**

JavaScript —É–∂–µ –±—ã–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ HTTP 401 –æ—à–∏–±–æ–∫:

```javascript
async function getQR() {
    try {
        const res = await telegramAPI.get('{% url "telegram:qr_start" %}');
        // ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    } catch (error) {
        if (error.response?.status === 401) {
            const errorData = error.response?.data;
            if (errorData?.requires_django_auth) {
                showTelegramStatus('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –≤ HR Helper. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.', 'error');
            }
        } else {
            showTelegramStatus('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞: ' + (error.response?.data?.error || error.message), 'error');
        }
    }
}
```

## üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π**

### **1. –ü—Ä–æ–≤–µ—Ä–∫–∞ API endpoints:**

#### **QR endpoint:**
```bash
curl -s http://localhost:8000/telegram/auth/qr/
# –†–µ–∑—É–ª—å—Ç–∞—Ç: {"error": "Not authenticated in Django", "requires_django_auth": true}
```

#### **Phone endpoint:**
```bash
curl -s -X POST http://localhost:8000/telegram/auth/phone/ -H "Content-Type: application/json" -d '{"phone": "+79001234567"}'
# –†–µ–∑—É–ª—å—Ç–∞—Ç: {"error": "Not authenticated in Django", "requires_django_auth": true}
```

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** HTTP 500 Internal Server Error
**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** HTTP 401 Unauthorized —Å JSON –æ—Ç–≤–µ—Ç–æ–º

### **2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:**
- ‚úÖ **–ö–Ω–æ–ø–∫–∞ QR-–∫–æ–¥** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –≤ HR Helper"
- ‚úÖ **–ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –≤ HR Helper"
- ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –≤ HR Helper"

## üéØ **–†–µ–∑—É–ª—å—Ç–∞—Ç**

### **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚úÖ **HTTP 500 –æ—à–∏–±–∫–∏** - –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ HTTP 401
- ‚úÖ **–ö—Ä–∞—à Django ORM** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω –≤—ã–∑–æ–≤ `get_client` —Å `AnonymousUser`
- ‚úÖ **–ù–µ–ø–æ–Ω—è—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏** - –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ **–ü–ª–æ—Ö–æ–π UX** - —É–ª—É—á—à–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

### **–£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ HTTP —Å—Ç–∞—Ç—É—Å—ã** - 401 –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ **JSON –æ—Ç–≤–µ—Ç—ã** - –≤–º–µ—Å—Ç–æ HTML –æ—à–∏–±–æ–∫
- ‚úÖ **–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å
- ‚úÖ **Graceful degradation** - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### **–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:**
- üéØ **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞**: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
- üîß **–û—Ç–ø—Ä–∞–≤–∫–∞ SMS –∫–æ–¥–∞**: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
- üì± **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**: –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- üöÄ **–°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞**: –Ω–µ—Ç HTTP 500 –æ—à–∏–±–æ–∫

### **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π:**
1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –≤ HR Helper**
2. **–û—Ç–∫—Ä—ã–≤–∞–µ—Ç Telegram —Å—Ç—Ä–∞–Ω–∏—Ü—É** - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. **–ù–∞–∂–∏–º–∞–µ—Ç "QR-–∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è"** - –≤–∏–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –≤ HR Helper. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É."
4. **–ù–∞–∂–∏–º–∞–µ—Ç "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É"** - –≤–∏–¥–∏—Ç —Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
5. **–ü–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π—Ç–∏ –≤ HR Helper**

–¢–µ–ø–µ—Ä—å Telegram API —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö! üéâ






