{% extends "base.html" %}
{% load static %}

{% block title %}Анализ hh.ru - Бенчмарки{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Анализ данных с hh.ru</h1>
                <div>
                    <a href="{% url 'finance:benchmarks_dashboard' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Назад к бенчмаркам
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Статистика -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ total_benchmarks }}</h4>
                            <p class="card-text">Всего бенчмарков</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-bar fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ hh_benchmarks }}</h4>
                            <p class="card-text">С hh.ru</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-external-link-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ vacancies.count }}</h4>
                            <p class="card-text">Активных вакансий</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-briefcase fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ grades.count }}</h4>
                            <p class="card-text">Грейдов</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-layer-group fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Форма анализа -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-search"></i> Анализ вакансий
                    </h5>
                </div>
                <div class="card-body">
                    <form id="hhAnalysisForm">
                        <div class="mb-3">
                            <label for="vacancySelect" class="form-label">Вакансия</label>
                            <select class="form-select" id="vacancySelect" required>
                                <option value="">Выберите вакансию</option>
                                {% for vacancy in vacancies %}
                                <option value="{{ vacancy.id }}">{{ vacancy.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="gradeSelect" class="form-label">Грейд</label>
                            <select class="form-select" id="gradeSelect" required>
                                <option value="">Выберите грейд</option>
                                {% for grade in grades %}
                                <option value="{{ grade.id }}">{{ grade.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="searchQuery" class="form-label">Поисковый запрос (необязательно)</label>
                            <input type="text" class="form-control" id="searchQuery" 
                                   placeholder="Например: Python разработчик">
                            <div class="form-text">Если не указан, будет использовано название вакансии</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="countrySelect" class="form-label">Страна</label>
                                    <select class="form-select" id="countrySelect">
                                        <option value="belarus">Беларусь</option>
                                        <option value="poland">Польша</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="areaSelect" class="form-label">Регион</label>
                                    <select class="form-select" id="areaSelect">
                                        <option value="">Весь регион</option>
                                        <option value="16.1">Минск</option>
                                        <option value="15.1">Варшава</option>
                                        <option value="15.2">Краков</option>
                                        <option value="15.3">Гданьск</option>
                                        <option value="15.4">Вроцлав</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-play"></i> Запустить анализ
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Массовый анализ -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tasks"></i> Массовый анализ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Выберите пары вакансия-грейд:</label>
                        <div id="batchPairs" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-muted">Выберите вакансии и грейды для массового анализа</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="addPairBtn">
                            <i class="fas fa-plus"></i> Добавить пару
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" id="clearPairsBtn">
                            <i class="fas fa-trash"></i> Очистить все
                        </button>
                    </div>
                    
                    <button type="button" class="btn btn-success" id="startBatchAnalysisBtn" disabled>
                        <i class="fas fa-rocket"></i> Запустить массовый анализ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Результаты анализа -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line"></i> Результаты анализа
                    </h5>
                </div>
                <div class="card-body">
                    <div id="analysisResults">
                        <div class="text-center text-muted">
                            <i class="fas fa-info-circle fa-3x mb-3"></i>
                            <p>Запустите анализ для просмотра результатов</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Последние бенчмарки -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history"></i> Последние бенчмарки
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_benchmarks %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Тип</th>
                                    <th>Вакансия</th>
                                    <th>Грейд</th>
                                    <th>Зарплата</th>
                                    <th>Локация</th>
                                    <th>Дата</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for benchmark in recent_benchmarks %}
                                <tr>
                                    <td>
                                        <span class="badge bg-{% if benchmark.type == 'candidate' %}primary{% else %}success{% endif %}">
                                            {{ benchmark.get_type_display }}
                                        </span>
                                    </td>
                                    <td>{{ benchmark.vacancy.name }}</td>
                                    <td>{{ benchmark.grade.name }}</td>
                                    <td>{{ benchmark.get_salary_display }}</td>
                                    <td>{{ benchmark.location }}</td>
                                    <td>{{ benchmark.date_added|date:"d.m.Y H:i" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>Бенчмарки не найдены</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления пары -->
<div class="modal fade" id="addPairModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить пару вакансия-грейд</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="modalVacancySelect" class="form-label">Вакансия</label>
                    <select class="form-select" id="modalVacancySelect">
                        <option value="">Выберите вакансию</option>
                        {% for vacancy in vacancies %}
                        <option value="{{ vacancy.id }}">{{ vacancy.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="modalGradeSelect" class="form-label">Грейд</label>
                    <select class="form-select" id="modalGradeSelect">
                        <option value="">Выберите грейд</option>
                        {% for grade in grades %}
                        <option value="{{ grade.id }}">{{ grade.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="addPairConfirmBtn">Добавить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const analysisForm = document.getElementById('hhAnalysisForm');
    const batchPairs = document.getElementById('batchPairs');
    const addPairBtn = document.getElementById('addPairBtn');
    const clearPairsBtn = document.getElementById('clearPairsBtn');
    const startBatchAnalysisBtn = document.getElementById('startBatchAnalysisBtn');
    const addPairModal = new bootstrap.Modal(document.getElementById('addPairModal'));
    const addPairConfirmBtn = document.getElementById('addPairConfirmBtn');
    
    let batchPairsList = [];
    
    // Обработка формы анализа
    analysisForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const vacancyId = document.getElementById('vacancySelect').value;
        const gradeId = document.getElementById('gradeSelect').value;
        const searchQuery = document.getElementById('searchQuery').value;
        const country = document.getElementById('countrySelect').value;
        const area = document.getElementById('areaSelect').value;
        
        if (!vacancyId || !gradeId) {
            alert('Пожалуйста, выберите вакансию и грейд');
            return;
        }
        
        startAnalysis(vacancyId, gradeId, searchQuery, country, area);
    });
    
    // Добавление пары для массового анализа
    addPairBtn.addEventListener('click', function() {
        addPairModal.show();
    });
    
    addPairConfirmBtn.addEventListener('click', function() {
        const vacancyId = document.getElementById('modalVacancySelect').value;
        const gradeId = document.getElementById('modalGradeSelect').value;
        
        if (!vacancyId || !gradeId) {
            alert('Пожалуйста, выберите вакансию и грейд');
            return;
        }
        
        const vacancyName = document.getElementById('modalVacancySelect').selectedOptions[0].text;
        const gradeName = document.getElementById('modalGradeSelect').selectedOptions[0].text;
        
        batchPairsList.push([parseInt(vacancyId), parseInt(gradeId)]);
        updateBatchPairsDisplay();
        
        addPairModal.hide();
        document.getElementById('modalVacancySelect').value = '';
        document.getElementById('modalGradeSelect').value = '';
    });
    
    // Очистка пар
    clearPairsBtn.addEventListener('click', function() {
        batchPairsList = [];
        updateBatchPairsDisplay();
    });
    
    // Запуск массового анализа
    startBatchAnalysisBtn.addEventListener('click', function() {
        if (batchPairsList.length === 0) {
            alert('Добавьте хотя бы одну пару вакансия-грейд');
            return;
        }
        
        startBatchAnalysis(batchPairsList);
    });
    
    function updateBatchPairsDisplay() {
        if (batchPairsList.length === 0) {
            batchPairs.innerHTML = '<div class="text-muted">Выберите вакансии и грейды для массового анализа</div>';
            startBatchAnalysisBtn.disabled = true;
        } else {
            let html = '';
            batchPairsList.forEach((pair, index) => {
                const vacancyName = document.querySelector(`#modalVacancySelect option[value="${pair[0]}"]`).text;
                const gradeName = document.querySelector(`#modalGradeSelect option[value="${pair[1]}"]`).text;
                html += `
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                        <span>${vacancyName} - ${gradeName}</span>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePair(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            });
            batchPairs.innerHTML = html;
            startBatchAnalysisBtn.disabled = false;
        }
    }
    
    function removePair(index) {
        batchPairsList.splice(index, 1);
        updateBatchPairsDisplay();
    }
    
    function startAnalysis(vacancyId, gradeId, searchQuery, country, area) {
        const resultsDiv = document.getElementById('analysisResults');
        resultsDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="mt-2">Запуск анализа hh.ru...</p>
            </div>
        `;
        
        fetch('{% url "finance:start_hh_analysis" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                vacancy_id: parseInt(vacancyId),
                grade_id: parseInt(gradeId),
                search_query: searchQuery,
                country: country,
                area: area
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> Анализ запущен успешно</h6>
                        <p>${data.message}</p>
                        <p><strong>ID задачи:</strong> ${data.task_id}</p>
                    </div>
                `;
                
                // Проверяем статус задачи
                checkTaskStatus(data.task_id);
            } else {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> Ошибка</h6>
                        <p>${data.message}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle"></i> Ошибка</h6>
                    <p>Произошла ошибка при запуске анализа</p>
                </div>
            `;
        });
    }
    
    function startBatchAnalysis(pairs) {
        const resultsDiv = document.getElementById('analysisResults');
        resultsDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="mt-2">Запуск массового анализа hh.ru...</p>
            </div>
        `;
        
        fetch('{% url "finance:start_batch_hh_analysis" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                vacancy_grade_pairs: pairs
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> Массовый анализ запущен успешно</h6>
                        <p>${data.message}</p>
                        <p><strong>ID задачи:</strong> ${data.task_id}</p>
                    </div>
                `;
                
                // Проверяем статус задачи
                checkTaskStatus(data.task_id);
            } else {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> Ошибка</h6>
                        <p>${data.message}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle"></i> Ошибка</h6>
                    <p>Произошла ошибка при запуске массового анализа</p>
                </div>
            `;
        });
    }
    
    function checkTaskStatus(taskId) {
        const resultsDiv = document.getElementById('analysisResults');
        
        const checkStatus = () => {
            fetch(`{% url "finance:task_status" "TASK_ID" %}`.replace('TASK_ID', taskId))
            .then(response => response.json())
            .then(data => {
                if (data.state === 'SUCCESS') {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle"></i> Анализ завершен успешно</h6>
                            <p><strong>Результат:</strong> ${data.result.message}</p>
                            <p><strong>Создано бенчмарков:</strong> ${data.result.created_benchmarks}</p>
                            <p><strong>Обработано вакансий:</strong> ${data.result.total_vacancies}</p>
                        </div>
                    `;
                } else if (data.state === 'FAILURE') {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle"></i> Анализ завершился с ошибкой</h6>
                            <p>${data.error}</p>
                        </div>
                    `;
                } else {
                    // Продолжаем проверку
                    setTimeout(checkStatus, 2000);
                }
            })
            .catch(error => {
                console.error('Error checking task status:', error);
                resultsDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle"></i> Ошибка проверки статуса</h6>
                        <p>Не удалось проверить статус задачи</p>
                    </div>
                `;
            });
        };
        
        checkStatus();
    }
    
    // Делаем функцию removePair глобальной
    window.removePair = removePair;
});
</script>
{% endblock %}
