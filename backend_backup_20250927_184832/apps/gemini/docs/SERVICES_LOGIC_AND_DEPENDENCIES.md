# Gemini App - –õ–æ–≥–∏–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

## üéØ –û–±–∑–æ—Ä

–î–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ª–æ–≥–∏–∫—É –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞, –∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ Gemini.

**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2024-01-20  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã**

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–°–µ—Ä–≤–∏—Å—ã –∏ –∏—Ö –ª–æ–≥–∏–∫–∞](#—Å–µ—Ä–≤–∏—Å—ã-–∏-–∏—Ö-–ª–æ–≥–∏–∫–∞)
2. [–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏](#–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏-–º–µ–∂–¥—É-—Å–µ—Ä–≤–∏—Å–∞–º–∏)
3. [–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –≤–Ω–µ—à–Ω–∏–º–∏ API](#–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ-—Å-–≤–Ω–µ—à–Ω–∏–º–∏-api)
4. [–õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤](#–ª–æ–≥–∏–∫–∞-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)
5. [–ú–æ–¥–µ–ª–∏ –∏ –∏—Ö —Å–≤—è–∑–∏](#–º–æ–¥–µ–ª–∏-–∏-–∏—Ö-—Å–≤—è–∑–∏)

---

## üîß **–°–ï–†–í–ò–°–´ –ò –ò–• –õ–û–ì–ò–ö–ê**

### 1. **GeminiService** - –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Gemini API

#### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
–û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Google Gemini API, –≤–∫–ª—é—á–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∫–æ–Ω—Ç–µ–Ω—Ç–∞, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π.

#### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:

##### 1.1 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞
```python
def __init__(self, api_key: str):
    """
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ —Å API –∫–ª—é—á–æ–º
    
    Args:
        api_key: API –∫–ª—é—á –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Gemini API
    """
    if not api_key:
        raise ValidationError("API –∫–ª—é—á –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
    
    self.api_key = api_key
    self.session = requests.Session()
    self.session.headers.update({
        'Content-Type': 'application/json',
    })
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
- `requests` - –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- `django.core.exceptions.ValidationError` - –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- `django.conf.settings` - –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫

##### 1.2 –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
```python
def _make_request(self, endpoint: str, data: Dict, max_retries: int = 2) -> Tuple[bool, Dict, Optional[str]]:
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Gemini API —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
    """
    url = f"{self.BASE_URL}/{endpoint}?key={self.api_key}"
    
    for attempt in range(max_retries + 1):
        try:
            # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
            response = self.session.post(url, json=data, timeout=30)
            
            if response.status_code == 200:
                return True, response.json(), None
            else:
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
                if response.status_code == 503:
                    # –ú–æ–¥–µ–ª—å –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞ - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
                elif response.status_code == 429:
                    # –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
                elif response.status_code == 400:
                    # –ù–µ–≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å - –≤–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏
```

**–õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:**
- **503 Service Unavailable** - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
- **429 Too Many Requests** - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
- **400 Bad Request** - –≤–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
- **Timeout** - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
- **Connection Error** - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π

##### 1.3 –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
```python
def generate_content(self, prompt: str, history: List[Dict] = None) -> Tuple[bool, str, Dict]:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç —Å –ø–æ–º–æ—â—å—é Gemini API
    """
    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–ª—è API
    contents = []
    
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    if history:
        for msg in history:
            if msg.get('role') in ['user', 'assistant']:
                contents.append({
                    "role": msg['role'],
                    "parts": [{"text": msg['content']}]
                })
    
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    contents.append({
        "role": "user",
        "parts": [{"text": prompt}]
    })
    
    # –î–∞–Ω–Ω—ã–µ –¥–ª—è API
    data = {
        "contents": contents,
        "generationConfig": {
            "temperature": 0.7,
            "topK": 40,
            "topP": 0.95,
            "maxOutputTokens": 2048,
        },
        "safetySettings": [
            # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        ]
    }
```

**–õ–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:**
1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–º–ø—Ç–∞
2. **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤** - —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, —Ç–æ–∫–µ–Ω—ã, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
4. **–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞** - —á–µ—Ä–µ–∑ `_make_request`
5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞** - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
6. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - —É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞, —Ç–µ–∫—Å—Ç, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

##### 1.4 –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
```python
def test_connection(self) -> Tuple[bool, str]:
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Gemini API
    """
    test_prompt = "–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –û—Ç–≤–µ—Ç—å –∫–æ—Ä–æ—Ç–∫–æ."
    
    success, response, metadata = self.generate_content(test_prompt)
    
    if success:
        return True, "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Gemini API —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
    else:
        return False, f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {response}"
```

**–õ–æ–≥–∏–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
1. **–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞** - –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞** - —É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞
3. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ

##### 1.5 –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
```python
def get_available_models(self) -> Tuple[bool, List[str], Optional[str]]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
    """
    success, response_data, error = self._make_request("models", {})
    
    if not success:
        return False, [], error
    
    try:
        models = []
        if 'models' in response_data:
            for model in response_data['models']:
                if 'name' in model:
                    models.append(model['name'])
        return True, models, None
    except (KeyError, TypeError) as e:
        return False, [], f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π: {str(e)}"
```

**–õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π:**
1. **–ó–∞–ø—Ä–æ—Å –∫ API** - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞** - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π –º–æ–¥–µ–ª–µ–π
3. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π

#### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- **–í–Ω–µ—à–Ω–∏–µ:** Google Gemini API
- **–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ:** Django settings, ValidationError
- **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏:** requests, json, time

---

### 2. **MessageHandler** - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞

#### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ —á–∞—Ç–∞, –≤–∫–ª—é—á–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—é, —Å–æ–∑–¥–∞–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–∫—É –≤ Gemini –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ.

#### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:

##### 2.1 –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
```python
@staticmethod
def validate_message_request(data: Dict[str, Any]) -> Tuple[bool, Optional[str]]:
    """
    –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è
    """
    session_id = data.get('session_id')
    message = data.get('message', '').strip()
    
    if not session_id:
        return False, '–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç session_id'
    
    if not message:
        return False, '–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç message'
    
    return True, None
```

**–õ–æ–≥–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ session_id** - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ message** - –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º
3. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∏ –æ—à–∏–±–∫–∞

##### 2.2 –í–∞–ª–∏–¥–∞—Ü–∏—è API –∫–ª—é—á–∞
```python
@staticmethod
def validate_api_key(user) -> Tuple[bool, Optional[str]]:
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è API –∫–ª—é—á–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    if not user.gemini_api_key:
        return False, 'API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'
    
    return True, None
```

**–õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–ª—é—á–∞** - —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - –µ—Å—Ç—å –∫–ª—é—á –∏–ª–∏ –æ—à–∏–±–∫–∞

##### 2.3 –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —á–∞—Ç–∞
```python
@staticmethod
def get_chat_session(session_id: int, user) -> ChatSession:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —á–∞—Ç–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
    """
    return get_object_or_404(ChatSession, id=session_id, user=user)
```

**–õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è:**
1. **–ü–æ–∏—Å–∫ —Å–µ—Å—Å–∏–∏** - –ø–æ ID –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤** - —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Å–µ—Å—Å–∏—é
3. **–í–æ–∑–≤—Ä–∞—Ç —Å–µ—Å—Å–∏–∏** - –∏–ª–∏ 404 –æ—à–∏–±–∫–∞

##### 2.4 –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```python
@staticmethod
def create_user_message(session: ChatSession, message: str) -> ChatMessage:
    """
    –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    return ChatMessage.objects.create(
        session=session,
        role='user',
        content=message
    )
```

**–õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è:**
1. **–°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞** - ChatMessage
2. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–æ–ª–∏** - 'user'
3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î** - —á–µ—Ä–µ–∑ ORM
4. **–í–æ–∑–≤—Ä–∞—Ç –æ–±—ä–µ–∫—Ç–∞** - —Å–æ–∑–¥–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

##### 2.5 –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
```python
@staticmethod
def get_message_history(session: ChatSession, limit: int = 20) -> list:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    """
    history_messages = ChatMessage.objects.filter(
        session=session
    ).order_by('timestamp')[:limit]
    
    history = []
    for msg in history_messages:
        history.append({
            'role': msg.role,
            'content': msg.content
        })
    
    return history
```

**–õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:**
1. **–ó–∞–ø—Ä–æ—Å –∫ –ë–î** - –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π
2. **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞** - –ø–æ –≤—Ä–µ–º–µ–Ω–∏
3. **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞** - –¥–ª—è API
4. **–í–æ–∑–≤—Ä–∞—Ç –∏—Å—Ç–æ—Ä–∏–∏** - —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π

##### 2.6 –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Gemini
```python
@staticmethod
def send_to_gemini(message: str, history: list, api_key: str) -> Tuple[bool, str, Dict[str, Any]]:
    """
    –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Gemini API
    """
    gemini_service = GeminiService(api_key)
    return gemini_service.generate_content(message, history)
```

**–õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:**
1. **–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞** - —Å API –∫–ª—é—á–æ–º
2. **–í—ã–∑–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏** - —á–µ—Ä–µ–∑ GeminiService
3. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - —É—Å–ø–µ—Ö, –æ—Ç–≤–µ—Ç, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

##### 2.7 –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
```python
@staticmethod
def create_assistant_message(session: ChatSession, response: str, metadata: Dict[str, Any]) -> ChatMessage:
    """
    –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    """
    return ChatMessage.objects.create(
        session=session,
        role='assistant',
        content=response,
        tokens_used=metadata.get('usage_metadata', {}).get('totalTokenCount'),
        response_time=metadata.get('response_time')
    )
```

**–õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞:**
1. **–°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞** - ChatMessage
2. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–æ–ª–∏** - 'assistant'
3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö** - —Ç–æ–∫–µ–Ω—ã, –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
4. **–í–æ–∑–≤—Ä–∞—Ç –æ–±—ä–µ–∫—Ç–∞** - —Å–æ–∑–¥–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

##### 2.8 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–µ—Å—Å–∏–∏
```python
@staticmethod
def update_session_timestamp(session: ChatSession) -> None:
    """
    –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
    """
    session.updated_at = timezone.now()
    session.save()
```

**–õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**
1. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏** - —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
2. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** - –≤ –ë–î

##### 2.9 –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
```python
@staticmethod
def send_message_to_gemini(session_id: int, message: str, user) -> Dict[str, Any]:
    """
    –û–±—â–∞—è –ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Gemini
    """
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
        is_valid, error = MessageHandler.validate_message_request({
            'session_id': session_id,
            'message': message
        })
        if not is_valid:
            return {'success': False, 'error': error}
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞
        has_key, error = MessageHandler.validate_api_key(user)
        if not has_key:
            return {'success': False, 'error': error}
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
        chat_session = MessageHandler.get_chat_session(session_id, user)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_message = MessageHandler.create_user_message(chat_session, message)
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        history = MessageHandler.get_message_history(chat_session)
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –∫ Gemini
        success, response, metadata = MessageHandler.send_to_gemini(
            message, history, user.gemini_api_key
        )
        
        if success:
            # –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
            assistant_message = MessageHandler.create_assistant_message(
                chat_session, response, metadata
            )
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–µ—Å—Å–∏–∏
            MessageHandler.update_session_timestamp(chat_session)
            
            return {
                'success': True,
                'response': response,
                'user_message_id': user_message.id,
                'assistant_message_id': assistant_message.id,
                'metadata': metadata
            }
        else:
            return {'success': False, 'error': response}
            
    except Exception as e:
        return {'success': False, 'error': f'–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: {str(e)}'}
```

**–õ–æ–≥–∏–∫–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞:**
1. **–í–∞–ª–∏–¥–∞—Ü–∏—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞** - —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏** - —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤
4. **–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
5. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏** - –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
6. **–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Gemini** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
7. **–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞** - –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
8. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏** - –≤—Ä–µ–º–µ–Ω–∏
9. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - —É—Å–ø–µ—Ö –∏–ª–∏ –æ—à–∏–±–∫–∞

#### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- **–ú–æ–¥–µ–ª–∏:** ChatSession, ChatMessage
- **–°–µ—Ä–≤–∏—Å—ã:** GeminiService
- **Django:** get_object_or_404, timezone
- **–í–Ω–µ—à–Ω–∏–µ:** Google Gemini API

---

### 3. **ApiKeyHandler** - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ API –∫–ª—é—á–µ–π

#### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API –∫–ª—é—á–µ–π Gemini.

#### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:

##### 3.1 –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω–æ–≥–æ –∫–ª—é—á–∞
```python
@staticmethod
def validate_api_key_input(api_key: str) -> Tuple[bool, str]:
    """
    –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω–æ–≥–æ API –∫–ª—é—á–∞
    """
    if not api_key:
        return False, 'API –∫–ª—é—á –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'
    
    if not api_key.strip():
        return False, 'API –∫–ª—é—á –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'
    
    return True, ''
```

**–õ–æ–≥–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ None** - –∫–ª—é—á –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å None
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ—Ç—É** - –ø–æ—Å–ª–µ strip()
3. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∏ –æ—à–∏–±–∫–∞

##### 3.2 –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
```python
@staticmethod
def test_api_key_connection(api_key: str) -> Tuple[bool, str]:
    """
    –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Gemini API
    """
    try:
        gemini_service = GeminiService(api_key)
        success, message = gemini_service.test_connection()
        return success, message
    except ValidationError as e:
        return False, f'–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ API –∫–ª—é—á–∞: {str(e)}'
    except Exception as e:
        return False, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ API –∫–ª—é—á–∞: {str(e)}'
```

**–õ–æ–≥–∏–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
1. **–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞** - —Å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º –∫–ª—é—á–æ–º
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** - —á–µ—Ä–µ–∑ GeminiService
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - ValidationError –∏ –æ–±—â–∏–µ
4. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - —É—Å–ø–µ—Ö –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ

##### 3.3 –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```python
@staticmethod
def test_api_key(api_key: str) -> Dict[str, Any]:
    """
    –û–±—â–∞—è –ª–æ–≥–∏–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API –∫–ª—é—á–∞
    """
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    is_valid, error = ApiKeyHandler.validate_api_key_input(api_key)
    if not is_valid:
        return {
            'success': False,
            'error': error
        }
    
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    success, message = ApiKeyHandler.test_api_key_connection(api_key)
    
    return {
        'success': success,
        'message': message
    }
```

**–õ–æ–≥–∏–∫–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞:**
1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–ª—é—á–∞** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** - –∫ Gemini API
3. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - —É—Å–ø–µ—Ö –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ

#### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- **–°–µ—Ä–≤–∏—Å—ã:** GeminiService
- **Django:** ValidationError

---

### 4. **StatsHandler** - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

#### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å–µ—Å—Å–∏—è–º, —Å–æ–æ–±—â–µ–Ω–∏—è–º –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é API.

#### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:

##### 4.1 –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```python
@staticmethod
def get_user_sessions(user) -> List[ChatSession]:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    return ChatSession.objects.filter(user=user)
```

**–õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è:**
1. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é** - –≤—Å–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. **–í–æ–∑–≤—Ä–∞—Ç QuerySet** - –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

##### 4.2 –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
```python
@staticmethod
def get_active_sessions(user) -> List[ChatSession]:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    return ChatSession.objects.filter(
        user=user, 
        is_active=True
    ).order_by('-updated_at')[:10]
```

**–õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è:**
1. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è** - –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
2. **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞** - –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–µ)
3. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ** - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–µ—Å—Å–∏–π
4. **–í–æ–∑–≤—Ä–∞—Ç —Å–ø–∏—Å–∫–∞** - –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π

##### 4.3 –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–µ—Å—Å–∏–π
```python
@staticmethod
def get_recent_sessions(user, limit: int = 5) -> List[ChatSession]:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    return ChatSession.objects.filter(user=user).order_by('-created_at')[:limit]
```

**–õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è:**
1. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è** - –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
2. **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞** - –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–µ)
3. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ** - —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
4. **–í–æ–∑–≤—Ä–∞—Ç —Å–ø–∏—Å–∫–∞** - –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–µ—Å—Å–∏–π

##### 4.4 –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–µ—Å—Å–∏–π
```python
@staticmethod
def calculate_session_stats(sessions) -> Dict[str, int]:
    """
    –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å–µ—Å—Å–∏—è–º
    """
    total_sessions = sessions.count()
    active_sessions = sessions.filter(is_active=True).count()
    
    return {
        'total_sessions': total_sessions,
        'active_sessions': active_sessions
    }
```

**–õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞:**
1. **–ü–æ–¥—Å—á–µ—Ç –æ–±—â–∏—Ö** - –≤—Å–µ–≥–æ —Å–µ—Å—Å–∏–π
2. **–ü–æ–¥—Å—á–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö** - —Å is_active=True
3. **–í–æ–∑–≤—Ä–∞—Ç —Å–ª–æ–≤–∞—Ä—è** - —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π

##### 4.5 –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
```python
@staticmethod
def calculate_message_stats(sessions) -> Dict[str, Any]:
    """
    –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º
    """
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    messages = ChatMessage.objects.filter(session__in=sessions)
    
    total_messages = messages.count()
    total_tokens = messages.aggregate(
        total=Sum('tokens_used')
    )['total'] or 0
    
    # –°—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
    average_messages_per_session = (
        total_messages / sessions.count() if sessions.count() > 0 else 0
    )
    average_tokens_per_message = (
        total_tokens / total_messages if total_messages > 0 else 0
    )
    
    return {
        'total_messages': total_messages,
        'total_tokens': total_tokens,
        'average_messages_per_session': average_messages_per_session,
        'average_tokens_per_message': average_tokens_per_message
    }
```

**–õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞:**
1. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π** - –¥–ª—è –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. **–ü–æ–¥—Å—á–µ—Ç –æ–±—â–∏—Ö** - –≤—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π
3. **–ü–æ–¥—Å—á–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤** - —Å—É–º–º–∞ —á–µ—Ä–µ–∑ aggregate
4. **–†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–∏—Ö** - —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ —Å–µ—Å—Å–∏—é –∏ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
5. **–í–æ–∑–≤—Ä–∞—Ç —Å–ª–æ–≤–∞—Ä—è** - —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π

##### 4.6 –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
```python
@staticmethod
def get_user_stats(user) -> Dict[str, Any]:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        sessions = StatsHandler.get_user_sessions(user)
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–π
        session_stats = StatsHandler.calculate_session_stats(sessions)
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        message_stats = StatsHandler.calculate_message_stats(sessions)
        
        # –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–µ—Å—Å–∏–∏
        recent_sessions = StatsHandler.get_recent_sessions(user)
        recent_sessions_data = ChatSessionSerializer(
            recent_sessions, many=True
        ).data
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        stats = {
            **session_stats,
            **message_stats,
            'recent_sessions': recent_sessions_data
        }
        
        return stats
        
    except Exception as e:
        return {
            'error': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {str(e)}'
        }
```

**–õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:**
1. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. **–†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–µ—Å—Å–∏–π** - –æ–±—â–∏–µ –∏ –∞–∫—Ç–∏–≤–Ω—ã–µ
3. **–†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Ç–æ–∫–µ–Ω—ã
4. **–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–µ—Å—Å–∏–π** - –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
5. **–°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è** - —á–µ—Ä–µ–∑ ChatSessionSerializer
6. **–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ** - –≤—Å–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
7. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - –ø–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞

##### 4.7 –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∞—à–±–æ—Ä–¥–∞
```python
@staticmethod
def get_dashboard_context(user) -> Dict[str, Any]:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞
    """
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞
        has_api_key = bool(user.gemini_api_key)
        
        # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏
        chat_sessions = StatsHandler.get_active_sessions(user)
        
        context = {
            'has_api_key': has_api_key,
            'chat_sessions': chat_sessions,
            'api_key_configured': has_api_key,
        }
        
        return context
        
    except Exception as e:
        return {
            'error': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∞—à–±–æ—Ä–¥–∞: {str(e)}'
        }
```

**–õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:**
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞** - –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π** - –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
3. **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** - –¥–ª—è —à–∞–±–ª–æ–Ω–∞
4. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞

#### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- **–ú–æ–¥–µ–ª–∏:** ChatSession, ChatMessage
- **–°–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä—ã:** ChatSessionSerializer
- **Django:** Sum, aggregate

---

## üîó **–ó–ê–í–ò–°–ò–ú–û–°–¢–ò –ú–ï–ñ–î–£ –°–ï–†–í–ò–°–ê–ú–ò**

### –ì—Ä–∞—Ñ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   MessageHandler ‚îÇ
‚îÇ                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ GeminiService‚îÇ ‚îÇ
‚îÇ  ‚îÇ             ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ requests ‚îÇ ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ   API   ‚îÇ ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   ApiKeyHandler ‚îÇ
‚îÇ                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ GeminiService‚îÇ ‚îÇ
‚îÇ  ‚îÇ             ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ requests ‚îÇ ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ   API   ‚îÇ ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   StatsHandler  ‚îÇ
‚îÇ                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ   Models    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ChatSession ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ChatMessage ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:

#### 1. **MessageHandler** ‚Üí **GeminiService**
- **–¢–∏–ø –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ü—Ä—è–º–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Gemini API
- **–ú–µ—Ç–æ–¥—ã:** `send_to_gemini()` ‚Üí `generate_content()`

#### 2. **ApiKeyHandler** ‚Üí **GeminiService**
- **–¢–∏–ø –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ü—Ä—è–º–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –∫–ª—é—á–µ–π
- **–ú–µ—Ç–æ–¥—ã:** `test_api_key_connection()` ‚Üí `test_connection()`

#### 3. **StatsHandler** ‚Üí **Models**
- **–¢–∏–ø –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ü—Ä—è–º–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î
- **–ú–æ–¥–µ–ª–∏:** ChatSession, ChatMessage

#### 4. **GeminiService** ‚Üí **External API**
- **–¢–∏–ø –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –í–Ω–µ—à–Ω—è—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Google Gemini API
- **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏:** requests, json, time

---

## üåê **–í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï –° –í–ù–ï–®–ù–ò–ú–ò API**

### 1. **Google Gemini API**

#### Endpoints:
- **`/v1beta/models/{model}:generateContent`** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- **`/v1beta/models`** - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π

#### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:
```json
{
    "contents": [
        {
            "role": "user",
            "parts": [{"text": "–ü—Ä–∏–≤–µ—Ç!"}]
        }
    ],
    "generationConfig": {
        "temperature": 0.7,
        "topK": 40,
        "topP": 0.95,
        "maxOutputTokens": 2048
    },
    "safetySettings": [
        {
            "category": "HARM_CATEGORY_HARASSMENT",
            "threshold": "BLOCK_MEDIUM_AND_ABOVE"
        }
    ]
}
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤:
```json
{
    "candidates": [
        {
            "content": {
                "parts": [{"text": "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?"}]
            },
            "finishReason": "STOP",
            "safetyRatings": []
        }
    ],
    "usageMetadata": {
        "promptTokenCount": 5,
        "candidatesTokenCount": 10,
        "totalTokenCount": 15
    }
}
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
- **503 Service Unavailable** - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
- **429 Too Many Requests** - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
- **400 Bad Request** - –≤–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏
- **Timeout** - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
- **Connection Error** - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞

---

## üìä **–õ–û–ì–ò–ö–ê –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í**

### 1. **MessageApiHandler** - API –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π

#### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è API endpoints, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.

#### –ú–µ—Ç–æ–¥—ã:

##### 1.1 send_message_api_handler
```python
@staticmethod
def send_message_api_handler(data: Dict[str, Any], request) -> Dict[str, Any]:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    """
    session_id = data.get('session_id')
    message = data.get('message', '').strip()
    
    return MessageHandler.send_message_to_gemini(session_id, message, request.user)
```

**–õ–æ–≥–∏–∫–∞:**
1. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** - session_id –∏ message
2. **–í—ã–∑–æ–≤ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞** - MessageHandler
3. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - —É—Å–ø–µ—Ö –∏–ª–∏ –æ—à–∏–±–∫–∞

##### 1.2 send_message_viewset_handler
```python
@staticmethod
def send_message_viewset_handler(session: ChatSession, content: str, user) -> Dict[str, Any]:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è ViewSet –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    """
    return MessageHandler.send_message_to_gemini(session.id, content, user)
```

**–õ–æ–≥–∏–∫–∞:**
1. **–ü–æ–ª—É—á–µ–Ω–∏–µ ID —Å–µ—Å—Å–∏–∏** - –∏–∑ –æ–±—ä–µ–∫—Ç–∞ —Å–µ—Å—Å–∏–∏
2. **–í—ã–∑–æ–≤ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞** - MessageHandler
3. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - —É—Å–ø–µ—Ö –∏–ª–∏ –æ—à–∏–±–∫–∞

### 2. **ApiKeyApiHandler** - API –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª—é—á–µ–π

#### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è API endpoints, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º API –∫–ª—é—á–µ–π.

#### –ú–µ—Ç–æ–¥—ã:

##### 2.1 test_api_key_handler
```python
@staticmethod
def test_api_key_handler(data: Dict[str, Any], request) -> Dict[str, Any]:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ API –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API –∫–ª—é—á–∞
    """
    api_key = data.get('api_key', '').strip()
    return ApiKeyHandler.test_api_key(api_key)
```

**–õ–æ–≥–∏–∫–∞:**
1. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–∞** - –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞
2. **–í—ã–∑–æ–≤ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞** - ApiKeyHandler
3. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - —É—Å–ø–µ—Ö –∏–ª–∏ –æ—à–∏–±–∫–∞

##### 2.2 test_connection_viewset_handler
```python
@staticmethod
def test_connection_viewset_handler(api_key: str) -> Dict[str, Any]:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è ViewSet —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    """
    return ApiKeyHandler.test_api_key(api_key)
```

**–õ–æ–≥–∏–∫–∞:**
1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–∞** - –Ω–∞–ø—Ä—è–º—É—é
2. **–í—ã–∑–æ–≤ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞** - ApiKeyHandler
3. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - —É—Å–ø–µ—Ö –∏–ª–∏ –æ—à–∏–±–∫–∞

### 3. **StatsApiHandler** - API –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

#### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è API endpoints, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π.

#### –ú–µ—Ç–æ–¥—ã:

##### 3.1 get_stats_handler
```python
@staticmethod
def get_stats_handler(data: Dict[str, Any], request) -> Dict[str, Any]:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    """
    return StatsHandler.get_user_stats(request.user)
```

**–õ–æ–≥–∏–∫–∞:**
1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** - –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
2. **–í—ã–∑–æ–≤ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞** - StatsHandler
3. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞

##### 3.2 get_dashboard_handler
```python
@staticmethod
def get_dashboard_handler(data: Dict[str, Any], request) -> Dict[str, Any]:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∞—à–±–æ—Ä–¥–∞
    """
    return StatsHandler.get_dashboard_context(request.user)
```

**–õ–æ–≥–∏–∫–∞:**
1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** - –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
2. **–í—ã–∑–æ–≤ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞** - StatsHandler
3. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞

---

## üóÉÔ∏è **–ú–û–î–ï–õ–ò –ò –ò–• –°–í–Ø–ó–ò**

### 1. **ChatSession** - –°–µ—Å—Å–∏–∏ —á–∞—Ç–∞

#### –ü–æ–ª—è:
```python
class ChatSession(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    title = models.CharField(max_length=200)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    is_active = models.BooleanField(default=True)
```

#### –°–≤—è–∑–∏:
- **User** (ForeignKey) - –≤–ª–∞–¥–µ–ª–µ—Ü —Å–µ—Å—Å–∏–∏
- **ChatMessage** (OneToMany) - —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–µ—Å—Å–∏–∏

#### –õ–æ–≥–∏–∫–∞:
1. **–°–æ–∑–¥–∞–Ω–∏–µ** - –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π
3. **–î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è** - –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏

### 2. **ChatMessage** - –°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞

#### –ü–æ–ª—è:
```python
class ChatMessage(models.Model):
    session = models.ForeignKey(ChatSession, on_delete=models.CASCADE)
    role = models.CharField(max_length=20, choices=ROLE_CHOICES)
    content = models.TextField()
    timestamp = models.DateTimeField(auto_now_add=True)
    tokens_used = models.IntegerField(null=True, blank=True)
    response_time = models.FloatField(null=True, blank=True)
```

#### –°–≤—è–∑–∏:
- **ChatSession** (ForeignKey) - —Å–µ—Å—Å–∏—è, –∫ –∫–æ—Ç–æ—Ä–æ–π –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ

#### –õ–æ–≥–∏–∫–∞:
1. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ** - –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è
2. **–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞** - –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Gemini
3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö** - —Ç–æ–∫–µ–Ω—ã, –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞

---

## üéØ **–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**

### ‚úÖ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

1. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - –∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–≤–æ—é –æ–±–ª–∞—Å—Ç—å
2. **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** - –æ–±—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ views
3. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
5. **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å** - –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ

### üìä **–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:**
- **–°–µ—Ä–≤–∏—Å—ã:** ‚úÖ **–ü–æ–ª–Ω–æ—Å—Ç—å—é –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã**
- **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** ‚úÖ **–ß–µ—Ç–∫–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã**
- **–õ–æ–≥–∏–∫–∞:** ‚úÖ **–î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—Å–∞–Ω–∞**
- **API:** ‚úÖ **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã**
- **–ú–æ–¥–µ–ª–∏:** ‚úÖ **–°–≤—è–∑–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**

### üöÄ **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:**
**–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã Gemini App –ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**

---

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2024-01-20  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã**  
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:** Production Ready  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

---

**–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Gemini –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ—Ç–ª–∏—á–Ω—ã–π –ø—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å–µ—Ä–≤–∏—Å–æ–≤!** üéâ
