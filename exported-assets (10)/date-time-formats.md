# Библиотека форматов даты и времени для analyze_time_with_parser

## 1. Конфигурация временных слотов

### Бизнес-часы: 11:00 - 18:00
### Временные слоты: 00, 15, 30, 45 минут каждого часа

```python
BUSINESS_HOURS = {
    'start': 11,
    'end': 18
}

TIME_SLOTS = [0, 15, 30, 45]  # минуты

VALID_TIMES = [
    "11:00", "11:15", "11:30", "11:45",
    "12:00", "12:15", "12:30", "12:45",
    "13:00", "13:15", "13:30", "13:45",
    "14:00", "14:15", "14:30", "14:45",
    "15:00", "15:15", "15:30", "15:45",
    "16:00", "16:15", "16:30", "16:45",
    "17:00", "17:15", "17:30", "17:45"
]
```

## 2. Словари сопоставлений

### 2.1 Неправильная раскладка клавиатуры

```python
KEYBOARD_MAPPING = {
    # Английские буквы → Русские (QWERTY → ЙЦУКЕН)
    'q': 'й', 'w': 'ц', 'e': 'у', 'r': 'к', 't': 'е', 'y': 'н',
    'u': 'г', 'i': 'ш', 'o': 'щ', 'p': 'з', '[': 'х', ']': 'ъ',
    'a': 'ф', 's': 'ы', 'd': 'в', 'f': 'а', 'g': 'п', 'h': 'р',
    'j': 'о', 'k': 'л', 'l': 'д', ';': 'ж', "'": 'э',
    'z': 'я', 'x': 'ч', 'c': 'с', 'v': 'м', 'b': 'и', 'n': 'т',
    'm': 'ь', ',': 'б', '.': 'ю', '/': '.',
    
    # Русские буквы → Английские (ЙЦУКЕН → QWERTY)
    'й': 'q', 'ц': 'w', 'у': 'e', 'к': 'r', 'е': 't', 'н': 'y',
    'г': 'u', 'ш': 'i', 'щ': 'o', 'з': 'p', 'х': '[', 'ъ': ']',
    'ф': 'a', 'ы': 's', 'в': 'd', 'а': 'f', 'п': 'g', 'р': 'h',
    'о': 'j', 'л': 'k', 'д': 'l', 'ж': ';', 'э': "'",
    'я': 'z', 'ч': 'x', 'с': 'c', 'м': 'v', 'и': 'b', 'т': 'n',
    'ь': 'm', 'б': ',', 'ю': '.', '.': '/'
}

# Примеры исправлений
COMMON_KEYBOARD_ERRORS = {
    'GY': 'ПН',      # понедельник
    'ds': 'вт',      # вторник  
    'ch': 'ср',      # среда
    'xn': 'чт',      # четверг
    'gn': 'пт',      # пятница
    'c,': 'сб',      # суббота
    'dc': 'вс',      # воскресенье
    'pfdnhf': 'завтра',
    'ctuljyz': 'сегодня',
    'gjcrfx': 'после',
    'jrn': 'окт',
    'yjz': 'ноя',
    'ltrf,hm': 'декабрь'
}
```

### 2.2 Дни недели (все варианты)

```python
WEEKDAYS = {
    # --- Понедельник / Monday ---
    'понедельник': 0, 'пн': 0, 'пон': 0, 'понед': 0,
    'пенедельник': 0, 'панидельник': 0, 'понеделньик': 0, 'понедельниик': 0,
    'понедельника': 0, 'понеделник': 0, 'пнделник': 0,
    'gy': 0, 'gj': 0, 'ekf': 0, 'ekfqf': 0, 'ghjnfyfdfkz': 0,
    'gjnjnfyfdfkz': 0, 'gjnfyfdbfkz': 0, 'ghjnfyfzdfkz': 0, 'ghjnfyfdfk': 0,
    'ponedelnik': 0,
    'monday': 0, 'mon': 0, 'mond': 0,
    'mondy': 0, 'mon day': 0, 'munday': 0, 'monda': 0, 'monnday': 0, 'mondae': 0,

    # --- Вторник / Tuesday ---
    'вторник': 1, 'вт': 1, 'втор': 1, 'вторн': 1,
    'вторниик': 1, 'втоорник': 1, 'втpник': 1, 'втоpник': 1, 'вторника': 1,
    'ds': 1, 'cu': 1, 'cth': 1, 'cthjn': 1, 'cthjnrf': 1, 'cuhjnrf': 1,
    'cthjnr': 1, 'cuhjnr': 1, 'cthjnf': 1, 'cuhjn': 1,
    'vtornik': 1,
    'tuesday': 1, 'tue': 1, 'tues': 1, 'tu': 1,
    'tuseday': 1, 'tuesady': 1, 'thuesday': 1, 'tuesda': 1, 'tueday': 1, 'tues day': 1,

    # --- Среда / Wednesday ---
    'среда': 2, 'ср': 2, 'сред': 2, 'среду': 2,
    'средда': 2, 'срeда': 2, 'сpеда': 2, 'средаа': 2, 'средаы': 2, 'срeду': 2,
    'ch': 2, 'cc': 2, 'cjd': 2, 'cjdth': 2, 'cjdthf': 2, 'ccjdthf': 2,
    'cjdth': 2, 'ccjdt': 2, 'cjd t': 2, 'ccjd': 2,
    'sreda': 2,
    'wednesday': 2, 'wed': 2, 'weds': 2,
    'wensday': 2, 'wednsday': 2, 'wednesdayy': 2, 'wednesdy': 2, 'wedsday': 2, 'wednes day': 2,

    # --- Четверг / Thursday ---
    'четверг': 3, 'чт': 3, 'четв': 3, 'четвер': 3,
    'четвеpг': 3, 'чевтерг': 3, 'четвергг': 3, 'четвeрг': 3, 'чeтвeрг': 3, 'четверга': 3,
    'xn': 3, 'db': 3, 'dctk': 3, 'dctkf': 3, 'dctkfdbnm': 3, 'dbctkfdbnm': 3,
    'dctkfd': 3, 'dbctkfd': 3, 'dctkfdb': 3, 'dbctkfdb': 3,
    'chetverg': 3,
    'thursday': 3, 'thu': 3, 'thur': 3, 'thurs': 3,
    'thrusday': 3, 'thurday': 3, 'thuesday': 3, 'thursady': 3, 'thur sday': 3, 'thusrday': 3,

    # --- Пятница / Friday ---
    'пятница': 4, 'пт': 4, 'пятн': 4, 'пятни': 4,
    'пятнница': 4, 'пяьница': 4, 'пятницаа': 4, 'птница': 4,
    'gn': 4, 'зщ': 4, 'зщы': 4, 'зщыфи': 4, 'зщыфия': 4, 'зщы фия': 4,
    'pyatnitsa': 4,
    'friday': 4, 'fri': 4, 'fr': 4,
    'frday': 4, 'fridday': 4, 'fryday': 4, 'fridy': 4, 'fridayy': 4, 'fri day': 4,

    # --- Суббота / Saturday ---
    'суббота': 5, 'сб': 5, 'субб': 5, 'суббо': 5,
    'суботта': 5, 'субббота': 5, 'субботаа': 5, 'субботаы': 5, 'саббота': 5, 'суб ботта': 5,
    'c': 5, 'su': 5, 'су': 5, 'суке': 5, 'сукеым': 5, 'сукеымг': 5, 'subbota': 5,
    'saturday': 5, 'sat': 5, 'sa': 5,
    'saterday': 5, 'saturady': 5, 'satuday': 5, 'satur day': 5, 'satyrday': 5, 'satruday': 5,

    # --- Воскресенье / Sunday ---
    'воскресенье': 6, 'вс': 6, 'воскр': 6, 'воск': 6,
    'воскресение': 6, 'воскресеньe': 6, 'воскресеье': 6, 'воскресенья': 6, 'воскресень': 6,
    'dc': 6, 'вж': 6, 'виж': 6, 'вижсп': 6, 'вижспщкшеук': 6,
    'voskresenye': 6,
    'sunday': 6, 'sun': 6, 'sunn': 6,
    'sundy': 6, 'sundaay': 6, 'suday': 6, 'sunnday': 6, 'sundayy': 6, 'sun day': 6,
}
```

### 2.3 Месяцы (все варианты)

В файле months_full.py

### 2.4 Относительные даты

```python
RELATIVE_DATES = {
    # Сегодня/завтра
    'сегодня': 0, 'сёдня': 0, 'седня': 0, 'today': 0,
    'завтра': 1, 'завтро': 1, 'завр': 1, 'tomorrow': 1,
    'послезавтра': 2, 'послезавтро': 2,
    
    # Через N дней
    'через день': 1,
    'через два дня': 2,
    'через три дня': 3,
    'через неделю': 7,
    
    # На следующей неделе
    'на следующей неделе': 'next_week',
    'следующая неделя': 'next_week',
    'след неделе': 'next_week',
    'next week': 'next_week'
}
```

## 3. Форматы дат и времени

### 3.1 Форматы дат

```python
DATE_FORMATS = [
    # С разделителями
    'DD.MM.YYYY', 'DD.MM.YY', 'DD.MM',
    'DD/MM/YYYY', 'DD/MM/YY', 'DD/MM',
    'DD-MM-YYYY', 'DD-MM-YY', 'DD-MM',
    
    # Без разделителей
    'DDMM', 'DDMMYY', 'DDMMYYYY',
    
    # С текстом
    'DD месяц', 'DD месяц YYYY',
    'DD мес', 'DD мес YY',
    
    # Примеры
    '10.10', '10.10.24', '10.10.2024',
    '10/10', '10-10', '1010',
    '10 окт', '10окт', '10 октября',
    '10 oct', '10oct', '10 october'
]

# Регулярные выражения для парсинга
DATE_PATTERNS = [
    r'(\d{1,2})\.(\d{1,2})\.(\d{2,4})',      # DD.MM.YYYY
    r'(\d{1,2})\.(\d{1,2})',                 # DD.MM
    r'(\d{1,2})/(\d{1,2})/(\d{2,4})',       # DD/MM/YYYY
    r'(\d{1,2})/(\d{1,2})',                  # DD/MM
    r'(\d{1,2})-(\d{1,2})-(\d{2,4})',       # DD-MM-YYYY
    r'(\d{1,2})-(\d{1,2})',                  # DD-MM
    r'(\d{1,2})\s*([а-яё]{3,9})',           # DD месяц
    r'(\d{1,2})\s*([a-z]{3,9})',            # DD month
    r'(\d{2,4})',                            # DDMM или DDMMYY
]
```

### 3.2 Форматы времени

```python
TIME_FORMATS = [
    # Полный формат
    'HH:MM', 'HH.MM', 'HH-MM',
    'H:MM', 'H.MM', 'H-MM',
    
    # Только час
    'HH', 'H',
    
    # С секундами
    'HH:MM:SS', 'HH.MM.SS',
    
    # 12-часовой формат  
    'HH:MM AM/PM', 'H:MM AM/PM',
    
    # Без разделителей
    'HHMM', 'HMM'
]

# Регулярные выражения для времени
TIME_PATTERNS = [
    r'(\d{1,2})[:\.\-](\d{2})',             # HH:MM, HH.MM, HH-MM
    r'(\d{1,2})\s*(?:ч|час|h|час\.|h\.)',   # HH час
    r'(\d{1,2})',                           # просто число (час)
    r'(\d{3,4})',                           # HHMM или HMM без разделителя
]
```

## 4. Примеры всех поддерживаемых форматов

### 4.1 Полные даты и время

```python
EXAMPLES_FULL = [
    # Стандартные форматы
    "10.10.2024 15:00",
    "10/10/2024 15:30", 
    "10-10-2024 16:45",
    
    # С текстовыми месяцами
    "10 октября 2024 15:00",
    "10 oct 2024 3:30 PM",
    "10окт2024 1500",
    
    # Сокращенные
    "10.10 15:00",
    "10/10 1530",
    "10окт 15"
]
```

### 4.2 Дни недели с временем

```python
EXAMPLES_WEEKDAYS = [
    # Полные названия
    "понедельник 15:00",
    "вторник в 16:30", 
    "среду 17:45",
    
    # Сокращения
    "пн 15", "вт 1630",
    "ср в 17:00", "чт 16",
    
    # Английские
    "monday 15:00",
    "tue 4 PM",
    "wed 16:30",
    
    # С ошибками раскладки  
    "GY 15", "ds 1630", "ch 17",
    
    # Опечатки
    "пенедельник 15:00",
    "втоник 16:30"
]
```

### 4.3 Относительные даты

```python
EXAMPLES_RELATIVE = [
    # Завтра/послезавтра
    "завтра 15:00",
    "завтро в 16:30",
    "послезавтра 17:45",
    
    # С ошибками раскладки
    "pfdnhf 15:00",  # завтра
    "ctuljyz 16:30", # сегодня
    
    # Через время
    "через день в 15:00",
    "через неделю 16:30",
    "на следующей неделе в пн 15:00"
]
```

### 4.4 Только даты (без времени)

```python
EXAMPLES_DATES_ONLY = [
    # Числовые форматы
    "10.10", "10/10", "10-10",
    "1010", "10102024",
    
    # С месяцами
    "10 окт", "10окт", "10 октября",
    "10 oct", "10oct", "10 october",
    
    # Дни недели
    "пн", "понедельник", "monday",
    "GY",  # ПН с неправильной раскладкой
    
    # Относительные
    "завтра", "pfdnhf", "послезавтра",
    "через день", "на след неделе"
]
```

### 4.5 Только время

```python
EXAMPLES_TIME_ONLY = [
    # Стандартные форматы
    "15:00", "15.30", "15-45",
    "15", "1530", "3:30 PM",
    
    # С текстом
    "в 15:00", "к 16:30", 
    "после 17:00", "до 18:00",
    "около 15", "примерно 16:30"
]
```

## 5. Логика поиска свободного слота

### 5.1 Алгоритм поиска

```python
def find_available_slot(day_of_week, time, existing_bookings):
    """
    Поиск ближайшего доступного слота
    
    Логика:
    1. Если указанный слот свободен - используем его
    2. Если занят - ищем следующий доступный слот в этот день недели
    3. Исключаем прошедшие даты и текущий день
    """
    
    # Пример: ПН 15:00
    target_weekday = 0  # понедельник  
    target_time = "15:00"
    
    # Находим ближайший понедельник
    next_monday = get_next_weekday(target_weekday)
    
    # Проверяем доступность
    if is_slot_available(next_monday, target_time):
        return next_monday + " " + target_time
    else:
        # Ищем следующий понедельник
        following_monday = next_monday + timedelta(weeks=1)
        return following_monday + " " + target_time
```

### 5.2 Примеры поиска слотов

```python
SLOT_SEARCH_EXAMPLES = {
    # Входной запрос: результат поиска
    "ПН 15": "2024-10-14 15:00",  # ближайший понедельник 15:00
    "вт 16:30": "2024-10-15 16:30",  # ближайший вторник 16:30
    "завтра 15": "2024-10-09 15:00", # завтра если свободно
    
    # Если слот занят
    "ПН 15 (занят)": "2024-10-21 15:00",  # следующий понедельник
    "среда 16 (занят)": "2024-10-23 16:00", # следующая среда
    
    # Округление до ближайшего допустимого слота
    "ПН 15:12": "2024-10-14 15:15",  # округление до 15 минут
    "вт 16:07": "2024-10-15 16:00",  # округление до 00 минут
    "ср 14:38": "2024-10-16 14:45"   # округление до 45 минут
}
```

## 6. Правила валидации и коррекции

### 6.1 Временные ограничения

```python
VALIDATION_RULES = {
    'business_hours': (11, 18),  # рабочие часы 11-18
    'valid_minutes': [0, 15, 30, 45],  # разрешенные минуты
    'min_lead_time': 1,  # минимум 1 час до встречи
    'max_advance': 90,   # максимум 90 дней вперед
    'exclude_weekends': False,  # включить выходные
    'exclude_holidays': True    # исключить праздники
}
```

### 6.2 Автокоррекция

```python
AUTOCORRECTION = {
    # Округление времени
    'round_minutes_to_slot': True,  # 15:12 → 15:15
    'round_hours_to_business': True,  # 10:00 → 11:00
    
    # Коррекция дат
    'skip_past_dates': True,      # пропустить прошедшие даты
    'skip_current_day': True,     # пропустить сегодняшний день
    'prefer_business_days': True, # предпочитать рабочие дни
    
    # Поиск альтернатив
    'suggest_alternatives': True,  # предложить альтернативы
    'alternative_count': 3,       # количество альтернатив
    'alternative_range': 7        # диапазон поиска (дни)
}
```

## 7. Формат ответа analyze_time_with_parser

```python
RESPONSE_FORMAT = {
    "parsed_datetime": "DD.MM.YYYY HH:MM",
    "confidence": 0.95,
    "original_text": "пн 15",
    "normalized_text": "понедельник 15:00",
    
    "alternatives": [
        {
            "datetime": "DD.MM.YYYY HH:MM",
            "confidence": 0.90,
            "reason": "следующий доступный слот"
        }
    ],
    
    "corrections": [
        {
            "type": "keyboard_layout",
            "original": "GY",
            "corrected": "ПН"
        },
        {
            "type": "time_rounding", 
            "original": "15:12",
            "corrected": "15:15"
        }
    ],
    
    "validation": {
        "is_valid": True,
        "business_hours": True,
        "valid_slot": True,
        "future_date": True,
        "warnings": []
    },
    
    "metadata": {
        "detected_language": "ru",
        "keyboard_layout": "mixed",
        "has_typos": True,
        "parsing_method": "regex+nlp"
    }
}
```

Эта библиотека обеспечивает полное покрытие всех возможных форматов ввода даты и времени для метода `analyze_time_with_parser`.