# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç –ù–ë–†–ë

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç –ù–ë–†–ë (USD –∏ PLN) –≤ –±—É–¥–Ω–∏–µ –¥–Ω–∏ –≤ 11:00 –∏ 16:00 —á–µ—Ä–µ–∑ Celery Beat.

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. Django –∫–æ–º–∞–Ω–¥–∞
- **–§–∞–π–ª**: `apps/finance/management/commands/update_nbrb_rates.py`
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: `python manage.py update_nbrb_rates`
- **–§—É–Ω–∫—Ü–∏—è**: –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç

### 2. Celery –∑–∞–¥–∞—á–∞
- **–§–∞–π–ª**: `apps/finance/tasks.py` ‚Üí `update_currency_rates()`
- **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è**: `config.celery.py` ‚Üí `config.celery.update_currency_rates`
- **–§—É–Ω–∫—Ü–∏—è**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç

### 3. –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ Celery Beat
- **–£—Ç—Ä–µ–Ω–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 11:00 –ü–ù-–ü–¢
- **–í–µ—á–µ—Ä–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 16:00 –ü–ù-–ü–¢
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: `config/celery.py`

### 4. –¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞
- **–§–∞–π–ª**: `apps/finance/management/commands/test_currency_update.py`
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: `python manage.py test_currency_update`
- **–§—É–Ω–∫—Ü–∏—è**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Celery –∑–∞–¥–∞—á–∏

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
- **API**: –ù–ë–†–ë (api.nbrb.by)
- **–í–∞–ª—é—Ç—ã**: USD, PLN, EUR
- **–°–µ—Ä–≤–∏—Å**: `logic/base/currency_service.py`

### –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö
- **–¢–∞–±–ª–∏—Ü–∞**: `finance_currencyrate`
- **–ü–æ–ª—è**: `code`, `rate`, `scale`, `fetched_at`
- **–ú–æ–¥–µ–ª—å**: `apps/finance/models.py` ‚Üí `CurrencyRate`

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **Celery –ª–æ–≥–∏**: `logs/celery.log`
- **–§–æ—Ä–º–∞—Ç**: –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ —Å —ç–º–æ–¥–∑–∏ –∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏
- **–£—Ä–æ–≤–µ–Ω—å**: INFO –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π, ERROR –¥–ª—è –æ—à–∏–±–æ–∫

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã
python manage.py shell -c "
from apps.finance.models import CurrencyRate
for rate in CurrencyRate.objects.all():
    print(f'{rate.code}: {rate.rate} BYN ({rate.fetched_at})')
"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ Celery Beat
python manage.py shell -c "
from config.celery import app
for name, config in app.conf.beat_schedule.items():
    if 'currency' in name.lower():
        print(f'{name}: {config}')
"
```

### –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
```bash
# –û–±–Ω–æ–≤–∏—Ç—å –∫—É—Ä—Å—ã –≤—Ä—É—á–Ω—É—é
python manage.py update_nbrb_rates

# –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Celery –∑–∞–¥–∞—á—É
python manage.py test_currency_update
```

## –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ

| –í—Ä–µ–º—è | –î–Ω–∏ | –ó–∞–¥–∞—á–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|-----|--------|----------|
| 11:00 | –ü–ù-–ü–¢ | `update-currency-rates-morning` | –£—Ç—Ä–µ–Ω–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ |
| 16:00 | –ü–ù-–ü–¢ | `update-currency-rates-afternoon` | –í–µ—á–µ—Ä–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ |

## –õ–æ–≥–∏

### –£—Å–ø–µ—à–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
```
üîÑ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç –ù–ë–†–ë...
üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ù–ë–†–ë API...
‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ù–ë–†–ë API —É—Å–ø–µ—à–Ω–æ
üí± –û–±–Ω–æ–≤–ª—è–µ–º –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...
‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ 2 –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
  üí∞ USD: 3.039 BYN (–æ–±–Ω–æ–≤–ª–µ–Ω)
  üí∞ PLN: 8.3291 BYN (–æ–±–Ω–æ–≤–ª–µ–Ω)
```

### –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
```
‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ù–ë–†–ë API: Connection timeout
```

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- **Celery**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
- **Celery Beat**: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏
- **Redis**: –ë—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
- **Django**: ORM –∏ –∫–æ–º–∞–Ω–¥—ã
- **requests**: HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ –ù–ë–†–ë API

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ù–µ —Ç—Ä–µ–±—É—é—Ç—Å—è (–ù–ë–†–ë API –ø—É–±–ª–∏—á–Ω—ã–π)

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Celery
- **–§–∞–π–ª**: `config/celery.py`
- **–ê–≤—Ç–æ–¥–∏—Å–∫–∞–≤–µ—Ä–∏**: `apps.finance`
- **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è**: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –≤ `config.celery`

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ó–∞–¥–∞—á–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å Celery Worker: `./start_services.sh`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `tail -f logs/celery.log`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∑–∞–¥–∞—á–∏: `python manage.py shell -c "from config.celery import app; print(app.tasks.keys())"`

### –û—à–∏–±–∫–∏ API
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ù–ë–†–ë API: `curl https://api.nbrb.by/exrates/rates/USD?parammode=2`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ `logs/celery.log`

### –ü—Ä–æ–±–ª–µ–º—ã —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Beat: `python manage.py shell -c "from config.celery import app; print(app.conf.beat_schedule)"`
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã: `./stop_services.sh && ./start_services.sh`
