{% extends 'common/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Заголовок -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">{{ title }}</h1>
                <div>
                    <a href="{% url 'google_oauth:combined_workflow' %}" class="btn btn-outline-info me-2">
                        <i class="fas fa-magic me-2"></i>Combined Workflow
                    </a>
                    <a href="{% url 'google_oauth:dashboard' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Назад
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Чат -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-comments me-2"></i>HR-помощник
                        <span class="badge bg-secondary ms-2">#{{ chat_session.id }}</span>
                    </h6>
                </div>
                
                <div class="card-body p-0">
                    <!-- Сообщения чата -->
                    <div id="chat-messages" class="chat-messages" style="height: 500px; overflow-y: auto;">
                        {% for message in messages %}
                            <div class="message mb-3 {% if message.message_type == 'user' %}user-message{% elif message.message_type == 'hr_screening' %}system-message hr-screening-message{% elif message.message_type == 'invite' %}system-message invite-message{% else %}system-message{% endif %}">
                                <div class="d-flex {% if message.message_type == 'user' %}justify-content-end{% else %}justify-content-start{% endif %}">
                                    <div class="message-bubble {% if message.message_type == 'user' %}user-bubble{% else %}system-bubble{% endif %}">
                                        
                                        <!-- Пользовательское сообщение -->
                                        {% if message.message_type == 'user' %}
                                            <div class="message-header">
                                                <i class="fas fa-user me-1"></i>
                                                <strong>Вы</strong>
                                                <small class="text-muted ms-2">{{ message.created_at|date:"d.m.Y H:i" }}</small>
                                            </div>
                                            <div class="message-content user-content">{{ message.content|linebreaks }}</div>
                                        
                                        <!-- HR-скрининг -->
                                        {% elif message.message_type == 'hr_screening' %}
                                            <div class="message-header">
                                                <i class="fas fa-clipboard-list me-1"></i>
                                                <strong>HR-скрининг</strong>
                                                <small class="text-muted ms-2">{{ message.created_at|date:"d.m.Y H:i" }}</small>
                                            </div>
                                            <div class="message-content bot-content-fixed">
                                                <!-- Контейнер с информацией и кнопками -->
                                                <div class="message-body-with-buttons">
                                                    <div class="message-info">
                                                        <!-- Информация о кандидате -->
                                                        <div class="candidate-info-table">
                                                            {% if message.metadata.candidate_name %}
                                                                <div class="info-row-table">
                                                                    <span class="info-label-table">Кандидат:</span>
                                                                    <span class="info-value-table">{{ message.metadata.candidate_name }}</span>
                                                                </div>
                                                            {% endif %}
                                                            
                                                            {% if message.metadata.vacancy_name %}
                                                                <div class="info-row-table">
                                                                    <span class="info-label-table">Вакансия:</span>
                                                                    <span class="info-value-table">{{ message.metadata.vacancy_name }}</span>
                                                                </div>
                                                            {% endif %}
                                                            
                                                            {% if message.metadata.determined_grade %}
                                                                <div class="info-row-table">
                                                                    <span class="info-label-table">Уровень:</span>
                                                                    <span class="grade-badge-inline">{{ message.metadata.determined_grade }}</span>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                        
                                                        <div class="status-message-compact">
                                                            <i class="fas fa-check-circle me-1"></i>
                                                            Данные сохранены и переданы в Huntflow
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Кнопки действий справа -->
                                                    {% if message.metadata %}
                                                        <div class="action-buttons-right">
                                                            {% if message.metadata.candidate_url %}
                                                                <a href="{{ message.metadata.candidate_url }}" target="_blank" class="btn btn-sm btn-outline-primary" title="Открыть в Huntflow">
                                                                    <i class="fas fa-external-link-alt"></i>
                                                                </a>
                                                            {% endif %}
                                                            {% if message.hr_screening %}
                                                                <a href="{% url 'google_oauth:hr_screening_detail' message.hr_screening.id %}" class="btn btn-sm btn-outline-success" title="Подробности">
                                                                    <i class="fas fa-eye"></i>
                                                                </a>
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        
                                        <!-- Инвайт -->
                                        {% elif message.message_type == 'invite' %}
                                            <div class="message-header">
                                                <i class="fas fa-calendar-plus me-1"></i>
                                                <strong>Инвайт</strong>
                                                <small class="text-muted ms-2">{{ message.created_at|date:"d.m.Y H:i" }}</small>
                                            </div>
                                            <div class="message-content bot-content-fixed">
                                                <!-- Контейнер с информацией и кнопками -->
                                                <div class="message-body-with-buttons">
                                                    <div class="message-info">
                                                        <!-- Информация об инвайте -->
                                                        <div class="candidate-info-table">
                                                            {% if message.metadata.candidate_name %}
                                                                <div class="info-row-table">
                                                                    <span class="info-label-table">Кандидат:</span>
                                                                    <span class="info-value-table">{{ message.metadata.candidate_name }}</span>
                                                                </div>
                                                            {% endif %}
                                                            
                                                            {% if message.metadata.vacancy_name %}
                                                                <div class="info-row-table">
                                                                    <span class="info-label-table">Вакансия:</span>
                                                                    <span class="info-value-table">{{ message.metadata.vacancy_name }}</span>
                                                                </div>
                                                            {% endif %}
                                                            
                                                            {% if message.metadata.determined_grade %}
                                                                <div class="info-row-table">
                                                                    <span class="info-label-table">Уровень:</span>
                                                                    <span class="grade-badge-inline">{{ message.metadata.determined_grade }}</span>
                                                                </div>
                                                            {% endif %}
                                                            
                                                            {% if message.invite.google_drive_file_url %}
                                                                <div class="info-row-table">
                                                                    <span class="info-label-table">Scorecard:</span>
                                                                    <a href="{{ message.invite.google_drive_file_url }}" target="_blank" class="info-link-compact">
                                                                        Открыть <i class="fas fa-external-link-alt ms-1"></i>
                                                                    </a>
                                                                </div>
                                                            {% endif %}
                                                            
                                                            {% if message.invite.google_meet_url %}
                                                                <div class="info-row-table">
                                                                    <span class="info-label-table">Google Meet:</span>
                                                                    <a href="{{ message.invite.google_meet_url }}" target="_blank" class="info-link-compact">
                                                                        Присоединиться <i class="fas fa-external-link-alt ms-1"></i>
                                                                    </a>
                                                                </div>
                                                            {% endif %}
                                                            
                                                            {% if message.invite.interview_datetime %}
                                                                <div class="info-row-table">
                                                                    <span class="info-label-table">Дата интервью:</span>
                                                                    <span class="info-value-table">{{ message.invite.interview_datetime|date:"Y-m-d H:i" }}</span>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                        
                                                        <div class="status-message-compact">
                                                            <i class="fas fa-check-circle me-1"></i>
                                                            Инвайт отправлен и добавлен в календарь
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Кнопки действий справа -->
                                                    {% if message.metadata %}
                                                        <div class="action-buttons-right">
                                                            {% if message.metadata.candidate_url %}
                                                                <a href="{{ message.metadata.candidate_url }}" target="_blank" class="btn btn-sm btn-outline-primary" title="Открыть в Huntflow">
                                                                    <i class="fas fa-external-link-alt"></i>
                                                                </a>
                                                            {% endif %}
                                                            {% if message.invite %}
                                                                <a href="{% url 'google_oauth:invite_detail' message.invite.id %}" class="btn btn-sm btn-outline-success" title="Подробности">
                                                                    <i class="fas fa-eye"></i>
                                                                </a>
                                                                <button type="button" class="btn btn-sm btn-outline-warning copy-invitation-btn" data-invite-id="{{ message.invite.id }}" title="Копировать текст инвайта">
                                                                    <i class="fas fa-copy"></i>
                                                                </button>
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        
                                        <!-- Системное сообщение -->
                                        {% else %}
                                            <div class="message-header">
                                                <i class="fas fa-robot me-1"></i>
                                                <strong>Система</strong>
                                                <small class="text-muted ms-2">{{ message.created_at|date:"d.m.Y H:i" }}</small>
                                            </div>
                                            <div class="message-content">{{ message.content|linebreaks }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-comments fa-3x mb-3"></i>
                                <p>Начните диалог, отправив сообщение</p>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Форма ввода -->
                    <div class="card-footer">
                        <form method="post" id="chat-form">
                            {% csrf_token %}
                            <input type="hidden" name="session_id" value="{{ chat_session.id }}">
                            <div class="input-group">
                                {{ form.message }}
                                <button type="submit" class="btn btn-primary" id="send-btn">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            {% if form.message.errors %}
                                <div class="alert alert-danger small mt-2">
                                    {% for error in form.message.errors %}
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ error|striptags }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
         <!-- Боковая панель со списком сессий -->
         <div class="col-lg-4">
             <div class="card shadow">
                 <div class="card-header py-3">
                     <h6 class="m-0 font-weight-bold text-primary">
                         <i class="fas fa-comments me-2"></i>История чатов
                     </h6>
                 </div>
                 <div class="card-body p-0 pt-2">
                     <!-- Список сессий -->
                     <div class="sessions-list" style="max-height: 400px; overflow-y: auto;">
                         {% for session in all_sessions %}
                             <div class="session-item mx-2 {% if session.id == chat_session.id %}active{% endif %}">
                                 <a href="{% url 'google_oauth:chat_workflow_session' session.id %}" class="session-link">
                                     <div class="session-header">
                                         <div class="session-info">
                                             <span class="session-id">#{{ session.id }}</span>
                                             <span class="session-date">{{ session.updated_at|date:"d.m.Y H:i" }}</span>
                                         </div>
                                         <div class="session-status">
                                             {% if session.id == chat_session.id %}
                                                 <i class="fas fa-circle text-primary" style="font-size: 8px;"></i>
                                             {% endif %}
                                         </div>
                                     </div>
                                     <div class="session-preview">
                                         {% if session.messages.last %}
                                             <span class="session-last-message">
                                                 {% if session.messages.last.message_type == 'user' %}
                                                     <i class="fas fa-user me-1 text-muted"></i>
                                                 {% elif session.messages.last.message_type == 'hr_screening' %}
                                                     <i class="fas fa-clipboard-list me-1 text-success"></i>
                                                 {% elif session.messages.last.message_type == 'invite' %}
                                                     <i class="fas fa-calendar-plus me-1 text-warning"></i>
                                                 {% else %}
                                                     <i class="fas fa-robot me-1 text-muted"></i>
                                                 {% endif %}
                                                 {{ session.messages.last.content|truncatechars:50 }}
                                             </span>
                                         {% else %}
                                             <span class="session-empty text-muted">
                                                 <i class="fas fa-comment-slash me-1"></i>
                                                 Пустой чат
                                             </span>
                                         {% endif %}
                                     </div>
                                 </a>
                             </div>
                         {% empty %}
                             <div class="text-center text-muted py-4">
                                 <i class="fas fa-comments fa-2x mb-2"></i>
                                 <p class="mb-0">Нет чатов</p>
                             </div>
                         {% endfor %}
                     </div>
                 </div>
                 <div class="card-footer py-2">
                     <a href="{% url 'google_oauth:chat_workflow' %}" class="btn btn-sm btn-outline-primary w-100">
                         <i class="fas fa-plus me-1"></i>Новый чат
                     </a>
                 </div>
             </div>
         </div>
    </div>
</div>

<style>
/* === ЕДИНООБРАЗИЕ РАЗМЕРОВ ШРИФТОВ === */
.card .chat-messages {
    background-color: var(--hr-chat-messages-bg, #f8f9fa);
    padding: 12px !important;
}

.card .message {
    margin-bottom: 12px !important;
    width: 100%;
    display: block;
}

.card .message > .d-flex {
    width: 100%;
}

/* КЛЮЧЕВОЕ ИЗМЕНЕНИЕ: Единый размер шрифта для всех сообщений */
.card .message-bubble {
    padding: 8px 12px;
    border-radius: 12px;
    word-wrap: break-word;
    line-height: 1.3;
    font-size: 1.1rem !important; /* УВЕЛИЧИВАЕМ до размера пользовательских сообщений */
    display: inline-block;
    width: auto !important;
    min-width: fit-content !important;
    max-width: none !important;
}

/* Пользовательские сообщения - остаются с ограничением */
.card .user-message .message-bubble {
    max-width: 75%;
    min-width: 120px;
}

/* Системные сообщения - БЕЗ ОГРАНИЧЕНИЙ ШИРИНЫ */
.card .system-message .message-bubble {
    max-width: none !important;
    min-width: fit-content !important;
    width: auto !important;
}

.card .user-bubble {
    background: var(--hr-gradient, linear-gradient(135deg, #007bff 0%, #0056b3 100%));
    color: white;
    border: none;
}

.card .system-bubble {
    background-color: var(--hr-card-bg, #ffffff);
    border: 1px solid var(--hr-border, #dee2e6);
    color: var(--hr-text, #333);
}

/* Заголовки сообщений - ОСТАВЛЯЕМ меньшими для различия */
.card .message-header {
    font-size: 0.7rem;
    margin-bottom: 4px;
    opacity: 0.8;
    font-weight: 500;
    line-height: 1.2;
}

.card .message-header i {
    font-size: 0.65rem;
    margin-right: 3px;
}

.card .message-header strong {
    font-weight: 600;
}

.card .message-header small {
    font-size: 0.65rem;
    margin-left: 6px;
}

/* КЛЮЧЕВОЕ ИЗМЕНЕНИЕ: контент сообщений ОДИНАКОВОГО размера */
.card .message-content {
    line-height: 1.3;
    margin: 0;
    width: auto !important;
    max-width: none !important;
    min-width: fit-content !important;
    display: block !important;
    font-size: 1.1rem !important; /* ОДИНАКОВЫЙ с пользовательскими сообщениями */
}

/* Пользовательский контент - сохраняем многострочность */
.card .user-content {
    white-space: pre-wrap;
    word-break: break-word;
}

/* Контент бота БЕЗ ОГРАНИЧЕНИЙ */
.card .bot-content-fixed {
    display: block !important;
    width: auto !important;
    min-width: fit-content !important;
    max-width: none !important;
}

/* Контейнер с информацией и кнопками */
.card .message-body-with-buttons {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    width: auto;
    min-width: fit-content;
}

.card .message-info {
    flex: 1;
    min-width: fit-content;
}

/* Кнопки действий СПРАВА */
.card .action-buttons-right {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex-shrink: 0;
    align-self: flex-start;
    margin-top: 2px;
}

/* ТАБЛИЧНАЯ СТРУКТУРА для гарантии одной строки */
.card .candidate-info-table {
    display: table;
    width: auto;
    min-width: fit-content;
    border-spacing: 0;
    border-collapse: collapse;
    margin-bottom: 6px;
}

.card .info-row-table {
    display: table-row;
}

/* КЛЮЧЕВОЕ ИЗМЕНЕНИЕ: увеличиваем размер лейблов */
.card .info-label-table {
    display: table-cell;
    font-weight: 600;
    color: var(--hr-text, #333);
    padding-right: 8px;
    white-space: nowrap;
    vertical-align: top;
    line-height: 1.3;
    font-size: 1.1rem !important; /* УВЕЛИЧИВАЕМ до размера пользовательских сообщений */
    min-width: 65px;
}

/* КЛЮЧЕВОЕ ИЗМЕНЕНИЕ: увеличиваем размер значений */
.card .info-value-table {
    display: table-cell;
    white-space: nowrap;
    vertical-align: top;
    line-height: 1.3;
    font-size: 1.1rem !important; /* УВЕЛИЧИВАЕМ до размера пользовательских сообщений */
}

/* КЛЮЧЕВОЕ ИЗМЕНЕНИЕ: увеличиваем размер ссылок */
.card .info-link-compact {
    color: var(--color-primary, #007bff);
    text-decoration: none;
    font-size: 1.1rem !important; /* УВЕЛИЧИВАЕМ до размера пользовательских сообщений */
    white-space: nowrap;
}

.card .info-link-compact:hover {
    text-decoration: underline;
}

/* КЛЮЧЕВОЕ ИЗМЕНЕНИЕ: увеличиваем размер бейджа */
.card .grade-badge-inline {
    background: linear-gradient(135deg, var(--color-primary, #007bff) 0%, var(--color-primary-hover, #0056b3) 100%);
    color: white;
    padding: 2px 8px; /* Увеличиваем padding для большего текста */
    border-radius: 8px;
    font-size: 0.8rem !important; /* УВЕЛИЧИВАЕМ размер бейджа */
    font-weight: 500;
    white-space: nowrap;
}

/* КЛЮЧЕВОЕ ИЗМЕНЕНИЕ: увеличиваем размер статуса */
.card .status-message-compact {
    color: var(--color-success, #28a745);
    font-weight: 500;
    font-size: 1.1rem !important; /* УВЕЛИЧИВАЕМ до размера пользовательских сообщений */
    padding: 6px 10px; /* Увеличиваем padding для большего текста */
    background: rgba(40, 167, 69, 0.1);
    border-radius: 6px;
    border-left: 2px solid var(--color-success, #28a745);
    margin-top: 4px;
    white-space: nowrap;
    display: inline-block;
    width: auto;
}

/* Стили для кнопок справа - оставляем прежними */
.card .action-buttons-right .btn {
    padding: 3px 6px !important;
    font-size: 1.2rem !important;
    border-radius: 4px !important;
    border-width: 1px !important;
    min-height: 28px !important;
    min-width: 28px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

.card .action-buttons-right .btn i {
    font-size: 0.85rem !important;
    margin: 0 !important;
}

/* Выравнивание сообщений */
.card .user-message {
    display: flex;
    justify-content: flex-end;
    width: 100%;
}

.card .system-message {
    display: flex;
    justify-content: flex-start;
    width: 100%;
    max-width: none !important;
}

.card .user-message .message-bubble {
    border-bottom-right-radius: 3px;
}

.card .system-message .message-bubble {
    border-bottom-left-radius: 3px;
}

/* Специальные цвета для типов сообщений */
.card .hr-screening-message .system-bubble {
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.08) 0%, rgba(76, 175, 80, 0.03) 100%);
    border-color: rgba(76, 175, 80, 0.2);
}

.card .hr-screening-message .message-header {
    color: #2e7d32;
}

.card .invite-message .system-bubble {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.08) 0%, rgba(255, 193, 7, 0.03) 100%);
    border-color: rgba(255, 193, 7, 0.2);
}

.card .invite-message .message-header {
    color: #f57c00;
}

/* Футер карточки */
.card .card-footer {
    padding: 12px !important;
    background-color: var(--hr-card-bg, #ffffff);
    border-top: 1px solid var(--hr-border, #dee2e6);
}

.card #id_message {
    border-radius: 18px 0 0 18px;
    border-right: none;
    padding: 8px 12px;
    font-size: 1.1rem; /* ТАКОЙ ЖЕ размер как и в сообщениях */
    min-height: 36px;
    resize: vertical;
    max-height: 100px;
}

.card #send-btn {
    border-radius: 0 18px 18px 0;
    padding: 8px 12px;
    min-height: 36px;
}

/* Заголовок карточки */
.card .card-header {
    padding: 12px 16px !important;
    background: var(--hr-gradient, linear-gradient(135deg, #007bff 0%, #0056b3 100%));
    border-bottom: 1px solid var(--hr-border, #dee2e6);
}

.card .card-header h6 {
    margin: 0 !important;
    font-size: 1.1rem !important;
    color: white !important;
}

.card .card-header .badge {
    font-size: 0.65rem !important;
    padding: 2px 6px !important;
    margin-left: 6px !important;
}

/* Адаптивность для мобильных - сохраняем пропорциональность */
@media (max-width: 768px) {
    .card .message-bubble {
        max-width: 95%;
        padding: 6px 10px;
        font-size: 0.85rem !important; /* На мобильных чуть меньше, но одинаково */
    }
    
    .card .system-message .message-bubble {
        min-width: 200px;
        max-width: 95%;
    }
    
    .card .message-content {
        font-size: 0.85rem !important; /* На мобильных чуть меньше, но одинаково */
    }
    
    .card .message-body-with-buttons {
        flex-direction: column;
        gap: 6px;
    }
    
    .card .action-buttons-right {
        flex-direction: row;
        align-self: stretch;
        justify-content: flex-end;
    }
    
    .card .info-label-table {
        min-width: 55px;
        font-size: 0.85rem !important; /* На мобильных чуть меньше, но одинаково */
    }
    
    .card .info-value-table {
        font-size: 0.85rem !important; /* На мобильных чуть меньше, но одинаково */
    }
    
    .card .info-link-compact {
        font-size: 0.85rem !important; /* На мобильных чуть меньше, но одинаково */
    }
    
    .card .status-message-compact {
        font-size: 0.85rem !important; /* На мобильных чуть меньше, но одинаково */
        padding: 4px 8px;
    }
    
    .card .grade-badge-inline {
        font-size: 0.75rem !important;
        padding: 1px 6px;
    }
    
    .card .action-buttons-right .btn {
        padding: 2px 5px !important;
        font-size: 0.65rem !important;
        min-width: 24px !important;
    }
    
    .card #id_message {
        font-size: 0.85rem; /* На мобильных тоже меньше, но одинаково */
    }
}

/* Анимации */
.card .message {
    animation: messageSlideIn 0.2s ease-out;
}

@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(8px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Скроллбар */
.card .chat-messages::-webkit-scrollbar {
    width: 4px;
}

.card .chat-messages::-webkit-scrollbar-track {
    background: var(--hr-border, #dee2e6);
    border-radius: 2px;
}

.card .chat-messages::-webkit-scrollbar-thumb {
    background: var(--hr-primary, #007bff);
    border-radius: 2px;
}

.card .chat-messages::-webkit-scrollbar-thumb:hover {
    background: var(--hr-primary-hover, #0056b3);
}

/* Темная тема */
[data-theme="dark"] .card .hr-screening-message .system-bubble {
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.12) 0%, rgba(76, 175, 80, 0.06) 100%);
    border-color: rgba(76, 175, 80, 0.3);
}

[data-theme="dark"] .card .hr-screening-message .message-header {
    color: #81c784;
}

[data-theme="dark"] .card .invite-message .system-bubble {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.12) 0%, rgba(255, 193, 7, 0.06) 100%);
    border-color: rgba(255, 193, 7, 0.3);
}

 [data-theme="dark"] .card .invite-message .message-header {
     color: #ffb300;
 }

 /* === СТИЛИ ДЛЯ СПИСКА СЕССИЙ === */
 .card .sessions-list {
     background-color: var(--hr-card-bg, #ffffff);
 }

 .card .session-item {
     border-bottom: 1px solid var(--hr-border, #dee2e6);
     transition: background-color 0.2s ease;
 }

 .card .session-item:last-child {
     border-bottom: none;
 }

 .card .session-item:hover {
     background-color: var(--hr-hover-bg, #f8f9fa);
 }

 .card .session-item.active {
     background-color: var(--hr-primary-light, rgba(0, 123, 255, 0.1));
     border-left: 3px solid var(--hr-primary, #007bff);
 }

 .card .session-link {
     display: block;
     padding: 12px 16px;
     text-decoration: none;
     color: inherit;
 }

 .card .session-link:hover {
     text-decoration: none;
     color: inherit;
 }

 .card .session-header {
     display: flex;
     justify-content: space-between;
     align-items: center;
     margin-bottom: 6px;
 }

 .card .session-info {
     display: flex;
     align-items: center;
     gap: 8px;
 }

 .card .session-id {
     font-weight: 600;
     font-size: 0.9rem;
     color: var(--hr-primary, #007bff);
 }

 .card .session-date {
     font-size: 0.75rem;
     color: var(--hr-text-muted, #6c757d);
 }

 .card .session-status {
     display: flex;
     align-items: center;
 }

 .card .session-preview {
     font-size: 0.8rem;
     line-height: 1.3;
 }

 .card .session-last-message {
     color: var(--hr-text, #333);
     display: block;
     overflow: hidden;
     text-overflow: ellipsis;
     white-space: nowrap;
 }

 .card .session-empty {
     font-size: 0.8rem;
     font-style: italic;
 }

 /* Темная тема для списка сессий */
 [data-theme="dark"] .card .session-item:hover {
     background-color: var(--color-surface-hover, #2d3748);
 }

 [data-theme="dark"] .card .session-item.active {
     background-color: rgba(0, 123, 255, 0.15);
 }

 [data-theme="dark"] .card .session-last-message {
     color: var(--color-text, #e2e8f0);
 }

 [data-theme="dark"] .card .session-empty {
     color: var(--color-text-muted, #a0aec0);
 }

 /* Скроллбар для списка сессий */
 .card .sessions-list::-webkit-scrollbar {
     width: 4px;
 }

 .card .sessions-list::-webkit-scrollbar-track {
     background: var(--hr-border, #dee2e6);
     border-radius: 2px;
 }

 .card .sessions-list::-webkit-scrollbar-thumb {
     background: var(--hr-primary, #007bff);
     border-radius: 2px;
 }

 .card .sessions-list::-webkit-scrollbar-thumb:hover {
     background: var(--hr-primary-hover, #0056b3);
 }
 </style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('id_message');
    const sendBtn = document.getElementById('send-btn');

    // Прокрутка вниз
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    scrollToBottom();

    // Отправка формы
    chatForm.addEventListener('submit', function(e) {
        if (!messageInput.value.trim()) {
            e.preventDefault();
            return;
        }
        
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        sendBtn.disabled = true;
        messageInput.disabled = true;
    });

    // Автоматическое изменение размера textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });

    // Отправка по Enter (без Shift)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.submit();
        }
    });

    // Фокус на поле ввода
    messageInput.focus();

    // Копирование текста инвайта
    document.addEventListener('click', function(e) {
        if (e.target.closest('.copy-invitation-btn')) {
            e.preventDefault();
            const btn = e.target.closest('.copy-invitation-btn');
            const inviteId = btn.getAttribute('data-invite-id');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;
            
            fetch(`/google-oauth/invites/${inviteId}/invitation-text/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.invitation_text) {
                    navigator.clipboard.writeText(data.invitation_text).then(() => {
                        btn.innerHTML = '<i class="fas fa-check"></i>';
                        btn.classList.remove('btn-outline-warning');
                        btn.classList.add('btn-success');
                        
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.classList.remove('btn-success');
                            btn.classList.add('btn-outline-warning');
                            btn.disabled = false;
                        }, 1500);
                    }).catch(err => {
                        console.error('Clipboard error:', err);
                        alert('Ошибка копирования в буфер обмена');
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    });
                } else {
                    alert('Ошибка получения текста инвайта');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('Ошибка сети');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
    });
});
</script>
{% endblock %}