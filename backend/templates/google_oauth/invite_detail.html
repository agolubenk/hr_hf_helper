{% extends 'common/base.html' %}
{% load static %}

{% block title %}–ò–Ω–≤–∞–π—Ç: {{ invite.candidate_name }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">–ò–Ω–≤–∞–π—Ç: {{ invite.candidate_name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</h1>
                <div>
                    <a href="{% url 'google_oauth:invite_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
                    </a>
                    <a href="{% url 'google_oauth:invite_create' %}" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π
                    </a>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>–ö–∞–Ω–¥–∏–¥–∞—Ç:</h6>
                                    <p class="text-muted">{{ invite.candidate_name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</p>
                                    {% if invite.candidate_name and "–ö–∞–Ω–¥–∏–¥–∞—Ç" in invite.candidate_name and invite.candidate_id %}
                                        <div class="alert alert-warning small">
                                            <i class="fas fa-exclamation-triangle"></i> 
                                            <strong>–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ –∑–∞–≥–ª—É—à–∫–∏</strong><br>
                                            <small>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ URL —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º ID –∞–∫–∫–∞—É–Ω—Ç–∞ (org694) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</small>
                                        </div>
                                    {% endif %}
                                    
                                    <h6>ID –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:</h6>
                                    <p class="text-muted">{{ invite.candidate_id|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</p>
                                    
                                    <h6>–£—Ä–æ–≤–µ–Ω—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:</h6>
                                    <p class="text-muted">{{ invite.candidate_grade|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</p>
                                    {% if invite.candidate_grade == "–ù–µ —É–∫–∞–∑–∞–Ω" %}
                                        <small class="text-info">
                                            <i class="fas fa-info-circle"></i> 
                                            –£—Ä–æ–≤–µ–Ω—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–∞–Ω–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
                                        </small>
                                    {% endif %}
                                    
                                    <h6>–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:</h6>
                                    <a href="{{ invite.candidate_url }}" target="_blank" class="btn btn-primary btn-sm">
                                        <i class="fas fa-external-link-alt me-2"></i>–û—Ç–∫—Ä—ã—Ç—å –≤ Huntflow
                                    </a>
                                </div>
                                <div class="col-md-6">
                                    <h6>–í–∞–∫–∞–Ω—Å–∏—è:</h6>
                                    <p class="text-muted">{{ invite.vacancy_title|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</p>
                                    {% if invite.vacancy_title and "–í–∞–∫–∞–Ω—Å–∏—è" in invite.vacancy_title and invite.vacancy_id %}
                                        <div class="alert alert-warning small">
                                            <i class="fas fa-exclamation-triangle"></i> 
                                            <strong>–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ –∑–∞–≥–ª—É—à–∫–∏</strong><br>
                                            <small>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ URL —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º ID –∞–∫–∫–∞—É–Ω—Ç–∞ (org694) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</small>
                                        </div>
                                    {% endif %}
                                    
                                    <h6>ID –≤–∞–∫–∞–Ω—Å–∏–∏:</h6>
                                    <p class="text-muted">{{ invite.vacancy_id|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</p>
                                    
                                    <h6>–®–∞–±–ª–æ–Ω scorecard:</h6>
                                    {% if invite.scorecard_template_url %}
                                        <p class="text-muted">
                                            <a href="{{ invite.scorecard_template_url }}" target="_blank" class="text-decoration-none">
                                                <i class="fas fa-external-link-alt me-1"></i>
                                                –û—Ç–∫—Ä—ã—Ç—å —à–∞–±–ª–æ–Ω
                                            </a>
                                        </p>
                                    {% else %}
                                        <p class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω</p>
                                    {% endif %}
                                    
                                    <h6>–°—Ç–∞—Ç—É—Å:</h6>
                                    <span class="badge badge-{% if invite.status == 'pending' %}warning{% elif invite.status == 'sent' %}info{% elif invite.status == 'completed' %}success{% else %}secondary{% endif %}">
                                        {{ invite.get_status_display }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Google —Å–µ—Ä–≤–∏—Å—ã –≤ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <!-- Google Drive –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                            <div class="card shadow h-100">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Google Drive</h6>
                                </div>
                                <div class="card-body">
                                    {% if invite.google_drive_file_url %}
                                        <h6>Scorecard:</h6>
                                        <a href="{{ invite.google_drive_file_url }}" target="_blank" class="btn btn-success btn-block mb-3">
                                            <i class="fas fa-file-excel me-2"></i>–û—Ç–∫—Ä—ã—Ç—å Scorecard
                                        </a>
                                        
                                        <h6>–ü–∞–ø–∫–∞:</h6>
                                        {% if invite.get_google_drive_folder_url %}
                                            <a href="{{ invite.get_google_drive_folder_url }}" target="_blank" class="btn btn-outline-primary btn-sm btn-block mb-3">
                                                <i class="fas fa-folder me-2"></i>–û—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É
                                            </a>
                                        {% else %}
                                            <p class="text-muted small">–ù–µ —É–∫–∞–∑–∞–Ω–∞</p>
                                        {% endif %}
                                        
                                        <h6>–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É:</h6>
                                        <p class="text-muted small">{{ invite.get_google_drive_file_path|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</p>
                                    {% elif invite.google_drive_file_id %}
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>Scorecard –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω, –Ω–æ –Ω–µ —Å–æ–∑–¥–∞–Ω</strong>
                                        </div>
                                        <p class="text-muted small">
                                            –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ scorecard —Ñ–∞–π–ª–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Google OAuth –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é.
                                        </p>
                                        
                                        <h6>–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</h6>
                                        {% if invite.get_google_drive_folder_url %}
                                            <a href="{{ invite.get_google_drive_folder_url }}" target="_blank" class="btn btn-outline-primary btn-sm btn-block mb-2">
                                                <i class="fas fa-folder me-2"></i>–û—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É
                                            </a>
                                        {% endif %}
                                        <p class="text-muted small">
                                            <strong>–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É:</strong> {{ invite.get_google_drive_file_path|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}
                                        </p>
                                    {% else %}
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>Scorecard –Ω–µ —Å–æ–∑–¥–∞–Ω</strong>
                                        </div>
                                        <p class="text-muted small">
                                            Scorecard –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Google OAuth –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <!-- Google Calendar –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                            <div class="card shadow h-100">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Google Calendar</h6>
                                </div>
                                <div class="card-body">
                                    {% if invite.calendar_event_url %}
                                        <h6>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –∏–Ω—Ç–µ—Ä–≤—å—é:</h6>
                                        <p class="text-primary font-weight-bold">{{ invite.get_formatted_interview_datetime }}</p>
                                        
                                        <h6>–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ:</h6>
                                        <a href="{{ invite.calendar_event_url }}" target="_blank" class="btn btn-info btn-block mb-3">
                                            <i class="fas fa-calendar-alt me-2"></i>–û—Ç–∫—Ä—ã—Ç—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
                                        </a>
                                        
                                        {% if invite.google_meet_url %}
                                            <h6>Google Meet:</h6>
                                            <a href="{{ invite.google_meet_url }}" target="_blank" class="btn btn-success btn-block mb-3">
                                                <i class="fas fa-video me-2"></i>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –≤—Å—Ç—Ä–µ—á–µ
                                            </a>
                                        {% endif %}
                                        
                                        <h6>ID —Å–æ–±—ã—Ç–∏—è:</h6>
                                        <p class="text-muted small">{{ invite.calendar_event_id }}</p>
                                        
                                        <div class="alert alert-success small">
                                            <i class="fas fa-check-circle me-2"></i>
                                            <strong>–°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ</strong><br>
                                            <small>–ò–Ω—Ç–µ—Ä–≤—å—é –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ 45 –º–∏–Ω—É—Ç</small>
                                        </div>
                                    {% else %}
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–æ</strong>
                                        </div>
                                        <p class="text-muted small">
                                            –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Google OAuth –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é.
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">–î–µ–π—Å—Ç–≤–∏—è</h6>
                        </div>
                        <div class="card-body">
                            <button type="button" class="btn btn-primary w-100 mb-2" onclick="copyInvitation({{ invite.pk }})">
                                <i class="fas fa-copy me-2"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
                            </button>
                            
                            <a href="{% url 'google_oauth:invite_update' invite.pk %}" class="btn btn-warning w-100 mb-2">
                                <i class="fas fa-edit me-2"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </a>
                            
                            {% if invite.google_drive_file_url %}
                                <button type="button" class="btn btn-info w-100 mb-2" onclick="regenerateScorecard({{ invite.pk }})">
                                    <i class="fas fa-sync me-2"></i>–ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å Scorecard
                                </button>
                            {% endif %}
                            
                            <a href="{% url 'google_oauth:invite_delete' invite.pk %}" class="btn btn-danger w-100">
                                <i class="fas fa-trash me-2"></i>–£–¥–∞–ª–∏—Ç—å –∏–Ω–≤–∞–π—Ç
                            </a>
                        </div>
                    </div>

                    <!-- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ -->
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ</h6>
                        </div>
                        <div class="card-body">
                            <h6>–°–æ–∑–¥–∞–Ω:</h6>
                            <p class="text-muted small">{{ invite.created_at|date:"d.m.Y H:i" }}</p>
                            
                            <h6>–û–±–Ω–æ–≤–ª–µ–Ω:</h6>
                            <p class="text-muted small">{{ invite.updated_at|date:"d.m.Y H:i" }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copyInvitation(inviteId) {
    console.log('üîç –ù–∞—á–∏–Ω–∞–µ–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥–ª—è –∏–Ω–≤–∞–π—Ç–∞:', inviteId);
    
    // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('‚ùå CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
        showNotification('–û—à–∏–±–∫–∞: CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
        return;
    }
    
    console.log('üîç CSRF —Ç–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω:', csrfToken.value.substring(0, 10) + '...');
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞
    fetch(`/google-oauth/invites/${inviteId}/invitation-text/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken.value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        console.log('üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–ª—É—á–µ–Ω:', response.status, response.statusText);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('üîç –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', data);
        if (data.success) {
            console.log('üîç –¢–µ–∫—Å—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è:', data.invitation_text);
            // –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(data.invitation_text).then(function() {
                    console.log('‚úÖ –¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
                    showNotification('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
                }).catch(function(err) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ Clipboard API:', err);
                    // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                    fallbackCopyTextToClipboard(data.invitation_text);
                });
            } else {
                console.log('üîç Clipboard API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback');
                fallbackCopyTextToClipboard(data.invitation_text);
            }
        } else {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data.message);
            showNotification('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: ' + error.message, 'error');
    });
}

function fallbackCopyTextToClipboard(text) {
    console.log('üîç –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback –º–µ—Ç–æ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
    
    const textArea = document.createElement("textarea");
    textArea.value = text;
    
    // –ò–∑–±–µ–≥–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∫ —ç–ª–µ–º–µ–Ω—Ç—É
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";
    textArea.style.opacity = "0";
    textArea.style.pointerEvents = "none";
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        console.log('üîç Fallback –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ:', successful ? '—É—Å–ø–µ—à–Ω–æ' : '–Ω–µ—É–¥–∞—á–Ω–æ');
        if (successful) {
            showNotification('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
        } else {
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ', 'error');
        }
    } catch (err) {
        console.error('‚ùå Fallback: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', err);
        showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ', 'error');
    }
    
    document.body.removeChild(textArea);
}

function showNotification(message, type) {
    // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

function regenerateScorecard(inviteId) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å scorecard? –≠—Ç–æ —É–¥–∞–ª–∏—Ç —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª –∏ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–π.')) {
        console.log('üîç –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ scorecard –¥–ª—è –∏–Ω–≤–∞–π—Ç–∞:', inviteId);
        
        // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            console.error('‚ùå CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
            showNotification('–û—à–∏–±–∫–∞: CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            return;
        }
        
        fetch(`/google-oauth/invites/${inviteId}/regenerate-scorecard/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken.value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            console.log('üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–ª—É—á–µ–Ω:', response.status, response.statusText);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üîç –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', data);
            if (data.success) {
                showNotification('Scorecard —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω!', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
            showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
        });
    }
}
</script>
{% endblock %}
