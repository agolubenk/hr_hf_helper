{% extends 'common/base.html' %}
{% load static %}

{% block title %}G-–¥–∞–Ω–Ω—ã–µ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è{% endblock %}

{% block extra_css %}
<link href="{% static 'css/google-oauth.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-robot text-primary me-2"></i>
                G-–¥–∞–Ω–Ω—ã–µ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
            </h1>
            <p class="text-muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Google-—Å–µ—Ä–≤–∏—Å–∞–º–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è HR-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤</p>
        </div>
    </div>

    <!-- –°–µ–ª–µ–∫—Ç–æ—Ä –≤–∞–∫–∞–Ω—Å–∏–∏ -->
    <div class="vacancy-selector">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h3 class="mb-0">
                    <i class="fas fa-briefcase me-2"></i>
                    –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–∫–∞–Ω—Å–∏—é –¥–ª—è —Ä–∞–±–æ—Ç—ã
                </h3>
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏ -->
    {% if selected_vacancy %}
    <div class="automation-card">
        <div class="row align-items-center">
            <div class="col-12">
                <!-- –ö–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ —Å–ª–æ—Ç–æ–≤ -->
                <div class="copy-buttons">
                    <div class="d-flex gap-2 flex-wrap">
                        <!-- –ö–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –ë–µ–ª–∞—Ä—É—Å–∏ -->
                        <button class="btn-copy btn-copy-vacancy-link-belarus position-relative" 
                                onclick="window.copyVacancyLink('belarus')"
                                {% if not selected_vacancy.vacancy_link_belarus %}disabled{% endif %}
                                title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é (–ë–µ–ª–∞—Ä—É—Å—å)">
                            <i class="fas fa-link"></i>
                            <div class="position-absolute top-0 start-100 translate-middle">
                                <span class="flag-emoji">üáßüáæ</span>
                            </div>
                            <div class="copy-tooltip">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é (–ë–µ–ª–∞—Ä—É—Å—å)</div>
                        </button>
                        
                        <button class="btn-copy btn-copy-belarus position-relative" 
                                onclick="copyQuestions('belarus')"
                                {% if not selected_vacancy.questions_belarus %}disabled{% endif %}
                                title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ë–µ–ª–∞—Ä—É—Å–∏">
                            <i class="fas fa-question"></i>
                            <div class="position-absolute top-0 start-100 translate-middle">
                                <span class="flag-emoji">üáßüáæ</span>
                            </div>
                            <div class="copy-tooltip">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ë–µ–ª–∞—Ä—É—Å–∏</div>
                        </button>
                        
                        <!-- –ö–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –ü–æ–ª—å—à–∏ -->
                        <button class="btn-copy btn-copy-vacancy-link-poland position-relative" 
                                onclick="window.copyVacancyLink('poland')"
                                {% if not selected_vacancy.vacancy_link_poland %}disabled{% endif %}
                                title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é (–ü–æ–ª—å—à–∞)">
                            <i class="fas fa-link"></i>
                            <div class="position-absolute top-0 start-100 translate-middle">
                                <span class="flag-emoji">üáµüá±</span>
                            </div>
                            <div class="copy-tooltip">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é (–ü–æ–ª—å—à–∞)</div>
                        </button>
                        
                        <button class="btn-copy btn-copy-poland position-relative" 
                                onclick="copyQuestions('poland')"
                                {% if not selected_vacancy.questions_poland %}disabled{% endif %}
                                title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ü–æ–ª—å—à–∏">
                            <i class="fas fa-question"></i>
                            <div class="position-absolute top-0 start-100 translate-middle">
                                <span class="flag-emoji">üáµüá±</span>
                            </div>
                            <div class="copy-tooltip">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ü–æ–ª—å—à–∏</div>
                        </button>
                        
                        <!-- –ö–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª–æ—Ç–æ–≤ -->
                        <button class="btn-copy btn-copy-current-week" 
                                onclick="window.copyWeekSlots('current')"
                                title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç—ã —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏">
                            <i class="fas fa-calendar-week"></i>
                            <div class="copy-tooltip">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç—ã —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏</div>
                        </button>
                        
                        <button class="btn-copy btn-copy-next-week" 
                                onclick="window.copyWeekSlots('next')"
                                title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç—ã —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏">
                            <i class="fas fa-calendar-plus"></i>
                            <div class="copy-tooltip">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç—ã —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏</div>
                        </button>
                        
                        <button class="btn-copy btn-copy-all-slots" 
                                onclick="window.copyAllSlots()"
                                title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å–ª–æ—Ç—ã">
                            <i class="fas fa-copy"></i>
                            <div class="copy-tooltip">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å–ª–æ—Ç—ã</div>
                        </button>
                        
                        <button class="btn-copy btn-refresh-slots" 
                                onclick="window.refreshSlots()"
                                title="–û–±–Ω–æ–≤–∏—Ç—å —Å–ª–æ—Ç—ã">
                            <i class="fas fa-sync-alt"></i>
                            <div class="copy-tooltip">–û–±–Ω–æ–≤–∏—Ç—å —Å–ª–æ—Ç—ã</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
            </div>
            <div class="col-md-4">
                <form method="GET" id="vacancyForm">
                    <select name="vacancy_id" style="margin-top: 40px!important;" class="form-select" onchange="this.form.submit()">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–∫–∞–Ω—Å–∏—é --</option>
                        {% for vacancy in active_vacancies %}
                            <option value="{{ vacancy.id }}" 
                                    {% if selected_vacancy and vacancy.id == selected_vacancy.id %}selected{% endif %}>
                                {{ vacancy.name }}
                            </option>
                        {% endfor %}
                    </select>
                </form>
                {% if selected_vacancy %}
                <div class="mt-2 text-end">
                    <span class="badge bg-success fs-6">
                        <i class="fas fa-check-circle me-1"></i>
                        –ê–∫—Ç–∏–≤–Ω–∞
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>



    <!-- –°–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã -->
    {% if selected_vacancy %}
    <div class="row">
        <div class="col-12">
            <div class="general-card">

                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-clock text-success me-2"></i>
                        –°–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã
                        <button class="btn btn-sm btn-outline-secondary ms-2 btn-collapse" type="button" data-bs-toggle="collapse" data-bs-target="#slotsCardBody" aria-expanded="false" aria-controls="slotsCardBody">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </h5>
                    <small class="text-muted" id="last-update-time">
                        –û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="update-timestamp">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
                    </small>
                </div>
                <small class="text-muted d-block">–ö–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –≤—ã—à–µ</small>
            </div>
        </div>
                
                <div class="collapse" id="slotsCardBody">
                    <!-- –¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è -->
                    <div class="week-section current-week mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-calendar-week me-2"></i>
                            –¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è
                            <button class="btn btn-sm btn-outline-primary float-end btn-collapse" type="button" data-bs-toggle="collapse" data-bs-target="#currentWeekSlots" aria-expanded="true" aria-controls="currentWeekSlots">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                        </h6>
                        <div class="collapse show" id="currentWeekSlots">
                            <div class="row">
                                <!-- –°–ª–æ—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- –°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è -->
                    <div class="week-section next-week">
                        <h6 class="text-info mb-3">
                            <i class="fas fa-calendar-plus me-2"></i>
                            –°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è
                            <button class="btn btn-sm btn-outline-info float-end btn-collapse" type="button" data-bs-toggle="collapse" data-bs-target="#nextWeekSlots" aria-expanded="true" aria-controls="nextWeekSlots">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                        </h6>
                        <div class="collapse show" id="nextWeekSlots">
                            <div class="row">
                                <!-- –°–ª–æ—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>
    {% endif %}

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ -->
    <div class="row">
        <div class="col-12">
            <div class="general-card">
                <div class="row">
                    <!-- Google Calendar -->
                    <div class="col-lg-6 col-xl-3">
                        <div class="feature-icon icon-calendar">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <h5>Google Calendar</h5>
                        <p class="text-muted mb-3">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è–º–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å—Ç—Ä–µ—á</p>
                        <div class="d-grid gap-2">
                            <a href="{% url 'google_oauth:calendar_events' %}" class="btn btn-primary btn-automation">
                                <i class="fas fa-calendar me-1"></i>
                                –û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                            </a>
                            <a href="{% url 'google_oauth:sync_calendar' %}" class="btn btn-outline-primary btn-automation">
                                <i class="fas fa-sync me-1"></i>
                                –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                            </a>
                        </div>
                    </div>

                    <!-- Google Drive -->
                    <div class="col-lg-6 col-xl-3">
                        <div class="feature-icon icon-drive">
                            <i class="fas fa-cloud"></i>
                        </div>
                        <h5>Google Drive</h5>
                        <p class="text-muted mb-3">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞–º–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –≤ –æ–±–ª–∞—á–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</p>
                        <div class="d-grid gap-2">
                            <a href="{% url 'google_oauth:sync_drive' %}" class="btn btn-outline-primary btn-automation">
                                <i class="fas fa-sync me-1"></i>
                                –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                            </a>
                        </div>
                    </div>

                    <!-- Google Sheets -->
                    <div class="col-lg-6 col-xl-3">
                        <div class="feature-icon icon-sheets">
                            <i class="fas fa-table"></i>
                        </div>
                        <h5>Google Sheets</h5>
                        <p class="text-muted mb-3">–†–∞–±–æ—Ç–∞ —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏</p>
                        <div class="d-grid gap-2">
                            <a href="{% url 'google_oauth:sheets' %}" class="btn btn-primary btn-automation">
                                <i class="fas fa-table me-1"></i>
                                –û—Ç–∫—Ä—ã—Ç—å Sheets
                            </a>
                            <a href="{% url 'google_oauth:sync_sheets' %}" class="btn btn-outline-primary btn-automation">
                                <i class="fas fa-sync me-1"></i>
                                –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                            </a>
                        </div>
                    </div>

                    <!-- AI –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è -->
                    <div class="col-lg-6 col-xl-3">
                        <div class="feature-icon icon-ai">
                            <i class="fas fa-brain"></i>
                        </div>
                        <h5>AI –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è</h5>
                        <p class="text-muted mb-3">–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
                        <div class="d-grid gap-2">
                            <a href="{% url 'google_oauth:invite_dashboard' %}" class="btn btn-outline-primary btn-automation">
                                <i class="fas fa-envelope me-1"></i>
                                –ò–Ω–≤–∞–π—Ç—ã
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã -->
    <div class="row">
        <div class="col-12">
            <div class="general-card">
                <div class="row">
                    <div class="col-md-4">
                        <div class="d-grid">
                            <a href="{% url 'google_oauth:scorecard_path_settings' %}" class="btn btn-outline-secondary btn-automation">
                                <i class="fas fa-cog me-1"></i>
                                –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–ø–æ–∫
                            </a>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid">
                            <a href="{% url 'google_oauth:check_integration' %}" class="btn btn-outline-info btn-automation">
                                <i class="fas fa-check-circle me-1"></i>
                                –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
                            </a>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid">
                            <a href="{% url 'google_oauth:debug_cache' %}" class="btn btn-outline-warning btn-automation">
                                <i class="fas fa-bug me-1"></i>
                                –û—Ç–ª–∞–¥–∫–∞ –∫—ç—à–∞
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—è) -->
    {% if selected_vacancy %}
    <div class="row">
        <div class="col-12">
            <div class="general-card">
                <h5 class="mb-4">
                    <i class="fas fa-chart-bar text-primary me-2"></i>
                    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤–∞–∫–∞–Ω—Å–∏–∏ "{{ selected_vacancy.name }}"
                </h5>
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-primary mb-1">0</h4>
                            <small class="text-muted">–°–æ–±—ã—Ç–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-success mb-1">0</h4>
                            <small class="text-muted">–§–∞–π–ª—ã –≤ Drive</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-info mb-1">0</h4>
                            <small class="text-muted">HR-—Å–∫—Ä–∏–Ω–∏–Ω–≥–∏</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-warning mb-1">0</h4>
                            <small class="text-muted">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∏–Ω–≤–∞–π—Ç—ã</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>

{{ calendar_events_data|json_script:"calendar-events" }}

<script>
// –î–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏–π –∏–∑ Django –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–∫–∞–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è)
console.log('üîç DEBUG: –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å–æ–±—ã—Ç–∏–π...');
console.log('üîç DEBUG: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ:', {{ calendar_events_data|length|default:"0" }});

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏–π
const calendarEvents = JSON.parse(document.getElementById('calendar-events').textContent);
console.log('üîç DEBUG: –ó–∞–≥—Ä—É–∂–µ–Ω—ã —Ä–µ–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:', calendarEvents.length);

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª–æ—Ç–æ–≤ –∏–∑ Django –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
let slotsSettings = {{ slots_settings.to_dict|default:"{}"|safe }};
console.log('üîç DEBUG: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª–æ—Ç–æ–≤:', slotsSettings);

console.log('üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–æ–±—ã—Ç–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', calendarEvents.length);
console.log('üîç DEBUG: –ü–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ:', calendarEvents[0]);
console.log('üîç DEBUG: –í—Å–µ —Å–æ–±—ã—Ç–∏—è:', calendarEvents);

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('vacancyForm');
    const select = form.querySelector('select[name="vacancy_id"]');
    
    select.addEventListener('change', function() {
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const submitBtn = document.createElement('button');
        submitBtn.type = 'submit';
        submitBtn.style.display = 'none';
        form.appendChild(submitBtn);
        submitBtn.click();
    });
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
    setupCollapseButtons();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–æ—Ç—ã
    initializeSlots();
});

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
function setupCollapseButtons() {
    console.log('üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è...');
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
    const collapseButtons = document.querySelectorAll('.btn-collapse');
    collapseButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-bs-target');
            const targetElement = document.querySelector(targetId);
            
            if (targetElement) {
                // –û–±–Ω–æ–≤–ª—è–µ–º aria-expanded –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                const isExpanded = targetElement.classList.contains('show');
                this.setAttribute('aria-expanded', !isExpanded);
                
                console.log(`üîÑ ${targetId} ${isExpanded ? '—Å–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è' : '—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è'}`);
            }
        });
    });
    
    console.log('‚úÖ –ö–Ω–æ–ø–∫–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
}

// –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–æ–∫ –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏–∏ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
window.copyVacancyLink = function(country) {
    {% if selected_vacancy %}
    let vacancyLink = '';
    let buttonClass = '';
    let countryName = '';
    
    if (country === 'belarus') {
        vacancyLink = `{{ selected_vacancy.vacancy_link_belarus|escapejs }}`;
        buttonClass = 'btn-copy-vacancy-link-belarus';
        countryName = '–ë–µ–ª–∞—Ä—É—Å–∏';
    } else if (country === 'poland') {
        vacancyLink = `{{ selected_vacancy.vacancy_link_poland|escapejs }}`;
        buttonClass = 'btn-copy-vacancy-link-poland';
        countryName = '–ü–æ–ª—å—à–∏';
    }
    
    if (!vacancyLink || vacancyLink.trim() === '') {
        showNotification('–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é –¥–ª—è ' + countryName + ' –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞', 'warning');
        return;
    }
    
    // –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
    navigator.clipboard.writeText(vacancyLink).then(function() {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        showNotification('–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é –¥–ª—è ' + countryName + ' —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
        
        // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
        const button = document.querySelector('.' + buttonClass);
        const originalClass = button.className;
        button.className = originalClass + ' copy-success';
        
        setTimeout(function() {
            button.className = originalClass;
        }, 2000);
        
    }).catch(function(err) {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
        showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'error');
    });
    {% else %}
    showNotification('–í–∞–∫–∞–Ω—Å–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞', 'warning');
    {% endif %}
};

// –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
function copyQuestions(country) {
    {% if selected_vacancy %}
    let questions = '';
    let buttonClass = '';
    let countryName = '';
    
    if (country === 'belarus') {
        questions = `{{ selected_vacancy.questions_belarus|escapejs }}`;
        buttonClass = 'btn-copy-belarus';
        countryName = '–ë–µ–ª–∞—Ä—É—Å–∏';
    } else if (country === 'poland') {
        questions = `{{ selected_vacancy.questions_poland|escapejs }}`;
        buttonClass = 'btn-copy-poland';
        countryName = '–ü–æ–ª—å—à–∏';
    }
    
    if (!questions || questions.trim() === '') {
        showNotification('–í–æ–ø—Ä–æ—Å—ã –¥–ª—è ' + countryName + ' –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã', 'warning');
        return;
    }
    
    // –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
    navigator.clipboard.writeText(questions).then(function() {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        showNotification('–í–æ–ø—Ä–æ—Å—ã –¥–ª—è ' + countryName + ' —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
        
        // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
        const button = document.querySelector('.' + buttonClass);
        const originalClass = button.className;
        button.className = originalClass + ' copy-success';
        
        setTimeout(function() {
            button.className = originalClass;
        }, 2000);
        
    }).catch(function(err) {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
        showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'error');
    });
    {% else %}
    showNotification('–í–∞–∫–∞–Ω—Å–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞', 'warning');
    {% endif %}
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info') {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'error' ? 'times-circle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    document.body.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(function() {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª–æ—Ç–æ–≤ (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ calendar_events.html)
function calculateAvailableSlots(dayEvents, date) {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã: 11:00-18:00 (7 —á–∞—Å–æ–≤)
    const workStartHour = 11;
    const workEndHour = 18;
    
    // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ —Å–ª–æ—Ç–æ–≤ –ø–æ —á–∞—Å–∞–º
    const slots = [];
    for (let hour = workStartHour; hour < workEndHour; hour++) {
        slots.push({
            hour: hour,
            start: new Date(date.getFullYear(), date.getMonth(), date.getDate(), hour, 0, 0),
            end: new Date(date.getFullYear(), date.getMonth(), date.getDate(), hour + 1, 0, 0),
            isOccupied: false
        });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–Ω—è –∏ –æ—Ç–º–µ—á–∞–µ–º –∑–∞–Ω—è—Ç—ã–µ —Å–ª–æ—Ç—ã
    dayEvents.forEach(event => {
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–±—ã—Ç–∏—è –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å
        if (event.is_all_day) {
            return;
        }
        
        const eventStart = new Date(event.start);
        const eventEnd = new Date(event.end);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è –ª–∏ —Å–æ–±—ã—Ç–∏–µ —Å —Ä–∞–±–æ—á–∏–º–∏ —á–∞—Å–∞–º–∏
        if (eventStart.getHours() < workEndHour && eventEnd.getHours() >= workStartHour) {
            // –û—Ç–º–µ—á–∞–µ–º –∑–∞–Ω—è—Ç—ã–µ —Å–ª–æ—Ç—ã
            slots.forEach(slot => {
                // –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –∑–∞–Ω–∏–º–∞–µ—Ç —Ö–æ—Ç—è –±—ã –ø–æ–ª—á–∞—Å–∞ –≤ —Å–ª–æ—Ç–µ, —Å—á–∏—Ç–∞–µ–º —Å–ª–æ—Ç –∑–∞–Ω—è—Ç—ã–º
                const slotStart = slot.start.getTime();
                const slotEnd = slot.end.getTime();
                const eventStartTime = eventStart.getTime();
                const eventEndTime = eventEnd.getTime();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ (—Å–æ–±—ã—Ç–∏–µ –∑–∞–Ω–∏–º–∞–µ—Ç –º–∏–Ω–∏–º—É–º 30 –º–∏–Ω—É—Ç –≤ —Å–ª–æ—Ç–µ)
                const overlapStart = Math.max(slotStart, eventStartTime);
                const overlapEnd = Math.min(slotEnd, eventEndTime);
                const overlapDuration = overlapEnd - overlapStart;
                
                if (overlapDuration >= 30 * 60 * 1000) { // 30 –º–∏–Ω—É—Ç –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
                    slot.isOccupied = true;
                }
            });
        }
    });
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
    const availableRanges = [];
    let currentRangeStart = null;
    
    slots.forEach((slot, index) => {
        if (!slot.isOccupied) {
            if (currentRangeStart === null) {
                currentRangeStart = slot.hour;
            }
        } else {
            if (currentRangeStart !== null) {
                // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç–µ–∫—É—â–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω
                if (currentRangeStart === slot.hour - 1) {
                    availableRanges.push(currentRangeStart.toString());
                } else {
                    // –î–æ–±–∞–≤–ª—è–µ–º +1 –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —á–∞—Å—É –¥–∏–∞–ø–∞–∑–æ–Ω–∞, —Ç–∞–∫ –∫–∞–∫ —Å–ª–æ—Ç –æ–∑–Ω–∞—á–∞–µ—Ç –≤—Ä–µ–º—è –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —á–∞—Å–∞
                    availableRanges.push(`${currentRangeStart}-${slot.hour}`);
                }
                currentRangeStart = null;
            }
        }
    });
    
    // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    if (currentRangeStart !== null) {
        const lastSlot = slots[slots.length - 1];
        if (currentRangeStart === lastSlot.hour) {
            availableRanges.push(currentRangeStart.toString());
        } else {
            // –î–æ–±–∞–≤–ª—è–µ–º +1 –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —á–∞—Å—É, —Ç–∞–∫ –∫–∞–∫ —Å–ª–æ—Ç 17 –æ–∑–Ω–∞—á–∞–µ—Ç –≤—Ä–µ–º—è 17:00-18:00
            availableRanges.push(`${currentRangeStart}-${lastSlot.hour + 1}`);
        }
    }
    
    return availableRanges.length > 0 ? availableRanges.join(', ') : '–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤';
}

function generateWeekSlots(weekOffset) {
    const today = new Date();
    const startOfWeek = new Date(today);
    
    // –ù–∞—Ö–æ–¥–∏–º –Ω–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
    const dayOfWeek = today.getDay();
    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    startOfWeek.setDate(today.getDate() + daysToMonday + (weekOffset * 7));
    
    console.log(`üìÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª–æ—Ç–æ–≤ –¥–ª—è –Ω–µ–¥–µ–ª–∏ ${weekOffset}, –Ω–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏:`, startOfWeek.toDateString());
    
    const slots = [];
    const weekdays = ['–ü–ù', '–í–¢', '–°–†', '–ß–¢', '–ü–¢', '–°–ë', '–í–°'];
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª–æ—Ç—ã –¥–ª—è —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫-–ø—è—Ç–Ω–∏—Ü–∞)
    for (let i = 0; i < 5; i++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + i);
        
        const dateStr = date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
        
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—à–µ–¥—à–∏–µ –¥–Ω–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏ (–≤–∫–ª—é—á–∞—è —Å–µ–≥–æ–¥–Ω—è)
        if (weekOffset === 0) {
            const now = new Date();
            const dateStart = new Date(date);
            dateStart.setHours(0, 0, 0, 0);
            const nowStart = new Date(now);
            nowStart.setHours(0, 0, 0, 0);
            
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å –∏ –≤—Å–µ –ø—Ä–æ—à–µ–¥—à–∏–µ –¥–Ω–∏
            if (dateStart <= nowStart) {
                console.log(`üö´ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–µ–Ω—å ${dateStr} (—Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ –ø—Ä–æ—à–µ–¥—à–∏–π)`);
                continue;
            }
        }
        let meetingsCount = 0;
        let availableSlots = '';
        
        if (typeof calendarEvents !== 'undefined' && Array.isArray(calendarEvents)) {
            console.log(`üîç –ü–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –¥–∞—Ç—ã ${dateStr} (${date.toDateString()})`);
            
            const dayEvents = calendarEvents.filter(event => {
                const eventDate = new Date(event.start);
                const isMatch = eventDate.toDateString() === date.toDateString();
                if (isMatch) {
                    console.log(`  ‚úÖ –ù–∞–π–¥–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ: "${event.title}" –Ω–∞ ${eventDate.toDateString()}`);
                }
                return isMatch;
            });
            
            // –ò—Å–∫–ª—é—á–∞–µ–º –≤—Å—Ç—Ä–µ—á–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º "–û–±–µ–¥" –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –≤—Å—Ç—Ä–µ—á
            const meetingsWithoutLunch = dayEvents.filter(event => {
                const title = event.title.toLowerCase();
                const isLunch = title.includes('–æ–±–µ–¥') || title.includes('lunch');
                if (isLunch) {
                    console.log(`  üçΩÔ∏è –ò—Å–∫–ª—é—á–∞–µ–º –æ–±–µ–¥: "${event.title}"`);
                }
                return !isLunch;
            });
            
            meetingsCount = meetingsWithoutLunch.length;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ (11-18, –∏—Å–∫–ª—é—á–∞—è –æ–±–µ–¥)
            availableSlots = calculateAvailableSlots(dayEvents, date);
            
            console.log(`üìÖ –î–∞—Ç–∞ ${dateStr}: ${meetingsWithoutLunch.length} –≤—Å—Ç—Ä–µ—á (–∏—Å–∫–ª—é—á–∞—è –æ–±–µ–¥ –∏–∑ ${dayEvents.length} –æ–±—â–∏—Ö), —Å–ª–æ—Ç—ã: ${availableSlots}`);
        } else {
            console.log(`‚ö†Ô∏è calendarEvents –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –¥–∞—Ç—ã ${dateStr}`);
            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ–±—ã—Ç–∏—è—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å–ª–æ—Ç—ã –∫–∞–∫ –¥–æ—Å—Ç—É–ø–Ω—ã–µ
            availableSlots = '11-18';
        }
        
        slots.push({
            date: date,
            dateStr: dateStr,
            weekday: weekdays[i],
            meetingsCount: meetingsCount,
            availableSlots: availableSlots
        });
    }
    
    console.log(`üìÖ –ò—Ç–æ–≥–æ —Å–ª–æ—Ç–æ–≤ –¥–ª—è –Ω–µ–¥–µ–ª–∏ ${weekOffset}: ${slots.length}`);
    return slots;
}

function initializeSlots() {
    console.log('üéØ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–æ—Ç–æ–≤...');
    console.log('üìä –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', typeof calendarEvents, calendarEvents ? calendarEvents.length : '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    const currentWeekSection = document.querySelector('.week-section.current-week');
    const nextWeekSection = document.querySelector('.week-section.next-week');
    console.log('üìÖ –°–µ–∫—Ü–∏—è —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏:', currentWeekSection);
    console.log('üìÖ –°–µ–∫—Ü–∏—è —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏:', nextWeekSection);
    
    if (!currentWeekSection || !nextWeekSection) {
        console.error('‚ùå –°–µ–∫—Ü–∏–∏ –Ω–µ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ calendarEvents
    if (!calendarEvents || !Array.isArray(calendarEvents)) {
        console.error('‚ùå calendarEvents –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∏–ª–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º!');
        return;
    }
    
    console.log('üìä calendarEvents —Å–æ–¥–µ—Ä–∂–∏—Ç', calendarEvents.length, '—Å–æ–±—ã—Ç–∏–π');
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª–æ—Ç—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π –∏ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏
    console.log('üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª–æ—Ç—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏...');
    const currentWeekSlots = generateWeekSlots(0);
    console.log('üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª–æ—Ç—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏...');
    const nextWeekSlots = generateWeekSlots(1);
    
    console.log('üìÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏:', currentWeekSlots);
    console.log('üìÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏:', nextWeekSlots);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º DOM —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–ª–æ—Ç–æ–≤
    console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–æ—Ç–æ–≤...');
    updateSlotsDisplay(currentWeekSlots, nextWeekSlots);
    
    console.log('‚úÖ –°–ª–æ—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    updateLastUpdateTime();
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
function updateLastUpdateTime() {
    const timestampElement = document.getElementById('update-timestamp');
    if (timestampElement) {
        const now = new Date();
        const timeString = now.toLocaleTimeString('ru-RU', { 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit'
        });
        timestampElement.textContent = timeString;
        console.log(`üïê –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${timeString}`);
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ª–æ—Ç–æ–≤
window.refreshSlots = function() {
    console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ª–æ—Ç–æ–≤...');
    
    const refreshBtn = document.querySelector('.btn-refresh-slots');
    if (refreshBtn) {
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        refreshBtn.classList.add('refreshing');
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i><div class="copy-tooltip">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</div>';
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showNotification('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ª–æ—Ç–æ–≤...', 'info');
    
    // –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
    fetch('/google-oauth/api/calendar-events/', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${data.count} —Å–æ–±—ã—Ç–∏–π —Å —Å–µ—Ä–≤–µ—Ä–∞`);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é calendarEvents
            window.calendarEvents = data.events;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–æ—Ç—ã —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            initializeSlots();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            updateLastUpdateTime();
            
            showNotification(`–°–ª–æ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã! –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.count} —Å–æ–±—ã—Ç–∏–π`, 'success');
            console.log('‚úÖ –°–ª–æ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ');
        } else {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞:', data.message);
            showNotification(`–û—à–∏–±–∫–∞: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ —Å–µ—Ä–≤–µ—Ä—É:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–ª–æ—Ç–æ–≤', 'error');
    })
    .finally(() => {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        if (refreshBtn) {
            // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            refreshBtn.classList.remove('refreshing');
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i><div class="copy-tooltip">–û–±–Ω–æ–≤–∏—Ç—å —Å–ª–æ—Ç—ã</div>';
        }
    });
};

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ª–æ—Ç–æ–≤
function setupAutoRefresh() {
    console.log('üîÑ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ª–æ—Ç–æ–≤...');
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
    setInterval(function() {
        console.log('‚è∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ª–æ—Ç–æ–≤ (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)');
        refreshSlots();
    }, 5 * 60 * 1000); // 5 –º–∏–Ω—É—Ç
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            console.log('üëÅÔ∏è –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞–ª–∞ –≤–∏–¥–∏–º–æ–π, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ª–æ—Ç—ã');
            refreshSlots();
        }
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –æ–∫–Ω–µ
    window.addEventListener('focus', function() {
        console.log('üéØ –û–∫–Ω–æ –ø–æ–ª—É—á–∏–ª–æ —Ñ–æ–∫—É—Å, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ª–æ—Ç—ã');
        refreshSlots();
    });
    
    console.log('‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ');
}

function updateSlotsDisplay(currentWeekSlots, nextWeekSlots) {
    console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ª–æ—Ç–æ–≤...');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é
    const currentWeekSection = document.querySelector('.week-section.current-week');
    if (currentWeekSection && currentWeekSlots.length > 0) {
        const slotsRow = currentWeekSection.querySelector('.row');
        if (slotsRow) {
            slotsRow.innerHTML = '';
            currentWeekSlots.forEach(slot => {
                const slotHtml = createSlotCard(slot);
                slotsRow.insertAdjacentHTML('beforeend', slotHtml);
            });
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é
    const nextWeekSection = document.querySelector('.week-section.next-week');
    if (nextWeekSection && nextWeekSlots.length > 0) {
        const slotsRow = nextWeekSection.querySelector('.row');
        if (slotsRow) {
            slotsRow.innerHTML = '';
            nextWeekSlots.forEach(slot => {
                const slotHtml = createSlotCard(slot);
                slotsRow.insertAdjacentHTML('beforeend', slotHtml);
            });
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–ª–æ—Ç–æ–≤ –∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    updateSlotButtons(currentWeekSlots, nextWeekSlots);
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫ —Å–ª–æ—Ç–æ–≤
function updateSlotButtons(currentWeekSlots, nextWeekSlots) {
    console.log('üîò –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫ —Å–ª–æ—Ç–æ–≤...');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã –≤ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–µ
    const currentWeekHasSlots = currentWeekSlots && currentWeekSlots.length > 0 && 
        currentWeekSlots.some(slot => slot.availableSlots !== '–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã –≤ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–µ
    const nextWeekHasSlots = nextWeekSlots && nextWeekSlots.length > 0 && 
        nextWeekSlots.some(slot => slot.availableSlots !== '–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤');
    
    console.log(`üìÖ –¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è –∏–º–µ–µ—Ç —Å–ª–æ—Ç—ã: ${currentWeekHasSlots}`);
    console.log(`üìÖ –°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è –∏–º–µ–µ—Ç —Å–ª–æ—Ç—ã: ${nextWeekHasSlots}`);
    
    // –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª–æ—Ç–æ–≤ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
    const currentWeekBtn = document.querySelector('.btn-copy-current-week');
    if (currentWeekBtn) {
        if (currentWeekHasSlots) {
            currentWeekBtn.disabled = false;
            currentWeekBtn.classList.remove('disabled');
            currentWeekBtn.title = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç—ã —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏';
        } else {
            currentWeekBtn.disabled = true;
            currentWeekBtn.classList.add('disabled');
            currentWeekBtn.title = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –Ω–∞ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–µ';
        }
    }
    
    // –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª–æ—Ç–æ–≤ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏
    const nextWeekBtn = document.querySelector('.btn-copy-next-week');
    if (nextWeekBtn) {
        if (nextWeekHasSlots) {
            nextWeekBtn.disabled = false;
            nextWeekBtn.classList.remove('disabled');
            nextWeekBtn.title = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç—ã —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏';
        } else {
            nextWeekBtn.disabled = true;
            nextWeekBtn.classList.add('disabled');
            nextWeekBtn.title = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–µ';
        }
    }
    
    // –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Å–ª–æ—Ç–æ–≤ (–¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è, –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –Ω–µ–¥–µ–ª—è –Ω–µ –∏–º–µ–µ—Ç —Å–ª–æ—Ç–æ–≤)
    const allSlotsBtn = document.querySelector('.btn-copy-all-slots');
    if (allSlotsBtn) {
        if (currentWeekHasSlots && nextWeekHasSlots) {
            allSlotsBtn.disabled = false;
            allSlotsBtn.classList.remove('disabled');
            allSlotsBtn.title = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å–ª–æ—Ç—ã';
        } else {
            allSlotsBtn.disabled = true;
            allSlotsBtn.classList.add('disabled');
            allSlotsBtn.title = '–ù–µ –≤—Å–µ –Ω–µ–¥–µ–ª–∏ –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã';
        }
    }
    
    console.log('‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —Å–ª–æ—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
}

function createSlotCard(slot) {
    const slotsCount = slot.availableSlots === '–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤' ? 0 : slot.availableSlots.split(',').length;
    const badgeClass = slotsCount > 0 ? 'bg-primary' : 'bg-secondary';
    
    return `
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="slot-card card h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="fw-bold">${slot.dateStr}</span>
                        <span class="badge ${badgeClass} rounded-pill">${slotsCount}</span>
                    </div>
                    <div class="text-muted small mb-2">${slot.weekday}</div>
                    <div class="text-primary small">${slot.availableSlots}</div>
                </div>
            </div>
        </div>
    `;
}

// –§—É–Ω–∫—Ü–∏–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª–æ—Ç–æ–≤ (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ calendar_events.html)
window.copyAllSlots = function() {
    console.log('üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–ª–æ—Ç–æ–≤...');
    
    const currentWeekSlots = [];
    const nextWeekSlots = [];
    
    // –ö–æ–ø–∏—Ä—É–µ–º —Å–ª–æ—Ç—ã –∏–∑ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
    const currentWeekSection = document.querySelector('.week-section.current-week');
    if (currentWeekSection) {
        currentWeekSection.querySelectorAll('.slot-card').forEach(card => {
            const slotData = extractSlotData(card);
            if (slotData) {
                currentWeekSlots.push(slotData);
            }
        });
    }
    
    // –ö–æ–ø–∏—Ä—É–µ–º —Å–ª–æ—Ç—ã –∏–∑ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏
    const nextWeekSection = document.querySelector('.week-section.next-week');
    if (nextWeekSection) {
        nextWeekSection.querySelectorAll('.slot-card').forEach(card => {
            const slotData = extractSlotData(card);
            if (slotData) {
                nextWeekSlots.push(slotData);
            }
        });
    }
    
    if (currentWeekSlots.length === 0 && nextWeekSlots.length === 0) {
        showNotification('–ù–µ—Ç —Å–ª–æ—Ç–æ–≤ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'warning');
        return;
    }
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫
    let text = '';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—â–∏–π –ø—Ä–µ—Ñ–∏–∫—Å, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
    if (slotsSettings.allSlotsPrefix) {
        text += `${slotsSettings.allSlotsPrefix}\n`;
    }
    
    if (currentWeekSlots.length > 0) {
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–ª–æ—Ç—ã —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏ —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≤—Ä–µ–º–µ–Ω–∞–º–∏
        currentWeekSlots.forEach(slot => {
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–Ω–∏ –±–µ–∑ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
            if (slot.slots && slot.slots !== '–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤') {
                text += `${slot.weekday} ${slot.slots}\n`;
            }
        });
    }
    
    if (nextWeekSlots.length > 0) {
        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª—è—é—â–∏–π —Ç–µ–∫—Å—Ç –º–µ–∂–¥—É –Ω–µ–¥–µ–ª—è–º–∏, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
        if (slotsSettings.separatorText) {
            text += `\n${slotsSettings.separatorText}\n`;
        } else {
            text += '\n';
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–ª–æ—Ç—ã —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏ —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≤—Ä–µ–º–µ–Ω–∞–º–∏
        nextWeekSlots.forEach(slot => {
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–Ω–∏ –±–µ–∑ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
            if (slot.slots && slot.slots !== '–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤') {
                text += `${slot.weekday} (${slot.date}) ${slot.slots}\n`;
            }
        });
    }
    
    copySlotsToClipboard(text.trim());
}

window.copyWeekSlots = function(weekType) {
    console.log(`üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ—Ç–æ–≤ ${weekType} –Ω–µ–¥–µ–ª–∏...`);
    
    // –ù–∞—Ö–æ–¥–∏–º —Å–µ–∫—Ü–∏—é –Ω–µ–¥–µ–ª–∏ –ø–æ —Ç–∏–ø—É
    let weekSection;
    if (weekType === 'current') {
        weekSection = document.querySelector('.week-section.current-week');
    } else if (weekType === 'next') {
        weekSection = document.querySelector('.week-section.next-week');
    }
    
    if (!weekSection) {
        showNotification('–°–µ–∫—Ü–∏—è –Ω–µ–¥–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
        return;
    }
    
    const slots = [];
    weekSection.querySelectorAll('.slot-card').forEach(card => {
        const slotData = extractSlotData(card);
        if (slotData) {
            slots.push(slotData);
        }
    });
    
    if (slots.length === 0) {
        showNotification('–ù–µ—Ç —Å–ª–æ—Ç–æ–≤ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ', 'warning');
        return;
    }
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫
    let text = '';
    if (weekType === 'current') {
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
        if (slotsSettings.currentWeekPrefix) {
            text += `${slotsSettings.currentWeekPrefix}\n`;
        }
        // –§–æ—Ä–º–∞—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏: –ü–ù 12-15, 17
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–Ω–∏ –±–µ–∑ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
        slots.forEach(slot => {
            if (slot.slots && slot.slots !== '–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤') {
                text += `${slot.weekday} ${slot.slots}\n`;
            }
        });
    } else if (weekType === 'next') {
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
        if (slotsSettings.nextWeekPrefix) {
            text += `${slotsSettings.nextWeekPrefix}\n`;
        }
        // –§–æ—Ä–º–∞—Ç –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏: –ü–ù (15.09) 11-14, 15
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–Ω–∏ –±–µ–∑ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
        slots.forEach(slot => {
            if (slot.slots && slot.slots !== '–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤') {
                text += `${slot.weekday} (${slot.date}) ${slot.slots}\n`;
            }
        });
    }
    
    copySlotsToClipboard(text.trim());
}

function extractSlotData(card) {
    try {
        const dateElement = card.querySelector('.fw-bold');
        const weekdayElement = card.querySelector('.text-muted');
        const slotsElement = card.querySelector('.text-primary, .text-info');
        
        if (!dateElement || !weekdayElement || !slotsElement) {
            console.warn('‚ö†Ô∏è –ù–µ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Å–ª–æ—Ç–∞');
            return null;
        }
        
        const slotData = {
            date: dateElement.textContent.trim(),
            weekday: weekdayElement.textContent.trim(),
            slots: slotsElement.textContent.trim()
        };
        
        console.log('üîç –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–ª–æ—Ç–∞:', slotData);
        return slotData;
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å–ª–æ—Ç–∞:', e);
        return null;
    }
}

function copySlotsToClipboard(text) {
    if (navigator.clipboard && window.isSecureContext) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π API
        navigator.clipboard.writeText(text).then(() => {
            showNotification('–°–ª–æ—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
            fallbackCopySlotsToClipboard(text);
        });
    } else {
        // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        fallbackCopySlotsToClipboard(text);
    }
}

function fallbackCopySlotsToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showNotification('–°–ª–æ—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ fallback –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
        showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.', 'error');
    }
    
    document.body.removeChild(textArea);
}
</script>
{% endblock %}