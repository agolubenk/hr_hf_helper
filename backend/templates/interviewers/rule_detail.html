{% extends 'interviewers/base.html' %}

{% block interviewer_title %}{{ rule.name }} - HR Helper{% endblock %}
{% block interviewer_page_title %}{{ rule.name }}{% endblock %}

{% block interviewer_content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Основная информация -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Информация о правиле
                </h5>
                {% if rule.is_active %}
                    <span class="badge bg-success fs-6">
                        <i class="fas fa-star me-1"></i>Активно
                    </span>
                {% else %}
                    <span class="badge bg-secondary fs-6">Неактивно</span>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Название</h6>
                        <p class="text-muted">{{ rule.name }}</p>
                        
                        <h6>Описание</h6>
                        <p class="text-muted">
                            {% if rule.description %}
                                {{ rule.description }}
                            {% else %}
                                <em>Описание не указано</em>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>Диапазон грейдов</h6>
                        <p class="text-muted">
                            <i class="fas fa-layer-group me-1"></i>
                            {{ rule.get_grade_range }}
                        </p>
                        
                        <h6>Статус</h6>
                        <p class="text-muted">
                            {% if rule.is_active %}
                                <span class="text-success">
                                    <i class="fas fa-check-circle me-1"></i>Активно
                                </span>
                            {% else %}
                                <span class="text-muted">
                                    <i class="fas fa-pause-circle me-1"></i>Неактивно
                                </span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Лимиты привлечения -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Лимиты привлечения
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <i class="fas fa-calendar-day fa-lg"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h4 class="mb-1">{{ rule.daily_limit }}</h4>
                                <p class="text-muted mb-0">Интервью в день</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <i class="fas fa-calendar-week fa-lg"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h4 class="mb-1">{{ rule.weekly_limit }}</h4>
                                <p class="text-muted mb-0">Интервью в неделю</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Системная информация -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cog me-2"></i>
                    Системная информация
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Дата создания</h6>
                        <p class="text-muted">
                            <i class="fas fa-calendar-plus me-1"></i>
                            {{ rule.created_at|date:"d.m.Y H:i" }}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>Последнее обновление</h6>
                        <p class="text-muted">
                            <i class="fas fa-calendar-edit me-1"></i>
                            {{ rule.updated_at|date:"d.m.Y H:i" }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Действия -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tools me-2"></i>
                    Действия
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'interviewers:rule_edit' rule.pk %}" class="btn btn-primary">
                        <i class="fas fa-edit me-1"></i>Редактировать правило
                    </a>
                    
                    <button type="button" class="btn btn-{% if rule.is_active %}warning{% else %}success{% endif %} toggle-active" 
                            data-url="{% url 'interviewers:rule_toggle_active' rule.pk %}"
                            data-rule-name="{{ rule.name }}">
                        <i class="fas fa-{% if rule.is_active %}pause{% else %}play{% endif %} me-1"></i>
                        {% if rule.is_active %}Деактивировать правило{% else %}Активировать правило{% endif %}
                    </button>
                    
                    <a href="{% url 'interviewers:rule_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-list me-1"></i>К списку правил
                    </a>
                </div>
            </div>
        </div>

        <!-- Статистика -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Статистика
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Дневной лимит</span>
                        <span class="fw-bold">{{ rule.daily_limit }}</span>
                    </div>
                    <div class="progress mt-1" style="height: 8px;">
                        <div class="progress-bar bg-primary" style="width: {{ rule.daily_limit|floatformat:0 }}%"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Недельный лимит</span>
                        <span class="fw-bold">{{ rule.weekly_limit }}</span>
                    </div>
                    <div class="progress mt-1" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: {{ rule.weekly_limit|floatformat:0 }}%"></div>
                    </div>
                </div>
                
                <hr>
                
                <div class="text-center">
                    <h6>Диапазон грейдов</h6>
                    <div class="badge bg-info fs-6">
                        <i class="fas fa-layer-group me-1"></i>
                        {{ rule.get_grade_range }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Скрытый CSRF токен для AJAX запросов -->
{% csrf_token %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Функция для получения CSRF токена
    function getCSRFToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]');
        return token ? token.value : '';
    }

    // Обработка переключения статуса активности
    document.querySelectorAll('.toggle-active').forEach(button => {
        button.addEventListener('click', function() {
            const url = this.dataset.url;
            const ruleName = this.dataset.ruleName;
            const action = this.textContent.trim();
            
            if (confirm(`Вы уверены, что хотите ${action.toLowerCase()}?`)) {
                // Показываем индикатор загрузки
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Обработка...';
                this.disabled = true;
                
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Показываем успешное сообщение
                        this.innerHTML = '<i class="fas fa-check me-1"></i>Успешно!';
                        this.classList.remove('btn-warning', 'btn-success');
                        this.classList.add('btn-success');
                        
                        // Перезагружаем страницу через небольшую задержку
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        throw new Error(data.message || 'Неизвестная ошибка');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ошибка: ' + error.message);
                    
                    // Восстанавливаем кнопку
                    this.innerHTML = originalText;
                    this.disabled = false;
                });
            }
        });
    });
});
</script>
{% endblock %}
