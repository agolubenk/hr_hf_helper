{% extends 'common/base.html' %}
{% load static %}

{% block title %}{{ chat_session.title }} - Gemini AI{% endblock %}
{% block page_title %}{{ chat_session.title }}{% endblock %}

{% block page_actions %}
{% endblock %}

{% block content %}
<style>
/* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π —á–∞—Ç–∞ */
.chat-container {
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
}

.chat-history-container {
    width: 100% !important;
    margin: 0 !important;
}

.row.g-0 {
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
}

.row.g-0 > [class*="col-"] {
    padding-left: 15px !important;
    padding-right: 15px !important;
}
</style>
<div class="row g-0">
    <div class="col-12 col-md-4 col-lg-3 chat-sidebar">
        <div class="card chat-history-container">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-comments me-2"></i>
                    –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤
                </h6>
            </div>
            <div class="card-body">
                {% for session in all_sessions %}
                    <div class="session-item {% if session.id == chat_session.id %}active{% endif %}" 
                         data-session-id="{{ session.id }}">
                        <div class="session-content" onclick="location.href='{% url 'gemini:chat_session' session.id %}'">
                            <div class="session-title">{{ session.title }}</div>
                            <div class="session-date">
                                {{ session.updated_at|date:"d.m.Y H:i" }}
                            </div>
                        </div>
                        <div class="session-actions">
                            <i class="fas fa-trash session-delete-icon" 
                               onclick="event.stopPropagation(); deleteSessionFromList({{ session.id }})"
                               title="–£–¥–∞–ª–∏—Ç—å —á–∞—Ç"></i>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <a href="{% url 'gemini:new_chat' %}" class="btn-new-chat w-100">
            <i class="fas fa-plus me-2"></i>
            –ù–æ–≤—ã–π —á–∞—Ç
        </a>
    </div>
    
    <div class="col-12 col-md-8 col-lg-9 chat-main-panel">
        <div class="card chat-container">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center">
                            <h6 class="mb-0 me-2" id="chat-title-display">{{ chat_session.title }}</h6>
                            <i class="fas fa-edit chat-title-edit" id="edit-title-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ"></i>
                        </div>
                        <small class="opacity-75">
                            –°–æ–∑–¥–∞–Ω: {{ chat_session.created_at|date:"d.m.Y H:i" }}
                        </small>
                    </div>
                    <div class="chat-header-actions">
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSession()" title="–£–¥–∞–ª–∏—Ç—å —á–∞—Ç">
                            <i class="fas fa-trash me-1"></i>
                            –£–¥–∞–ª–∏—Ç—å —á–∞—Ç
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card-body chat-messages" id="chat-messages">
                {% for message in messages %}
                    <div class="message {% if message.role == 'user' %}user-message{% else %}system-message{% endif %}">
                        <div class="message-bubble {% if message.role == 'user' %}user-bubble{% else %}system-bubble{% endif %}">
                            <div class="message-header">
                                {% if message.role == 'user' %}
                                    <i class="fas fa-user"></i>
                                    <strong>–í—ã</strong>
                                {% else %}
                                    <i class="fas fa-robot"></i>
                                    <strong>Gemini AI</strong>
                                {% endif %}
                                <small>{{ message.created_at|date:"H:i" }}</small>
                            </div>
                            <div class="message-content">
                                {{ message.content|linebreaks }}
                            </div>
                            {% if message.role == 'assistant' and message.response_time %}
                                <div class="status-message-compact">
                                    <i class="fas fa-clock me-1"></i>
                                    {{ message.response_time|floatformat:2 }}—Å
                                    {% if message.tokens_used %}
                                        ‚Ä¢ {{ message.tokens_used }} —Ç–æ–∫–µ–Ω–æ–≤
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% empty %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-comments" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-3 mb-0">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å Gemini AI</p>
                        <small>–ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø–æ–ø—Ä–æ—Å–∏—Ç–µ –ø–æ–º–æ—â–∏</small>
                    </div>
                {% endfor %}
                
                <div class="typing-indicator" id="typing-indicator" style="display: none;">
                    <div class="message system-message">
                        <div class="message-bubble system-bubble">
                            <div class="message-header">
                                <i class="fas fa-robot"></i>
                                <strong>Gemini AI</strong>
                            </div>
                            <div class="message-content">
                                <span class="loading-spinner me-2"></span>
                                Gemini –ø–µ—á–∞—Ç–∞–µ—Ç...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card-footer chat-input">
                <form id="chat-form">
                    {% csrf_token %}
                    <input type="hidden" name="session_id" value="{{ chat_session.id }}">
                    <div class="input-group">
                        <textarea class="form-control" 
                                  id="message-input" 
                                  name="message" 
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                                  autocomplete="off"
                                  required
                                  rows="1"></textarea>
                        <button type="submit" class="btn btn-primary" id="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const chatMessages = document.getElementById('chat-messages');
    const typingIndicator = document.getElementById('typing-indicator');
    
    // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    messageInput.focus();
    
    // –ê–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ textarea
    function autoResizeTextarea() {
        messageInput.style.height = 'auto';
        // –ü–æ–ª—É—á–∞–µ–º –≤—ã—Å–æ—Ç—É –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ (line-height + padding)
        const lineHeight = parseFloat(window.getComputedStyle(messageInput).lineHeight) || 24;
        const paddingTop = parseFloat(window.getComputedStyle(messageInput).paddingTop) || 8;
        const paddingBottom = parseFloat(window.getComputedStyle(messageInput).paddingBottom) || 8;
        
        // –í—ã—Å–æ—Ç–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ —Å —É—á–µ—Ç–æ–º padding
        const singleLineHeight = lineHeight + paddingTop + paddingBottom;
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 7 —Å—Ç—Ä–æ–∫
        const maxHeight = 7 * singleLineHeight;
        messageInput.style.height = Math.min(messageInput.scrollHeight, maxHeight) + 'px';
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã—Å–æ—Ç—ã
    autoResizeTextarea();
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
    messageInput.addEventListener('input', autoResizeTextarea);
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message) return;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç
        addMessageToChat('user', message);
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É
        messageInput.value = '';
        autoResizeTextarea();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
        showTypingIndicator();
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
        sendMessage(message);
    });
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter (–Ω–æ –Ω–µ Shift+Enter)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.dispatchEvent(new Event('submit'));
        }
    });
    
    function addMessageToChat(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role === 'user' ? 'user-message' : 'system-message'}`;
        
        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = `message-bubble ${role === 'user' ? 'user-bubble' : 'system-bubble'}`;
        
        const headerDiv = document.createElement('div');
        headerDiv.className = 'message-header';
        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        
        if (role === 'user') {
            headerDiv.innerHTML = '<i class="fas fa-user"></i><strong>–í—ã</strong><small>' + timeStr + '</small>';
        } else {
            headerDiv.innerHTML = '<i class="fas fa-robot"></i><strong>Gemini AI</strong><small>' + timeStr + '</small>';
        }
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.innerHTML = content.replace(/\n/g, '<br>');
        
        bubbleDiv.appendChild(headerDiv);
        bubbleDiv.appendChild(contentDiv);
        messageDiv.appendChild(bubbleDiv);
        
        chatMessages.insertBefore(messageDiv, typingIndicator);
        
        // –£–¥–∞–ª—è–µ–º –ª—é–±—ã–µ X –∏–∫–æ–Ω–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥–ª–∏ –ø–æ—è–≤–∏—Ç—å—Å—è
        removeCloseButtons(messageDiv);
        
        scrollToBottom();
    }
    
    function removeCloseButtons(element) {
        // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å X –∏–∫–æ–Ω–∫–∞–º–∏
        const closeElements = element.querySelectorAll('.fa-times, .fa-x, .close, .delete, [class*="close"], [class*="delete"], [class*="remove"], [class*="dismiss"]');
        closeElements.forEach(el => el.remove());
        
        // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å X —Å–∏–º–≤–æ–ª–æ–º
        const allElements = element.querySelectorAll('*');
        allElements.forEach(el => {
            if (el.textContent && (el.textContent.includes('√ó') || el.textContent.includes('‚úï') || el.textContent.includes('X'))) {
                if (el.textContent.trim() === '√ó' || el.textContent.trim() === '‚úï' || el.textContent.trim() === 'X') {
                    el.remove();
                }
            }
        });
        
        // –£–¥–∞–ª—è–µ–º –∞–ª–µ—Ä—Ç—ã –≤–Ω—É—Ç—Ä–∏ —ç–ª–µ–º–µ–Ω—Ç–∞
        const alerts = element.querySelectorAll('.alert, .messages');
        alerts.forEach(alert => alert.remove());
    }
    
    function showTypingIndicator(message = 'Gemini –ø–µ—á–∞—Ç–∞–µ—Ç...') {
        const messageContent = typingIndicator.querySelector('.message-content');
        messageContent.innerHTML = `
            <span class="loading-spinner me-2"></span>
            ${message}
        `;
        typingIndicator.style.display = 'block';
        scrollToBottom();
    }
    
    function hideTypingIndicator() {
        typingIndicator.style.display = 'none';
    }
    
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function sendMessage(message) {
        const sessionId = document.querySelector('input[name="session_id"]').value;
        
        fetch('{% url "gemini:send_message" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                session_id: sessionId,
                content: message
            })
        })
        .then(response => response.json())
        .then(data => {
            hideTypingIndicator();
            
            if (data.success) {
                addMessageToChat('assistant', data.response);
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ
                let errorMessage = '‚ùå –û—à–∏–±–∫–∞: ' + data.error;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
                if (data.error.includes('–ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞')) {
                    errorMessage += '\n\nüí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.';
                } else if (data.error.includes('–ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤')) {
                    errorMessage += '\n\nüí° –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.';
                } else if (data.error.includes('API –∫–ª—é—á')) {
                    errorMessage += '\n\nüí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API –∫–ª—é—á–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏".';
                }
                
                addMessageToChat('assistant', errorMessage);
            }
        })
        .catch(error => {
            hideTypingIndicator();
            addMessageToChat('assistant', '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            console.error('Error:', error);
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
    window.deleteSession = function() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–µ—Å—Å–∏—é —á–∞—Ç–∞?')) {
            fetch('{% url "gemini:delete_session" chat_session.id %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(() => {
                window.location.href = '{% url "gemini:dashboard" %}';
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏', 'error');
            });
        }
    };
    
    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –∏–∑ —Å–ø–∏—Å–∫–∞
    window.deleteSessionFromList = function(sessionId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–µ—Å—Å–∏—é —á–∞—Ç–∞?')) {
            fetch(`/gemini/session/${sessionId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(() => {
                // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞
                const sessionElement = document.querySelector(`[data-session-id="${sessionId}"]`);
                if (sessionElement) {
                    sessionElement.remove();
                }
                
                // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –¥–∞—à–±–æ—Ä–¥
                if (sessionId == {{ chat_session.id }}) {
                    window.location.href = '{% url "gemini:dashboard" %}';
                }
                
                showNotification('–°–µ—Å—Å–∏—è —á–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏', 'error');
            });
        }
    };
    
    // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    scrollToBottom();
    
    // –£–¥–∞–ª—è–µ–º –∞–ª–µ—Ä—Ç—ã —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    const alerts = document.querySelectorAll('.alert, .messages');
    alerts.forEach(alert => alert.remove());
    
    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º X –∏–∫–æ–Ω–∫–∏ –∏ –∞–ª–µ—Ä—Ç—ã
    setInterval(() => {
        const messages = document.querySelectorAll('.message');
        messages.forEach(message => {
            removeCloseButtons(message);
        });
        
        // –£–¥–∞–ª—è–µ–º Django messages –∞–ª–µ—Ä—Ç—ã
        const alerts = document.querySelectorAll('.alert, .messages');
        alerts.forEach(alert => alert.remove());
    }, 1000);
    
    // –ò–Ω–ª–∞–π–Ω —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —á–∞—Ç–∞
    const editTitleBtn = document.getElementById('edit-title-btn');
    const chatTitleDisplay = document.getElementById('chat-title-display');
    
    console.log('Edit button found:', editTitleBtn);
    console.log('Title display found:', chatTitleDisplay);
    
    if (editTitleBtn && chatTitleDisplay) {
        console.log('Adding click listener to edit button');
        editTitleBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Edit button clicked!');
        const currentTitle = chatTitleDisplay.textContent.trim();
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const editForm = document.createElement('div');
        editForm.className = 'chat-title-edit-form';
        
        // –°–æ–∑–¥–∞–µ–º input –ø–æ–ª–µ
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentTitle;
        input.style.width = '300px';
        
        // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn btn-sm btn-success ms-2';
        saveBtn.innerHTML = '<i class="fas fa-check"></i>';
        saveBtn.title = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn btn-sm btn-secondary ms-1';
        cancelBtn.innerHTML = '<i class="fas fa-times"></i>';
        cancelBtn.title = '–û—Ç–º–µ–Ω–∞';
        
        // –ó–∞–º–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        chatTitleDisplay.style.display = 'none';
        editTitleBtn.style.display = 'none';
        
        // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–æ—Ä–º—ã
        editForm.appendChild(input);
        editForm.appendChild(saveBtn);
        editForm.appendChild(cancelBtn);
        
        // –í—Å—Ç–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –≤–º–µ—Å—Ç–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        chatTitleDisplay.parentNode.insertBefore(editForm, chatTitleDisplay);
        
        // –§–æ–∫—É—Å –Ω–∞ input
        input.focus();
        input.select();
        
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã
        function cancelEdit() {
            console.log('Cancelling edit');
            editForm.remove();
            chatTitleDisplay.style.display = 'block';
            editTitleBtn.style.display = 'inline-block';
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        function saveTitle() {
            const newTitle = input.value.trim();
            
            if (!newTitle) {
                alert('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }
            
            if (newTitle === currentTitle) {
                cancelEdit();
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            saveBtn.disabled = true;
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            fetch(`{% url "gemini:update_session_title" chat_session.id %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    title: newTitle
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ —á–∞—Ç–µ
                    chatTitleDisplay.textContent = newTitle;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ —Å–ø–∏—Å–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤
                    const currentSessionItem = document.querySelector('.session-item.active');
                    if (currentSessionItem) {
                        const sessionTitle = currentSessionItem.querySelector('.session-title');
                        if (sessionTitle) {
                            sessionTitle.textContent = newTitle;
                        }
                    }
                    
                    cancelEdit();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                    showNotification('–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏—è: ' + data.error);
                    saveBtn.innerHTML = '<i class="fas fa-check"></i>';
                    saveBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                saveBtn.innerHTML = '<i class="fas fa-check"></i>';
                saveBtn.disabled = false;
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        saveBtn.addEventListener('click', saveTitle);
        cancelBtn.addEventListener('click', cancelEdit);
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveTitle();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                cancelEdit();
            }
        });
        
        // –û—Ç–º–µ–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —ç–ª–µ–º–µ–Ω—Ç–∞
        document.addEventListener('click', function(e) {
            if (!input.contains(e.target) && !saveBtn.contains(e.target) && !cancelBtn.contains(e.target)) {
                cancelEdit();
            }
        }, { once: true });
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
        
        const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
        
        notification.innerHTML = `
            <i class="fas fa-${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }
});
</script>
{% endblock %}



