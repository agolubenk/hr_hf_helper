{% extends 'common/base.html' %}

{% block title %}{{ title }} - HR Helper{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-{% if vacancy %}edit{% else %}plus{% endif %} me-2"></i>
                    {{ title }}
                </h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <!-- Основная информация -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-info-circle me-1"></i>
                                Основная информация
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.name.id_for_label }}" class="form-label">
                                    {{ form.name.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.name }}
                                {% if form.name.help_text %}
                                    <div class="form-text">{{ form.name.help_text }}</div>
                                {% endif %}
                                {% if form.name.errors %}
                                    <div class="text-danger">{{ form.name.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.external_id.id_for_label }}" class="form-label">
                                    {{ form.external_id.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.external_id }}
                                {% if form.external_id.help_text %}
                                    <div class="form-text">{{ form.external_id.help_text }}</div>
                                {% endif %}
                                {% if form.external_id.errors %}
                                    <div class="text-danger">{{ form.external_id.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.recruiter.id_for_label }}" class="form-label">
                                    {{ form.recruiter.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.recruiter }}
                                {% if form.recruiter.help_text %}
                                    <div class="form-text">{{ form.recruiter.help_text }}</div>
                                {% endif %}
                                {% if form.recruiter.errors %}
                                    <div class="text-danger">{{ form.recruiter.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.screening_duration.id_for_label }}" class="form-label">
                                    {{ form.screening_duration.label }}
                                </label>
                                {{ form.screening_duration }}
                                {% if form.screening_duration.help_text %}
                                    <div class="form-text">{{ form.screening_duration.help_text }}</div>
                                {% endif %}
                                {% if form.screening_duration.errors %}
                                    <div class="text-danger">{{ form.screening_duration.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    {{ form.is_active }}
                                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                        {{ form.is_active.label }}
                                    </label>
                                </div>
                                {% if form.is_active.help_text %}
                                    <div class="form-text">{{ form.is_active.help_text }}</div>
                                {% endif %}
                                {% if form.is_active.errors %}
                                    <div class="text-danger">{{ form.is_active.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Инвайты -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-envelope me-1"></i>
                                Инвайты
                            </h6>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="{{ form.invite_title.id_for_label }}" class="form-label">
                                    {{ form.invite_title.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.invite_title }}
                                {% if form.invite_title.help_text %}
                                    <div class="form-text">{{ form.invite_title.help_text }}</div>
                                {% endif %}
                                {% if form.invite_title.errors %}
                                    <div class="text-danger">{{ form.invite_title.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="{{ form.invite_text.id_for_label }}" class="form-label">
                                    {{ form.invite_text.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.invite_text }}
                                {% if form.invite_text.help_text %}
                                    <div class="form-text">{{ form.invite_text.help_text }}</div>
                                {% endif %}
                                {% if form.invite_text.errors %}
                                    <div class="text-danger">{{ form.invite_text.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Scorecard -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-chart-line me-1"></i>
                                Scorecard
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.scorecard_title.id_for_label }}" class="form-label">
                                    {{ form.scorecard_title.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.scorecard_title }}
                                {% if form.scorecard_title.help_text %}
                                    <div class="form-text">{{ form.scorecard_title.help_text }}</div>
                                {% endif %}
                                {% if form.scorecard_title.errors %}
                                    <div class="text-danger">{{ form.scorecard_title.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.scorecard_link.id_for_label }}" class="form-label">
                                    {{ form.scorecard_link.label }}
                                </label>
                                {{ form.scorecard_link }}
                                {% if form.scorecard_link.help_text %}
                                    <div class="form-text">{{ form.scorecard_link.help_text }}</div>
                                {% endif %}
                                {% if form.scorecard_link.errors %}
                                    <div class="text-danger">{{ form.scorecard_link.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Этапы для перевода кандидатов -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-route me-1"></i>
                                Этапы для перевода кандидатов
                            </h6>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.hr_screening_stage.id_for_label }}" class="form-label">
                                    {{ form.hr_screening_stage.label }}
                                </label>
                                {{ form.hr_screening_stage }}
                                {% if form.hr_screening_stage.help_text %}
                                    <div class="form-text">{{ form.hr_screening_stage.help_text }}</div>
                                {% endif %}
                                {% if form.hr_screening_stage.errors %}
                                    <div class="text-danger">{{ form.hr_screening_stage.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.tech_screening_stage.id_for_label }}" class="form-label">
                                    {{ form.tech_screening_stage.label }}
                                </label>
                                {{ form.tech_screening_stage }}
                                {% if form.tech_screening_stage.help_text %}
                                    <div class="form-text">{{ form.tech_screening_stage.help_text }}</div>
                                {% endif %}
                                {% if form.tech_screening_stage.errors %}
                                    <div class="text-danger">{{ form.tech_screening_stage.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.tech_interview_stage.id_for_label }}" class="form-label">
                                    {{ form.tech_interview_stage.label }}
                                </label>
                                {{ form.tech_interview_stage }}
                                {% if form.tech_interview_stage.help_text %}
                                    <div class="form-text">{{ form.tech_interview_stage.help_text }}</div>
                                {% endif %}
                                {% if form.tech_interview_stage.errors %}
                                    <div class="text-danger">{{ form.tech_interview_stage.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Вопросы для интервью -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-question-circle me-1"></i>
                                Вопросы для интервью
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.questions_belarus.id_for_label }}" class="form-label">
                                    {{ form.questions_belarus.label }}
                                </label>
                                {{ form.questions_belarus }}
                                {% if form.questions_belarus.help_text %}
                                    <div class="form-text">{{ form.questions_belarus.help_text }}</div>
                                {% endif %}
                                {% if form.questions_belarus.errors %}
                                    <div class="text-danger">{{ form.questions_belarus.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.questions_poland.id_for_label }}" class="form-label">
                                    {{ form.questions_poland.label }}
                                </label>
                                {{ form.questions_poland }}
                                {% if form.questions_poland.help_text %}
                                    <div class="form-text">{{ form.questions_poland.help_text }}</div>
                                {% endif %}
                                {% if form.questions_poland.errors %}
                                    <div class="text-danger">{{ form.questions_poland.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Ссылки на вакансии по странам -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-globe me-1"></i>
                                Ссылки на вакансии по странам
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.vacancy_link_belarus.id_for_label }}" class="form-label">
                                    {{ form.vacancy_link_belarus.label }}
                                </label>
                                {{ form.vacancy_link_belarus }}
                                {% if form.vacancy_link_belarus.help_text %}
                                    <div class="form-text">{{ form.vacancy_link_belarus.help_text }}</div>
                                {% endif %}
                                {% if form.vacancy_link_belarus.errors %}
                                    <div class="text-danger">{{ form.vacancy_link_belarus.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.vacancy_link_poland.id_for_label }}" class="form-label">
                                    {{ form.vacancy_link_poland.label }}
                                </label>
                                {{ form.vacancy_link_poland }}
                                {% if form.vacancy_link_poland.help_text %}
                                    <div class="form-text">{{ form.vacancy_link_poland.help_text }}</div>
                                {% endif %}
                                {% if form.vacancy_link_poland.errors %}
                                    <div class="text-danger">{{ form.vacancy_link_poland.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Промпты -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-robot me-1"></i>
                                Промпты для AI
                            </h6>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="{{ form.candidate_update_prompt.id_for_label }}" class="form-label">
                                    {{ form.candidate_update_prompt.label }}
                                </label>
                                {{ form.candidate_update_prompt }}
                                {% if form.candidate_update_prompt.help_text %}
                                    <div class="form-text">{{ form.candidate_update_prompt.help_text }}</div>
                                {% endif %}
                                {% if form.candidate_update_prompt.errors %}
                                    <div class="text-danger">{{ form.candidate_update_prompt.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Интервьюеры -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-users me-1"></i>
                                Интервьюеры
                            </h6>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="{{ form.interviewers.id_for_label }}" class="form-label">
                                    {{ form.interviewers.label }}
                                </label>
                                <div class="row">
                                    {% for choice in form.interviewers %}
                                        <div class="col-md-6 col-lg-4 mb-2">
                                            <div class="form-check">
                                                {{ choice.tag }}
                                                <label class="form-check-label" for="{{ choice.id_for_label }}">
                                                    {{ choice.choice_label }}
                                                </label>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                {% if form.interviewers.help_text %}
                                    <div class="form-text">{{ form.interviewers.help_text }}</div>
                                {% endif %}
                                {% if form.interviewers.errors %}
                                    <div class="text-danger">{{ form.interviewers.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Зарплатные вилки -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-money-bill-wave me-1"></i>
                                Зарплатные вилки
                            </h6>
                        </div>
                        <div class="col-12">
                            {% if salary_ranges %}
                                <div class="alert alert-info">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Доступные зарплатные вилки
                                    </h6>
                                    <p class="mb-2">Для этой вакансии доступны следующие зарплатные вилки по грейдам:</p>
                                    <div class="row">
                                        {% for salary_range in salary_ranges %}
                                            <div class="col-md-6 col-lg-4 mb-2">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h6 class="card-title mb-0 d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <span class="badge bg-primary me-2">{{ salary_range.grade.name }}</span>
                                                                {% if salary_range.is_active %}
                                                                    <span class="badge bg-success">Активна</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">Неактивна</span>
                                                                {% endif %}
                                                            </div>
                                                            <div>
                                                                <small class="text-muted text-end">
                                                                    UPD: {{ salary_range.updated_at|date:"d.m.Y" }}
                                                                </small>
                                                            </div>
                                                        </h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <!-- USD -->
                                                        <div class="mb-2">
                                                            <div class="fw-bold text-primary">
                                                                <b class="text-muted">USD:</b>
                                                                {{ salary_range.salary_min_usd }} - {{ salary_range.salary_max_usd }}
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- BYN -->
                                                        {% if salary_range.salary_min_byn and salary_range.salary_max_byn %}
                                                            <div class="mb-2">
                                                                <div class="fw-bold text-info">
                                                                    <b class="text-muted">BYN:</b>
                                                                    {{ salary_range.salary_min_byn }} - {{ salary_range.salary_max_byn }}
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                        
                                                        <!-- PLN -->
                                                        {% if salary_range.salary_min_pln and salary_range.salary_max_pln %}
                                                            <div class="mb-2">
                                                                <div class="fw-bold text-warning">
                                                                    <b class="text-muted">PLN:</b>
                                                                    {{ salary_range.salary_min_pln }} - {{ salary_range.salary_max_pln }}
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                        
                                                        <!-- EUR -->
                                                        {% if salary_range.salary_min_eur and salary_range.salary_max_eur %}
                                                            <div class="mb-2">
                                                                <div class="fw-bold text-success">
                                                                    <b class="text-muted">EUR:</b>
                                                                    {{ salary_range.salary_min_eur }} - {{ salary_range.salary_max_eur }}
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="card-footer">
                                                        <div class="btn-group w-100" role="group">
                                                            <a href="{% url 'vacancies:salary_range_detail' salary_range.pk %}" 
                                                               class="btn btn-outline-primary btn-sm" title="Просмотр">
                                                                <i class="fas fa-eye"></i>
                                                            </a>
                                                            <a href="{% url 'vacancies:salary_range_edit' salary_range.pk %}?next={{ request.get_full_path|urlencode }}" 
                                                               class="btn btn-outline-warning btn-sm" title="Редактировать">
                                                                <i class="fas fa-edit"></i>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <hr class="my-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            Зарплатные вилки автоматически перерассчитываются на основе курса USD НБРБ каждый день
                                        </small>
                                        <div>
                                            <a href="{% url 'vacancies:salary_range_create' %}" class="btn btn-primary btn-sm me-2" target="_blank" rel="noopener noreferrer">
                                                <i class="fas fa-plus me-1"></i>
                                                Создать вилку
                                                <i class="fas fa-external-link-alt ms-1"></i>
                                            </a>
                                            <a href="{% url 'vacancies:salary_ranges_list' %}" class="btn btn-outline-primary btn-sm" target="_blank" rel="noopener noreferrer">
                                                <i class="fas fa-cog me-1"></i>
                                                Управление вилками
                                                <i class="fas fa-external-link-alt ms-1"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        Зарплатные вилки не настроены
                                    </h6>
                                    <p class="mb-2">Для отображения зарплатных вилок в вакансиях необходимо создать вилки для грейдов.</p>
                                    <a href="{% url 'vacancies:salary_range_create' %}?next={{ request.get_full_path|urlencode }}" class="btn btn-warning" target="_blank" rel="noopener noreferrer">
                                        <i class="fas fa-plus me-1"></i>
                                        Создать зарплатную вилку
                                        <i class="fas fa-external-link-alt ms-1"></i>
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Кнопки -->
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <a href="{% if vacancy %}{% url 'vacancies:vacancy_detail' vacancy.pk %}{% else %}{% url 'vacancies:vacancy_list' %}{% endif %}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-1"></i>
                                    Отмена
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>
                                    {{ submit_text }}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
