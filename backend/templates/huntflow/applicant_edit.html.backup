{% extends 'common/base.html' %}
{% load huntflow_filters %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: {{ applicant.first_name|default:"" }} {{ applicant.last_name|default:"" }}{% endblock %}
{% block page_title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: {{ applicant.first_name|default:"" }} {{ applicant.last_name|default:"" }}{% endblock %}


{% block content %}
<form method="post">
    {% csrf_token %}
    <div class="row">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="col-md-8">
            <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-user me-2"></i>
                    –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ ID {{ applicant.id }}
                </h5>
            </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <!-- –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: –í–∞–∫–∞–Ω—Å–∏—è | –°—Ç–∞—Ç—É—Å -->
                            <div class="row mb-3">
                                <div class="col-4">
                                    <strong>–í–∞–∫–∞–Ω—Å–∏—è:</strong> 
                                    {% if applicant.vacancy_info %}
                                        <span class="badge bg-primary">{{ applicant.vacancy_info.position }}</span>
                                    {% else %}
                                        <span class="text-muted">–ù–µ—Ç –≤–∞–∫–∞–Ω—Å–∏–π</span>
                                    {% endif %}
                                </div>
                                <div class="col-8">
                                    <div class="d-flex align-items-center gap-2">
                                    <strong>–°—Ç–∞—Ç—É—Å:</strong>
                                        <select name="status_id" class="form-select form-select-sm d-inline-block w-auto">
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
                                        {% if statuses and statuses.items %}
                                            {% for status in statuses.items %}
                                                <option value="{{ status.id }}" 
                                                        {% if applicant.status_info and status.id == applicant.status_info.id %}selected{% endif %}>
                                                    {{ status.name }}
                                                </option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                        <button type="button" class="btn btn-primary btn-sm" id="toggle-status-comment" title="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Å—Ç–∞—Ç—É—Å—É">
                                            <i class="fas fa-comment"></i>
                                        </button>
                            </div>
                            
                                    <!-- –ö–æ–ª–ª–∞–ø—Å –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∫ —Å—Ç–∞—Ç—É—Å—É -->
                                    <div class="collapse mt-2" id="status-comment-collapse">
                                        <div class="add-comment-section mb-4">
                                            <form id="status-comment-form" class="comment-form">
                                                {% csrf_token %}
                                                <div class="form-group">
                                                    <label for="status_comment" class="form-label">
                                                        <i class="fas fa-plus-circle me-1"></i>
                                                        –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—é —Å—Ç–∞—Ç—É—Å–∞
                                                    </label>
                                                    <div class="comment-input-wrapper">
                                                        <textarea 
                                                            id="status_comment" 
                                                            name="status_comment" 
                                                            class="form-control comment-textarea" 
                                                            rows="1" 
                                                            placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                                                        ></textarea>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            

                            
                            <!-- –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞: –§–ò–û (–≤—Å–µ 3 –ø–æ–ª—è) -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <strong>–§–ò–û:</strong>
                                    <div class="d-flex gap-2 mt-1">
                                        <input type="text" class="form-control form-control-sm" name="first_name" 
                                               value="{{ applicant.first_name|default:'' }}" placeholder="–ò–º—è">
                                        <input type="text" class="form-control form-control-sm" name="last_name" 
                                               value="{{ applicant.last_name|default:'' }}" placeholder="–§–∞–º–∏–ª–∏—è">
                                        <input type="text" class="form-control form-control-sm" name="middle_name" 
                                               value="{{ applicant.middle_name|default:'' }}" placeholder="–û—Ç—á–µ—Å—Ç–≤–æ">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- –¢—Ä–µ—Ç—å—è —Å—Ç—Ä–æ–∫–∞: –ó–∞—Ä–ø–ª–∞—Ç–Ω—ã–µ –æ–∂–∏–¥–∞–Ω–∏—è -->
                            <div class="row mb-3">
                                <div class="col-12">
                                <label for="money" class="form-label"><strong>–ó–∞—Ä–ø–ª–∞—Ç–Ω—ã–µ –æ–∂–∏–¥–∞–Ω–∏—è:</strong></label>
                                <input type="text" class="form-control" id="money" name="money" 
                                       value="{{ applicant.money|default:'' }}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1000$" maxlength="100" data-maxlength="100">
                                <div class="maxlength-feedback" id="money-feedback"></div>
                                </div>
                            </div>
                            
                            <!-- –ß–µ—Ç–≤–µ—Ä—Ç–∞—è —Å—Ç—Ä–æ–∫–∞: –ú–µ—Ç–∫–∏ -->
                            <div class="row mb-3">
                                <div class="col-12">
                                <label class="form-label"><strong>–ú–µ—Ç–∫–∏:</strong></label>
                                <div class="tokenfield-container">
                                    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤ –∏ –ø–æ–ª—è –≤–≤–æ–¥–∞ -->
                                    <div class="selected-tags" id="selected-tags">
                                        {% if applicant.enriched_tags %}
                                            {% for tag in applicant.enriched_tags %}
                                                <span class="tag-token" data-tag-id="{{ tag.id }}">
                                                    {% if tag.color %}
                                                        <span class="badge me-1" style="background-color: #{{ tag.color }} !important; color: {{ tag.color|get_contrast_color }} !important;">{{ tag.name }}</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary me-1">{{ tag.name }}</span>
                                                    {% endif %}
                                                    <button type="button" class="btn-close" aria-label="–£–¥–∞–ª–∏—Ç—å"></button>
                                                </span>
                                            {% endfor %}
                                        {% endif %}
                                        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
                                        <input type="text" class="tag-input" id="tag-input" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –º–µ—Ç–∫—É...">
                                    </div>
                                    
                                    <!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ -->
                                    <div class="tag-dropdown" id="tag-dropdown" style="display: none;">
                                        {% if tags and tags.items %}
                                            {% for tag in tags.items %}
                                                <div class="tag-option" data-tag-id="{{ tag.id }}" data-tag-name="{{ tag.name }}" data-tag-color="{{ tag.color|default:'' }}">
                                                    {% if tag.color %}
                                                        <span class="badge me-2" style="background-color: #{{ tag.color }} !important; color: {{ tag.color|get_contrast_color }} !important;">{{ tag.name }}</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary me-2">{{ tag.name }}</span>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="tag-option text-muted">–ú–µ—Ç–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤ -->
                                    <div id="hidden-tag-inputs">
                                        {% if applicant.enriched_tags %}
                                            {% for tag in applicant.enriched_tags %}
                                                <input type="hidden" name="tags" value="{{ tag.id }}">
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
        </div>
                    
            <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-address-book me-2"></i>
                        –ö–æ–Ω—Ç–∞–∫—Ç—ã
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label"><strong>Email:</strong></label>
                                <input type="email" class="form-control" id="email" name="email" 
                                       value="{{ applicant.email|default:'' }}" placeholder="email@example.com" maxlength="255" data-maxlength="255">
                                <div class="maxlength-feedback" id="email-feedback"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="phone" class="form-label"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong></label>
                                <input type="tel" class="form-control" id="phone" name="phone" 
                                       value="{{ applicant.phone|default:'' }}" placeholder="+375 29 123-45-67" maxlength="20" data-maxlength="20">
                                <div class="maxlength-feedback" id="phone-feedback"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Telegram -->
                    <div class="mb-3">
                        <label for="telegram" class="form-label"><strong>Telegram:</strong></label>
                        <div class="input-group">
                            <span class="input-group-text">@</span>
                            <input type="text" class="form-control" id="telegram" name="telegram" 
                                   value="{% if applicant.social %}{% for social in applicant.social %}{% if social.social_type == 'TELEGRAM' %}{{ social.value }}{% endif %}{% endfor %}{% endif %}" 
                                   placeholder="username" maxlength="50" data-maxlength="50">
                        </div>
                        <div class="maxlength-feedback" id="telegram-feedback"></div>
                    </div>
                </div>
            </div>
            
            <!-- –ê–Ω–∫–µ—Ç–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ -->
            {% if questionary %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clipboard-list me-2"></i>
                        –ê–Ω–∫–µ—Ç–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
                        <span class="badge bg-primary ms-2">{{ questionary|length }} –ø–æ–ª–µ–π</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for field_key, field_data in questionary.items %}
                        <div class="col-12 mb-3">
                            <div class="questionary-field">
                                <div class="d-flex align-items-center gap-2">
                                    <label for="questionary_{{ field_key }}" class="form-label mb-0" style="min-width: 200px; flex-shrink: 0;">
                                        <strong>{{ field_data.title }}</strong>
                                    </label>
                                
                                    {% if field_data.type == 'textarea' %}
                                        <textarea class="form-control flex-grow-1" id="questionary_{{ field_key }}" 
                                                  name="questionary_{{ field_key }}" rows="2"
                                                  placeholder="–í–≤–µ–¥–∏—Ç–µ {{ field_data.title|lower }}">{{ field_data.value|default:'' }}</textarea>
                                    {% elif field_data.type == 'select' %}
                                        <select class="form-select flex-grow-1" id="questionary_{{ field_key }}" 
                                                name="questionary_{{ field_key }}">
                                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ {{ field_data.title|lower }}</option>
                                            {% if field_data.options %}
                                                {% for option in field_data.options %}
                                                    {% if option.value %}
                                                        <option value="{{ option.value }}" 
                                                                {% if field_data.value == option.value %}selected{% endif %}>
                                                            {{ option.title|default:option.value }}
                                                        </option>
                                                    {% elif option.title %}
                                                        <option value="{{ option.title }}" 
                                                                {% if field_data.value == option.title %}selected{% endif %}>
                                                            {{ option.title }}
                                                        </option>
                                                    {% else %}
                                                        <option value="{{ option }}" 
                                                                {% if field_data.value == option %}selected{% endif %}>
                                                            {{ option }}
                                                        </option>
                                                    {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                <!-- –ï—Å–ª–∏ –æ–ø—Ü–∏–π –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ -->
                                                {% if field_data.value %}
                                                    <option value="{{ field_data.value }}" selected>{{ field_data.value }}</option>
                                                {% endif %}
                                            {% endif %}
                                        </select>
                                    {% elif field_data.type == 'checkbox' %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="questionary_{{ field_key }}" 
                                                   name="questionary_{{ field_key }}" value="true"
                                                   {% if field_data.value %}checked{% endif %}>
                                        </div>
                                    {% else %}
                                        <input type="text" class="form-control flex-grow-1" id="questionary_{{ field_key }}" 
                                               name="questionary_{{ field_key }}" 
                                               value="{{ field_data.value|default:'' }}"
                                               placeholder="–í–≤–µ–¥–∏—Ç–µ {{ field_data.title|lower }}">
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="col-md-4 sticky-sidebar">
            <!-- –î–µ–π—Å—Ç–≤–∏—è -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        –î–µ–π—Å—Ç–≤–∏—è
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-1"></i>
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        </button>
                        <a href="{% url 'huntflow:applicant_detail' account_id applicant.id %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>
                            –û—Ç–º–µ–Ω–∏—Ç—å
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                    </h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-2">
                        <i class="fas fa-edit me-1"></i>
                        <strong>–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è:</strong> –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ–Ω—Ç–∞–∫—Ç—ã, —Å—Ç–∞—Ç—É—Å, –º–µ—Ç–∫–∏, –∞–Ω–∫–µ—Ç–∞.
                    </p>
                    <p class="small text-muted mb-2">
                        <i class="fas fa-lock me-1"></i>
                        <strong>–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä:</strong> –≤–∞–∫–∞–Ω—Å–∏—è (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –≤ Huntflow).
                    </p>
                    <p class="small text-muted mb-0">
                        <i class="fas fa-save me-1"></i>
                        <strong>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:</strong> –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Huntflow.
                    </p>
                </div>
            </div>
        </div>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<!-- –°—Ç–∏–ª–∏ —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –≤ base.html -->

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
    let messagesContainer = document.querySelector('.messages');
    if (!messagesContainer) {
        messagesContainer = document.createElement('div');
        messagesContainer.className = 'messages';
        document.body.insertBefore(messagesContainer, document.body.firstChild);
    }
    
    messagesContainer.insertAdjacentHTML('beforeend', alertHtml);
    
    setTimeout(() => {
        const alert = messagesContainer.querySelector('.alert:last-child');
        if (alert) {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 150);
        }
    }, 3000);
}

document.addEventListener('DOMContentLoaded', function() {
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–ª–∞–ø—Å–æ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∫ —Å—Ç–∞—Ç—É—Å—É
    const toggleStatusCommentBtn = document.getElementById('toggle-status-comment');
    const statusCommentCollapse = document.getElementById('status-comment-collapse');
    const statusCommentTextarea = document.getElementById('status_comment');
    
    if (toggleStatusCommentBtn && statusCommentCollapse) {
        toggleStatusCommentBtn.addEventListener('click', function() {
            const isCollapsed = statusCommentCollapse.classList.contains('show');
            
            if (isCollapsed) {
                // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
                statusCommentCollapse.classList.remove('show');
                toggleStatusCommentBtn.innerHTML = '<i class="fas fa-comment"></i>';
                toggleStatusCommentBtn.title = '–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Å—Ç–∞—Ç—É—Å—É';
                // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º textarea
                if (statusCommentTextarea) {
                    statusCommentTextarea.classList.remove('expanded');
                }
            } else {
                // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
                statusCommentCollapse.classList.add('show');
                toggleStatusCommentBtn.innerHTML = '<i class="fas fa-comment-slash"></i>';
                toggleStatusCommentBtn.title = '–°–∫—Ä—ã—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Å—Ç–∞—Ç—É—Å—É';
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ textarea –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∫ —Å—Ç–∞—Ç—É—Å—É (–∫–∞–∫ –≤ applicant_detail.html)
    if (statusCommentTextarea) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ–∫—É—Å–∞ –Ω–∞ textarea
        statusCommentTextarea.addEventListener('focus', function() {
            this.classList.add('expanded');
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞
        statusCommentTextarea.addEventListener('blur', function() {
            if (!this.value.trim()) {
                this.classList.remove('expanded');
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –≤–Ω–µ —Ñ–æ—Ä–º—ã
        document.addEventListener('click', function(e) {
            if (!statusCommentCollapse.contains(e.target) && !statusCommentTextarea.value.trim()) {
                statusCommentTextarea.classList.remove('expanded');
            }
        });
    }
    
    const tagInput = document.getElementById('tag-input');
    const tagDropdown = document.getElementById('tag-dropdown');
    const selectedTagsContainer = document.getElementById('selected-tags');
    const hiddenInputsContainer = document.getElementById('hidden-tag-inputs');
    
    // –ú–∞—Å—Å–∏–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤
    let selectedTags = [];
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤
    function initializeSelectedTags() {
        const existingTags = selectedTagsContainer.querySelectorAll('.tag-token');
        existingTags.forEach(tag => {
            const tagId = tag.getAttribute('data-tag-id');
            const tagName = tag.querySelector('.badge').textContent;
            const tagColor = tag.querySelector('.badge').style.backgroundColor || '';
            selectedTags.push({
                id: tagId,
                name: tagName,
                color: tagColor
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Ç–µ–≥–∞–º
            const removeBtn = tag.querySelector('.btn-close');
            if (removeBtn) {
                removeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    removeTag(tagId);
                });
            }
        });
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞
    function addTag(tagId, tagName, tagColor) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã–±—Ä–∞–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —Ç–µ–≥
        if (selectedTags.some(tag => tag.id === tagId)) {
            return;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤
        selectedTags.push({
            id: tagId,
            name: tagName,
            color: tagColor
        });
        
        // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç —Ç–µ–≥–∞
        const tagElement = document.createElement('span');
        tagElement.className = 'tag-token';
        tagElement.setAttribute('data-tag-id', tagId);
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç–∏–ª—å –¥–ª—è –±–µ–π–¥–∂–∞
        let badgeStyle = '';
        if (tagColor) {
            const contrastColor = getContrastColor(tagColor);
            badgeStyle = `style="background-color: #${tagColor} !important; color: ${contrastColor} !important;"`;
        } else {
            badgeStyle = 'class="badge bg-secondary me-1"';
        }
        
        tagElement.innerHTML = `
            <span class="badge me-1" ${badgeStyle}>${tagName}</span>
            <button type="button" class="btn-close" aria-label="–£–¥–∞–ª–∏—Ç—å"></button>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
        const removeBtn = tagElement.querySelector('.btn-close');
        removeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            removeTag(tagId);
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥–∞
        tagInput.parentNode.insertBefore(tagElement, tagInput);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
        updateHiddenInputs();
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        tagInput.value = '';
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–≥–∞
        tagDropdown.style.display = 'none';
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        setTimeout(() => {
            tagInput.focus();
        }, 10);
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–≥–∞
    function removeTag(tagId) {
        // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
        selectedTags = selectedTags.filter(tag => tag.id !== tagId);
        
        // –ù–∞—Ö–æ–¥–∏–º –∏ —É–¥–∞–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
        const tagElement = selectedTagsContainer.querySelector(`[data-tag-id="${tagId}"]`);
        if (tagElement) {
            tagElement.classList.add('removing');
            setTimeout(() => {
                tagElement.remove();
            }, 300);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
        updateHiddenInputs();
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    function updateHiddenInputs() {
        // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
        hiddenInputsContainer.innerHTML = '';
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–µ–≥–∞
        selectedTags.forEach(tag => {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'tags';
            hiddenInput.value = tag.id;
            hiddenInputsContainer.appendChild(hiddenInput);
        });
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ (—Å–∫—Ä—ã—Ç–∏–µ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤)
    function updateDropdown() {
        const options = tagDropdown.querySelectorAll('.tag-option');
        options.forEach(option => {
            const tagId = option.getAttribute('data-tag-id');
            if (tagId && selectedTags.some(tag => tag.id === tagId)) {
                option.style.display = 'none';
            } else {
                option.style.display = 'block';
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –æ–ø—Ü–∏–∏ –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ
    tagDropdown.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const option = e.target.closest('.tag-option');
        if (option && option.getAttribute('data-tag-id')) {
            const tagId = option.getAttribute('data-tag-id');
            const tagName = option.getAttribute('data-tag-name');
            const tagColor = option.getAttribute('data-tag-color');
            
            addTag(tagId, tagName, tagColor);
        }
    });
    
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –Ω–µ–≥–æ
    tagDropdown.addEventListener('mouseenter', function(e) {
        e.stopPropagation();
    });
    
    tagDropdown.addEventListener('mouseleave', function(e) {
        e.stopPropagation();
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    function positionDropdown() {
        const inputRect = tagInput.getBoundingClientRect();
        tagDropdown.style.top = (inputRect.bottom + window.scrollY + 2) + 'px';
        tagDropdown.style.left = inputRect.left + 'px';
        tagDropdown.style.width = inputRect.width + 'px';
        tagDropdown.style.zIndex = '9999';
        tagDropdown.style.position = 'absolute';
        
        // –ü–†–û–í–ï–†–Ø–ï–ú –°–û–î–ï–†–ñ–ò–ú–û–ï –°–ü–ò–°–ö–ê
        const options = tagDropdown.querySelectorAll('.tag-option');
        console.log('–°–ø–∏—Å–æ–∫ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø—Ü–∏–π:', options.length);
        console.log('HTML —Å–ø–∏—Å–∫–∞:', tagDropdown.innerHTML);
        console.log('–°—Ç–∏–ª–∏ —Å–ø–∏—Å–∫–∞:', {
            display: tagDropdown.style.display,
            visibility: tagDropdown.style.visibility,
            opacity: tagDropdown.style.opacity,
            position: tagDropdown.style.position,
            zIndex: tagDropdown.style.zIndex
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
    tagInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const options = tagDropdown.querySelectorAll('.tag-option');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
        positionDropdown();
        tagDropdown.style.display = 'block';
        
        options.forEach(option => {
            if (option.getAttribute('data-tag-name')) {
                const tagId = option.getAttribute('data-tag-id');
                const tagName = option.getAttribute('data-tag-name').toLowerCase();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã–±—Ä–∞–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —Ç–µ–≥
                const isSelected = selectedTags.some(tag => tag.id === tagId);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–≥ –Ω–µ –≤—ã–±—Ä–∞–Ω –ò —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–∏—Å–∫—É
                if (!isSelected && tagName.includes(searchTerm)) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            }
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ–∫—É—Å–∞ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    tagInput.addEventListener('focus', function() {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ
        positionDropdown();
        tagDropdown.style.display = 'block';
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∫–∞–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
        const searchTerm = this.value.toLowerCase();
        const options = tagDropdown.querySelectorAll('.tag-option');
        
        options.forEach(option => {
            if (option.getAttribute('data-tag-name')) {
                const tagId = option.getAttribute('data-tag-id');
                const tagName = option.getAttribute('data-tag-name').toLowerCase();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã–±—Ä–∞–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —Ç–µ–≥
                const isSelected = selectedTags.some(tag => tag.id === tagId);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–≥ –Ω–µ –≤—ã–±—Ä–∞–Ω –ò —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–∏—Å–∫—É
                if (!isSelected && tagName.includes(searchTerm)) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            }
        });
    });
    
    // –°–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.tokenfield-container') && 
            !e.target.closest('.tag-dropdown')) {
            tagDropdown.style.display = 'none';
        }
    });
    
    // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ
    window.addEventListener('scroll', function() {
        if (tagDropdown.style.display === 'block') {
            positionDropdown();
        }
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    window.addEventListener('resize', function() {
        if (tagDropdown.style.display === 'block') {
            positionDropdown();
        }
    });
    
    // –°–ü–ò–°–û–ö –í–°–ï–ì–î–ê –í–ò–î–ï–ù! –ù–ê–•–£–ô –í–°–ï –°–û–ë–´–¢–ò–Ø!
    const tokenfieldContainer = document.querySelector('.tokenfield-container');
    
    // –ü–†–û–°–¢–û–ï –†–ï–®–ï–ù–ò–ï: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –º—ã—à–∏, —Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ —É–±–∏—Ä–∞–Ω–∏–∏
    tokenfieldContainer.addEventListener('mouseenter', function() {
        positionDropdown();
        tagDropdown.style.display = 'block';
    });
    
    tokenfieldContainer.addEventListener('mouseleave', function() {
        tagDropdown.style.display = 'none';
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    tagInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const searchTerm = this.value.trim();
            if (searchTerm) {
                // –ò—â–µ–º –ø–µ—Ä–≤—ã–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–µ–≥
                const options = tagDropdown.querySelectorAll('.tag-option');
                for (let option of options) {
                    const tagId = option.getAttribute('data-tag-id');
                    const tagName = option.getAttribute('data-tag-name').toLowerCase();
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã–±—Ä–∞–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —Ç–µ–≥
                    const isSelected = selectedTags.some(tag => tag.id === tagId);
                    
                    if (!isSelected && tagName.includes(searchTerm.toLowerCase()) && option.style.display !== 'none') {
                        const tagColor = option.getAttribute('data-tag-color');
                        addTag(tagId, option.getAttribute('data-tag-name'), tagColor);
                        break;
                    }
                }
            }
        } else if (e.key === 'Backspace' && this.value === '') {
            // –ï—Å–ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—É—Å—Ç–æ–µ –∏ –Ω–∞–∂–∞—Ç Backspace, —É–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥
            e.preventDefault();
            if (selectedTags.length > 0) {
                const lastTag = selectedTags[selectedTags.length - 1];
                removeTag(lastTag.id);
            }
        }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    initializeSelectedTags();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Bootstrap Maxlength
    initializeMaxlength();
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç–∏ —Ü–≤–µ—Ç–∞
function getContrastColor(hexColor) {
    if (!hexColor) {
        return '#000000';
    }
    
    // –£–±–∏—Ä–∞–µ–º # –µ—Å–ª–∏ –µ—Å—Ç—å
    hexColor = hexColor.replace('#', '');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π hex —Ü–≤–µ—Ç
    if (hexColor.length !== 6) {
        return '#000000';
    }
    
    try {
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º hex –≤ RGB
        const r = parseInt(hexColor.substr(0, 2), 16);
        const g = parseInt(hexColor.substr(2, 2), 16);
        const b = parseInt(hexColor.substr(4, 2), 16);
        
        // –í—ã—á–∏—Å–ª—è–µ–º —è—Ä–∫–æ—Å—Ç—å –ø–æ —Ñ–æ—Ä–º—É–ª–µ W3C
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Å–∞ –¥–ª—è —É—á–µ—Ç–∞ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è —è—Ä–∫–æ—Å—Ç–∏ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º –≥–ª–∞–∑–æ–º
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —á–µ—Ä–Ω—ã–π –¥–ª—è —Å–≤–µ—Ç–ª—ã—Ö —Ü–≤–µ—Ç–æ–≤, –±–µ–ª—ã–π –¥–ª—è —Ç–µ–º–Ω—ã—Ö
        return brightness > 128 ? '#000000' : '#ffffff';
    } catch (error) {
        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —á–µ—Ä–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        return '#000000';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –∫ –º–µ—Ç–∫–∞–º
function applyContrastToTags() {
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–∫–∏
    const existingTags = document.querySelectorAll('.tag-token .badge');
    existingTags.forEach(badge => {
        const bgColor = badge.style.backgroundColor;
        if (bgColor && bgColor !== 'rgb(108, 117, 125)') { // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–µ—Ä—ã–µ –º–µ—Ç–∫–∏
            const contrastColor = getContrastColor(bgColor);
            badge.style.color = contrastColor + ' !important';
        }
    });
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–ø—Ü–∏–∏ –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ
    const dropdownOptions = document.querySelectorAll('.tag-option .badge');
    dropdownOptions.forEach(badge => {
        const bgColor = badge.style.backgroundColor;
        if (bgColor && bgColor !== 'rgb(108, 117, 125)') { // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–µ—Ä—ã–µ –º–µ—Ç–∫–∏
            const contrastColor = getContrastColor(bgColor);
            badge.style.color = contrastColor + ' !important';
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Bootstrap Maxlength
function initializeMaxlength() {
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø–æ–ª—è —Å –∞—Ç—Ä–∏–±—É—Ç–æ–º data-maxlength
    const inputs = document.querySelectorAll('input[data-maxlength]');
    
    inputs.forEach(input => {
        const maxLength = parseInt(input.getAttribute('data-maxlength'));
        const feedbackId = input.id + '-feedback';
        const feedback = document.getElementById(feedbackId);
        
        if (feedback) {
            // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞
            function updateCounter() {
                const currentLength = input.value.length;
                const remaining = maxLength - currentLength;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
                feedback.textContent = `${currentLength}/${maxLength} —Å–∏–º–≤–æ–ª–æ–≤`;
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Å–∏–º–≤–æ–ª–æ–≤
                feedback.className = 'maxlength-feedback';
                
                if (remaining <= 0) {
                    feedback.classList.add('danger');
                } else if (remaining <= maxLength * 0.1) { // 10% –æ—Ç –º–∞–∫—Å–∏–º—É–º–∞
                    feedback.classList.add('warning');
                } else if (remaining <= maxLength * 0.2) { // 20% –æ—Ç –º–∞–∫—Å–∏–º—É–º–∞
                    feedback.classList.add('warning');
                } else {
                    feedback.classList.add('success');
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            updateCounter();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –≤–≤–æ–¥–µ
            input.addEventListener('input', updateCounter);
            input.addEventListener('paste', function() {
                setTimeout(updateCounter, 10); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å—Ç–∞–≤–∫–∏
            });
        }
    });
}
// –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã –¥–ª—è Huntflow
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã
function toggleTheme() {
    console.log('üîÑ Huntflow: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã...');
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    console.log('üìä Huntflow: –¢–µ–∫—É—â–∞—è —Ç–µ–º–∞:', currentTheme);
    console.log('üéØ Huntflow: –ù–æ–≤–∞—è —Ç–µ–º–∞:', newTheme);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—É—é —Ç–µ–º—É
    html.setAttribute('data-theme', newTheme);
    console.log('‚úÖ Huntflow: –ê—Ç—Ä–∏–±—É—Ç data-theme —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', html.getAttribute('data-theme'));
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    const root = document.documentElement;
    if (newTheme === 'dark') {
        root.style.setProperty('--color-background', '#0d1117');
        root.style.setProperty('--color-surface', '#161b22');
        root.style.setProperty('--color-text', 'var(--color-luna-400)');
        root.style.setProperty('--color-primary', 'var(--color-pink-400)');
        console.log('üåô Huntflow: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Ç–µ–º–Ω—ã–µ —Ü–≤–µ—Ç–∞');
    } else {
        root.style.setProperty('--color-background', '#ffffff');
        root.style.setProperty('--color-surface', '#ffffff');
        root.style.setProperty('--color-text', '#13343b');
        root.style.setProperty('--color-primary', 'var(--color-lime-500)');
        console.log('‚òÄÔ∏è Huntflow: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å–≤–µ—Ç–ª—ã–µ —Ü–≤–µ—Ç–∞');
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
    localStorage.setItem('theme', newTheme);
    console.log('üíæ Huntflow: –¢–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ localStorage:', localStorage.getItem('theme'));
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É
    updateThemeIcon(newTheme);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showThemeNotification(newTheme);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ —Ç–µ–º—ã
function updateThemeIcon(theme) {
    const themeIcon = document.getElementById('themeIcon');
    if (themeIcon) {
        if (theme === 'dark') {
            themeIcon.className = 'fas fa-moon';
        } else {
            themeIcon.className = 'fas fa-sun';
        }
        console.log('üé® Huntflow: –ò–∫–æ–Ω–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è —Ç–µ–º—ã:', theme);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–º–µ–Ω–µ —Ç–µ–º—ã
function showThemeNotification(theme) {
    const themeName = theme === 'dark' ? '–¢—ë–º–Ω–∞—è' : '–°–≤–µ—Ç–ª–∞—è';
    
    // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 200px;';
    
    notification.innerHTML = `
        <i class="fas fa-${theme === 'dark' ? 'moon' : 'sun'} me-2"></i>
        –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ ${themeName} —Ç–µ–º—É
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    document.body.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(function() {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Huntflow: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —Ç–µ–º—ã...');
    
    // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é
    const savedTheme = localStorage.getItem('theme');
    const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    const theme = savedTheme || systemTheme;
    
    console.log('üíæ Huntflow: –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è —Ç–µ–º–∞:', savedTheme);
    console.log('üñ•Ô∏è Huntflow: –°–∏—Å—Ç–µ–º–Ω–∞—è —Ç–µ–º–∞:', systemTheme);
    console.log('üéØ Huntflow: –í—ã–±—Ä–∞–Ω–Ω–∞—è —Ç–µ–º–∞:', theme);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É
    document.documentElement.setAttribute('data-theme', theme);
    console.log('‚úÖ Huntflow: –ê—Ç—Ä–∏–±—É—Ç data-theme —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', document.documentElement.getAttribute('data-theme'));
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    const root = document.documentElement;
    if (theme === 'dark') {
        root.style.setProperty('--color-background', '#0d1117');
        root.style.setProperty('--color-surface', '#161b22');
        root.style.setProperty('--color-text', 'var(--color-luna-400)');
        root.style.setProperty('--color-primary', 'var(--color-pink-400)');
        console.log('üåô Huntflow: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Ç–µ–º–Ω—ã–µ —Ü–≤–µ—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ');
    } else {
        root.style.setProperty('--color-background', '#ffffff');
        root.style.setProperty('--color-surface', '#ffffff');
        root.style.setProperty('--color-text', '#13343b');
        root.style.setProperty('--color-primary', 'var(--color-lime-500)');
        console.log('‚òÄÔ∏è Huntflow: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å–≤–µ—Ç–ª—ã–µ —Ü–≤–µ—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É
    updateThemeIcon(theme);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã
    const themeToggle = document.getElementById('themeToggle');
    console.log('üîò Huntflow: –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã –Ω–∞–π–¥–µ–Ω–∞:', themeToggle);
    if (themeToggle) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        themeToggle.removeEventListener('click', toggleTheme);
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        themeToggle.addEventListener('click', toggleTheme);
        console.log('‚úÖ Huntflow: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω');
    } else {
        console.error('‚ùå Huntflow: –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
    }
    
    // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
        if (!localStorage.getItem('theme')) {
            const newTheme = e.matches ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            updateThemeIcon(newTheme);
        }
    });
    
    console.log('‚úÖ Huntflow: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —Ç–µ–º—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
    
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    window.testThemeToggle = function() {
        console.log('üß™ Huntflow: –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã...');
        toggleTheme();
    };
});
</script>
{% endblock %}
