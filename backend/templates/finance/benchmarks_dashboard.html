{% extends 'common/base.html' %}
{% load static %}

{% block title %}–î–∞—à–±–æ—Ä–¥ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/finance.css' %}">
<style>
.dashboard-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-20);
    margin-bottom: var(--space-16);
    transition: all var(--duration-normal) var(--ease-standard);
}

.dashboard-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.stat-card {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
    color: white;
    border-radius: var(--radius-lg);
    padding: var(--space-20);
    text-align: center;
    margin-bottom: var(--space-16);
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    pointer-events: none;
}

.stat-card .stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: var(--space-4);
    position: relative;
    z-index: 1;
}

.stat-card .stat-label {
    font-size: 1rem;
    opacity: 0.9;
    position: relative;
    z-index: 1;
}

.stat-card .stat-icon {
    position: absolute;
    top: var(--space-12);
    right: var(--space-12);
    font-size: 3rem;
    opacity: 0.2;
    z-index: 0;
}

.chart-container {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-20);
    margin-bottom: var(--space-16);
}

/* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∫—Ä—É–≥–æ–≤—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ */
.chart-container.pie-chart-container {
    min-height: 350px;
    display: flex;
    flex-direction: column;
    overflow: hidden; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã—Ö–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã */
}

.chart-container.pie-chart-container canvas {
    flex: 1;
    max-height: 200px; /* –£–º–µ–Ω—å—à–∞–µ–º –≤—ã—Å–æ—Ç—É canvas, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
}

/* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ª–∏–Ω–µ–π–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ */
.chart-container.line-chart-container {
    min-height: 400px;
    display: flex;
    flex-direction: column;
    overflow: hidden; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã—Ö–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã */
}

.chart-container.line-chart-container canvas {
    flex: 1;
    max-height: 250px; /* –£–º–µ–Ω—å—à–∞–µ–º –≤—ã—Å–æ—Ç—É canvas, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
}

/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è canvas */
.chart-container canvas {
    width: 100% !important;
    height: auto !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ª–µ–≥–µ–Ω–¥—ã candlestick */
.candlestick-legend {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 8px;
    margin-bottom: 4px;
    flex-wrap: wrap;
    max-height: 30px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –ª–µ–≥–µ–Ω–¥—ã */
    overflow: hidden;
}

.candlestick-legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    color: var(--color-text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 120px;
}

.candlestick-legend-color {
    width: 12px;
    height: 2px;
    border-radius: 1px;
    flex-shrink: 0;
}

/* –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã —É –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤ */
.chart-container .chart-title {
    margin-bottom: 15px;
    flex-shrink: 0;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ */

/* –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ –≥—Ä–∞—Ñ–∏–∫–æ–≤ */
.local-filters-container {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--color-border);
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}

.local-filters-section {
    flex: 1;
    min-width: 200px;
}

.local-filters-title {
    color: var(--color-text);
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 10px;
    text-align: center;
}

.local-filters-items {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
}

.local-filter-item {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 4px 8px;
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.8rem;
}

.local-filter-item:hover {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
}

.local-filter-item.active {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
}

.local-filter-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
}


/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 768px) {
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    .local-filters-container {
        max-height: 60px; /* –£–º–µ–Ω—å—à–∞–µ–º –≤—ã—Å–æ—Ç—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        padding: 4px 0;
    }
    
    .local-filter-item {
        font-size: 0.65rem;
        padding: 1px 4px;
        max-width: 80px;
    }
    
    .local-filter-color {
        width: 4px;
        height: 4px;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –ª–∏–Ω–µ–π–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    .chart-container.line-chart-container {
        min-height: 350px; /* –£–º–µ–Ω—å—à–∞–µ–º –≤—ã—Å–æ—Ç—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    }
    
    .chart-container.line-chart-container canvas {
        max-height: 200px; /* –£–º–µ–Ω—å—à–∞–µ–º –≤—ã—Å–æ—Ç—É canvas –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    }
    
    .candlestick-legend {
        max-height: 25px; /* –£–º–µ–Ω—å—à–∞–µ–º –≤—ã—Å–æ—Ç—É –ª–µ–≥–µ–Ω–¥—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        gap: 10px;
    }
    
    .candlestick-legend-item {
        font-size: 10px;
        max-width: 100px;
    }
}

.chart-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: var(--space-16);
    color: var(--color-text);
}

.benchmark-item {
    display: flex;
    justify-content: between;
    align-items: center;
    padding: var(--space-12);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-base);
    margin-bottom: var(--space-8);
    transition: all var(--duration-normal) var(--ease-standard);
}

.benchmark-item:hover {
    background: var(--color-background);
    transform: translateX(4px);
}

.benchmark-type-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-4) var(--space-8);
    border-radius: var(--radius-full);
    font-size: 0.875rem;
    font-weight: 500;
}

.benchmark-type-badge.candidate {
    background: rgba(40, 167, 69, 0.1);
    color: var(--color-success);
}

.benchmark-type-badge.vacancy {
    background: rgba(0, 123, 255, 0.1);
    color: var(--color-primary);
}

.progress-bar-custom {
    height: 8px;
    border-radius: var(--radius-full);
    background: var(--color-border);
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-secondary) 100%);
    border-radius: var(--radius-full);
    transition: width var(--duration-normal) var(--ease-standard);
}

[data-theme="dark"] .dashboard-card {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}

[data-theme="dark"] .dashboard-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

[data-theme="dark"] .chart-container {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}

[data-theme="dark"] .benchmark-item {
    background: rgba(255, 255, 255, 0.03);
    border-color: rgba(255, 255, 255, 0.1);
}

[data-theme="dark"] .benchmark-item:hover {
    background: rgba(255, 255, 255, 0.08);
}

/* –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ –≥—Ä–∞—Ñ–∏–∫–æ–≤ - –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–µ —Ç–µ–≥–∏ */
.local-filters-container {
    margin-top: 8px;
    padding: 8px 0;
    border: none;
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞–µ—Ç—Å—è */
    min-height: 40px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    max-height: 80px; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞, —á—Ç–æ–±—ã –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç–æ—á–∫–∏ */
    overflow-y: auto; /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞, –µ—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –º–Ω–æ–≥–æ */
}

.local-filters-items {
    display: flex;
    flex-wrap: wrap;
    gap: 3px;
    justify-content: center;
    align-items: center;
}

.local-filter-item {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 2px 6px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.15s ease;
    font-size: 0.7rem;
    color: #495057;
    line-height: 1;
    font-weight: 400;
    white-space: nowrap;
    user-select: none;
    max-width: 100px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
    overflow: hidden;
    text-overflow: ellipsis;
}

.local-filter-item:hover {
    background: #e9ecef;
    border-color: #adb5bd;
    transform: translateY(-1px);
}

.local-filter-item.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
}

.local-filter-item.active:hover {
    background: #0056b3;
    border-color: #0056b3;
}

.local-filter-color {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    flex-shrink: 0;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.local-filter-item.active .local-filter-color {
    border-color: rgba(255, 255, 255, 0.5);
}

/* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
[data-theme="dark"] .local-filter-item {
    background: #343a40;
    border-color: #495057;
    color: #f8f9fa;
}

[data-theme="dark"] .local-filter-item:hover {
    background: #495057;
    border-color: #6c757d;
}

[data-theme="dark"] .local-filter-item.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

[data-theme="dark"] .local-filter-item.active:hover {
    background: #0056b3;
    border-color: #0056b3;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–ª–ª–∞–ø—Å–∏—Ä—É—é—â–µ–≥–æ –±–ª–æ–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
.collapse-icon {
    transition: transform 0.3s ease;
    font-size: 0.9rem;
    color: #6c757d;
}

.collapsed .collapse-icon {
    transform: rotate(-90deg);
}

.card-header .btn-link {
    text-decoration: none;
    color: inherit;
}

.card-header .btn-link:hover {
    text-decoration: none;
    color: inherit;
}

.card-header .btn-link:focus {
    box-shadow: none;
    text-decoration: none;
    color: inherit;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è collapse */
.collapse {
    transition: height 0.3s ease;
}

/* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∫–æ–ª–ª–∞–ø—Å–∏—Ä—É—é—â–µ–≥–æ –±–ª–æ–∫–∞ */
[data-theme="dark"] .collapse-icon {
    color: #adb5bd;
}

[data-theme="dark"] .card-header .btn-link {
    color: var(--color-text);
}

[data-theme="dark"] .card-header .btn-link:hover {
    color: var(--color-text);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è tokenfield (–º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä —Ñ–∏–ª—å—Ç—Ä–æ–≤) - –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ applicant_edit.html */
.tokenfield-container {
    position: relative;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    background: #fff;
    min-height: 38px;
    padding: 4px 8px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 4px;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.tokenfield-container:focus-within {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.selected-tags {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 4px;
    flex: 1;
}

.tag-token {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 6px;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

.tag-token:hover {
    transform: scale(1.02);
}

.tag-token.removing {
    opacity: 0;
    transform: scale(0.8);
}

.tag-token .btn-close {
    background: none;
    border: none;
    color: inherit;
    opacity: 0.5;
    font-size: 0.75rem;
    padding: 0;
    margin-left: 4px;
    cursor: pointer;
    transition: opacity 0.2s ease;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.tag-token .btn-close:hover {
    opacity: 1;
}

.tag-token .btn-close::before {
    content: '√ó';
    font-size: 14px;
    font-weight: bold;
}

.tag-input {
    border: none;
    outline: none;
    background: transparent;
    color: #212529;
    font-size: 0.875rem;
    padding: 4px 8px;
    min-width: 120px;
    flex: 1;
}

.tag-input::placeholder {
    color: #6c757d;
}

.tag-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    max-height: 200px;
    overflow-y: auto;
    z-index: 1050;
    margin-top: 2px;
}

.tag-option {
    padding: 8px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: background-color 0.15s ease-in-out;
}

.tag-option:hover {
    background-color: #f8f9fa;
}

.tag-option:first-child {
    border-radius: 0.375rem 0.375rem 0 0;
}

.tag-option:last-child {
    border-radius: 0 0 0.375rem 0.375rem;
}

/* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è tokenfield */
[data-theme="dark"] .tokenfield-container {
    background: #212529;
    border-color: #495057;
    color: #f8f9fa;
}

[data-theme="dark"] .tokenfield-container:focus-within {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

[data-theme="dark"] .tag-input {
    color: #f8f9fa;
}

[data-theme="dark"] .tag-input::placeholder {
    color: #adb5bd;
}

[data-theme="dark"] .tag-dropdown {
    background: #212529;
    border-color: #495057;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.3);
}

[data-theme="dark"] .tag-option:hover {
    background-color: #343a40;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-chart-line me-2"></i>
                        –î–∞—à–±–æ—Ä–¥ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤
                    </h1>
                    <p class="text-muted mb-0">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã–º –±–µ–Ω—á–º–∞—Ä–∫–∞–º</p>
                </div>
                <div class="btn-group">
                    <a href="{% url 'finance:benchmarks_list' %}" class="btn btn-primary">
                        <i class="fas fa-list me-2"></i>–í—Å–µ –±–µ–Ω—á–º–∞—Ä–∫–∏
                    </a>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createBenchmarkModal">
                        <i class="fas fa-plus me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫
                    </button>
                    <a href="{% url 'finance:hh_analysis_dashboard' %}" class="btn btn-info">
                        <i class="fas fa-external-link-alt me-2"></i>–ê–Ω–∞–ª–∏–∑ hh.ru
                    </a>
                    <a href="{% url 'finance:ai_analysis_dashboard' %}" class="btn btn-warning">
                        <i class="fas fa-brain me-2"></i>–ò–ò –ê–Ω–∞–ª–∏–∑
                    </a>
                </div>
            </div>


            <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-number">{{ total_benchmarks }}</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);">
                        <div class="stat-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="stat-number">{{ candidate_count }}</div>
                        <div class="stat-label">–ö–∞–Ω–¥–∏–¥–∞—Ç—ã</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);">
                        <div class="stat-icon">
                            <i class="fas fa-briefcase"></i>
                        </div>
                        <div class="stat-number">{{ vacancy_count }}</div>
                        <div class="stat-label">–í–∞–∫–∞–Ω—Å–∏–∏</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-number">${{ avg_amount|floatformat:0 }}</div>
                        <div class="stat-label">–°—Ä–µ–¥–Ω—è—è –∑–∞—Ä–ø–ª–∞—Ç–∞</div>
                    </div>
                </div>
            </div>

            <!-- –ö–æ–ª–ª–∞–ø—Å–∏—Ä—É—é—â–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <button class="btn btn-link p-0 w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#mainFiltersCollapse" aria-expanded="false" aria-controls="mainFiltersCollapse">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title mb-0">
                                            <i class="fas fa-filter me-2"></i>
                                            –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
                                        </h5>
                                        <p class="card-subtitle text-muted mb-0">–ü—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ –≤—Å–µ–º –≥—Ä–∞—Ñ–∏–∫–∞–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</p>
                                    </div>
                                    <i class="fas fa-chevron-down collapse-icon"></i>
                                </div>
                            </button>
                        </div>
                        <div class="collapse" id="mainFiltersCollapse">
                            <div class="card-body">
                                <!-- –§–∏–ª—å—Ç—Ä –ø–æ –≥—Ä–µ–π–¥–∞–º -->
                                <div class="mb-3">
                                    <label class="form-label"><strong>–ì—Ä–µ–π–¥—ã:</strong></label>
                                    <div class="tokenfield-container">
                                        <div class="selected-tags" id="selected-grade-tags">
                                            <input type="text" class="tag-input" id="grade-tag-input" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≥—Ä–µ–π–¥...">
                                        </div>
                                        <div class="tag-dropdown" id="grade-tag-dropdown" style="display: none;">
                                            {% for grade_id, grade_name in available_grades %}
                                            <div class="tag-option" data-tag-id="{{ grade_id }}" data-tag-name="{{ grade_name }}">
                                                <span class="badge bg-primary me-2">{{ grade_name }}</span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <div id="hidden-grade-inputs"></div>
                                    </div>
                                </div>

                                <!-- –§–∏–ª—å—Ç—Ä –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º -->
                                <div class="mb-3">
                                    <label class="form-label"><strong>–í–∞–∫–∞–Ω—Å–∏–∏:</strong></label>
                                    <div class="tokenfield-container">
                                        <div class="selected-tags" id="selected-vacancy-tags">
                                            <input type="text" class="tag-input" id="vacancy-tag-input" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤–∞–∫–∞–Ω—Å–∏—é...">
                                        </div>
                                        <div class="tag-dropdown" id="vacancy-tag-dropdown" style="display: none;">
                                            {% for vacancy_id, vacancy_name in available_vacancies %}
                                            <div class="tag-option" data-tag-id="{{ vacancy_id }}" data-tag-name="{{ vacancy_name }}">
                                                <span class="badge bg-info me-2">{{ vacancy_name }}</span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <div id="hidden-vacancy-inputs"></div>
                                    </div>
                                </div>

                                <!-- –§–∏–ª—å—Ç—Ä –ø–æ –ª–æ–∫–∞—Ü–∏—è–º -->
                                <div class="mb-3">
                                    <label class="form-label"><strong>–õ–æ–∫–∞—Ü–∏–∏:</strong></label>
                                    <div class="tokenfield-container">
                                        <div class="selected-tags" id="selected-location-tags">
                                            <input type="text" class="tag-input" id="location-tag-input" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é...">
                                        </div>
                                        <div class="tag-dropdown" id="location-tag-dropdown" style="display: none;">
                                            {% for location in available_locations %}
                                            <div class="tag-option" data-tag-id="{{ location }}" data-tag-name="{{ location }}">
                                                <span class="badge bg-success me-2">{{ location }}</span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <div id="hidden-location-inputs"></div>
                                    </div>
                                </div>

                                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="applyMainFilters()">
                                        <i class="fas fa-search me-1"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearMainFilters()">
                                        <i class="fas fa-times me-1"></i> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="dashboard-card">
                        <h5 class="chart-title">
                            <i class="fas fa-chart-bar me-2"></i>
                            –î–∏–∞–ø–∞–∑–æ–Ω –∑–∞—Ä–ø–ª–∞—Ç
                        </h5>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="h4 text-success">${{ min_amount|floatformat:0 }}</div>
                                <small class="text-muted">–ú–∏–Ω–∏–º—É–º</small>
                            </div>
                            <div class="col-4">
                                <div class="h4 text-primary">${{ avg_amount|floatformat:0 }}</div>
                                <small class="text-muted">–°—Ä–µ–¥–Ω–µ–µ</small>
                            </div>
                            <div class="col-4">
                                <div class="h4 text-warning">${{ max_amount|floatformat:0 }}</div>
                                <small class="text-muted">–ú–∞–∫—Å–∏–º—É–º</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="dashboard-card">
                        <h5 class="chart-title">
                            <i class="fas fa-balance-scale me-2"></i>
                            –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–∏–ø–æ–≤
                        </h5>
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="h4 text-success">${{ avg_candidate|floatformat:0 }}</div>
                                <small class="text-muted">–ö–∞–Ω–¥–∏–¥–∞—Ç—ã</small>
                            </div>
                            <div class="col-6">
                                <div class="h4 text-primary">${{ avg_vacancy|floatformat:0 }}</div>
                                <small class="text-muted">–í–∞–∫–∞–Ω—Å–∏–∏</small>
                            </div>
                        </div>
                        {% if total_benchmarks > 0 %}
                        <div class="mt-3">
                            <div class="d-flex justify-content-between mb-1">
                                <small>–ö–∞–Ω–¥–∏–¥–∞—Ç—ã</small>
                                <small>{{ candidate_count }}</small>
                            </div>
                            <div class="progress-bar-custom">
                                <div class="progress-fill" style="width: {% widthratio candidate_count total_benchmarks 100 %}%"></div>
                            </div>
                            <div class="d-flex justify-content-between mb-1 mt-2">
                                <small>–í–∞–∫–∞–Ω—Å–∏–∏</small>
                                <small>{{ vacancy_count }}</small>
                            </div>
                            <div class="progress-bar-custom">
                                <div class="progress-fill" style="width: {% widthratio vacancy_count total_benchmarks 100 %}%"></div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="dashboard-card">
                        <h5 class="chart-title">
                            <i class="fas fa-info-circle me-2"></i>
                            –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                        </h5>
                        <div class="row">
                            <div class="col-12 mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>–ê–∫—Ç–∏–≤–Ω—ã—Ö –±–µ–Ω—á–º–∞—Ä–∫–æ–≤:</span>
                                    <strong>{{ total_benchmarks }}</strong>
                                </div>
                            </div>
                            <div class="col-12 mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>–ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:</span>
                                    <strong class="text-success">{{ candidate_count }}</strong>
                                </div>
                            </div>
                            <div class="col-12 mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>–í–∞–∫–∞–Ω—Å–∏–π:</span>
                                    <strong class="text-primary">{{ vacancy_count }}</strong>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <span>–°—Ä–µ–¥–Ω—è—è –∑–∞—Ä–ø–ª–∞—Ç–∞:</span>
                                    <strong class="text-warning">${{ avg_amount|floatformat:0 }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –¢–æ–ø —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->


            <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
            <div class="row mb-4">
                <!-- –ö—Ä—É–≥–æ–≤–æ–π –≥—Ä–∞—Ñ–∏–∫ - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≥—Ä–µ–π–¥–∞–º -->
                <div class="col-md-4">
                    <div class="chart-container pie-chart-container">
                        <h5 class="chart-title">
                            <i class="fas fa-chart-pie me-2"></i>
                            –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≥—Ä–µ–π–¥–∞–º
                        </h5>
                        <canvas id="gradeChart"></canvas>
                        <!-- –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ –≥—Ä–µ–π–¥–∞–º -->
                        <div class="local-filters-container mt-3">
                            <div id="gradeLocalFilters" class="local-filters-items"></div>
                                </div>
                                </div>
                            </div>

                <!-- –ö—Ä—É–≥–æ–≤–æ–π –≥—Ä–∞—Ñ–∏–∫ - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º -->
                <div class="col-md-4">
                    <div class="chart-container pie-chart-container">
                        <h5 class="chart-title">
                            <i class="fas fa-chart-pie me-2"></i>
                            –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º
                        </h5>
                        <canvas id="vacancyChart"></canvas>
                        <!-- –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º -->
                        <div class="local-filters-container mt-3">
                            <div id="vacancyLocalFilters" class="local-filters-items"></div>
                            </div>
                    </div>
                </div>

                <!-- –ö—Ä—É–≥–æ–≤–æ–π –≥—Ä–∞—Ñ–∏–∫ - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º -->
                <div class="col-md-4">
                    <div class="chart-container pie-chart-container">
                        <h5 class="chart-title">
                            <i class="fas fa-chart-pie me-2"></i>
                            –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º
                        </h5>
                        <canvas id="locationChart"></canvas>
                        <!-- –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º -->
                        <div class="local-filters-container mt-3">
                            <div id="locationLocalFilters" class="local-filters-items"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ –º–µ–¥–∏–∞–Ω–Ω–æ–π –∑–∞—Ä–ø–ª–∞—Ç—ã -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="chart-container line-chart-container">
                        <h5 class="chart-title">
                            <i class="fas fa-chart-line me-2"></i>
                            –°—Ä–µ–¥–Ω—è—è –∑–∞—Ä–ø–ª–∞—Ç–∞ –ø–æ –º–µ—Å—è—Ü–∞–º
                        </h5>
                        <canvas id="medianSalaryChart"></canvas>
                        <!-- –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ª–∏–Ω–µ–π–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ -->
                        <div class="local-filters-container mt-3">
                            <div id="dataTypeFilters" class="local-filters-items">
                                <div class="local-filter-item active" data-type="candidate">
                                    <div class="local-filter-color" style="background-color: #28a745"></div>
                                    <span>–ö–∞–Ω–¥–∏–¥–∞—Ç—ã</span>
                                </div>
                                <div class="local-filter-item active" data-type="vacancy">
                                    <div class="local-filter-color" style="background-color: #007bff"></div>
                                    <span>–í–∞–∫–∞–Ω—Å–∏–∏</span>
                                </div>
                            </div>
                            </div>
                    </div>
                </div>
                
                <!-- –ì—Ä–∞—Ñ–∏–∫-—Å–≤–µ—á–∫–∏ –¥–ª—è –≤–∞–∫–∞–Ω—Å–∏–π -->
                <div class="col-md-6">
                    <div class="chart-container line-chart-container">
                        <h5 class="chart-title">
                            <i class="fas fa-chart-bar me-2"></i>
                            –ì—Ä–∞—Ñ–∏–∫-—Å–≤–µ—á–∫–∏ –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º
                        </h5>
                        <canvas id="candlestickChart" width="800" height="400"></canvas>
                        <div id="candlestickLegend" class="candlestick-legend"></div>
                        <!-- –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è candlestick –≥—Ä–∞—Ñ–∏–∫–∞ -->
                        <div class="local-filters-container mt-3">
                            <div id="candlestickDataTypeFilters" class="local-filters-items">
                                <div class="local-filter-item" data-type="vacancy">
                                    <div class="local-filter-color" style="background-color: #007bff"></div>
                                    <span>–í–∞–∫–∞–Ω—Å–∏–∏</span>
                                </div>
                            </div>
                            <!-- –§–∏–ª—å—Ç—Ä—ã –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –≤–∞–∫–∞–Ω—Å–∏—è–º –¥–ª—è candlestick -->
                            <div id="candlestickLocalFilters" class="local-filters-items"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –±–µ–Ω—á–º–∞—Ä–∫–∏ -->
            <div class="row">
                <div class="col-12">
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="chart-title mb-0">
                                <i class="fas fa-clock me-2"></i>
                                –ü–æ—Å–ª–µ–¥–Ω–∏–µ –±–µ–Ω—á–º–∞—Ä–∫–∏
                            </h5>
                            <a href="{% url 'finance:benchmarks_list' %}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-list me-1"></i>–í—Å–µ –±–µ–Ω—á–º–∞—Ä–∫–∏
                            </a>
                        </div>
                        {% if recent_benchmarks %}
                            <div class="row">
                                {% for benchmark in recent_benchmarks %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <span class="benchmark-type-badge {{ benchmark.type }}">
                                                    <i class="{{ benchmark.type_icon }}"></i>
                                                    {{ benchmark.get_type_display }}
                                                </span>
                                                <small class="text-muted">{{ benchmark.date_added|date:"d.m.Y" }}</small>
                                            </div>
                                            
                                            <h6 class="card-title mb-1">{{ benchmark.vacancy.name }}</h6>
                                            <p class="text-muted small mb-2">{{ benchmark.grade.name }}</p>
                                            
                                            <div class="h5 text-primary mb-2">{{ benchmark.amount_formatted }}</div>
                                            
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">
                                                    <i class="fas fa-map-marker-alt me-1"></i>{{ benchmark.location }}
                                                </small>
                                                <a href="{% url 'finance:benchmark_detail' benchmark.pk %}" class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-chart-line fa-3x mb-3"></i>
                                <h4>–ù–µ—Ç –±–µ–Ω—á–º–∞—Ä–∫–æ–≤</h4>
                                <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –±–µ–Ω—á–º–∞—Ä–∫ –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏–∑–∞</p>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createBenchmarkModal">
                                    <i class="fas fa-plus me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –±–µ–Ω—á–º–∞—Ä–∫–∞ -->
<div class="modal fade" id="createBenchmarkModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createBenchmarkForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="createType" class="form-label">–¢–∏–ø –±–µ–Ω—á–º–∞—Ä–∫–∞ *</label>
                            <select class="form-select" id="createType" name="type" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                                <option value="candidate">–ö–∞–Ω–¥–∏–¥–∞—Ç</option>
                                <option value="vacancy">–í–∞–∫–∞–Ω—Å–∏—è</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="createAmount" class="form-label">–°—É–º–º–∞ (USD) *</label>
                            <input type="number" class="form-control" id="createAmount" name="amount" 
                                   step="0.01" min="0" required placeholder="3000.00">
                        </div>
                        <div class="col-md-6">
                            <label for="createVacancy" class="form-label">–í–∞–∫–∞–Ω—Å–∏—è *</label>
                            <select class="form-select" id="createVacancy" name="vacancy_id" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–∫–∞–Ω—Å–∏—é</option>
                                <!-- –í–∞–∫–∞–Ω—Å–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ AJAX -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="createGrade" class="form-label">–ì—Ä–µ–π–¥ *</label>
                            <select class="form-select" id="createGrade" name="grade_id" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä–µ–π–¥</option>
                                <!-- –ì—Ä–µ–π–¥—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ AJAX -->
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="createLocation" class="form-label">–õ–æ–∫–∞—Ü–∏—è *</label>
                            <input type="text" class="form-control" id="createLocation" name="location" 
                                   required placeholder="–ú–∏–Ω—Å–∫, –ë–µ–ª–∞—Ä—É—Å—å">
                        </div>
                        <div class="col-12">
                            <label for="createNotes" class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                            <textarea class="form-control" id="createNotes" name="notes" rows="3" 
                                      placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–µ–Ω—á–º–∞—Ä–∫–µ..."></textarea>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="createIsActive" name="is_active" checked>
                                <label class="form-check-label" for="createIsActive">
                                    –ê–∫—Ç–∏–≤–µ–Ω
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –±–µ–Ω—á–º–∞—Ä–∫</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞–∫–∞–Ω—Å–∏–∏ –∏ –≥—Ä–µ–π–¥—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('createBenchmarkModal').addEventListener('show.bs.modal', function() {
        loadVacanciesAndGrades();
    });
});

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞–∫–∞–Ω—Å–∏–π –∏ –≥—Ä–µ–π–¥–æ–≤
async function loadVacanciesAndGrades() {
    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞–∫–∞–Ω—Å–∏–∏
        const vacanciesResponse = await fetch('/api/vacancies/');
        const vacancies = await vacanciesResponse.json();
        
        const vacancySelect = document.getElementById('createVacancy');
        vacancySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–∫–∞–Ω—Å–∏—é</option>';
        vacancies.forEach(vacancy => {
            vacancySelect.innerHTML += `<option value="${vacancy.id}">${vacancy.name}</option>`;
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–µ–π–¥—ã
        const gradesResponse = await fetch('/api/grades/');
        const grades = await gradesResponse.json();
        
        const gradeSelect = document.getElementById('createGrade');
        gradeSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä–µ–π–¥</option>';
        grades.forEach(grade => {
            gradeSelect.innerHTML += `<option value="${grade.id}">${grade.name}</option>`;
        });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –±–µ–Ω—á–º–∞—Ä–∫–∞
document.getElementById('createBenchmarkForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch('{% url "finance:benchmark_create" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            bootstrap.Modal.getInstance(document.getElementById('createBenchmarkModal')).hide();
            this.reset();
            location.reload();
        } else {
            showAlert('error', result.message);
        }
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–µ–Ω—á–º–∞—Ä–∫–∞');
    }
});

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showAlert(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 'alert-info';
    
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}

// –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤
function initializeCharts() {
    console.log('üîç initializeCharts –≤—ã–∑–≤–∞–Ω–∞');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
    const gradeContainer = document.getElementById('gradeLocalFilters');
    const vacancyContainer = document.getElementById('vacancyLocalFilters');
    const locationContainer = document.getElementById('locationLocalFilters');
    
    console.log('üîç –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ initializeCharts:', {
        grade: !!gradeContainer,
        vacancy: !!vacancyContainer,
        location: !!locationContainer
    });
    
    // –ü–æ–¥–∫–ª—é—á–∞–µ–º Chart.js —Å date adapter
    if (typeof Chart === 'undefined') {
        console.log('üìä –ó–∞–≥—Ä—É–∂–∞–µ–º Chart.js...');
        const script = document.createElement('script');
        script.src = '{% static "js/chart.min.js" %}';
        script.onload = function() {
            console.log('üìä Chart.js –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º date adapter...');
            // –ó–∞–≥—Ä—É–∂–∞–µ–º date adapter
            const dateAdapterScript = document.createElement('script');
            dateAdapterScript.src = '{% static "js/chartjs-adapter-date-fns.min.js" %}';
            dateAdapterScript.onload = function() {
                console.log('üìä Date adapter –∑–∞–≥—Ä—É–∂–µ–Ω, –≤—ã–∑—ã–≤–∞–µ–º createCharts...');
            createCharts();
            };
            dateAdapterScript.onerror = function() {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ date adapter');
            };
            document.head.appendChild(dateAdapterScript);
        };
        script.onerror = function() {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Chart.js');
        };
        document.head.appendChild(script);
    } else {
        console.log('üìä Chart.js —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –≤—ã–∑—ã–≤–∞–µ–º createCharts...');
        createCharts();
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∏
let gradeChart = null;
let vacancyChart = null;
let locationChart = null;
let medianSalaryChart = null;
let candlestickChart = null;

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
let originalGradeData = null;
let originalVacancyData = null;
let originalLocationData = null;
let originalCandidateData = null;
let originalVacancyData2 = null;
let originalCandlestickData = null;

// –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
function createCharts() {
    console.log('üìä –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏...');
    console.log('üîß Chart.js –¥–æ—Å—Ç—É–ø–µ–Ω:', typeof Chart !== 'undefined');
    
    // –¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞
    const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
    ];
    
    // –ö—Ä—É–≥–æ–≤–æ–π –≥—Ä–∞—Ñ–∏–∫ - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≥—Ä–µ–π–¥–∞–º
    const gradeCtx = document.getElementById('gradeChart');
    console.log('üîß Grade chart canvas:', gradeCtx);
    if (gradeCtx) {
        const gradeData = {{ grade_distribution|safe }};
        console.log('üîß Grade data:', gradeData);
        originalGradeData = gradeData; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        
        if (gradeData && gradeData.length > 0) {
            gradeChart = new Chart(gradeCtx, {
                type: 'doughnut',
                data: {
                    labels: gradeData.map(item => item.grade__name),
                    datasets: [{
                        data: gradeData.map(item => item.count),
                        backgroundColor: colors.slice(0, gradeData.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                aspectRatio: 1,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
            });
        } else {
            gradeCtx.parentElement.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-chart-pie fa-2x mb-2"></i><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p></div>';
        }
    }
    
    // –ö—Ä—É–≥–æ–≤–æ–π –≥—Ä–∞—Ñ–∏–∫ - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º
    const vacancyCtx = document.getElementById('vacancyChart');
    if (vacancyCtx) {
        const vacancyData = {{ vacancy_distribution|safe }};
        originalVacancyData = vacancyData; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        
        if (vacancyData && vacancyData.length > 0) {
            vacancyChart = new Chart(vacancyCtx, {
            type: 'doughnut',
            data: {
                labels: vacancyData.map(item => item.vacancy__name.length > 20 ? 
                    item.vacancy__name.substring(0, 20) + '...' : item.vacancy__name),
                datasets: [{
                    data: vacancyData.map(item => item.count),
                    backgroundColor: colors.slice(0, vacancyData.length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                aspectRatio: 1,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
            });
        } else {
            vacancyCtx.parentElement.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-chart-pie fa-2x mb-2"></i><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p></div>';
        }
    }
    
    // –ö—Ä—É–≥–æ–≤–æ–π –≥—Ä–∞—Ñ–∏–∫ - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º
    const locationCtx = document.getElementById('locationChart');
    if (locationCtx) {
        const locationData = {{ location_distribution|safe }};
        originalLocationData = locationData; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        
        if (locationData && locationData.length > 0) {
            locationChart = new Chart(locationCtx, {
            type: 'doughnut',
            data: {
                labels: locationData.map(item => item.location.length > 15 ? 
                    item.location.substring(0, 15) + '...' : item.location),
                datasets: [{
                    data: locationData.map(item => item.count),
                    backgroundColor: colors.slice(0, locationData.length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                aspectRatio: 1,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
            });
        } else {
            locationCtx.parentElement.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-chart-pie fa-2x mb-2"></i><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p></div>';
        }
    }
    
    // –õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ - –°—Ä–µ–¥–Ω—è—è –∑–∞—Ä–ø–ª–∞—Ç–∞ –ø–æ –º–µ—Å—è—Ü–∞–º
    const medianCtx = document.getElementById('medianSalaryChart');
    if (medianCtx) {
        const candidateData = {{ candidate_avg_by_month|safe }};
        const vacancyAvgData = {{ vacancy_avg_by_month|safe }};
        originalCandidateData = candidateData; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        originalVacancyData2 = vacancyAvgData; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        
        console.log('–î–∞–Ω–Ω—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:', candidateData);
        console.log('–î–∞–Ω–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–π:', vacancyAvgData);
        
        if (candidateData.length > 0 || vacancyAvgData.length > 0) {
            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–µ—Å—è—Ü–µ–≤
            const allMonths = new Set();
            candidateData.forEach(item => allMonths.add(item.month));
            vacancyAvgData.forEach(item => allMonths.add(item.month));
            const sortedMonths = Array.from(allMonths).sort();
            
            console.log('–û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Å—è—Ü—ã:', sortedMonths);
            
            // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
            const candidateSalaries = sortedMonths.map(month => {
                const item = candidateData.find(d => d.month === month);
                return item ? item.avg_salary : null;
            });
            
            const vacancySalaries = sortedMonths.map(month => {
                const item = vacancyAvgData.find(d => d.month === month);
                return item ? item.avg_salary : null;
            });
            
            console.log('–ó–∞—Ä–ø–ª–∞—Ç—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:', candidateSalaries);
            console.log('–ó–∞—Ä–ø–ª–∞—Ç—ã –≤–∞–∫–∞–Ω—Å–∏–π:', vacancySalaries);
            
            medianSalaryChart = new Chart(medianCtx, {
            type: 'line',
            data: {
                labels: sortedMonths.map(month => new Date(month).toLocaleDateString('ru-RU', { 
                    month: 'short', 
                    year: 'numeric' 
                })),
                datasets: [
                    {
                        label: '–ö–∞–Ω–¥–∏–¥–∞—Ç—ã',
                        data: candidateSalaries,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    },
                    {
                        label: '–í–∞–∫–∞–Ω—Å–∏–∏',
                        data: vacancySalaries,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                aspectRatio: 1,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0
                        }
                    }
                }
            }
            });
        } else {
            medianCtx.parentElement.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-chart-line fa-2x mb-2"></i><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p></div>';
        }
    }
    
    // –ì—Ä–∞—Ñ–∏–∫-—Å–≤–µ—á–∫–∏ –¥–ª—è –≤–∞–∫–∞–Ω—Å–∏–π
    const candlestickCanvas = document.getElementById('candlestickChart');
    console.log('üîß Candlestick chart canvas:', candlestickCanvas);
    if (candlestickCanvas) {
        const candlestickData = {{ vacancy_candlestick_data|safe }};
        console.log('üîß Candlestick data –≤ createCharts:', candlestickData);
        console.log('üîß –¢–∏–ø candlestick data:', typeof candlestickData);
        console.log('üîß –î–ª–∏–Ω–∞ candlestick data:', candlestickData ? candlestickData.length : 'undefined');
        originalCandlestickData = candlestickData; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        
        console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–≤–µ—á–µ–∫:', candlestickData);
        if (candlestickData && candlestickData.length > 0) {
            console.log('‚úÖ –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ candlestick, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º...');
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –º–µ—Å—è—Ü–∞–º –∏ –≤–∞–∫–∞–Ω—Å–∏—è–º
            const monthlyVacancyData = {};
            console.log('üîß –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ candlestick...');
            candlestickData.forEach((item, index) => {
                console.log(`üîß –≠–ª–µ–º–µ–Ω—Ç ${index}:`, item);
                const month = item.month;
                const vacancyName = item.vacancy__name;
                console.log(`üîß –ú–µ—Å—è—Ü: ${month}, –í–∞–∫–∞–Ω—Å–∏—è: ${vacancyName}`);
                console.log(`üîß –ó–∞—Ä–ø–ª–∞—Ç—ã: min=${item.min_salary}, median_min=${item.median_min_salary}, median_max=${item.median_max_salary}, max=${item.max_salary}`);
                
                if (!monthlyVacancyData[month]) {
                    monthlyVacancyData[month] = {};
                    console.log(`üîß –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–µ—Å—è—Ü: ${month}`);
                }
                
                monthlyVacancyData[month][vacancyName] = {
                    min_salary: item.min_salary,
                    median_min_salary: item.median_min_salary,
                    median_max_salary: item.median_max_salary,
                    max_salary: item.max_salary,
                    count: item.count,
                    vacancy_id: item.vacancy__id
                };
                console.log(`üîß –î–æ–±–∞–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è ${month}/${vacancyName}:`, monthlyVacancyData[month][vacancyName]);
            });
            
            const sortedMonths = Object.keys(monthlyVacancyData).sort();
            console.log('–û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Å—è—Ü—ã –¥–ª—è —Å–≤–µ—á–µ–∫:', sortedMonths);
            console.log('üîß monthlyVacancyData:', monthlyVacancyData);
            
            // –°–æ–∑–¥–∞–µ–º candlestick –≥—Ä–∞—Ñ–∏–∫ —Å –ø–æ–º–æ—â—å—é Chart.js
            console.log('üîß –í—ã–∑—ã–≤–∞–µ–º createChartJSCandlestickChart...');
            createChartJSCandlestickChart(candlestickCanvas, monthlyVacancyData, sortedMonths);
        } else {
            console.log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è candlestick –≥—Ä–∞—Ñ–∏–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback –¥–∞–Ω–Ω—ã–µ');
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const fallbackCandlestickData = [
                {
                    month: '2024-01',
                    vacancy__name: 'Service Manager/Sport Analyst',
                    min_salary: 4000,
                    median_min_salary: 4500,
                    median_max_salary: 5500,
                    max_salary: 6000,
                    count: 5
                },
                {
                    month: '2024-02',
                    vacancy__name: 'Service Manager/Sport Analyst',
                    min_salary: 4200,
                    median_min_salary: 4700,
                    median_max_salary: 5700,
                    max_salary: 6200,
                    count: 3
                }
            ];
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º fallback –¥–∞–Ω–Ω—ã–µ –ø–æ –º–µ—Å—è—Ü–∞–º –∏ –≤–∞–∫–∞–Ω—Å–∏—è–º
            const monthlyVacancyData = {};
            fallbackCandlestickData.forEach(item => {
                const month = item.month;
                const vacancyName = item.vacancy__name;
                
                if (!monthlyVacancyData[month]) {
                    monthlyVacancyData[month] = {};
                }
                
                monthlyVacancyData[month][vacancyName] = {
                    min_salary: item.min_salary,
                    median_min_salary: item.median_min_salary,
                    median_max_salary: item.median_max_salary,
                    max_salary: item.max_salary,
                    count: item.count,
                    vacancy_id: 1
                };
            });
            
            const sortedMonths = Object.keys(monthlyVacancyData).sort();
            console.log('üîß Fallback –¥–∞–Ω–Ω—ã–µ –¥–ª—è candlestick:', monthlyVacancyData);
            console.log('üîß Fallback –º–µ—Å—è—Ü—ã:', sortedMonths);
            
            // –°–æ–∑–¥–∞–µ–º candlestick –≥—Ä–∞—Ñ–∏–∫ —Å fallback –¥–∞–Ω–Ω—ã–º–∏
            createChartJSCandlestickChart(candlestickCanvas, monthlyVacancyData, sortedMonths);
        }
    }
    
    console.log('‚úÖ –ì—Ä–∞—Ñ–∏–∫–∏ —Å–æ–∑–¥–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ!');
    console.log('üîß –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏:', {
        gradeChart: !!gradeChart,
        vacancyChart: !!vacancyChart,
        locationChart: !!locationChart,
        medianSalaryChart: !!medianSalaryChart,
        candlestickChart: !!candlestickChart
    });
    
    // –°–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
    console.log('üîß –í—ã–∑—ã–≤–∞–µ–º createLocalFilters...');
    createLocalFilters();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
function createLocalFilters() {
    console.log('üîß createLocalFilters –≤—ã–∑–≤–∞–Ω–∞');
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ Django (—É–∂–µ —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤ JSON)
    let gradeData = {{ grade_distribution|safe }};
    let vacancyData = {{ vacancy_distribution|safe }};
    let locationData = {{ location_distribution|safe }};
    
    console.log('üìä –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤:', { gradeData, vacancyData, locationData });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø—É—Å—Ç—ã–µ –∏ –¥–æ–±–∞–≤–ª—è–µ–º fallback –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if (!gradeData || gradeData.length === 0) {
        gradeData = [
            {grade__name: 'Junior', count: 5},
            {grade__name: 'Middle', count: 8},
            {grade__name: 'Senior', count: 3}
        ];
    }
    if (!vacancyData || vacancyData.length === 0) {
        vacancyData = [
            {vacancy__name: 'Developer', count: 10},
            {vacancy__name: 'Designer', count: 4},
            {vacancy__name: 'Manager', count: 2}
        ];
    }
    if (!locationData || locationData.length === 0) {
        locationData = [
            {location: '–ú–∏–Ω—Å–∫', count: 8},
            {location: '–ú–æ—Å–∫–≤–∞', count: 5},
            {location: '–°–ü–±', count: 3}
        ];
    }
    
    
    // –°–æ–∑–¥–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –≥—Ä–µ–π–¥–∞–º
    createGradeLocalFilters(gradeData);
    
    // –°–æ–∑–¥–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º
    createVacancyLocalFilters(vacancyData);
    
    // –°–æ–∑–¥–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –ª–æ–∫–∞—Ü–∏—è–º
    createLocationLocalFilters(locationData);
    
    // –°–æ–∑–¥–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è candlestick –≥—Ä–∞—Ñ–∏–∫–∞
    const candlestickData = {{ vacancy_candlestick_data|safe }};
    console.log('üîß –î–∞–Ω–Ω—ã–µ –¥–ª—è candlestick —Ñ–∏–ª—å—Ç—Ä–æ–≤:', candlestickData);
    console.log('üîß –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö:', typeof candlestickData);
    console.log('üîß –î–ª–∏–Ω–∞ –¥–∞–Ω–Ω—ã—Ö:', candlestickData ? candlestickData.length : 'undefined');
    
    if (candlestickData && candlestickData.length > 0) {
        console.log('üîß –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ candlestick –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤...');
        // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –∏–∑ candlestick –¥–∞–Ω–Ω—ã—Ö
        const uniqueVacancies = candlestickData.reduce((acc, item) => {
            console.log('üîß –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç:', item);
            if (!acc.find(v => v.vacancy__name === item.vacancy__name)) {
                acc.push({
                    vacancy__name: item.vacancy__name,
                    count: candlestickData.filter(d => d.vacancy__name === item.vacancy__name).length
                });
            }
            return acc;
        }, []);
        
        console.log('üéØ –°–æ–∑–¥–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è candlestick —Å –¥–∞–Ω–Ω—ã–º–∏:', uniqueVacancies);
        createCandlestickLocalFilters(uniqueVacancies);
    } else {
        console.log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è candlestick —Ñ–∏–ª—å—Ç—Ä–æ–≤');
        // –î–æ–±–∞–≤–ª—è–µ–º fallback –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        console.log('üîß –î–æ–±–∞–≤–ª—è–µ–º fallback –¥–∞–Ω–Ω—ã–µ –¥–ª—è candlestick...');
        const fallbackCandlestickData = [
            {
                month: '2024-01',
                vacancy__name: 'Service Manager/Sport Analyst',
                min_salary: 4000,
                median_min_salary: 4500,
                median_max_salary: 5500,
                max_salary: 6000,
                count: 5
            },
            {
                month: '2024-02',
                vacancy__name: 'Service Manager/Sport Analyst',
                min_salary: 4200,
                median_min_salary: 4700,
                median_max_salary: 5700,
                max_salary: 6200,
                count: 3
            }
        ];
        
        const uniqueVacancies = fallbackCandlestickData.reduce((acc, item) => {
            if (!acc.find(v => v.vacancy__name === item.vacancy__name)) {
                acc.push({
                    vacancy__name: item.vacancy__name,
                    count: fallbackCandlestickData.filter(d => d.vacancy__name === item.vacancy__name).length
                });
            }
            return acc;
        }, []);
        
        console.log('üéØ –°–æ–∑–¥–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è candlestick —Å fallback –¥–∞–Ω–Ω—ã–º–∏:', uniqueVacancies);
        createCandlestickLocalFilters(uniqueVacancies);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
    initializeDataTypeFilters();
    initializeCandlestickDataTypeFilters();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
function initializeDataTypeFilters() {
    console.log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö...');
    const items = document.querySelectorAll('#dataTypeFilters .local-filter-item');
    console.log('üîß –ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö:', items.length);
    
    items.forEach((item, index) => {
        console.log(`üîß –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫ —ç–ª–µ–º–µ–Ω—Ç—É ${index}:`, item);
        item.addEventListener('click', function() {
            console.log('üñ±Ô∏è –ö–ª–∏–∫ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö:', this);
            toggleLocalFilter(this, 'dataType');
        });
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è candlestick –≥—Ä–∞—Ñ–∏–∫–∞
function createCandlestickLocalFilters(vacancyData) {
    const container = document.getElementById('candlestickLocalFilters');
    if (!container || !vacancyData) return;
    
    container.innerHTML = '';
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'];
    
    vacancyData.forEach((item, index) => {
        const color = colors[index % colors.length];
        const shortName = item.vacancy__name.length > 20 ? 
            item.vacancy__name.substring(0, 20) + '...' : 
            item.vacancy__name;
        
        const filterItem = document.createElement('div');
        filterItem.className = 'local-filter-item'; // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å active –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∫–∞–∫ –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–∞—Ö
        filterItem.setAttribute('data-vacancy', item.vacancy__name);
        filterItem.innerHTML = `
            <div class="local-filter-color" style="background-color: ${color}"></div>
            <span>${shortName}</span>
        `;
        filterItem.addEventListener('click', function() {
            console.log('üñ±Ô∏è –ö–ª–∏–∫ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É –≤–∞–∫–∞–Ω—Å–∏–∏ candlestick:', this);
            toggleCandlestickFilter(this, 'vacancy');
        });
        
        container.appendChild(filterItem);
    });
    
    console.log('‚úÖ Candlestick —Ñ–∏–ª—å—Ç—Ä—ã —Å–æ–∑–¥–∞–Ω—ã (–∫–∞–∫ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã)');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è candlestick
function initializeCandlestickDataTypeFilters() {
    console.log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è candlestick —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö...');
    const items = document.querySelectorAll('#candlestickDataTypeFilters .local-filter-item');
    console.log('üîß –ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ candlestick —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö:', items.length);
    
    items.forEach((item, index) => {
        console.log(`üîß –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫ candlestick —ç–ª–µ–º–µ–Ω—Ç—É ${index}:`, item);
        item.addEventListener('click', function() {
            console.log('üñ±Ô∏è –ö–ª–∏–∫ –ø–æ candlestick —Ñ–∏–ª—å—Ç—Ä—É —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö:', this);
            toggleCandlestickFilter(this, 'dataType');
        });
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ candlestick –≥—Ä–∞—Ñ–∏–∫–∞
function toggleCandlestickFilter(element, type) {
    console.log('üîÑ toggleCandlestickFilter –≤—ã–∑–≤–∞–Ω–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞:', element, '—Ç–∏–ø:', type);
    element.classList.toggle('active');
    console.log('‚úÖ –ö–ª–∞—Å—Å active –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω. –ê–∫—Ç–∏–≤–µ–Ω:', element.classList.contains('active'));
    
    // –°–æ–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è candlestick
    const activeFilters = {
        grades: [],
        vacancies: [],
        locations: [],
        dataTypes: []
    };
    
    // –°–æ–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è candlestick
    document.querySelectorAll('#candlestickDataTypeFilters .local-filter-item.active').forEach(item => {
        const dataType = item.getAttribute('data-type');
        if (dataType) {
            activeFilters.dataTypes.push(dataType);
        }
    });
    
    // –°–æ–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –¥–ª—è candlestick
    document.querySelectorAll('#candlestickLocalFilters .local-filter-item.active').forEach(item => {
        const vacancyName = item.getAttribute('data-vacancy');
        if (vacancyName) {
            activeFilters.vacancies.push(vacancyName);
        }
    });
    
    console.log('üìä –°–æ–±—Ä–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è candlestick:', activeFilters);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã —Ç–æ–ª—å–∫–æ –∫ candlestick –≥—Ä–∞—Ñ–∏–∫—É
    updateCandlestickChart(activeFilters);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ –≥—Ä–µ–π–¥–∞–º
function createGradeLocalFilters(gradeData) {
    const container = document.getElementById('gradeLocalFilters');
    if (!container || !gradeData) return;
    
    container.innerHTML = '';
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];
    
    gradeData.forEach((item, index) => {
        const color = colors[index % colors.length];
        const filterItem = document.createElement('div');
        filterItem.className = 'local-filter-item';
        filterItem.setAttribute('data-grade', item.grade__name);
        filterItem.innerHTML = `
            <div class="local-filter-color" style="background-color: ${color}"></div>
            <span>${item.grade__name}</span>
        `;
        filterItem.addEventListener('click', function() {
            console.log('üñ±Ô∏è –ö–ª–∏–∫ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É –≥—Ä–µ–π–¥–∞:', this);
            toggleLocalFilter(this, 'grade');
        });
        container.appendChild(filterItem);
    });
    console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ ${gradeData.length} —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è –≥—Ä–µ–π–¥–æ–≤`);
    console.log('üîç –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä gradeLocalFilters –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è:', document.getElementById('gradeLocalFilters').innerHTML);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º
function createVacancyLocalFilters(vacancyData) {
    console.log('üéØ createVacancyLocalFilters –≤—ã–∑–≤–∞–Ω–∞ —Å –¥–∞–Ω–Ω—ã–º–∏:', vacancyData);
    const container = document.getElementById('vacancyLocalFilters');
    console.log('üéØ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä vacancyLocalFilters –Ω–∞–π–¥–µ–Ω:', !!container);
    if (!container || !vacancyData) {
        console.log('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è –≤–∞–∫–∞–Ω—Å–∏–π');
        return;
    }
    
    container.innerHTML = '';
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'];
    
    vacancyData.forEach((item, index) => {
        const color = colors[index % colors.length];
        const shortName = item.vacancy__name.length > 15 ? 
            item.vacancy__name.substring(0, 15) + '...' : 
            item.vacancy__name;
        
        const filterItem = document.createElement('div');
        filterItem.className = 'local-filter-item';
        filterItem.setAttribute('data-vacancy', item.vacancy__name);
        filterItem.innerHTML = `
            <div class="local-filter-color" style="background-color: ${color}"></div>
            <span>${shortName}</span>
        `;
        filterItem.addEventListener('click', function() {
            console.log('üñ±Ô∏è –ö–ª–∏–∫ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É –≤–∞–∫–∞–Ω—Å–∏–∏:', this);
            toggleLocalFilter(this, 'vacancy');
        });
        container.appendChild(filterItem);
    });
    console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ ${vacancyData.length} —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è –≤–∞–∫–∞–Ω—Å–∏–π`);
    console.log('üîç –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä vacancyLocalFilters –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è:', document.getElementById('vacancyLocalFilters').innerHTML);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º
function createLocationLocalFilters(locationData) {
    console.log('üéØ createLocationLocalFilters –≤—ã–∑–≤–∞–Ω–∞ —Å –¥–∞–Ω–Ω—ã–º–∏:', locationData);
    const container = document.getElementById('locationLocalFilters');
    console.log('üéØ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä locationLocalFilters –Ω–∞–π–¥–µ–Ω:', !!container);
    if (!container || !locationData) {
        console.log('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è –ª–æ–∫–∞—Ü–∏–π');
        return;
    }
    
    container.innerHTML = '';
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#28a745'];
    
    locationData.forEach((item, index) => {
        const color = colors[index % colors.length];
        const shortName = item.location.length > 15 ? 
            item.location.substring(0, 15) + '...' : 
            item.location;
        
        const filterItem = document.createElement('div');
        filterItem.className = 'local-filter-item';
        filterItem.setAttribute('data-location', item.location);
        filterItem.innerHTML = `
            <div class="local-filter-color" style="background-color: ${color}"></div>
            <span>${shortName}</span>
        `;
        filterItem.addEventListener('click', function() {
            console.log('üñ±Ô∏è –ö–ª–∏–∫ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É –ª–æ–∫–∞—Ü–∏–∏:', this);
            toggleLocalFilter(this, 'location');
        });
        container.appendChild(filterItem);
    });
    console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ ${locationData.length} —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è –ª–æ–∫–∞—Ü–∏–π`);
    console.log('üîç –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä locationLocalFilters –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è:', document.getElementById('locationLocalFilters').innerHTML);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
function toggleLocalFilter(element, type) {
    console.log('üîÑ toggleLocalFilter –≤—ã–∑–≤–∞–Ω–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞:', element, '—Ç–∏–ø:', type);
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª–∞—Å—Å active
    element.classList.toggle('active');
    console.log('‚úÖ –ö–ª–∞—Å—Å active –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω. –ê–∫—Ç–∏–≤–µ–Ω:', element.classList.contains('active'));
    
    // –°–æ–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
    const activeFilters = {
        grades: [],
        vacancies: [],
        locations: [],
        dataTypes: []
    };
    
    // –°–æ–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä–µ–π–¥—ã
    document.querySelectorAll('#gradeLocalFilters .local-filter-item.active').forEach(item => {
        const gradeName = item.getAttribute('data-grade');
        if (gradeName) {
            activeFilters.grades.push(gradeName);
        }
    });
    
    // –°–æ–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏
    document.querySelectorAll('#vacancyLocalFilters .local-filter-item.active').forEach(item => {
        const vacancyName = item.getAttribute('data-vacancy');
        if (vacancyName) {
            activeFilters.vacancies.push(vacancyName);
        }
    });
    
    // –°–æ–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ª–æ–∫–∞—Ü–∏–∏
    document.querySelectorAll('#locationLocalFilters .local-filter-item.active').forEach(item => {
        const locationName = item.getAttribute('data-location');
        if (locationName) {
            activeFilters.locations.push(locationName);
        }
    });
    
    // –°–æ–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
    document.querySelectorAll('#dataTypeFilters .local-filter-item.active').forEach(item => {
        const dataType = item.getAttribute('data-type');
        if (dataType) {
            activeFilters.dataTypes.push(dataType);
        }
    });
    
    console.log('üìä –°–æ–±—Ä–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:', activeFilters);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∫ –≥—Ä–∞—Ñ–∏–∫–∞–º
    applyLocalFiltersToCharts(activeFilters);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∫ –≥—Ä–∞—Ñ–∏–∫–∞–º
function applyLocalFiltersToCharts(filters) {
    console.log('üîÑ applyLocalFiltersToCharts –≤—ã–∑–≤–∞–Ω–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏:', filters);
    
    // –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const unifiedData = getUnifiedFilteredData(filters);
    console.log('üìä –ü–æ–ª—É—á–µ–Ω—ã –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', unifiedData);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏ —Å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    console.log('üéØ –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø–æ –≥—Ä–µ–π–¥–∞–º...');
    updateGradeChart(filters);
    
    console.log('üéØ –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º...');
    updateVacancyChart(filters);
    
    console.log('üéØ –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º...');
    updateLocationChart(filters);
    
    console.log('üéØ –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫...');
    updateMedianSalaryChart(filters);
    
    console.log('üéØ –û–±–Ω–æ–≤–ª—è–µ–º candlestick –≥—Ä–∞—Ñ–∏–∫...');
    updateCandlestickChart(filters);
    
    console.log('‚úÖ –í—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
function getUnifiedFilteredData(filters) {
    console.log('–ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏:', filters);
    
    // –ó–¥–µ—Å—å –º—ã –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Django view —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    // –ü–æ–∫–∞ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∏—Ö –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
    let filteredData = {
        grades: originalGradeData || [],
        vacancies: originalVacancyData || [],
        locations: originalLocationData || [],
        candidates: originalCandidateData || [],
        vacancySalaries: originalVacancyData2 || [],
        candlestick: originalCandlestickData || []
    };
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –≥—Ä–µ–π–¥–∞–º –∫–æ –≤—Å–µ–º –¥–∞–Ω–Ω—ã–º
    if (filters.grades.length > 0) {
        // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –≥—Ä–µ–π–¥–∞–º
        // –≠—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏, —Ç–∞–∫ –∫–∞–∫ –Ω—É–∂–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ —Å–≤—è–∑–∞–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º
        console.log('–§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –≥—Ä–µ–π–¥–∞–º:', filters.grades);
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º –∫–æ –≤—Å–µ–º –¥–∞–Ω–Ω—ã–º
    if (filters.vacancies.length > 0) {
        filteredData.vacancies = filteredData.vacancies.filter(item => 
            filters.vacancies.includes(item.vacancy__name)
        );
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º candlestick –¥–∞–Ω–Ω—ã–µ –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º
        filteredData.candlestick = filteredData.candlestick.filter(item => 
            filters.vacancies.includes(item.vacancy__name)
        );
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –ª–æ–∫–∞—Ü–∏—è–º –∫–æ –≤—Å–µ–º –¥–∞–Ω–Ω—ã–º
    if (filters.locations.length > 0) {
        filteredData.locations = filteredData.locations.filter(item => 
            filters.locations.includes(item.location)
        );
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —Ç–∏–ø–∞–º –¥–∞–Ω–Ω—ã—Ö
    if (filters.dataTypes.length > 0) {
        if (!filters.dataTypes.includes('candidate')) {
            filteredData.candidates = [];
        }
        if (!filters.dataTypes.includes('vacancy')) {
            filteredData.vacancySalaries = [];
            filteredData.candlestick = [];
        }
    }
    
    return filteredData;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ –≥—Ä–µ–π–¥–∞–º
function updateGradeChart(filters) {
    console.log('üîÑ updateGradeChart –≤—ã–∑–≤–∞–Ω–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏:', filters);
    
    if (!gradeChart || !originalGradeData) {
        console.log('‚ùå gradeChart –∏–ª–∏ originalGradeData –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        return;
    }
    
    let filteredData = originalGradeData;
    console.log('üìä –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≥—Ä–µ–π–¥–æ–≤:', originalGradeData);
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º –≥—Ä–µ–π–¥–∞–º
    if (filters.grades.length > 0) {
        filteredData = originalGradeData.filter(item => 
            filters.grades.includes(item.grade__name)
        );
        console.log('üîç –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≥—Ä–µ–π–¥–æ–≤:', filteredData);
    } else {
        console.log('‚ÑπÔ∏è –ù–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ –≥—Ä–µ–π–¥–∞–º, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞
    gradeChart.data.labels = filteredData.map(item => item.grade__name);
    gradeChart.data.datasets[0].data = filteredData.map(item => item.count);
    gradeChart.data.datasets[0].backgroundColor = filteredData.map((item, index) => {
        const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];
        return colors[index % colors.length];
    });
    
    console.log('üé® –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –≥—Ä–µ–π–¥–æ–≤ —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏');
    gradeChart.update();
    console.log('‚úÖ –ì—Ä–∞—Ñ–∏–∫ –≥—Ä–µ–π–¥–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω!');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º
function updateVacancyChart(filters) {
    if (!vacancyChart || !originalVacancyData) return;
    
    let filteredData = originalVacancyData;
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º –≤–∞–∫–∞–Ω—Å–∏—è–º
    if (filters.vacancies.length > 0) {
        filteredData = originalVacancyData.filter(item => 
            filters.vacancies.includes(item.vacancy__name)
        );
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞
    vacancyChart.data.labels = filteredData.map(item => 
        item.vacancy__name.length > 20 ? 
        item.vacancy__name.substring(0, 20) + '...' : 
        item.vacancy__name
    );
    vacancyChart.data.datasets[0].data = filteredData.map(item => item.count);
    vacancyChart.data.datasets[0].backgroundColor = filteredData.map((item, index) => {
        const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'];
        return colors[index % colors.length];
    });
    
    vacancyChart.update();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º
function updateLocationChart(filters) {
    if (!locationChart || !originalLocationData) return;
    
    let filteredData = originalLocationData;
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º –ª–æ–∫–∞—Ü–∏—è–º
    if (filters.locations.length > 0) {
        filteredData = originalLocationData.filter(item => 
            filters.locations.includes(item.location)
        );
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞
    locationChart.data.labels = filteredData.map(item => 
        item.location.length > 15 ? 
        item.location.substring(0, 15) + '...' : 
        item.location
    );
    locationChart.data.datasets[0].data = filteredData.map(item => item.count);
    locationChart.data.datasets[0].backgroundColor = filteredData.map((item, index) => {
        const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#28a745'];
        return colors[index % colors.length];
    });
    
    locationChart.update();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–∏–Ω–µ–π–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
function updateMedianSalaryChart(filters) {
    if (!medianSalaryChart || !originalCandidateData || !originalVacancyData2) return;
    
    let candidateData = originalCandidateData;
    let vacancyData = originalVacancyData2;
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–∏–ø–∞–º –¥–∞–Ω–Ω—ã—Ö
    if (filters.dataTypes.length > 0) {
        if (!filters.dataTypes.includes('candidate')) {
            candidateData = [];
        }
        if (!filters.dataTypes.includes('vacancy')) {
            vacancyData = [];
        }
    }
    
    // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–µ—Å—è—Ü–µ–≤
    const allMonths = new Set();
    candidateData.forEach(item => allMonths.add(item.month));
    vacancyData.forEach(item => allMonths.add(item.month));
    const sortedMonths = Array.from(allMonths).sort();
    
    // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    const candidateSalaries = sortedMonths.map(month => {
        const item = candidateData.find(d => d.month === month);
        return item ? item.avg_salary : null;
    });
    
    const vacancySalaries = sortedMonths.map(month => {
        const item = vacancyData.find(d => d.month === month);
        return item ? item.avg_salary : null;
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞
    medianSalaryChart.data.labels = sortedMonths.map(month => 
        new Date(month).toLocaleDateString('ru-RU', { 
            month: 'short', 
            year: 'numeric' 
        })
    );
    
    // –û–±–Ω–æ–≤–ª—è–µ–º datasets
    medianSalaryChart.data.datasets[0].data = candidateSalaries;
    medianSalaryChart.data.datasets[0].hidden = candidateData.length === 0;
    
    medianSalaryChart.data.datasets[1].data = vacancySalaries;
    medianSalaryChart.data.datasets[1].hidden = vacancyData.length === 0;
    
    medianSalaryChart.update();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è candlestick –≥—Ä–∞—Ñ–∏–∫–∞
function updateCandlestickChart(filters) {
    if (!candlestickChart || !originalCandlestickData) return;
    
    let filteredData = originalCandlestickData;
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º –≤–∞–∫–∞–Ω—Å–∏—è–º
    if (filters.vacancies.length > 0) {
        filteredData = originalCandlestickData.filter(item => 
            filters.vacancies.includes(item.vacancy__name)
        );
    }
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–∏–ø–∞–º –¥–∞–Ω–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ –≤–∞–∫–∞–Ω—Å–∏–∏ –¥–ª—è candlestick)
    if (filters.dataTypes.length > 0 && !filters.dataTypes.includes('vacancy')) {
        filteredData = [];
    }
    
    // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    if (filteredData.length > 0) {
        const monthlyVacancyData = {};
        filteredData.forEach(item => {
            const month = item.month;
            const vacancyName = item.vacancy__name;
            
            if (!monthlyVacancyData[month]) {
                monthlyVacancyData[month] = {};
            }
            
            monthlyVacancyData[month][vacancyName] = {
                min_salary: item.min_salary,
                median_min_salary: item.median_min_salary,
                median_max_salary: item.median_max_salary,
                max_salary: item.max_salary,
                count: item.count,
                vacancy_id: item.vacancy__id
            };
        });
        
        const sortedMonths = Object.keys(monthlyVacancyData).sort();
        
        // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å Chart.js
        const canvas = document.getElementById('candlestickChart');
        if (candlestickChart) {
            candlestickChart.destroy();
        }
        
        createChartJSCandlestickChart(canvas, monthlyVacancyData, sortedMonths);
    } else {
        // –û—á–∏—â–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
        if (candlestickChart) {
            candlestickChart.destroy();
            candlestickChart = null;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö
        const canvas = document.getElementById('candlestickChart');
        if (canvas) {
            canvas.parentElement.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-chart-bar fa-2x mb-2"></i><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p></div>';
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –º–µ–¥–∏–∞–Ω—ã –º–∞—Å—Å–∏–≤–∞
function median(arr) {
    if (arr.length === 0) return 0;
    const sorted = [...arr].sort((a, b) => a - b);
    const mid = Math.floor(sorted.length / 2);
    if (sorted.length % 2 === 0) {
        return (sorted[mid - 1] + sorted[mid]) / 2;
    } else {
        return sorted[mid];
    }
}

// –§—É–Ω–∫—Ü–∏—è –º–∞–ø–ø–∏–Ω–≥–∞ –∑–Ω–∞—á–µ–Ω–∏–π –∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
function mapValueToY(value, minValue, maxValue, height, padding) {
    if (maxValue === minValue) return height / 2;
    const scale = (height - 2 * padding) / (maxValue - minValue);
    return height - padding - (value - minValue) * scale;
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ candlestick –≥—Ä–∞—Ñ–∏–∫–∞
function createCandlestickChart(canvas, monthlyVacancyData, sortedMonths) {
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
    const padding = 60; // –û—Ç—Å—Ç—É–ø—ã —Å–≤–µ—Ä—Ö—É, —Å–Ω–∏–∑—É –∏ –ø–æ –±–æ–∫–∞–º
    const candleWidth = 20; // –®–∏—Ä–∏–Ω–∞ —Å–≤–µ—á–∏
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –∏ –∏—Ö –¥–∞–Ω–Ω—ã–µ
    const allVacancies = new Set();
    const allMinValues = [];
    const allMaxValues = [];
    
    sortedMonths.forEach(month => {
        Object.keys(monthlyVacancyData[month]).forEach(vacancy => {
            allVacancies.add(vacancy);
            const data = monthlyVacancyData[month][vacancy];
            allMinValues.push(data.min_salary);
            allMaxValues.push(data.max_salary);
        });
    });
    
    const allVacanciesArray = Array.from(allVacancies);
    
    // –í—ã—á–∏—Å–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –º–∏–Ω–∏–º—É–º –∏ –º–∞–∫—Å–∏–º—É–º –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
    // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 0
    const globalMin = 0;
    const globalMax = Math.max(...allMaxValues);
    
    console.log('–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:', { globalMin, globalMax });
    console.log('–í—Å–µ –≤–∞–∫–∞–Ω—Å–∏–∏:', allVacanciesArray);
    console.log('–î–∞–Ω–Ω—ã–µ –ø–æ –º–µ—Å—è—Ü–∞–º:', monthlyVacancyData);
    console.log('–û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Å—è—Ü—ã:', sortedMonths);
    
    // –û—á–∏—Å—Ç–∫–∞ –∫–∞–Ω–≤–∞—Å–∞
    ctx.clearRect(0, 0, width, height);
    
    // –¶–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#28a745'];
    
    // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É –∏ –ø–æ–¥–ø–∏—Å–∏
    drawGrid(ctx, width, height, padding, globalMin, globalMax);
    
    // –†–∏—Å—É–µ–º —Å–≤–µ—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞
    const monthWidth = (width - 2 * padding) / sortedMonths.length;
    console.log('üìè –†–∞–∑–º–µ—Ä—ã:', { monthWidth, candleWidth, width, padding });
    
    sortedMonths.forEach((month, monthIndex) => {
        const monthData = monthlyVacancyData[month];
        const xCenter = padding + monthIndex * monthWidth + monthWidth / 2;
        
        // –ü–æ–¥–ø–∏—Å—å –º–µ—Å—è—Ü–∞
        ctx.fillStyle = '#666';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        const monthLabel = new Date(month).toLocaleDateString('ru-RU', { 
            month: 'short', 
            year: '2-digit' 
        });
        ctx.fillText(monthLabel, xCenter, height - 10);
        
        // –†–∏—Å—É–µ–º —Å–≤–µ—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ
        const vacancies = Object.keys(monthData);
        const candleSpacing = candleWidth * 1.5;
        const startX = xCenter - (vacancies.length - 1) * candleSpacing / 2;
        
        vacancies.forEach((vacancyName, vacancyIndex) => {
            const data = monthData[vacancyName];
            const color = colors[vacancyIndex % colors.length];
            const x = startX + vacancyIndex * candleSpacing;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            const yMax = mapValueToY(data.max_salary, globalMin, globalMax, height, padding);
            const yMin = mapValueToY(data.min_salary, globalMin, globalMax, height, padding);
            const yMedianMax = mapValueToY(data.median_max_salary, globalMin, globalMax, height, padding);
            const yMedianMin = mapValueToY(data.median_min_salary, globalMin, globalMax, height, padding);
            
            // –†–∏—Å—É–µ–º —Ñ–∏—Ç–∏–ª—å (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –æ—Ç –º–∏–Ω –¥–æ –º–∞–∫—Å)
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x, yMin);
            ctx.lineTo(x, yMax);
            ctx.stroke();
            
            // –†–∏—Å—É–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ –ø–æ–ª–µ –º–µ–∂–¥—É –º–µ–¥–∏–∞–Ω–∞–º–∏
            const fillHeight = yMedianMin - yMedianMax;
            if (fillHeight > 0) {
                // –ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ –ø–æ–ª–µ —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
                ctx.fillStyle = color + '40'; // 40 = 25% –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏
                ctx.fillRect(x - candleWidth/2, yMedianMax, candleWidth, fillHeight);
                
                // –ì—Ä–∞–Ω–∏—Ü—ã –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—è
                ctx.strokeStyle = color;
                ctx.lineWidth = 1;
                ctx.strokeRect(x - candleWidth/2, yMedianMax, candleWidth, fillHeight);
            }
            
            // –†–∏—Å—É–µ–º –º–µ–¥–∏–∞–Ω—É –º–∞–∫—Å–∏–º—É–º–æ–≤ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è)
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(x - candleWidth/2, yMedianMax);
            ctx.lineTo(x + candleWidth/2, yMedianMax);
            ctx.stroke();
            
            // –†–∏—Å—É–µ–º –º–µ–¥–∏–∞–Ω—É –º–∏–Ω–∏–º—É–º–æ–≤ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è)
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(x - candleWidth/2, yMedianMin);
            ctx.lineTo(x + candleWidth/2, yMedianMin);
            ctx.stroke();
            
            // –†–∏—Å—É–µ–º –º–∞–∫—Å–∏–º—É–º (—Ç–æ—á–∫–∞)
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, yMax, 4, 0, 2 * Math.PI);
            ctx.fill();
            
            // –†–∏—Å—É–µ–º –º–∏–Ω–∏–º—É–º (—Ç–æ—á–∫–∞)
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, yMin, 4, 0, 2 * Math.PI);
            ctx.fill();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å –≤–∞–∫–∞–Ω—Å–∏–∏ (—Å–æ–∫—Ä–∞—â–µ–Ω–Ω—É—é)
            ctx.fillStyle = color;
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            const shortName = vacancyName.length > 12 ? vacancyName.substring(0, 12) + '...' : vacancyName;
            ctx.fillText(shortName, x, yMax - 15);
        });
    });
    
    // –°–æ–∑–¥–∞–µ–º –ª–µ–≥–µ–Ω–¥—É
    createCandlestickLegend(allVacanciesArray, colors);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–æ—á–∫–µ
    canvas.addEventListener('mousemove', function(event) {
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        
        console.log('üñ±Ô∏è Mouse move –Ω–∞ candlestick:', { x, y, padding, width, height });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –º—ã—à—å –≤ –æ–±–ª–∞—Å—Ç–∏ –≥—Ä–∞—Ñ–∏–∫–∞
        if (x >= padding && x <= width - padding && y >= padding && y <= height - padding) {
            console.log('‚úÖ –ú—ã—à—å –≤ –æ–±–ª–∞—Å—Ç–∏ –≥—Ä–∞—Ñ–∏–∫–∞');
            // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é —Å–≤–µ—á—É
            const monthIndex = Math.floor((x - padding) / monthWidth);
            console.log('üîç monthIndex:', monthIndex, 'sortedMonths.length:', sortedMonths.length);
            
            if (monthIndex >= 0 && monthIndex < sortedMonths.length) {
                const month = sortedMonths[monthIndex];
                const monthData = monthlyVacancyData[month];
                const xCenter = padding + monthIndex * monthWidth + monthWidth / 2;
                
                console.log('üìÖ –ú–µ—Å—è—Ü:', month, 'monthData:', monthData, 'xCenter:', xCenter);
                
                // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é –≤–∞–∫–∞–Ω—Å–∏—é
                const vacancies = Object.keys(monthData);
                const candleSpacing = candleWidth * 1.5;
                const startX = xCenter - (vacancies.length - 1) * candleSpacing / 2;
                
                console.log('üè¢ –í–∞–∫–∞–Ω—Å–∏–∏:', vacancies, 'candleSpacing:', candleSpacing, 'startX:', startX);
                
                let closestVacancy = null;
                let minDistance = Infinity;
                
                vacancies.forEach((vacancyName, vacancyIndex) => {
                    const vacancyX = startX + vacancyIndex * candleSpacing;
                    const distance = Math.abs(x - vacancyX);
                    console.log(`üéØ –í–∞–∫–∞–Ω—Å–∏—è ${vacancyName}: vacancyX=${vacancyX}, distance=${distance}, candleWidth=${candleWidth}`);
                    
                    if (distance < minDistance && distance < candleWidth) {
                        minDistance = distance;
                        closestVacancy = {
                            name: vacancyName,
                            data: monthData[vacancyName],
                            color: colors[vacancyIndex % colors.length],
                            x: vacancyX
                        };
                        console.log('‚úÖ –ù–æ–≤–∞—è –±–ª–∏–∂–∞–π—à–∞—è –≤–∞–∫–∞–Ω—Å–∏—è:', closestVacancy);
                    }
                });
                
                if (closestVacancy) {
                    console.log('üéØ –ù–∞–π–¥–µ–Ω–∞ –±–ª–∏–∂–∞–π—à–∞—è –≤–∞–∫–∞–Ω—Å–∏—è:', closestVacancy);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º tooltip —Å –¥–∞–Ω–Ω—ã–º–∏
                    showCandlestickTooltip(event.clientX, event.clientY, closestVacancy, month);
                } else {
                    console.log('‚ùå –ë–ª–∏–∂–∞–π—à–∞—è –≤–∞–∫–∞–Ω—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }
            } else {
                console.log('‚ùå –ú–µ—Å—è—Ü –Ω–µ –Ω–∞–π–¥–µ–Ω, monthIndex:', monthIndex);
            }
        } else {
            console.log('‚ùå –ú—ã—à—å –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏ –≥—Ä–∞—Ñ–∏–∫–∞');
        }
    });
    
    canvas.addEventListener('mouseleave', function() {
        hideCandlestickTooltip();
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è —Å–µ—Ç–∫–∏
function drawGrid(ctx, width, height, padding, globalMin, globalMax) {
    // –†–∏—Å—É–µ–º –æ—Å—å Y
    ctx.strokeStyle = '#ddd';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, height - padding);
    ctx.stroke();
    
    // –†–∏—Å—É–µ–º –æ—Å—å X
    ctx.beginPath();
    ctx.moveTo(padding, height - padding);
    ctx.lineTo(width - padding, height - padding);
    ctx.stroke();
    
    // –ü–æ–¥–ø–∏—Å–∏ –Ω–∞ –æ—Å–∏ Y
    const steps = 5;
    for (let i = 0; i <= steps; i++) {
        const value = globalMin + (globalMax - globalMin) * i / steps;
        const y = mapValueToY(value, globalMin, globalMax, height, padding);
        
        ctx.strokeStyle = '#ddd';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padding - 5, y);
        ctx.lineTo(padding, y);
        ctx.stroke();
        
        ctx.fillStyle = '#666';
        ctx.font = '10px Arial';
        ctx.textAlign = 'right';
        ctx.fillText('$' + Math.round(value).toLocaleString(), padding - 10, y + 3);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ª–µ–≥–µ–Ω–¥—ã
function createCandlestickLegend(vacancies, colors) {
    const legendContainer = document.getElementById('candlestickLegend');
    if (!legendContainer) return;
    
    legendContainer.innerHTML = '';
    
    vacancies.forEach((vacancyName, index) => {
        const color = colors[index % colors.length];
        const shortName = vacancyName.length > 20 ? vacancyName.substring(0, 20) + '...' : vacancyName;
        
        const legendItem = document.createElement('div');
        legendItem.className = 'candlestick-legend-item';
        legendItem.innerHTML = `
            <div class="candlestick-legend-color" style="background-color: ${color}"></div>
            <span>${shortName}</span>
        `;
        legendContainer.appendChild(legendItem);
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ tooltip —Å –¥–∞–Ω–Ω—ã–º–∏ candlestick –≥—Ä–∞—Ñ–∏–∫–∞
function showCandlestickTooltip(x, y, vacancy, month) {
    console.log('üñ±Ô∏è showCandlestickTooltip –≤—ã–∑–≤–∞–Ω–∞:', { x, y, vacancy, month });
    
    // –°–æ–∑–¥–∞–µ–º tooltip, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
    let tooltip = document.getElementById('candlestickTooltip');
    if (!tooltip) {
        console.log('üîß –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π tooltip');
        tooltip = document.createElement('div');
        tooltip.id = 'candlestickTooltip';
        tooltip.style.cssText = `
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 1000;
            pointer-events: none;
            max-width: 280px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        `;
        document.body.appendChild(tooltip);
    }
    
    const monthLabel = new Date(month).toLocaleDateString('ru-RU', { 
        month: 'long', 
        year: 'numeric' 
    });
    
    tooltip.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 8px; color: #fff; font-size: 14px;">${vacancy.name}</div>
        <div style="margin-bottom: 6px; color: #ccc; font-size: 11px;">–ü–µ—Ä–∏–æ–¥: ${monthLabel}</div>
        <div style="margin-bottom: 4px;">üìä –ú–∏–Ω: <strong>$${vacancy.data.min_salary.toLocaleString()}</strong></div>
        <div style="margin-bottom: 4px;">üìà –ú–∞–∫—Å: <strong>$${vacancy.data.max_salary.toLocaleString()}</strong></div>
        <div style="margin-bottom: 4px;">üìâ –ú–µ–¥. –º–∏–Ω: <strong>$${vacancy.data.median_min_salary.toLocaleString()}</strong></div>
        <div style="margin-bottom: 4px;">üìä –ú–µ–¥. –º–∞–∫—Å: <strong>$${vacancy.data.median_max_salary.toLocaleString()}</strong></div>
        <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.2); color: #ccc; font-size: 11px;">
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${vacancy.data.count} –∑–∞–ø–∏—Å–µ–π
        </div>
    `;
    
    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º tooltip
    tooltip.style.left = (x + 10) + 'px';
    tooltip.style.top = (y - tooltip.offsetHeight - 10) + 'px';
    tooltip.style.display = 'block';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è tooltip
function hideCandlestickTooltip() {
    console.log('üñ±Ô∏è hideCandlestickTooltip –≤—ã–∑–≤–∞–Ω–∞');
    const tooltip = document.getElementById('candlestickTooltip');
    if (tooltip) {
        tooltip.style.display = 'none';
        console.log('‚úÖ Tooltip —Å–∫—Ä—ã—Ç');
    } else {
        console.log('‚ùå Tooltip –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è');
    }
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è candlestick –≥—Ä–∞—Ñ–∏–∫–∞ —Å –ø–æ–º–æ—â—å—é Chart.js
function createChartJSCandlestickChart(canvas, monthlyVacancyData, sortedMonths) {
    console.log('üìä –°–æ–∑–¥–∞–µ–º candlestick –≥—Ä–∞—Ñ–∏–∫ —Å Chart.js');
    console.log('üîß –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ—É–Ω–∫—Ü–∏–∏:', { canvas, monthlyVacancyData, sortedMonths });
    
    if (typeof Chart === 'undefined') {
        console.error('‚ùå Chart.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
        return;
    }
    
    if (!canvas) {
        console.error('‚ùå Canvas —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
    }
    
    if (!monthlyVacancyData || Object.keys(monthlyVacancyData).length === 0) {
        console.error('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö monthlyVacancyData!');
        return;
    }
    
    if (!sortedMonths || sortedMonths.length === 0) {
        console.error('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö sortedMonths!');
        return;
    }
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏
    const allVacancies = new Set();
    sortedMonths.forEach(month => {
        Object.keys(monthlyVacancyData[month]).forEach(vacancy => {
            allVacancies.add(vacancy);
        });
    });
    
    const allVacanciesArray = Array.from(allVacancies);
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#28a745'];
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è candlestick –≥—Ä–∞—Ñ–∏–∫–∞
    const datasets = [];
    console.log('üîß –°–æ–∑–¥–∞–µ–º datasets –¥–ª—è candlestick...');
    console.log('üîß allVacanciesArray:', allVacanciesArray);
    console.log('üîß sortedMonths:', sortedMonths);
    
    allVacanciesArray.forEach((vacancyName, vacancyIndex) => {
        console.log(`üîß –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–∞–∫–∞–Ω—Å–∏—é ${vacancyIndex}: ${vacancyName}`);
        const color = colors[vacancyIndex % colors.length];
        console.log(`üîß –¶–≤–µ—Ç –¥–ª—è ${vacancyName}: ${color}`);
        
        // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏
        const data = sortedMonths.map((month, index) => {
            console.log(`üîß –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–µ—Å—è—Ü ${index}: ${month}`);
            const monthData = monthlyVacancyData[month];
            console.log(`üîß –î–∞–Ω–Ω—ã–µ –¥–ª—è –º–µ—Å—è—Ü–∞ ${month}:`, monthData);
            
            if (monthData && monthData[vacancyName]) {
                const dataPoint = {
                    y: monthData[vacancyName].median_max_salary, // –û—Å–Ω–æ–≤–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è bar
                    l: monthData[vacancyName].min_salary, // Low (–º–∏–Ω–∏–º—É–º)
                    h: monthData[vacancyName].max_salary, // High (–º–∞–∫—Å–∏–º—É–º)
                    c: monthData[vacancyName].median_max_salary, // Close (–º–µ–¥–∏–∞–Ω–Ω—ã–π –º–∞–∫—Å–∏–º—É–º)
                    count: monthData[vacancyName].count
                };
                console.log(`üîß –°–æ–∑–¥–∞–Ω–∞ —Ç–æ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è ${month}/${vacancyName}:`, dataPoint);
                return dataPoint;
            } else {
                console.log(`üîß –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è ${month}/${vacancyName}`);
                return null;
            }
        }).filter(item => item !== null);
        
        console.log(`üîß –î–∞–Ω–Ω—ã–µ –¥–ª—è ${vacancyName}:`, data);
        
        if (data.length > 0) {
            const dataset = {
                label: vacancyName,
                data: data,
                backgroundColor: color + '60',
                borderColor: color,
                borderWidth: 1,
                barThickness: 20,
                maxBarThickness: 30
            };
            console.log(`üîß –°–æ–∑–¥–∞–Ω dataset –¥–ª—è ${vacancyName}:`, dataset);
            datasets.push(dataset);
        } else {
            console.log(`üîß –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è dataset ${vacancyName}`);
        }
    });
    
    console.log('üîß –ò—Ç–æ–≥–æ–≤—ã–µ datasets:', datasets);
    
        // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π bar –≥—Ä–∞—Ñ–∏–∫ –≤–º–µ—Å—Ç–æ candlestick
        try {
            console.log('üîß –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π bar –≥—Ä–∞—Ñ–∏–∫...');
            console.log('üîß Canvas —ç–ª–µ–º–µ–Ω—Ç:', canvas);
            console.log('üîß Datasets:', datasets);
            
            candlestickChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: sortedMonths.map(month => {
                        console.log(`üîß –°–æ–∑–¥–∞–µ–º label –¥–ª—è –º–µ—Å—è—Ü–∞: ${month}`);
                        const date = new Date(month + '-01');
                        console.log(`üîß –°–æ–∑–¥–∞–Ω–Ω–∞—è –¥–∞—Ç–∞: ${date}`);
                        console.log(`üîß –î–∞—Ç–∞ –≤–∞–ª–∏–¥–Ω–∞: ${!isNaN(date.getTime())}`);
                        const label = date.toLocaleDateString('ru-RU', { month: 'short', year: 'numeric' });
                        console.log(`üîß –°–æ–∑–¥–∞–Ω–Ω—ã–π label: ${label}`);
                        return label;
                    }),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 1,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '–ú–µ—Å—è—Ü'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '–ó–∞—Ä–ø–ª–∞—Ç–∞ ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    const monthIndex = context[0].dataIndex;
                                    const month = sortedMonths[monthIndex];
                                    const date = new Date(month + '-01');
                                    return date.toLocaleDateString('ru-RU', { 
                                        month: 'long', 
                                        year: 'numeric' 
                                    });
                                },
                                label: function(context) {
                                    const raw = context.raw;
                                    return [
                                        `${context.dataset.label}:`,
                                        `–ú–∏–Ω: $${raw.l.toLocaleString()}`,
                                        `–ú–∞–∫—Å: $${raw.h.toLocaleString()}`,
                                        `–ú–µ–¥–∏–∞–Ω–∞: $${raw.c.toLocaleString()}`,
                                        `–ó–∞–ø–∏—Å–µ–π: ${raw.count}`
                                    ];
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
            
            console.log('‚úÖ Bar –≥—Ä–∞—Ñ–∏–∫ —Å–æ–∑–¥–∞–Ω —Å Chart.js');
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ bar –≥—Ä–∞—Ñ–∏–∫–∞:', error);
        }
}


// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏


// ===== –û–°–ù–û–í–ù–´–ï –§–ò–õ–¨–¢–†–´ –í –°–¢–ò–õ–ï –ú–ï–¢–û–ö =====

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
let selectedGrades = [];
let selectedVacancies = [];
let selectedLocations = [];

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±–µ–Ω—á–º–∞—Ä–∫–æ–≤
let originalBenchmarksData = [];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
function initializeMainFilters() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤...');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤
    initializeBenchmarksData();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –≥—Ä–µ–π–¥–∞–º
    initializeTokenField('grade', selectedGrades);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º
    initializeTokenField('vacancy', selectedVacancies);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –ª–æ–∫–∞—Ü–∏—è–º
    initializeTokenField('location', selectedLocations);
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –≤—Å–µ–º–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
    console.log('üìù –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –≤—Å–µ–º–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏...');
    populateAllFiltersOnStart();
    
    console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤—Å–µ–º–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
function populateAllFiltersOnStart() {
    console.log('üîß –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –≤—Å–µ–º–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ...');
    
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–∫–∞–∫ –≤ –ø–µ—Ä–≤–æ–º —Ñ–∏–ª—å—Ç—Ä–µ)
    const urlParams = new URLSearchParams(window.location.search);
    const gradesFromURL = urlParams.getAll('grades');
    const vacanciesFromURL = urlParams.getAll('vacancies');
    const locationsFromURL = urlParams.getAll('locations');
    
    console.log('üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL:', {
        grades: gradesFromURL,
        vacancies: vacanciesFromURL,
        locations: locationsFromURL
    });
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
    if (gradesFromURL.length > 0 || vacanciesFromURL.length > 0 || locationsFromURL.length > 0) {
        console.log('üéØ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ URL...');
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–µ–π–¥—ã –∏–∑ URL
        gradesFromURL.forEach(gradeId => {
            const option = document.querySelector(`#grade-tag-dropdown .tag-option[data-tag-id="${gradeId}"]`);
            if (option) {
                const tagName = option.getAttribute('data-tag-name');
                addTagToField('grade', gradeId, tagName);
            }
        });
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∞–∫–∞–Ω—Å–∏–∏ –∏–∑ URL
        vacanciesFromURL.forEach(vacancyId => {
            const option = document.querySelector(`#vacancy-tag-dropdown .tag-option[data-tag-id="${vacancyId}"]`);
            if (option) {
                const tagName = option.getAttribute('data-tag-name');
                addTagToField('vacancy', vacancyId, tagName);
            }
        });
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞—Ü–∏–∏ –∏–∑ URL
        locationsFromURL.forEach(locationId => {
            const option = document.querySelector(`#location-tag-dropdown .tag-option[data-tag-id="${locationId}"]`);
            if (option) {
                const tagName = option.getAttribute('data-tag-name');
                addTagToField('location', locationId, tagName);
            }
        });
        
        console.log('‚úÖ –§–∏–ª—å—Ç—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ URL');
    } else {
        console.log('üìù URL –ø—É—Å—Ç–æ–π, –∑–∞–ø–æ–ª–Ω—è–µ–º –≤—Å–µ–º–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏...');
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –≥—Ä–µ–π–¥–æ–≤ –≤—Å–µ–º–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≥—Ä–µ–π–¥–∞–º–∏
        const gradeOptions = document.querySelectorAll('#grade-tag-dropdown .tag-option');
        gradeOptions.forEach(option => {
            const tagId = option.getAttribute('data-tag-id');
            const tagName = option.getAttribute('data-tag-name');
            if (tagId && tagName) {
                addTagToField('grade', tagId, tagName);
            }
        });
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –≤–∞–∫–∞–Ω—Å–∏–π –≤—Å–µ–º–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≤–∞–∫–∞–Ω—Å–∏—è–º–∏
        const vacancyOptions = document.querySelectorAll('#vacancy-tag-dropdown .tag-option');
        vacancyOptions.forEach(option => {
            const tagId = option.getAttribute('data-tag-id');
            const tagName = option.getAttribute('data-tag-name');
            if (tagId && tagName) {
                addTagToField('vacancy', tagId, tagName);
            }
        });
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ª–æ–∫–∞—Ü–∏–π –≤—Å–µ–º–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –ª–æ–∫–∞—Ü–∏—è–º–∏
        const locationOptions = document.querySelectorAll('#location-tag-dropdown .tag-option');
        locationOptions.forEach(option => {
            const tagId = option.getAttribute('data-tag-id');
            const tagName = option.getAttribute('data-tag-name');
            if (tagId && tagName) {
                addTagToField('location', tagId, tagName);
            }
        });
        
        console.log('‚úÖ –í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ–º–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏');
    }
    
    // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º applyMainFilters –∑–¥–µ—Å—å, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    // –§–∏–ª—å—Ç—Ä—ã —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —á–µ—Ä–µ–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–≥–∞ –≤ –ø–æ–ª–µ
function addTagToField(type, tagId, tagName) {
    const selectedArray = type === 'grade' ? selectedGrades : 
                         type === 'vacancy' ? selectedVacancies : selectedLocations;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã–±—Ä–∞–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —Ç–µ–≥
    if (selectedArray.some(tag => tag.id === tagId)) {
        return;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤
    selectedArray.push({ id: tagId, name: tagName });
    
    // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç —Ç–µ–≥–∞
    const tagInput = document.getElementById(`${type}-tag-input`);
    const selectedTagsContainer = document.getElementById(`selected-${type}-tags`);
    
    const tagElement = document.createElement('span');
    tagElement.className = 'tag-token';
    tagElement.setAttribute('data-tag-id', tagId);
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –±–µ–π–¥–∂–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    let badgeClass = 'badge me-1';
    if (type === 'grade') badgeClass += ' bg-primary';
    else if (type === 'vacancy') badgeClass += ' bg-info';
    else if (type === 'location') badgeClass += ' bg-success';
    
    tagElement.innerHTML = `
        <span class="${badgeClass}">${tagName}</span>
        <button type="button" class="btn-close" aria-label="–£–¥–∞–ª–∏—Ç—å"></button>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
    const removeBtn = tagElement.querySelector('.btn-close');
    removeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        removeTagFromField(type, tagId);
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥–∞
    tagInput.parentNode.insertBefore(tagElement, tagInput);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
    updateHiddenInputsForField(type);
    
    // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º applyMainFilters –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - —ç—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–≥–∞ –∏–∑ –ø–æ–ª—è
function removeTagFromField(type, tagId) {
    const selectedArray = type === 'grade' ? selectedGrades : 
                         type === 'vacancy' ? selectedVacancies : selectedLocations;
    
    // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
    const index = selectedArray.findIndex(tag => tag.id === tagId);
    if (index > -1) {
        selectedArray.splice(index, 1);
    }
    
    // –ù–∞—Ö–æ–¥–∏–º –∏ —É–¥–∞–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
    const selectedTagsContainer = document.getElementById(`selected-${type}-tags`);
    const tagElement = selectedTagsContainer.querySelector(`[data-tag-id="${tagId}"]`);
    if (tagElement) {
        tagElement.classList.add('removing');
        setTimeout(() => {
            tagElement.remove();
            updateHiddenInputsForField(type);
            
            // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º applyMainFilters –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - —ç—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
        }, 200);
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π
function updateHiddenInputsForField(type) {
    const selectedArray = type === 'grade' ? selectedGrades : 
                         type === 'vacancy' ? selectedVacancies : selectedLocations;
    const hiddenInputsContainer = document.getElementById(`hidden-${type}-inputs`);
    
    // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    hiddenInputsContainer.innerHTML = '';
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–µ–≥–∞
    selectedArray.forEach(tag => {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = `${type}s`;
        hiddenInput.value = tag.id;
        hiddenInputsContainer.appendChild(hiddenInput);
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–ª–ª–∞–ø—Å–∏—Ä—É—é—â–µ–≥–æ –±–ª–æ–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
function initializeCollapsibleFilters() {
    const collapseElement = document.getElementById('mainFiltersCollapse');
    const collapseIcon = document.querySelector('.collapse-icon');
    
    if (collapseElement && collapseIcon) {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è collapse
        collapseElement.addEventListener('show.bs.collapse', function() {
            collapseIcon.style.transform = 'rotate(0deg)';
        });
        
        collapseElement.addEventListener('hide.bs.collapse', function() {
            collapseIcon.style.transform = 'rotate(-90deg)';
        });
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ (—Å–≤–µ—Ä–Ω—É—Ç–æ)
        collapseIcon.style.transform = 'rotate(-90deg)';
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –±–µ–Ω—á–º–∞—Ä–∫–æ–≤
function initializeBenchmarksData() {
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –±–µ–Ω—á–º–∞—Ä–∫–æ–≤
    const tableRows = document.querySelectorAll('.benchmark-item');
    originalBenchmarksData = [];
    
    console.log('–ù–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã:', tableRows.length);
    
    tableRows.forEach((row, index) => {
        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        let grade = '';
        let vacancy = '';
        let location = '';
        let type = '';
        let salaryFrom = 0;
        
        // –ò—â–µ–º –≥—Ä–µ–π–¥
        const gradeElement = row.querySelector('[data-grade]') || 
                           row.querySelector('.grade-name') || 
                           row.querySelector('.benchmark-grade');
        if (gradeElement) {
            grade = gradeElement.getAttribute('data-grade') || gradeElement.textContent?.trim() || '';
        }
        
        // –ò—â–µ–º –≤–∞–∫–∞–Ω—Å–∏—é
        const vacancyElement = row.querySelector('[data-vacancy]') || 
                             row.querySelector('.vacancy-name') || 
                             row.querySelector('.benchmark-vacancy');
        if (vacancyElement) {
            vacancy = vacancyElement.getAttribute('data-vacancy') || vacancyElement.textContent?.trim() || '';
        }
        
        // –ò—â–µ–º –ª–æ–∫–∞—Ü–∏—é
        const locationElement = row.querySelector('[data-location]') || 
                              row.querySelector('.location-name') || 
                              row.querySelector('.benchmark-location');
        if (locationElement) {
            location = locationElement.getAttribute('data-location') || locationElement.textContent?.trim() || '';
        }
        
        // –ò—â–µ–º —Ç–∏–ø
        const typeElement = row.querySelector('[data-type]') || 
                          row.querySelector('.benchmark-type');
        if (typeElement) {
            type = typeElement.getAttribute('data-type') || '';
        }
        
        // –ò—â–µ–º –∑–∞—Ä–ø–ª–∞—Ç—É
        const salaryElement = row.querySelector('[data-salary-from]') || 
                            row.querySelector('.salary-amount') || 
                            row.querySelector('.benchmark-amount');
        if (salaryElement) {
            const salaryText = salaryElement.getAttribute('data-salary-from') || 
                             salaryElement.textContent?.replace(/[^\d.]/g, '') || '0';
            salaryFrom = parseFloat(salaryText) || 0;
        }
        
        const benchmark = {
            grade__name: grade,
            vacancy__name: vacancy,
            location: location,
            type: type,
            salary_from: salaryFrom
        };
        
        originalBenchmarksData.push(benchmark);
        
        if (index < 3) { // –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ 3 –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            console.log(`–ë–µ–Ω—á–º–∞—Ä–∫ ${index + 1}:`, benchmark);
        }
    });
    
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤:', originalBenchmarksData.length, '–∑–∞–ø–∏—Å–µ–π');
    
    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    if (originalBenchmarksData.length === 0) {
        console.log('–°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ...');
        originalBenchmarksData = [
            { grade__name: 'Junior', vacancy__name: 'Developer', location: '–ú–∏–Ω—Å–∫', type: 'candidate', salary_from: 1000 },
            { grade__name: 'Senior', vacancy__name: 'Developer', location: '–ú–∏–Ω—Å–∫', type: 'vacancy', salary_from: 2000 },
            { grade__name: 'Junior', vacancy__name: 'Designer', location: '–ú–æ—Å–∫–≤–∞', type: 'candidate', salary_from: 1500 }
        ];
    }
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ tokenfield
function initializeTokenField(type, selectedArray) {
    const tagInput = document.getElementById(`${type}-tag-input`);
    const tagDropdown = document.getElementById(`${type}-tag-dropdown`);
    const selectedTagsContainer = document.getElementById(`selected-${type}-tags`);
    const hiddenInputsContainer = document.getElementById(`hidden-${type}-inputs`);
    
    if (!tagInput || !tagDropdown || !selectedTagsContainer || !hiddenInputsContainer) {
        console.error(`–ù–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è ${type} tokenfield`);
        return;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    function positionDropdown() {
        const inputRect = tagInput.getBoundingClientRect();
        tagDropdown.style.top = (inputRect.bottom + window.scrollY + 2) + 'px';
        tagDropdown.style.left = inputRect.left + 'px';
        tagDropdown.style.width = inputRect.width + 'px';
        tagDropdown.style.zIndex = '9999';
        tagDropdown.style.position = 'absolute';
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞
    function addTag(tagId, tagName) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã–±—Ä–∞–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —Ç–µ–≥
        if (selectedArray.some(tag => tag.id === tagId)) {
            return;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤
        selectedArray.push({ id: tagId, name: tagName });
        
        // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç —Ç–µ–≥–∞
        const tagElement = document.createElement('span');
        tagElement.className = 'tag-token';
        tagElement.setAttribute('data-tag-id', tagId);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –±–µ–π–¥–∂–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        let badgeClass = 'badge me-1';
        if (type === 'grade') badgeClass += ' bg-primary';
        else if (type === 'vacancy') badgeClass += ' bg-info';
        else if (type === 'location') badgeClass += ' bg-success';
        
        tagElement.innerHTML = `
            <span class="${badgeClass}">${tagName}</span>
            <button type="button" class="btn-close" aria-label="–£–¥–∞–ª–∏—Ç—å"></button>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
        const removeBtn = tagElement.querySelector('.btn-close');
        removeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            removeTag(tagId);
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥–∞
        tagInput.parentNode.insertBefore(tagElement, tagInput);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
        updateHiddenInputs();
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        tagInput.value = '';
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
        tagDropdown.style.display = 'none';
        
        // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º applyMainFilters –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - —ç—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
        console.log(`üè∑Ô∏è –î–æ–±–∞–≤–ª–µ–Ω —Ç–µ–≥ ${tagName} (${tagId}) –≤ ${type} —Ñ–∏–ª—å—Ç—Ä`);
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–≥–∞
    function removeTag(tagId) {
        // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
        const index = selectedArray.findIndex(tag => tag.id === tagId);
        if (index > -1) {
            selectedArray.splice(index, 1);
        }
        
        // –ù–∞—Ö–æ–¥–∏–º –∏ —É–¥–∞–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
        const tagElement = selectedTagsContainer.querySelector(`[data-tag-id="${tagId}"]`);
        if (tagElement) {
            tagElement.classList.add('removing');
            setTimeout(() => {
                tagElement.remove();
            }, 300);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
        updateHiddenInputs();
        
        // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º applyMainFilters –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - —ç—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
        console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω —Ç–µ–≥ ${tagId} –∏–∑ ${type} —Ñ–∏–ª—å—Ç—Ä–∞`);
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π
    function updateHiddenInputs() {
        // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
        hiddenInputsContainer.innerHTML = '';
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–µ–≥–∞
        selectedArray.forEach(tag => {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = `${type}_filters`;
            hiddenInput.value = tag.id;
            hiddenInputsContainer.appendChild(hiddenInput);
        });
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    function updateDropdown() {
        const options = tagDropdown.querySelectorAll('.tag-option');
        options.forEach(option => {
            const tagId = option.getAttribute('data-tag-id');
            if (tagId && selectedArray.some(tag => tag.id === tagId)) {
                option.style.display = 'none';
            } else {
                option.style.display = 'block';
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –æ–ø—Ü–∏–∏ –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ
    tagDropdown.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const option = e.target.closest('.tag-option');
        if (option && option.getAttribute('data-tag-id')) {
            const tagId = option.getAttribute('data-tag-id');
            const tagName = option.getAttribute('data-tag-name');
            addTag(tagId, tagName);
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
    tagInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const options = tagDropdown.querySelectorAll('.tag-option');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
        positionDropdown();
        tagDropdown.style.display = 'block';
        
        options.forEach(option => {
            if (option.getAttribute('data-tag-name')) {
                const tagId = option.getAttribute('data-tag-id');
                const tagName = option.getAttribute('data-tag-name').toLowerCase();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã–±—Ä–∞–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —Ç–µ–≥
                const isSelected = selectedArray.some(tag => tag.id === tagId);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–≥ –Ω–µ –≤—ã–±—Ä–∞–Ω –ò —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–∏—Å–∫—É
                if (!isSelected && tagName.includes(searchTerm)) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            }
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ–∫—É—Å–∞ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    tagInput.addEventListener('focus', function() {
        positionDropdown();
        tagDropdown.style.display = 'block';
        updateDropdown();
    });
    
    // –°–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', function(e) {
        if (!e.target.closest(`#selected-${type}-tags`)) {
            tagDropdown.style.display = 'none';
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à
    tagInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const searchTerm = this.value.trim();
            if (searchTerm) {
                // –ò—â–µ–º –ø–µ—Ä–≤—ã–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–µ–≥
                const options = tagDropdown.querySelectorAll('.tag-option');
                for (let option of options) {
                    const tagId = option.getAttribute('data-tag-id');
                    const tagName = option.getAttribute('data-tag-name').toLowerCase();
                    
                    const isSelected = selectedArray.some(tag => tag.id === tagId);
                    
                    if (!isSelected && tagName.includes(searchTerm.toLowerCase()) && option.style.display !== 'none') {
                        addTag(tagId, option.getAttribute('data-tag-name'));
                        break;
                    }
                }
            }
        } else if (e.key === 'Backspace' && this.value === '') {
            // –ï—Å–ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—É—Å—Ç–æ–µ –∏ –Ω–∞–∂–∞—Ç Backspace, —É–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥
            e.preventDefault();
            if (selectedArray.length > 0) {
                const lastTag = selectedArray[selectedArray.length - 1];
                removeTag(lastTag.id);
            }
        }
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    const tokenfieldContainer = selectedTagsContainer.closest('.tokenfield-container');
    tokenfieldContainer.addEventListener('mouseenter', function() {
        positionDropdown();
        tagDropdown.style.display = 'block';
        updateDropdown();
    });
    
    tokenfieldContainer.addEventListener('mouseleave', function() {
        tagDropdown.style.display = 'none';
    });
}

// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ (—Ç–æ–∫–µ–Ω-—Ñ–∏–ª–¥—ã) - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ –ø–µ—Ä–≤—ã–π —Ñ–∏–ª—å—Ç—Ä
function applyMainFilters() {
    console.log('üîß applyMainFilters –≤—ã–∑–≤–∞–Ω–∞!');
    console.log('üìä –¢–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã:', {
        grades: selectedGrades,
        vacancies: selectedVacancies,
        locations: selectedLocations
    });
    
    // –°–æ–±–∏—Ä–∞–µ–º ID –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–∫–∞–∫ –≤ –ø–µ—Ä–≤–æ–º —Ñ–∏–ª—å—Ç—Ä–µ)
    const selectedGradeIds = selectedGrades.map(tag => tag.id).filter(v => v);
    const selectedVacancyIds = selectedVacancies.map(tag => tag.id).filter(v => v);
    const selectedLocationIds = selectedLocations.map(tag => tag.id).filter(v => v);
    
    console.log('üéØ ID –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤:', {
        grades: selectedGradeIds,
        vacancies: selectedVacancyIds,
        locations: selectedLocationIds
    });
    
    // –°–æ–∑–¥–∞–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–∫–∞–∫ –≤ –ø–µ—Ä–≤–æ–º —Ñ–∏–ª—å—Ç—Ä–µ)
    const url = new URL(window.location);
    
    // –û—á–∏—â–∞–µ–º –í–°–ï —Å—Ç–∞—Ä—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–∏ —Å—Ç–∞—Ä—ã–µ, –∏ –Ω–æ–≤—ã–µ)
    url.searchParams.delete('grade');
    url.searchParams.delete('vacancy');
    url.searchParams.delete('location');
    url.searchParams.delete('grades');
    url.searchParams.delete('vacancies');
    url.searchParams.delete('locations');
    
    selectedGradeIds.forEach(grade => url.searchParams.append('grades', grade));
    selectedVacancyIds.forEach(vacancy => url.searchParams.append('vacancies', vacancy));
    selectedLocationIds.forEach(location => url.searchParams.append('locations', location));
    
    console.log('üåê –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ URL:', url.toString());
    
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ (–∫–∞–∫ –≤ –ø–µ—Ä–≤–æ–º —Ñ–∏–ª—å—Ç—Ä–µ)
    window.location.href = url.toString();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
function updateStatisticsWithFilters(filters) {
    console.log('–û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏:', filters);
    console.log('–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤:', originalBenchmarksData.length);
    
    // –ï—Å–ª–∏ –Ω–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –ø—ã—Ç–∞–µ–º—Å—è –∏—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
    if (!originalBenchmarksData || originalBenchmarksData.length === 0) {
        initializeBenchmarksData();
    }
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    let filteredBenchmarks = [...originalBenchmarksData] || [];
    console.log('–î–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:', filteredBenchmarks.length);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –≥—Ä–µ–π–¥–∞–º
    if (filters.grades && filters.grades.length > 0) {
        filteredBenchmarks = filteredBenchmarks.filter(benchmark => 
            benchmark.grade__name && filters.grades.includes(benchmark.grade__name)
        );
        console.log('–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≥—Ä–µ–π–¥–∞–º:', filteredBenchmarks.length);
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º
    if (filters.vacancies && filters.vacancies.length > 0) {
        filteredBenchmarks = filteredBenchmarks.filter(benchmark => 
            benchmark.vacancy__name && filters.vacancies.includes(benchmark.vacancy__name)
        );
        console.log('–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º:', filteredBenchmarks.length);
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –ª–æ–∫–∞—Ü–∏—è–º
    if (filters.locations && filters.locations.length > 0) {
        filteredBenchmarks = filteredBenchmarks.filter(benchmark => 
            benchmark.location && filters.locations.includes(benchmark.location)
        );
        console.log('–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º:', filteredBenchmarks.length);
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —Ç–∏–ø–∞–º –¥–∞–Ω–Ω—ã—Ö
    if (filters.dataTypes && filters.dataTypes.length > 0) {
        filteredBenchmarks = filteredBenchmarks.filter(benchmark => 
            benchmark.type && filters.dataTypes.includes(benchmark.type)
        );
        console.log('–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ç–∏–ø–∞–º –¥–∞–Ω–Ω—ã—Ö:', filteredBenchmarks.length);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
    const totalCount = filteredBenchmarks.length;
    const candidateCount = filteredBenchmarks.filter(b => b.type === 'candidate').length;
    const vacancyCount = filteredBenchmarks.filter(b => b.type === 'vacancy').length;
    
    updateStatCard('total-benchmarks', totalCount);
    updateStatCard('candidate-count', candidateCount);
    updateStatCard('vacancy-count', vacancyCount);
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω—é—é –∑–∞—Ä–ø–ª–∞—Ç—É
    const salaries = filteredBenchmarks.map(b => b.salary_from || 0).filter(s => s > 0);
    const avgSalary = salaries.length > 0 ? salaries.reduce((a, b) => a + b, 0) / salaries.length : 0;
    updateStatCard('avg-amount', Math.round(avgSalary));
    
    console.log('–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:', { totalCount, candidateCount, vacancyCount, avgSalary: Math.round(avgSalary) });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateStatCard(cardId, value) {
    const card = document.querySelector(`[data-stat="${cardId}"]`);
    if (card) {
        const numberElement = card.querySelector('.stat-number');
        if (numberElement) {
            numberElement.textContent = value;
        }
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
function updateBenchmarksTableWithFilters(filters) {
    console.log('–û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏:', filters);
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
    const tableRows = document.querySelectorAll('.benchmark-item');
    
    tableRows.forEach(row => {
        let showRow = true;
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏
        const gradeElement = row.querySelector('[data-grade]');
        const vacancyElement = row.querySelector('[data-vacancy]');
        const locationElement = row.querySelector('[data-location]');
        const typeElement = row.querySelector('[data-type]');
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –≥—Ä–µ–π–¥–∞–º
        if (filters.grades.length > 0 && gradeElement) {
            const grade = gradeElement.getAttribute('data-grade');
            if (!filters.grades.includes(grade)) {
                showRow = false;
            }
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º
        if (filters.vacancies.length > 0 && vacancyElement) {
            const vacancy = vacancyElement.getAttribute('data-vacancy');
            if (!filters.vacancies.includes(vacancy)) {
                showRow = false;
            }
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –ª–æ–∫–∞—Ü–∏—è–º
        if (filters.locations.length > 0 && locationElement) {
            const location = locationElement.getAttribute('data-location');
            if (!filters.locations.includes(location)) {
                showRow = false;
            }
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —Ç–∏–ø–∞–º –¥–∞–Ω–Ω—ã—Ö
        if (filters.dataTypes.length > 0 && typeElement) {
            const type = typeElement.getAttribute('data-type');
            if (!filters.dataTypes.includes(type)) {
                showRow = false;
            }
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É
        if (showRow) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ URL
function saveFiltersToURL(filters) {
    const url = new URL(window.location);
    
    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤
    url.searchParams.delete('grade');
    url.searchParams.delete('vacancy');
    url.searchParams.delete('location');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    if (filters.grades.length > 0) {
        filters.grades.forEach(grade => {
            url.searchParams.append('grade', grade);
        });
    }
    
    if (filters.vacancies.length > 0) {
        filters.vacancies.forEach(vacancy => {
            url.searchParams.append('vacancy', vacancy);
        });
    }
    
    if (filters.locations.length > 0) {
        filters.locations.forEach(location => {
            url.searchParams.append('location', location);
        });
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.history.replaceState({}, '', url);
}

// –û—á–∏—Å—Ç–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
function clearMainFilters() {
    console.log('üßπ –û—á–∏—â–∞–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã —Ç–æ–∫–µ–Ω-—Ñ–∏–ª–¥–æ–≤...');
    
    // –û—á–∏—â–∞–µ–º URL –æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–∫–∞–∫ –≤ –ø–µ—Ä–≤–æ–º —Ñ–∏–ª—å—Ç—Ä–µ)
    const url = new URL(window.location);
    
    // –û—á–∏—â–∞–µ–º –í–°–ï —Å—Ç–∞—Ä—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–∏ —Å—Ç–∞—Ä—ã–µ, –∏ –Ω–æ–≤—ã–µ)
    url.searchParams.delete('grade');
    url.searchParams.delete('vacancy');
    url.searchParams.delete('location');
    url.searchParams.delete('grades');
    url.searchParams.delete('vacancies');
    url.searchParams.delete('locations');
    
    console.log('üåê –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –æ—á–∏—â–µ–Ω–Ω—ã–π URL:', url.toString());
    
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–∫–∞–∫ –≤ –ø–µ—Ä–≤–æ–º —Ñ–∏–ª—å—Ç—Ä–µ)
    window.location.href = url.toString();
}
</script>
{% endblock %}

