{% load static %}
{% load huntflow_filters %}
{% load sidebar_tags %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% block title %}HR Helper{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="{% static 'css/all.min.css' %}" rel="stylesheet">
    <!-- Unified Color System -->
    <link href="{% static 'css/unified-colors.css' %}" rel="stylesheet">
    <!-- HR Helper Custom CSS -->
    <link href="{% static 'css/hrhelper.css' %}" rel="stylesheet">
    
    <!-- Адаптивный favicon -->
    <link id="favicon" rel="icon" type="image/png" href="{% static 'img/logo-dark.png' %}">
    
    <!-- Стили для многоуровневого сайдбара теперь включены в hrhelper.css -->
    
        {% block extra_css %}{% endblock %}
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            {% if not request.resolver_match.url_name == 'account_login' and not request.resolver_match.url_name == 'signup' and not request.resolver_match.url_name == 'password_reset' %}
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white">
                            <i class="fas fa-sync-alt me-2"></i>
                HR Helper
                        </h4>
                        <p class="text-white-50 small">Система управления HR</p>
                    </div>
                    
                    <!-- Динамичное многоуровневое меню -->
                    {% render_sidebar_menu %}

                    <hr class="my-4" style="border-color: rgba(255,255,255,0.5); border-width: 1px;">
                    <ul class="nav flex-column mb-2">
                        <li class="nav-item">
                            <a class="nav-link{% if request.resolver_match.url_name == 'profile' %} active{% endif %}" href="{% url 'accounts:profile' %}">
                                <i class="fas fa-user me-2"></i>
                                Профиль
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link{% if request.resolver_match.url_name == 'integrations' %} active{% endif %}" href="{% url 'accounts:integrations' %}">
                                <i class="fas fa-plug me-2"></i>
                                Интеграции
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link{% if request.resolver_match.namespace == 'admin' %} active{% endif %}" href="{% url 'admin:index' %}">
                                <i class="fas fa-cog me-2"></i>
                                Admin-панель
                            </a>
                        </li>
                    </ul>
            </div>
            </nav>
            {% endif %}
            
            <!-- Main content -->
            <main class="{% if request.resolver_match.url_name == 'account_login' or request.resolver_match.url_name == 'signup' or request.resolver_match.url_name == 'password_reset' %}col-12{% else %}col-md-9 ms-sm-auto col-lg-10{% endif %} px-md-4 main-content">
                <div class="sticky-top d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    {% if not request.resolver_match.url_name == 'account_login' and not request.resolver_match.url_name == 'signup' and not request.resolver_match.url_name == 'password_reset' %}
                    <!-- Кнопка переключения сайдбара -->
                    <div class="mx-3">
                        <i class="fas fa-caret-square-right sidebar-toggle" id="sidebarToggle" aria-label="Переключить сайдбар"></i>
                    <h1 class="h2">
                            {% block page_title %}HR Helper{% endblock %}
                    </h1>
                    </div>
                    {% else %}
                    <div></div>
                    {% endif %}
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <!-- Переключатель темы -->
                        <div class="btn-group me-3" role="group">
                            <button type="button" class="btn btn-outline-secondary theme-toggle" id="themeToggle" title="Переключить тему">
                                <i class="fas fa-sun" id="themeIcon"></i>
                </button>
            </div>
            
                    {% if user.is_authenticated %}
                            <div class="btn-group me-3" role="group">
                                <a href="{% url 'accounts:profile' %}" class="btn btn-outline-primary">
                                    <i class="fas fa-user me-1"></i>
                                    {{ user.email|default:user.username }}
                                </a>
                                <a href="{% url 'accounts:account_logout' %}" class="btn btn-outline-danger">
                                    <i class="fas fa-sign-out-alt me-1"></i>
                                    Выход
                                </a>
                            </div>
                    {% else %}
                            <a href="{% url 'accounts:account_login' %}" class="btn btn-primary me-3">
                                <i class="fas fa-sign-in-alt me-1"></i>
                                Вход
                            </a>
                    {% endif %}
                        {% block page_actions %}{% endblock %}
            </div>
        </div>

                <!-- Content wrapper -->
                <div class="content-wrapper">
                    <!-- Messages -->
                    {% if messages and not request.resolver_match.url_name == 'chat_workflow' and not request.resolver_match.url_name == 'chat_workflow_session' %}
                        <div class="messages">
                            {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                            {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Page content -->
                    {% block content %}{% endblock %}
                </div>
    </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <!-- jQuery -->
    <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
    
    <!-- Основные скрипты для всех страниц -->
    <script>
        // Общие функции для всех приложений
        function showLoading(element) {
            element.innerHTML = '<span class="loading-spinner"></span> Загрузка...';
            element.disabled = true;
        }
        
        function hideLoading(element, originalText) {
            element.innerHTML = originalText;
            element.disabled = false;
        }
        
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Автоматически скрыть через 5 секунд
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // Функциональность многоуровневого сайдбара
        document.addEventListener('DOMContentLoaded', function() {
            // Проверяем, находимся ли мы на странице "Главная" (чат-помощник)
            const isMainPage = window.location.pathname.includes('/google-oauth/chat/');
            
            // Сначала сворачиваем ВСЕ меню
            const allCollapseElements = document.querySelectorAll('.sidebar .collapse');
            allCollapseElements.forEach(element => {
                element.classList.remove('show');
                const toggle = document.querySelector(`[data-bs-target="#${element.id}"]`);
                if (toggle) {
                    toggle.setAttribute('aria-expanded', 'false');
                }
            });
            
            // Если мы на главной странице (чат-помощник), не разворачиваем никаких меню
            if (isMainPage) {
                // Убираем класс active со всех элементов на главной странице, кроме самой главной
                const allNavLinks = document.querySelectorAll('.sidebar .nav-link');
                allNavLinks.forEach(link => {
                    // Проверяем, не является ли это ссылкой на главную страницу
                    const href = link.getAttribute('href');
                    if (href && !href.includes('/google-oauth/chat/')) {
                        link.classList.remove('active');
                    }
                });
                console.log('🏠 Главная страница: убран класс active со всех элементов, кроме главной');
                return; // Выходим из функции, оставляя все меню свернутыми
            }
            
            // Находим все активные элементы меню
            const activeMenuItems = document.querySelectorAll('.sidebar .nav-link.active');
            
            // Для каждого активного элемента, разворачиваем только родительские меню
            activeMenuItems.forEach(function(activeItem) {
                let currentItem = activeItem.closest('.nav-item');
                
                // Поднимаемся по иерархии и разворачиваем только родительские меню
                while (currentItem) {
                    const parentToggle = currentItem.querySelector('.menu-toggle');
                    if (parentToggle) {
                        const targetId = parentToggle.getAttribute('data-bs-target');
                        const targetElement = document.querySelector(targetId);
                        
                        if (targetElement) {
                            targetElement.classList.add('show');
                            parentToggle.setAttribute('aria-expanded', 'true');
                        }
                    }
                    
                    // Переходим к следующему родительскому элементу
                    currentItem = currentItem.parentElement.closest('.nav-item');
                }
            });
            
            // Обработка кликов по многоуровневому меню
            const sidebarToggles = document.querySelectorAll('.menu-toggle');
            
            sidebarToggles.forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    // Если это ссылка с подменю - предотвратить переход
                    if (this.dataset.bsToggle === 'collapse') {
                        e.preventDefault();
                        
                        // Определяем уровень текущего элемента
                        const currentNavItem = this.closest('.nav-item');
                        const currentLevel = currentNavItem.classList.contains('ms-1') ? 1 : 
                                           currentNavItem.classList.contains('ms-2') ? 2 : 0;
                        
                        // Сворачиваем только меню того же уровня
                        const allCollapses = document.querySelectorAll('.sidebar .collapse');
                        allCollapses.forEach(collapse => {
                            if (collapse.id !== this.dataset.bsTarget.replace('#', '')) {
                                const collapseToggle = document.querySelector(`[data-bs-target="#${collapse.id}"]`);
                                if (collapseToggle) {
                                    const collapseNavItem = collapseToggle.closest('.nav-item');
                                    const collapseLevel = collapseNavItem.classList.contains('ms-1') ? 1 : 
                                                        collapseNavItem.classList.contains('ms-2') ? 2 : 0;
                                    
                                    // Сворачиваем только если это тот же уровень
                                    if (collapseLevel === currentLevel) {
                                        collapse.classList.remove('show');
                                        collapseToggle.setAttribute('aria-expanded', 'false');
                                    }
                                }
                            }
                        });
                        
                        // Переключаем текущее меню
                        const targetId = this.dataset.bsTarget.replace('#', '');
                        const targetElement = document.querySelector(this.dataset.bsTarget);
                        const isExpanded = this.getAttribute('aria-expanded') === 'true';
                        
                        if (isExpanded) {
                            // Сворачиваем
                            targetElement.classList.remove('show');
                            this.setAttribute('aria-expanded', 'false');
                        } else {
                            // Разворачиваем
                            targetElement.classList.add('show');
                            this.setAttribute('aria-expanded', 'true');
                        }
                    }
                });
            });
        });
        
        // ПЕРЕКЛЮЧАТЕЛЬ ТЕМЫ - теперь работает везде:
        
        // Функция для обновления favicon в зависимости от темы
        function updateFavicon(theme) {
            const favicon = document.getElementById('favicon');
            if (favicon) {
                // Используем отдельные файлы для каждой темы
                if (theme === 'dark') {
                    // Темная тема: используем светлый логотип
                    favicon.href = '{% static "img/logo-light.png" %}';
                } else {
                    // Светлая тема: используем темный логотип
                    favicon.href = '{% static "img/logo-dark.png" %}';
                }
            }
        }
        
        // Функция для переключения темы
        function toggleTheme() {
            console.log('🎨 Переключение темы...');
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            console.log('📊 Текущая тема:', currentTheme);
            console.log('🎯 Новая тема:', newTheme);
            
            // Устанавливаем новую тему
            html.setAttribute('data-theme', newTheme);
            console.log('✅ Атрибут data-theme установлен:', html.getAttribute('data-theme'));
            
            // Проверяем, что атрибут действительно установлен
            setTimeout(() => {
                console.log('🔍 Проверка после переключения:', html.getAttribute('data-theme'));
            }, 100);
            
            // Принудительно обновляем CSS переменные
            const root = document.documentElement;
            if (newTheme === 'dark') {
                root.style.setProperty('--color-background', '#0d1117');
                root.style.setProperty('--color-surface', '#161b22');
                root.style.setProperty('--color-text', 'var(--color-luna-400)');
                root.style.setProperty('--color-primary', 'var(--color-pink-400)');
                console.log('🌙 Принудительно установлены темные цвета');
            } else {
                root.style.setProperty('--color-background', '#ffffff');
                root.style.setProperty('--color-surface', '#ffffff');
                root.style.setProperty('--color-text', '#13343b');
                root.style.setProperty('--color-primary', 'var(--color-lime-500)'); // Теперь синий
                console.log('☀️ Принудительно установлены светлые цвета (лайм теперь синий)');
            }
            
            // Сохраняем в localStorage
            localStorage.setItem('theme', newTheme);
            console.log('💾 Тема сохранена в localStorage:', localStorage.getItem('theme'));
            
            // Обновляем иконку
            updateThemeIcon(newTheme);
            
            // Обновляем favicon
            updateFavicon(newTheme);
            
            // Показываем уведомление
            showThemeNotification(newTheme);
        }
        
        // Функция для обновления иконки темы
        function updateThemeIcon(theme) {
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                if (theme === 'dark') {
                    themeIcon.className = 'fas fa-moon';
                } else {
                    themeIcon.className = 'fas fa-sun';
                }
                console.log('🎨 Иконка обновлена для темы:', theme);
            }
        }
        
        // Функция для показа уведомления о смене темы
        function showThemeNotification(theme) {
            const themeName = theme === 'dark' ? 'Тёмная' : 'Светлая';
            
            // Создаем уведомление
            const notification = document.createElement('div');
            notification.className = 'alert alert-info alert-dismissible fade show position-fixed toast-notification';
            notification.style.cssText = 'bottom: 20px; left: 20px; z-index: 9999; transition: all 0.3s ease;';
            
            notification.innerHTML = `
                <i class="fas fa-${theme === 'dark' ? 'moon' : 'sun'} me-2"></i>
                Переключено на ${themeName} тему
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Добавляем обработчик для кнопки закрытия
            const closeButton = notification.querySelector('.btn-close');
            closeButton.addEventListener('click', function() {
                // Удаляем тост
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                    
                    // Пересчитываем позиции оставшихся тостов на основе их реальной высоты
                    const remainingToasts = document.querySelectorAll('.toast-notification');
                    let currentBottom = 20;
                    remainingToasts.forEach((toast) => {
                        toast.style.bottom = `${currentBottom}px`;
                        const toastHeight = toast.offsetHeight;
                        const margin = 10; // отступ между тостами
                        currentBottom += toastHeight + margin;
                    });
                }
            });
            
            // Подсчитываем существующие тосты
            const existingToasts = document.querySelectorAll('.toast-notification');
            
            // Добавляем на страницу сначала
            document.body.appendChild(notification);
            
            // Позиционируем новый тост в самом низу
            notification.style.bottom = '20px';
            
            // Поднимаем все существующие тосты вверх на основе их реальной высоты
            let currentBottom = 20;
            existingToasts.forEach((toast) => {
                const toastHeight = toast.offsetHeight;
                const margin = 10; // отступ между тостами
                currentBottom += toastHeight + margin;
                toast.style.bottom = `${currentBottom}px`;
            });
            
            // Автоматически удаляем через 3 секунды
            setTimeout(function() {
                if (notification.parentNode) {
                    // Удаляем тост
                    notification.parentNode.removeChild(notification);
                    
                    // Пересчитываем позиции оставшихся тостов на основе их реальной высоты
                    const remainingToasts = document.querySelectorAll('.toast-notification');
                    let currentBottom = 20;
                    remainingToasts.forEach((toast) => {
                        toast.style.bottom = `${currentBottom}px`;
                        const toastHeight = toast.offsetHeight;
                        const margin = 10; // отступ между тостами
                        currentBottom += toastHeight + margin;
                    });
                }
            }, 3000);
        }

        // Функция для очистки всех тостов
        function clearAllToasts() {
            const existingToasts = document.querySelectorAll('.toast-notification');
            existingToasts.forEach(toast => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            });
        }

        // Инициализация темы при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Инициализация переключателя темы...');
            
            // Очищаем все старые тосты при загрузке страницы
            clearAllToasts();
            
            // Получаем сохраненную тему или используем системную
            const savedTheme = localStorage.getItem('theme');
            const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            const theme = savedTheme || systemTheme;
            
            console.log('💾 Сохраненная тема:', savedTheme);
            console.log('🖥️ Системная тема:', systemTheme);
            console.log('🎯 Выбранная тема:', theme);
            
            // Устанавливаем тему
            document.documentElement.setAttribute('data-theme', theme);
            console.log('✅ Атрибут data-theme установлен при загрузке:', document.documentElement.getAttribute('data-theme'));
            
            // Проверяем, что атрибут действительно установлен
            setTimeout(() => {
                console.log('🔍 Проверка через 100ms:', document.documentElement.getAttribute('data-theme'));
            }, 100);
            
            // Принудительно обновляем CSS переменные при загрузке
            const root = document.documentElement;
            if (theme === 'dark') {
                root.style.setProperty('--color-background', '#0d1117');
                root.style.setProperty('--color-surface', '#161b22');
                root.style.setProperty('--color-text', 'var(--color-luna-400)');
                root.style.setProperty('--color-primary', 'var(--color-pink-400)');
                console.log('🌙 Принудительно установлены темные цвета при загрузке');
            } else {
                root.style.setProperty('--color-background', '#ffffff');
                root.style.setProperty('--color-surface', '#ffffff');
                root.style.setProperty('--color-text', '#13343b');
                root.style.setProperty('--color-primary', 'var(--color-lime-500)'); // Теперь синий
                console.log('☀️ Принудительно установлены светлые цвета при загрузке (лайм теперь синий)');
            }
            
            // Обновляем иконку
            updateThemeIcon(theme);
            
            // Обновляем favicon
            updateFavicon(theme);
            
            // Добавляем обработчик клика на кнопку переключения темы
            const themeToggle = document.getElementById('themeToggle');
            console.log('🔘 Кнопка переключения темы найдена:', themeToggle);
            if (themeToggle) {
                // Удаляем старые обработчики, если они есть
                themeToggle.removeEventListener('click', toggleTheme);
                // Добавляем новый обработчик
                themeToggle.addEventListener('click', toggleTheme);
                console.log('✅ Обработчик клика добавлен');
                
                // Тестируем клик программно
                console.log('🧪 Тестируем программный клик...');
                setTimeout(() => {
                    console.log('🎯 Атрибут data-theme перед тестом:', document.documentElement.getAttribute('data-theme'));
                }, 500);
            } else {
                console.error('❌ Кнопка переключения темы не найдена!');
            }
            
            // Слушаем изменения системной темы
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                if (!localStorage.getItem('theme')) {
                    const newTheme = e.matches ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', newTheme);
                    updateThemeIcon(newTheme);
                    updateFavicon(newTheme);
                }
            });
            
            console.log('✅ Инициализация переключателя темы завершена');
            
            // Глобальная функция для тестирования
            window.testThemeToggle = function() {
                console.log('🧪 Тестируем переключение темы...');
                toggleTheme();
            };
        });
    </script>

    <!-- JavaScript для функциональности переключения сайдбара -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Находим кнопку переключения сайдбара (теперь она в HTML)
        function getSidebarToggle() {
            const toggleBtn = document.getElementById('sidebarToggle');
            if (!toggleBtn) {
                console.warn('Кнопка переключения сайдбара не найдена');
            }
            return toggleBtn;
        }
        
        // Создаем кнопку закрытия сайдбара (только для мобильных)
        function createSidebarClose(sidebar) {
            const closeBtn = document.createElement('button');
            closeBtn.className = 'sidebar-close';
            closeBtn.innerHTML = '<i class="fas fa-caret-square-left"></i>';
            closeBtn.setAttribute('aria-label', 'Закрыть сайдбар');
            // Добавляем кнопку закрытия только на мобильных устройствах
            if (window.innerWidth <= 992) {
                sidebar.appendChild(closeBtn);
            }
            return closeBtn;
        }
        
        // Создаем overlay для мобильных
        function createSidebarOverlay() {
            const overlay = document.createElement('div');
            overlay.className = 'sidebar-overlay';
            document.body.appendChild(overlay);
            return overlay;
        }
        
        // Применяем классы к существующим элементам
        function setupSidebarStructure() {
            const sidebar = document.querySelector('.col-md-3:first-child') || 
                           document.querySelector('.sidebar') ||
                           document.querySelector('[class*="sidebar"]');
                           
            const mainContent = document.querySelector('.col-md-9:last-child') || 
                               document.querySelector('.main-content') ||
                               document.querySelector('[class*="main"]');
            
            if (sidebar) {
                sidebar.classList.add('sidebar-container');
                
                // На мобильных по умолчанию скрыт
                if (window.innerWidth <= 992) {
                    sidebar.classList.add('hidden');
                }
            }
            
            if (mainContent) {
                mainContent.classList.add('main-content');
            }
            
            return { sidebar, mainContent };
        }
        
        // Инициализация
        const { sidebar, mainContent } = setupSidebarStructure();
        
        if (!sidebar) {
            console.warn('Сайдбар не найден');
            return;
        }
        
        // Находим элементы управления
        const toggleBtn = getSidebarToggle();
        const closeBtn = createSidebarClose(sidebar);
        const overlay = createSidebarOverlay();
        
        // Проверяем, что кнопка переключения найдена
        if (!toggleBtn) {
            console.warn('Кнопка переключения сайдбара не найдена, функциональность отключена');
            return;
        }
        
        // Состояние сайдбара
        let sidebarVisible = window.innerWidth > 992;
        
        // Функция переключения сайдбара
        function toggleSidebar() {
            sidebarVisible = !sidebarVisible;
            
            if (sidebarVisible) {
                sidebar.classList.remove('hidden');
                sidebar.classList.add('show');
                if (mainContent) mainContent.classList.remove('sidebar-hidden');
                
                // На мобильных показываем overlay
                if (window.innerWidth <= 992) {
                    overlay.classList.add('show');
                }
                
                toggleBtn.className = 'fas fa-caret-square-left sidebar-toggle';
            } else {
                sidebar.classList.add('hidden');
                sidebar.classList.remove('show');
                if (mainContent) mainContent.classList.add('sidebar-hidden');
                
                overlay.classList.remove('show');
                toggleBtn.className = 'fas fa-caret-square-right sidebar-toggle';
            }
        }
        
        // Функция скрытия сайдбара
        function hideSidebar() {
            sidebarVisible = false;
            sidebar.classList.add('hidden');
            sidebar.classList.remove('show');
            if (mainContent) mainContent.classList.add('sidebar-hidden');
            overlay.classList.remove('show');
            toggleBtn.innerHTML = '<i class="fas fa-bars"></i>';
        }
        
        // События
        toggleBtn.addEventListener('click', toggleSidebar);
        closeBtn.addEventListener('click', hideSidebar);
        overlay.addEventListener('click', hideSidebar);
        
        // Обработка изменения размера окна
        window.addEventListener('resize', function() {
            if (window.innerWidth > 992) {
                // Десктоп: показываем сайдбар, убираем overlay
                sidebar.classList.remove('hidden', 'show');
                if (mainContent) mainContent.classList.remove('sidebar-hidden');
                overlay.classList.remove('show');
                sidebarVisible = true;
                toggleBtn.className = 'fas fa-caret-square-left sidebar-toggle';
                
                // Убираем кнопку закрытия на десктопе
                const existingCloseBtn = sidebar.querySelector('.sidebar-close');
                if (existingCloseBtn) {
                    existingCloseBtn.remove();
                }
            } else {
                // Мобильный: скрываем сайдбар
                if (sidebarVisible) {
                    overlay.classList.add('show');
                    sidebar.classList.add('show');
                } else {
                    sidebar.classList.add('hidden');
                    sidebar.classList.remove('show');
                    overlay.classList.remove('show');
                }
                
                // Добавляем кнопку закрытия на мобильных
                const existingCloseBtn = sidebar.querySelector('.sidebar-close');
                if (!existingCloseBtn) {
                    const newCloseBtn = createSidebarClose(sidebar);
                    newCloseBtn.addEventListener('click', hideSidebar);
                }
            }
        });
        
        // Устанавливаем правильное начальное состояние
        if (window.innerWidth <= 992) {
            hideSidebar();
        } else {
            toggleBtn.className = 'fas fa-caret-square-left sidebar-toggle';
        }
    });
    </script>

    <!-- Дополнительные скрипты для конкретных страниц -->
    {% block extra_js %}
    {% endblock %}
</body>
</html>
