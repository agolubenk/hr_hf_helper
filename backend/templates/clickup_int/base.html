{% extends 'common/base.html' %}
{% load static %}

{% block title %}{% block page_title %}ClickUp интеграция{% endblock %}{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block extra_css %}
<link href="{% static 'css/clickup.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Заголовок ClickUp -->
    <div class="clickup-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-tasks me-2"></i>
                        {% block header_title %}ClickUp интеграция{% endblock %}
                    </h1>
                    <p class="mb-0 opacity-75">{% block header_subtitle %}Управление задачами из ClickUp{% endblock %}</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex gap-2 justify-content-end">
                        <!-- Переключатель темы -->
                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-light btn-sm theme-toggle" id="themeToggle" title="Переключить тему">
                                <i class="fas fa-sun" id="themeIcon"></i>
                            </button>
                        </div>
                        <a href="{% url 'clickup_int:dashboard' %}" class="btn btn-light btn-sm">
                            <i class="fas fa-home me-1"></i>
                            Дашборд
                        </a>
                        <a href="{% url 'clickup_int:settings' %}" class="btn btn-light btn-sm">
                            <i class="fas fa-cog me-1"></i>
                            Настройки
                        </a>
                        <a href="{% url 'clickup_int:tasks_list' %}" class="btn btn-light btn-sm">
                            <i class="fas fa-list me-1"></i>
                            Задачи
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Основной контент -->
    <div class="container">
        {% block clickup_content %}
        {% endblock %}
    </div>
</div>

<!-- Уведомления -->
<div id="notifications-container" class="position-fixed" style="top: 20px; right: 20px; z-index: 9999;"></div>

<script>
// Функция для показа уведомлений
function showNotification(message, type = 'info') {
    const container = document.getElementById('notifications-container');
    const notification = document.createElement('div');
    
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    
    notification.className = `alert ${alertClass} alert-dismissible fade show`;
    notification.style.cssText = 'min-width: 300px; margin-bottom: 10px;';
    
    const icon = type === 'success' ? 'check-circle' : 
                 type === 'error' ? 'times-circle' : 
                 type === 'warning' ? 'exclamation-triangle' : 'info-circle';
    
    notification.innerHTML = `
        <i class="fas fa-${icon} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    container.appendChild(notification);
    
    // Автоматически удаляем через 5 секунд
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Функция для показа загрузки
function showLoading(element, text = 'Загрузка...') {
    const originalContent = element.innerHTML;
    element.innerHTML = `<span class="loading-spinner me-2"></span>${text}`;
    element.disabled = true;
    
    return function hideLoading() {
        element.innerHTML = originalContent;
        element.disabled = false;
    };
}

// Инициализация переключения тем для ClickUp
document.addEventListener('DOMContentLoaded', function() {
    // Получаем сохраненную тему или используем системную
    const savedTheme = localStorage.getItem('theme');
    const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    const theme = savedTheme || systemTheme;
    
    // Устанавливаем тему
    document.documentElement.setAttribute('data-theme', theme);
    
    // Принудительно обновляем CSS переменные
    const root = document.documentElement;
    if (theme === 'dark') {
        root.style.setProperty('--color-background', '#0d1117');
        root.style.setProperty('--color-surface', '#161b22');
        root.style.setProperty('--color-text', 'var(--color-luna-400)');
        root.style.setProperty('--color-primary', 'var(--color-pink-400)');
    } else {
        root.style.setProperty('--color-background', '#ffffff');
        root.style.setProperty('--color-surface', '#ffffff');
        root.style.setProperty('--color-text', '#13343b');
        root.style.setProperty('--color-primary', 'var(--color-lime-500)');
    }
    
    // Обновляем иконку
    updateThemeIcon(theme);
    
    // Добавляем обработчик клика на кнопку переключения темы
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
    }
});

// Функция для переключения темы
function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    // Устанавливаем новую тему
    html.setAttribute('data-theme', newTheme);
    
    // Принудительно обновляем CSS переменные
    const root = document.documentElement;
    if (newTheme === 'dark') {
        root.style.setProperty('--color-background', '#0d1117');
        root.style.setProperty('--color-surface', '#161b22');
        root.style.setProperty('--color-text', 'var(--color-luna-400)');
        root.style.setProperty('--color-primary', 'var(--color-pink-400)');
    } else {
        root.style.setProperty('--color-background', '#ffffff');
        root.style.setProperty('--color-surface', '#ffffff');
        root.style.setProperty('--color-text', '#13343b');
        root.style.setProperty('--color-primary', 'var(--color-lime-500)');
    }
    
    // Сохраняем в localStorage
    localStorage.setItem('theme', newTheme);
    
    // Обновляем иконку
    updateThemeIcon(newTheme);
}

// Функция для обновления иконки темы
function updateThemeIcon(theme) {
    const themeIcon = document.getElementById('themeIcon');
    if (themeIcon) {
        if (theme === 'dark') {
            themeIcon.className = 'fas fa-moon';
        } else {
            themeIcon.className = 'fas fa-sun';
        }
    }
}
</script>
{% endblock %}
