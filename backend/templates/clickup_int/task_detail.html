{% extends 'common/base.html' %}
{% load static %}
{% load common_filters %}


{% block content %}
{% csrf_token %}
<div class="row">
    <div class="col-lg-8">
        <div class="card clickup-card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>
                        {{ task.name }}
                    </h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-success" onclick="transferToHuntflow()" id="transferBtn">
                            <i class="fas fa-upload me-1"></i>
                            –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ Huntflow
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                        </h6>
                        
                        <div class="mb-3">
                            <strong>ID –∑–∞–¥–∞—á–∏:</strong>
                            <span class="badge bg-secondary ms-2">#{{ task.task_id }}</span>
                        </div>
                        
                        <div class="mb-3">
                            <strong>–°—Ç–∞—Ç—É—Å:</strong>
                            <span class="status-badge status-{{ task.status|lower|slugify }} ms-2">
                                {{ task.status }}
                            </span>
                        </div>
                        
                        {% if task.priority %}
                        <div class="mb-3">
                            <strong>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</strong>
                            <span class="priority-badge priority-{{ task.priority|lower|slugify }} ms-2">
                                {{ task.priority }}
                            </span>
                        </div>
                        {% endif %}
                        
                        <div class="mb-3">
                            <strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong>
                            <span class="ms-2">{{ task.date_created|date:"d.m.Y H:i" }}</span>
                        </div>
                        
                        <div class="mb-3">
                            <strong>–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</strong>
                            <span class="ms-2">{{ task.date_updated|date:"d.m.Y H:i" }}</span>
                        </div>
                        
                        {% if task.due_date %}
                        <div class="mb-3">
                            <strong>–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</strong>
                            <span class="ms-2 {% if task.due_date < now %}text-danger{% endif %}">
                                {{ task.due_date|date:"d.m.Y H:i" }}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-users me-2"></i>
                            –£—á–∞—Å—Ç–Ω–∏–∫–∏
                        </h6>
                        
                        {% if task.assignees %}
                        <div class="mb-3">
                            <strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏:</strong>
                            <div class="mt-2">
                                {% for assignee in task.assignees %}
                                    <span class="badge bg-primary me-1 mb-1">{{ assignee }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if task.tags %}
                        <div class="mb-3">
                            <strong>–¢–µ–≥–∏:</strong>
                            <div class="mt-2">
                                {% for tag in task.tags %}
                                    <span class="badge bg-secondary me-1 mb-1">{{ tag }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                    </div>
                </div>
                
                <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                {% if task.description %}
                <div class="mb-4">
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-align-left me-2"></i>
                        –û–ø–∏—Å–∞–Ω–∏–µ
                    </h6>
                    <div class="bg-light p-3 rounded">
                        {{ task.description|format_clickup_text }}
                    </div>
                </div>
                {% endif %}
                
                <!-- –í–ª–æ–∂–µ–Ω–∏—è -->
                <div class="mb-4">
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-paperclip me-2"></i>
                        –í–ª–æ–∂–µ–Ω–∏—è
                    </h6>
                    
                    {% if attachments %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            –í–ª–æ–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ ClickUp API ({{ attachments|length }})
                        </div>
                        <div class="row">
                            {% for attachment in attachments %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-file me-2 text-muted"></i>
                                            <div class="flex-grow-1">
                                                <h6 class="card-title mb-1">
                                                    <a href="{{ attachment.url }}" target="_blank" class="text-decoration-none">
                                                        {{ attachment.title|truncatechars:30 }}
                                                    </a>
                                                </h6>
                                                {% if attachment.size %}
                                                <small class="text-muted">
                                                    {{ attachment.size|filesizeformat }}
                                                </small>
                                                {% endif %}
                                                {% if attachment.date %}
                                                <br><small class="text-muted">
                                                    {{ attachment.date|date:"d.m.Y H:i" }}
                                                </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% elif task.attachments %}
                        <!-- Fallback –∫ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º -->
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            –í–ª–æ–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞ ({{ task.attachments|length }})
                        </div>
                        <div class="row">
                            {% for attachment in task.attachments %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-file me-2 text-muted"></i>
                                            <div class="flex-grow-1">
                                                <h6 class="card-title mb-1">
                                                    <a href="{{ attachment.url }}" target="_blank" class="text-decoration-none">
                                                        {{ attachment.name|truncatechars:30 }}
                                                    </a>
                                                </h6>
                                                {% if attachment.size %}
                                                <small class="text-muted">
                                                    {{ attachment.size|filesizeformat }}
                                                </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-light">
                            <i class="fas fa-info-circle me-2"></i>
                            –£ —ç—Ç–æ–π –∑–∞–¥–∞—á–∏ –Ω–µ—Ç –≤–ª–æ–∂–µ–Ω–∏–π
                        </div>
                    {% endif %}
                </div>
                
                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è -->
                {% if task.get_custom_fields_display %}
                <div class="mb-4">
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-cogs me-2"></i>
                        –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                    </h6>
                    <div class="row">
                        {% for field in task.get_custom_fields_display %}
                            {% if field.value %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="custom-field-item">
                                        <div class="custom-field-name text-muted small">
                                            {{ field.name }}
                                        </div>
                                        <div class="custom-field-value">
                                            {% if field.type == 'dropdown' or field.type == 'labels' %}
                                                {% if field.value %}
                                                    {% for value in field.value %}
                                                        <span class="badge bg-info me-1 mb-1">{{ value }}</span>
                                                    {% endfor %}
                                                {% endif %}
                                            {% elif field.type == 'date' %}
                                                <span class="badge bg-warning">{{ field.value|date:"d.m.Y" }}</span>
                                            {% elif field.type == 'number' %}
                                                <span class="badge bg-success">{{ field.value }}</span>
                                            {% elif field.type == 'checkbox' %}
                                                {% if field.value %}
                                                    <span class="badge bg-success">–î–∞</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">–ù–µ—Ç</span>
                                                {% endif %}
                                            {% elif field.type == 'url' %}
                                                <a href="{{ field.value }}" target="_blank" class="text-primary">
                                                    {{ field.value|truncatechars:50 }}
                                                </a>
                                            {% elif field.type == 'email' %}
                                                <a href="mailto:{{ field.value }}" class="text-primary">
                                                    {{ field.value }}
                                                </a>
                                            {% elif field.type == 'phone' %}
                                                <a href="tel:{{ field.value }}" class="text-primary">
                                                    {{ field.value }}
                                                </a>
                                            {% else %}
                                                <span class="text-dark">{{ field.value }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
                {% if comments %}
                <div class="mb-4">
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-comments me-2"></i>
                        –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ comments|length }})
                    </h6>
                    <div class="comments-container">
                        {% for comment in comments %}
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle me-2">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div>
                                            <strong>{{ comment.user.username|default:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" }}</strong>
                                            {% if comment.user.email %}
                                            <br><small class="text-muted">{{ comment.user.email }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        {{ comment.date|date:"d.m.Y H:i" }}
                                    </small>
                                </div>
                                
                        {% if comment.comment %}
                        <div class="comment-content">
                            {% if comment.comment_raw and comment.comment_raw != comment.comment %}
                                <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞—Ä—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º -->
                                {{ comment.comment|safe|linebreaks }}
                                <details class="mt-2">
                                    <summary class="text-muted small">–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç</summary>
                                    <pre class="mt-2 small text-muted">{{ comment.comment_raw|pprint }}</pre>
                                </details>
                            {% else %}
                                {{ comment.comment|safe|linebreaks }}
                            {% endif %}
                        </div>
                        {% endif %}
                                
                                {% if comment.assigned_by %}
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-user-plus me-1"></i>
                                        –ù–∞–∑–Ω–∞—á–µ–Ω–æ: {{ comment.assigned_by.username|default:comment.assigned_by.email }}
                                    </small>
                                </div>
                                {% endif %}
                                
                                {% if comment.resolved %}
                                <div class="mt-2">
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>
                                        –†–µ—à–µ–Ω–æ
                                    </span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="col-lg-4">
        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <div class="card clickup-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    –î–µ–π—Å—Ç–≤–∏—è
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ task.url }}" target="_blank" class="btn clickup-btn">
                        <i class="fas fa-external-link-alt me-1"></i>
                        –û—Ç–∫—Ä—ã—Ç—å –≤ ClickUp
                    </a>
                    <button class="btn clickup-btn-outline" onclick="copyTaskInfo()">
                        <i class="fas fa-copy me-1"></i>
                        –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    </button>
                    <a href="{% url 'clickup_int:tasks_list' %}" class="btn clickup-btn-outline">
                        <i class="fas fa-list me-1"></i>
                        –í—Å–µ –∑–∞–¥–∞—á–∏
                    </a>
                </div>
            </div>
        </div>
        
        <!-- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ -->
        <div class="card clickup-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info me-2"></i>
                    –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                </h5>
            </div>
            <div class="card-body">
                <div class="small text-muted">
                    <div class="mb-2">
                        <strong>–°–æ–∑–¥–∞–Ω–æ –≤ —Å–∏—Å—Ç–µ–º–µ:</strong><br>
                        {{ task.created_at|date:"d.m.Y H:i" }}
                    </div>
                    <div class="mb-2">
                        <strong>–û–±–Ω–æ–≤–ª–µ–Ω–æ –≤ —Å–∏—Å—Ç–µ–º–µ:</strong><br>
                        {{ task.updated_at|date:"d.m.Y H:i" }}
                    </div>
                    <div class="mb-2">
                        <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong><br>
                        {{ task.user.username }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info') {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger', 
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';
    
    const alertId = 'notification-' + Date.now();
    const alertHtml = `
        <div id="${alertId}" class="alert ${alertClass} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ body
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        const alertElement = document.getElementById(alertId);
        if (alertElement) {
            alertElement.remove();
        }
    }, 5000);
}

// –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–¥–∞—á–µ
function copyTaskInfo() {
    const taskInfo = `–ó–∞–¥–∞—á–∞: {{ task.name }}
ID: #{{ task.task_id }}
–°—Ç–∞—Ç—É—Å: {{ task.status }}
{% if task.priority %}–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {{ task.priority }}{% endif %}
{% if task.due_date %}–°—Ä–æ–∫: {{ task.due_date|date:"d.m.Y H:i" }}{% endif %}
{% if task.assignees %}–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: {{ task.assignees|join:", " }}{% endif %}
{% if task.tags %}–¢–µ–≥–∏: {{ task.tags|join:", " }}{% endif %}
–°—Å—ã–ª–∫–∞: {{ task.url }}`;
    
    navigator.clipboard.writeText(taskInfo).then(() => {
        showNotification('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞—á–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
    }).catch(err => {
        showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ' + err.message, 'error');
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤ Huntflow
function transferToHuntflow() {
    console.log('üöÄ transferToHuntflow() –≤—ã–∑–≤–∞–Ω–∞');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ (PDF, LinkedIn –∏–ª–∏ rabota.by)
    const attachments = {{ attachments|length|default:0 }};
    const customFields = {{ task.get_custom_fields_display|length|default:0 }};
    
    console.log('üìé –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–ª–æ–∂–µ–Ω–∏–π:', attachments);
    console.log('üìã –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ custom fields:', customFields);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ —Å –¥–∞–Ω–Ω—ã–º–∏
    let hasValidField = false;
    {% for field in task.get_custom_fields_display %}
        {% if field.value %}
            hasValidField = true;
        {% endif %}
    {% endfor %}
    
    console.log('‚úÖ –ï—Å—Ç—å –≤–∞–ª–∏–¥–Ω—ã–µ –ø–æ–ª—è:', hasValidField);
    
    if (attachments === 0 && !hasValidField) {
        showNotification('–£ —ç—Ç–æ–π –∑–∞–¥–∞—á–∏ –Ω–µ—Ç PDF —Ñ–∞–π–ª–æ–≤, LinkedIn –∏–ª–∏ rabota.by —Å—Å—ã–ª–æ–∫ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞', 'warning');
        return;
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –æ–¥–Ω–∞
    const accountSelect = document.getElementById('huntflowAccount');
    console.log('üè¢ –≠–ª–µ–º–µ–Ω—Ç huntflowAccount:', accountSelect);
    
    if (!accountSelect) {
        console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç huntflowAccount –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
    }
    
    const accounts = accountSelect.querySelectorAll('option[value]');
    console.log('üìã –ù–∞–π–¥–µ–Ω–æ –æ–ø—Ü–∏–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π:', accounts.length);
    
    if (accounts.length === 1) {
        // –ï—Å–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –æ–¥–Ω–∞, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –µ—ë
        const accountValue = accounts[0].value;
        console.log('üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é:', accountValue);
        accountSelect.value = accountValue;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞–∫–∞–Ω—Å–∏–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
        setTimeout(() => {
            console.log('‚è∞ –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤–∞–∫–∞–Ω—Å–∏–π —á–µ—Ä–µ–∑ 100ms');
            loadHuntflowVacancies();
        }, 100);
    } else {
        console.log('‚ö†Ô∏è –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –±–æ–ª—å—à–µ –æ–¥–Ω–æ–π –∏–ª–∏ –Ω–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–≤—ã–±–æ—Ä');
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –≤–∞–∫–∞–Ω—Å–∏–∏
    console.log('üì± –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ');
    const modal = $('#huntflowModal');
    console.log('üîç –ù–∞–π–¥–µ–Ω–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ:', modal.length);
    
    if (modal.length === 0) {
        console.error('‚ùå –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ huntflowModal –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!');
        return;
    }
    
    modal.modal('show');
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤–∞–∫–∞–Ω—Å–∏–π –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    modal.on('shown.bs.modal', function () {
        console.log('üì± –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∫–∞–∑–∞–Ω–æ, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤–∞–∫–∞–Ω—Å–∏–π');
        const accountId = $('#huntflowAccount').val();
        if (accountId) {
            console.log('üîÑ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ loadHuntflowVacancies()');
            loadHuntflowVacancies();
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–µ—Ä–µ–Ω–æ—Å–∞
function confirmTransfer() {
    const accountId = $('#huntflowAccount').val();
    const vacancyId = $('#huntflowVacancy').val();
    
    if (!accountId) {
        showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é', 'warning');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const transferBtn = document.getElementById('transferBtn');
    const modalTransferBtn = document.querySelector('#huntflowModal .btn-success');
    const originalText = transferBtn.innerHTML;
    const modalOriginalText = modalTransferBtn ? modalTransferBtn.innerHTML : '';
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ
    transferBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>–ü–µ—Ä–µ–Ω–æ—Å–∏–º...';
    transferBtn.disabled = true;
    transferBtn.classList.add('btn-secondary');
    transferBtn.classList.remove('btn-success');
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    if (modalTransferBtn) {
        modalTransferBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>–ü–µ—Ä–µ–Ω–æ—Å–∏–º...';
        modalTransferBtn.disabled = true;
        modalTransferBtn.classList.add('btn-secondary');
        modalTransferBtn.classList.remove('btn-success');
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
    const requestData = {
        account_id: accountId,
        vacancy_id: vacancyId
    };
    
    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ:', requestData);
    console.log('üîç –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö: account_id =', typeof accountId, ', vacancy_id =', typeof vacancyId);
    
    fetch('{% url "clickup_int:transfer_to_huntflow" task.task_id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('–ö–∞–Ω–¥–∏–¥–∞—Ç —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –≤ Huntflow!', 'success');
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
            transferBtn.innerHTML = originalText;
            transferBtn.disabled = false;
            transferBtn.classList.remove('btn-secondary');
            transferBtn.classList.add('btn-success');
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–µ–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            setTimeout(() => {
                $('#huntflowModal').modal('hide');
            }, 1500);
        } else {
            showNotification('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            transferBtn.innerHTML = originalText;
            transferBtn.disabled = false;
            transferBtn.classList.remove('btn-secondary');
            transferBtn.classList.add('btn-success');
            
            if (modalTransferBtn && modalOriginalText) {
                modalTransferBtn.innerHTML = modalOriginalText;
                modalTransferBtn.disabled = false;
                modalTransferBtn.classList.remove('btn-secondary');
                modalTransferBtn.classList.add('btn-success');
            }
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞: ' + error.message, 'error');
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ç–∏
        transferBtn.innerHTML = originalText;
        transferBtn.disabled = false;
        transferBtn.classList.remove('btn-secondary');
        transferBtn.classList.add('btn-success');
        
        if (modalTransferBtn && modalOriginalText) {
            modalTransferBtn.innerHTML = modalOriginalText;
            modalTransferBtn.disabled = false;
            modalTransferBtn.classList.remove('btn-secondary');
            modalTransferBtn.classList.add('btn-success');
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞–∫–∞–Ω—Å–∏–π –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
function loadHuntflowVacancies() {
    console.log('üöÄ loadHuntflowVacancies() –≤—ã–∑–≤–∞–Ω–∞');
    const accountId = $('#huntflowAccount').val();
    console.log('üîç –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞–∫–∞–Ω—Å–∏–∏ –¥–ª—è account_id:', accountId);
    
    if (!accountId) {
        $('#huntflowVacancy').empty().append('<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–∫–∞–Ω—Å–∏—é</option>');
        return;
    }
    
    $('#huntflowVacancy').empty().append('<option value="">–ó–∞–≥—Ä—É–∂–∞–µ–º...</option>');
    
    fetch(`/huntflow/accounts/${accountId}/vacancies/ajax/`)
    .then(response => {
        console.log('üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('üìã –î–∞–Ω–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–π:', data);
        $('#huntflowVacancy').empty();
        
        if (data.success && data.data && data.data.items && data.data.items.length > 0) {
            $('#huntflowVacancy').append('<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–∫–∞–Ω—Å–∏—é (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</option>');
            data.data.items.forEach(vacancy => {
                console.log(`  - –í–∞–∫–∞–Ω—Å–∏—è: ID ${vacancy.id}, Position: ${vacancy.position}`);
                $('#huntflowVacancy').append(`<option value="${vacancy.id}">${vacancy.position}</option>`);
            });
            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.data.items.length} –≤–∞–∫–∞–Ω—Å–∏–π`);
        } else {
            console.log('‚ö†Ô∏è –í–∞–∫–∞–Ω—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–≤–µ—Ä–Ω–∞—è');
            $('#huntflowVacancy').append('<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏)</option>');
        }
    })
    .catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞–∫–∞–Ω—Å–∏–π:', error);
        $('#huntflowVacancy').empty().append('<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏)</option>');
    });
}
// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
$(document).ready(function() {
    console.log('üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ ClickUp –∑–∞–¥–∞—á–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const accountSelect = document.getElementById('huntflowAccount');
    const vacancySelect = document.getElementById('huntflowVacancy');
    const modal = $('#huntflowModal');
    
    console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤:');
    console.log('  - huntflowAccount:', accountSelect ? '–Ω–∞–π–¥–µ–Ω' : '–ù–ï –ù–ê–ô–î–ï–ù');
    console.log('  - huntflowVacancy:', vacancySelect ? '–Ω–∞–π–¥–µ–Ω' : '–ù–ï –ù–ê–ô–î–ï–ù');
    console.log('  - huntflowModal:', modal.length > 0 ? '–Ω–∞–π–¥–µ–Ω' : '–ù–ï –ù–ê–ô–î–ï–ù');
    
    if (accountSelect) {
        const options = accountSelect.querySelectorAll('option[value]');
        console.log('  - –û–ø—Ü–∏–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π:', options.length);
        options.forEach((option, index) => {
            console.log(`    ${index + 1}. ${option.value}: ${option.textContent}`);
        });
    }
});

// –¢–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –≤ –±–∞–∑–æ–≤–æ–º —à–∞–±–ª–æ–Ω–µ
</script>





<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ Huntflow -->
<div class="modal fade" id="huntflowModal" tabindex="-1" aria-labelledby="huntflowModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="huntflowModalLabel">
                    <i class="fas fa-upload me-2"></i>
                    –ü–µ—Ä–µ–Ω–æ—Å –≤ Huntflow
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">
                    {% if huntflow_accounts|length == 1 %}
                        –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–∫–∞–Ω—Å–∏—é –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∏–∑ –∑–∞–¥–∞—á–∏ "{{ task.name }}".
                    {% else %}
                        –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –≤ Huntflow –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∏–∑ –∑–∞–¥–∞—á–∏ "{{ task.name }}".
                    {% endif %}
                    –í–∞–∫–∞–Ω—Å–∏—è –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ - –∫–∞–Ω–¥–∏–¥–∞—Ç –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏.
                    {% if attachments %}
                        –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π PDF —Ñ–∞–π–ª –∏–∑ –≤–ª–æ–∂–µ–Ω–∏–π.
                    {% else %}
                        –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ LinkedIn –∏–ª–∏ rabota.by —Å—Å—ã–ª–∫–∞ –∏–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π.
                    {% endif %}
                </p>
                
                <div class="mb-3">
                    <label for="huntflowAccount" class="form-label">
                        –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
                        {% if huntflow_accounts|length == 1 %}
                            <small class="text-muted">(–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–∞)</small>
                        {% endif %}
                    </label>
                    <select class="form-select" id="huntflowAccount" onchange="loadHuntflowVacancies()" {% if huntflow_accounts|length == 1 %}disabled{% endif %}>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</option>
                        {% for account in huntflow_accounts %}
                        <option value="{{ account.id }}" {% if huntflow_accounts|length == 1 %}selected{% endif %}>{{ account.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="huntflowVacancy" class="form-label">–í–∞–∫–∞–Ω—Å–∏—è <small class="text-muted">(–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</small></label>
                    <select class="form-select" id="huntflowVacancy">
                        {% if huntflow_accounts|length == 1 %}
                            <option value="">–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞–∫–∞–Ω—Å–∏–∏...</option>
                        {% else %}
                            <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</option>
                        {% endif %}
                    </select>
                    <small class="form-text text-muted">
                        –ï—Å–ª–∏ –≤–∞–∫–∞–Ω—Å–∏–π –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∏ –Ω–µ –ø–æ–¥—Ö–æ–¥—è—Ç, –∫–∞–Ω–¥–∏–¥–∞—Ç –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –≤–∞–∫–∞–Ω—Å–∏–∏
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-success" onclick="confirmTransfer()">
                    <i class="fas fa-upload me-1"></i>
                    –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
