{% extends "telegram/base.html" %}

{% block page_title %}Telegram - Чаты{% endblock %}

{% block telegram_content %}
<div class="telegram-chat-container">
    <!-- Список чатов -->
    <div class="telegram-chat-list">
        <div class="p-3 border-bottom">
            <h5 class="mb-0">
                <i class="fas fa-comments me-2"></i>
                Ваши чаты
            </h5>
        </div>
        
        <div id="chat-list" class="list-group list-group-flush">
            <div class="telegram-chat-item text-center text-muted">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Загрузка чатов...
            </div>
        </div>
    </div>

    <!-- Область сообщений -->
    <div class="telegram-messages">
        <div class="text-center text-muted">
            <i class="fas fa-comment-dots fa-3x mb-3"></i>
            <h5>Выберите чат</h5>
            <p>Выберите чат из списка слева для просмотра сообщений</p>
        </div>
        
        <ul id="msg-list" style="list-style:none; padding:0; display:none;">
            <!-- Сообщения будут здесь -->
        </ul>
    </div>
</div>

<!-- Кнопки управления -->
<div class="mt-3 text-center">
    <button class="btn btn-outline-primary me-2" onclick="loadChats()">
        <i class="fas fa-sync-alt me-2"></i>Обновить чаты
    </button>
    <button class="btn btn-outline-danger me-2" onclick="logoutTelegram()">
        <i class="fas fa-sign-out-alt me-2"></i>Выйти из Telegram
    </button>
    <button class="btn btn-outline-warning" onclick="resetAuth()">
        <i class="fas fa-redo me-2"></i>Сбросить авторизацию
    </button>
</div>
{% endblock %}

{% block telegram_js %}
<script>
    let currentChatId = null;
    let messageRefreshInterval;

    async function loadChats() {
        const chatList = document.getElementById('chat-list');
        
        try {
            showTelegramStatus('Загрузка чатов...', 'info');
            const res = await telegramAPI.get('{% url "telegram:chats_list" %}');
            
            chatList.innerHTML = '';
            
            if (res.data && res.data.length > 0) {
                res.data.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = 'telegram-chat-item';
                    chatItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${chat.title}</strong>
                                <br>
                                <small class="text-muted">${chat.type}</small>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    `;
                    chatItem.style.cursor = 'pointer';
                    chatItem.onclick = () => selectChat(chat.id, chat.title);
                    chatList.appendChild(chatItem);
                });
                showTelegramStatus('Чаты загружены', 'success');
            } else {
                chatList.innerHTML = `
                    <div class="telegram-chat-item text-center text-muted">
                        <i class="fas fa-inbox me-2"></i>
                        Чаты не найдены
                    </div>
                `;
                showTelegramStatus('Чаты не найдены', 'info');
            }
        } catch (error) {
            chatList.innerHTML = `
                <div class="telegram-chat-item text-center text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Ошибка загрузки чатов
                </div>
            `;
            console.error('Error loading chats:', error);
        }
    }

    function selectChat(chatId, chatTitle) {
        currentChatId = chatId;
        
        // Обновляем активный элемент в списке
        document.querySelectorAll('.telegram-chat-item').forEach(item => {
            item.classList.remove('active');
        });
        event.currentTarget.classList.add('active');
        
        // Загружаем сообщения
        loadMessages(chatId);
        
        // Начинаем автообновление сообщений
        startMessagesAutoRefresh();
    }

    async function loadMessages(chatId) {
        const msgList = document.getElementById('msg-list');
        const messagesContainer = document.querySelector('.telegram-messages');
        
        try {
            showTelegramStatus('Загрузка сообщений...', 'info');
            const res = await telegramAPI.get(`{% url "telegram:messages_list" "000000000" %}`.replace('000000000', chatId));
            
            msgList.innerHTML = '';
            
            if (res.data && res.data.length > 0) {
                // Скрываем заглушку и показываем список сообщений
                messagesContainer.querySelector('.text-center').style.display = 'none';
                msgList.style.display = 'block';
                
                res.data.reverse().forEach(message => {
                    const msgItem = document.createElement('li');
                    msgItem.className = `telegram-message ${message.is_outgoing ? 'outgoing' : 'incoming'}`;
                    
                    const time = message.date ? new Date(message.date).toLocaleString() : 'Неизвестно';
                    
                    msgItem.innerHTML = `
                        <div class="telegram-message-time">${time}</div>
                        <div class="telegram-message-text">
                            ${message.text || '<em>(Медиа-сообщение)</em>'}
                        </div>
                    `;
                    
                    msgList.appendChild(msgItem);
                });
                
                // Прокручиваем вниз
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                showTelegramStatus('Сообщения загружены', 'success');
            } else {
                // Показываем заглушку
                messagesContainer.querySelector('.text-center').style.display = 'block';
                msgList.style.display = 'none';
                showTelegramStatus('Сообщения не найдены', 'info');
            }
        } catch (error) {
            messagesContainer.querySelector('.text-center').style.display = 'block';
            msgList.style.display = 'none';
            console.error('Error loading messages:', error);
        }
    }

    function startMessagesAutoRefresh() {
        if (messageRefreshInterval) {
            clearInterval(messageRefreshInterval);
        }
        
        if (currentChatId) {
            messageRefreshInterval = setInterval(() => {
                loadMessages(currentChatId);
            }, 10000); // Обновляем каждые 10 секунд
        }
    }

    function stopMessagesAutoRefresh() {
        if (messageRefreshInterval) {
            clearInterval(messageRefreshInterval);
            messageRefreshInterval = null;
        }
    }

    async function logoutTelegram() {
        if (!confirm('Вы уверены, что хотите выйти из Telegram?')) {
            return;
        }
        
        try {
            showTelegramStatus('Выход из Telegram...', 'info');
            await telegramAPI.post('{% url "telegram:reset_session" %}');
            showTelegramStatus('Вы вышли из Telegram', 'success');
            setTimeout(() => location.reload(), 2000);
        } catch (error) {
            console.error('Error logging out:', error);
        }
    }

    async function resetAuth() {
        if (!confirm('Вы уверены, что хотите сбросить авторизацию Telegram? Это потребует повторной авторизации.')) {
            return;
        }
        
        try {
            showTelegramStatus('Сброс авторизации...', 'info');
            await telegramAPI.post('{% url "telegram:reset_session" %}');
            showTelegramStatus('Авторизация сброшена', 'success');
            setTimeout(() => location.reload(), 2000);
        } catch (error) {
            console.error('Error resetting auth:', error);
        }
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', () => {
        loadChats();
    });

    // Очистка при размонтировании
    window.addEventListener('beforeunload', () => {
        stopMessagesAutoRefresh();
    });
</script>
{% endblock %}
