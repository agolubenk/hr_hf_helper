{% extends 'profile/base.html' %}

{% block profile_title %}Интеграции - HR Helper{% endblock %}
{% block profile_page_title %}Управление интеграциями{% endblock %}

{% block profile_content %}
<div class="card profile-card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-plug me-2"></i>
            Статус интеграций
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            {% for key, integration in integrations.items %}
            <div class="col-md-4 mb-4">
                <div class="integration-card card {% if integration.enabled %}border-success{% else %}border-danger{% endif %} position-relative">
                    <!-- Кнопка настроек в правом верхнем углу -->
                    <a href="{% url 'accounts:api_keys' %}" class="btn btn-sm {% if integration.enabled %}btn-outline-success{% else %}btn-outline-danger{% endif %} position-absolute" style="top: 10px; right: 10px; z-index: 10;" title="Настроить">
                        {% if key == 'huntflow' and integration.token_configured %}
                            <i class="fas fa-key"></i>
                        {% else %}
                            <i class="fas fa-cog"></i>
                        {% endif %}
                    </a>
                    
                    <div class="card-body text-center">
                        {% if key == 'huntflow' %}
                            <i class="fas fa-briefcase fa-3x mb-3 {% if integration.enabled %}text-success{% else %}text-danger{% endif %}"></i>
                        {% elif key == 'gemini' %}
                            <i class="fas fa-robot fa-3x mb-3 {% if integration.enabled %}text-success{% else %}text-danger{% endif %}"></i>
                        {% elif key == 'clickup' %}
                            <i class="fas fa-tasks fa-3x mb-3 {% if integration.enabled %}text-success{% else %}text-danger{% endif %}"></i>
                        {% elif key == 'telegram' %}
                            <i class="fab fa-telegram fa-3x mb-3 {% if integration.enabled %}text-success{% else %}text-danger{% endif %}"></i>
                        {% elif key == 'notion' %}
                            <i class="fas fa-file-alt fa-3x mb-3 {% if integration.enabled %}text-success{% else %}text-danger{% endif %}"></i>
                        {% endif %}
                        
                        <h5 class="card-title">{{ integration.name }}</h5>
                        
                        {% if integration.enabled %}
                            <span class="status-badge status-active mb-3">Активна</span>
                        {% else %}
                            <span class="status-badge status-inactive mb-3">Неактивна</span>
                        {% endif %}
                        
                        {% if key == 'huntflow' %}
                            <div class="small text-muted mb-3">
                                {% if integration.token_configured %}
                                    <div class="mb-2">
                                        <strong>Токенная система:</strong>
                                        <span class="badge bg-success ms-1">Активна</span>
                                    </div>
                                    <div>Access Token: {% if integration.token_valid %}✅ Валидный{% else %}❌ Истек{% endif %}</div>
                                    <div>Refresh Token: {% if integration.refresh_valid %}✅ Валидный{% else %}❌ Истек{% endif %}</div>
                                {% elif integration.api_configured %}
                                    <div class="mb-2">
                                        <strong>API ключи:</strong>
                                        <span class="badge bg-warning ms-1">Устаревший</span>
                                    </div>
                                    <div>Песочница: {% if integration.sandbox_configured %}✅{% else %}❌{% endif %}</div>
                                    <div>Прод: {% if integration.prod_configured %}✅{% else %}❌{% endif %}</div>
                                {% else %}
                                    <div class="text-danger">Не настроено</div>
                                {% endif %}
                                <div>Активная система: {{ integration.active_system }}</div>
                            </div>
                        {% elif key == 'gemini' %}
                            <div class="small text-muted mb-3">
                                <div>API ключ: {% if integration.configured %}✅{% else %}❌{% endif %}</div>
                            </div>
                        {% elif key == 'clickup' %}
                            <div class="small text-muted mb-3">
                                <div>API ключ: {% if integration.configured %}✅{% else %}❌{% endif %}</div>
                            </div>
                        {% elif key == 'telegram' %}
                            <div class="small text-muted mb-3">
                                <div>Username: {% if integration.configured %}✅{% else %}❌{% endif %}</div>
                            </div>
                        {% elif key == 'notion' %}
                            <div class="small text-muted mb-3">
                                <div>Integration Token: {% if integration.configured %}✅{% else %}❌{% endif %}</div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Подробные инструкции по настройке -->
<div class="card profile-card mt-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-book me-2"></i>
            Подробные инструкции по получению API ключей
        </h5>
    </div>
    <div class="card-body">
        <div class="alert alert-info mb-4">
            <i class="fas fa-lightbulb me-2"></i>
            <strong>Совет:</strong> Нажмите на название интеграции ниже, чтобы увидеть пошаговые инструкции по получению API ключей.
        </div>
        
        <!-- Google OAuth статус -->
        {% if is_google_oauth_connected %}
            <div class="alert alert-success mb-4">
                <div class="d-flex align-items-center">
                    <i class="fas fa-google fa-2x me-3 text-success"></i>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">Google OAuth подключен</h6>
                        <p class="mb-0">
                            <strong>Email:</strong> {{ oauth_account.email }}<br>
                            <strong>Имя:</strong> {{ oauth_account.name }}<br>
                            <strong>Статус токена:</strong> 
                            {% if token_valid %}
                                <span class="text-success">✅ Действителен</span>
                            {% else %}
                                <span class="text-warning">⚠️ Требует обновления</span>
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <a href="/auth/google/login/" class="btn btn-outline-success">
                            <i class="fas fa-sync me-2"></i>
                            Обновить доступ
                        </a>
                    </div>
                </div>
            </div>
        {% elif is_google_social_connected %}
            <div class="alert alert-info mb-4">
                <div class="d-flex align-items-center">
                    <i class="fas fa-google fa-2x me-3 text-info"></i>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">Google авторизация активна</h6>
                        <p class="mb-0">Вы авторизованы через Google аккаунт. Для доступа к Google сервисам (Calendar, Drive, Sheets) подключите дополнительно Google OAuth API.</p>
                    </div>
                    <div>
                        <a href="/auth/google/login/" class="btn btn-primary">
                            <i class="fas fa-plug me-2"></i>
                            Подключить Google API
                        </a>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="alert alert-warning mb-4">
                <div class="d-flex align-items-center">
                    <i class="fas fa-google fa-2x me-3 text-danger"></i>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">Google OAuth не подключен</h6>
                        <p class="mb-0">Подключите ваш Google аккаунт для доступа к Google Calendar, Drive и другим сервисам</p>
                    </div>
                    <div>
                        <a href="/auth/google/login/" class="btn btn-danger">
                            <i class="fab fa-google me-2"></i>
                            Подключить Google
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <div class="accordion" id="integrationAccordion">
            <!-- Gemini AI -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="geminiHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#geminiCollapse">
                        <i class="fas fa-robot me-2"></i>
                        <strong>Gemini AI API</strong>
                        <span class="badge bg-primary ms-2">Google AI</span>
                    </button>
                </h2>
                <div id="geminiCollapse" class="accordion-collapse collapse" data-bs-parent="#integrationAccordion">
                    <div class="accordion-body">
                        <div class="mb-3">
                            <h6><i class="fas fa-link me-2"></i>Ссылка для начала:</h6>
                            <a href="https://ai.google.dev/" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-external-link-alt me-1"></i>
                                https://ai.google.dev/
                            </a>
                        </div>
                        
                        <h6><i class="fas fa-list-ol me-2"></i>Пошаговая инструкция:</h6>
                        <ol class="mb-3">
                            <li><strong>Войти в Google аккаунт</strong> - используйте ваш Google аккаунт</li>
                            <li><strong>Перейти в Google AI Studio</strong> - нажмите на ссылку выше</li>
                            <li><strong>Кликнуть "Get API Key"</strong> - найдите кнопку на главной странице</li>
                            <li><strong>Кликнуть "Create API key"</strong> - создайте новый ключ</li>
                            <li><strong>Выбрать проект или создать новый</strong> - выберите существующий проект Google Cloud или создайте новый</li>
                            <li><strong>Кликнуть "Create API key in existing project"</strong> - подтвердите создание</li>
                            <li><strong>Скопировать ключ и сохранить</strong> - скопируйте полученный API ключ и вставьте в настройки профиля</li>
                        </ol>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Важно:</strong> Сохраните API ключ в безопасном месте. Он больше не будет показан после закрытия страницы.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Huntflow -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="huntflowHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#huntflowCollapse">
                        <i class="fas fa-briefcase me-2"></i>
                        <strong>Huntflow API</strong>
                        <span class="badge bg-success ms-2">ATS</span>
                    </button>
                </h2>
                <div id="huntflowCollapse" class="accordion-collapse collapse" data-bs-parent="#integrationAccordion">
                    <div class="accordion-body">
                        <div class="mb-3">
                            <h6><i class="fas fa-map-marker-alt me-2"></i>Где искать в интерфейсе:</h6>
                            <ul>
                                <li>Правый верхний угол → <strong>Settings</strong> (шестеренка)</li>
                                <li>Вкладка <strong>"Companies"</strong></li>
                                <li>Левое меню → <strong>"API"</strong></li>
                            </ul>
                        </div>
                        
                        <div class="alert alert-success mb-3">
                            <i class="fas fa-star me-2"></i>
                            <strong>Рекомендуется:</strong> Используйте новую токенную систему для более безопасной и надежной интеграции.
                        </div>
                        
                        <h6><i class="fas fa-list-ol me-2"></i>Пошаговая инструкция (Токенная система):</h6>
                        <ol class="mb-3">
                            <li><strong>Кликнуть "+Add token"</strong> - найдите кнопку в разделе API</li>
                            <li><strong>Ввести название токена</strong> - например, "HR Helper Integration"</li>
                            <li><strong>Кликнуть "Generate the key"</strong> - создайте новый токен</li>
                            <li><strong>Перейти по полученной ссылке в новой вкладке</strong> - откроется страница авторизации</li>
                            <li><strong>Кликнуть "Receive token"</strong> - подтвердите получение токена</li>
                            <li><strong>Скопировать оба токена:</strong>
                                <ul>
                                    <li><strong>Access token</strong> - для API запросов (действует 7 дней)</li>
                                    <li><strong>Refresh token</strong> - для обновления (действует 14 дней)</li>
                                </ul>
                            </li>
                            <li><strong>Перейти в HR Helper → Интеграции → Huntflow → Управление токенами</strong></li>
                            <li><strong>Вставить оба токена и сохранить</strong></li>
                        </ol>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Преимущества токенной системы:</strong> Автоматическое обновление токенов, повышенная безопасность, надежная работа без перерывов.
                        </div>
                        
                        <details class="mt-3">
                            <summary class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-history me-1"></i>
                                Старая система API ключей (не рекомендуется)
                            </summary>
                            <div class="mt-2 p-3 bg-light rounded">
                                <p class="small mb-2">Если вы используете старую систему API ключей, перейдите в <strong>Настройки профиля → API ключи</strong> для настройки.</p>
                                <div class="alert alert-warning small">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    <strong>Внимание:</strong> API ключи устарели и могут быть отключены в будущем. Рекомендуется перейти на токенную систему.
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
            
            <!-- ClickUp -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="clickupHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#clickupCollapse">
                        <i class="fas fa-tasks me-2"></i>
                        <strong>ClickUp API</strong>
                        <span class="badge bg-warning ms-2">Task Management</span>
                    </button>
                </h2>
                <div id="clickupCollapse" class="accordion-collapse collapse" data-bs-parent="#integrationAccordion">
                    <div class="accordion-body">
                        <div class="mb-3">
                            <h6><i class="fas fa-map-marker-alt me-2"></i>Где искать в интерфейсе:</h6>
                            <ul>
                                <li>Правый верхний угол → <strong>аватар пользователя</strong></li>
                                <li><strong>"Settings"</strong></li>
                                <li>Левый сайдбар → <strong>"Apps"</strong> или <strong>"ClickUp API"</strong></li>
                            </ul>
                        </div>
                        
                        <h6><i class="fas fa-list-ol me-2"></i>Пошаговая инструкция:</h6>
                        <ol class="mb-3">
                            <li><strong>Кликнуть "+ Create new App"</strong> или <strong>"Generate API Token"</strong> - найдите соответствующую кнопку</li>
                            <li><strong>Ввести название приложения</strong> - например, "HR Helper"</li>
                            <li><strong>Указать redirect URL (если нужен OAuth)</strong> - обычно не требуется для простой интеграции</li>
                            <li><strong>Кликнуть "Create App"</strong> - создайте приложение</li>
                            <li><strong>Скопировать Client ID, Client Secret или API Token</strong> - скопируйте полученный API токен и вставьте в настройки профиля</li>
                        </ol>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Примечание:</strong> API ключ ClickUp позволяет интегрироваться с системой управления задачами для автоматизации процессов.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Telegram -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="telegramHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#telegramCollapse">
                        <i class="fab fa-telegram me-2"></i>
                        <strong>Telegram Username</strong>
                        <span class="badge telegram-badge ms-2">Messaging</span>
                    </button>
                </h2>
                <div id="telegramCollapse" class="accordion-collapse collapse" data-bs-parent="#integrationAccordion">
                    <div class="accordion-body">
                        <div class="mb-3">
                            <h6><i class="fas fa-map-marker-alt me-2"></i>Где начать:</h6>
                            <p>Telegram приложение (мобильное или десктопное)</p>
                        </div>
                        
                        <h6><i class="fas fa-list-ol me-2"></i>Пошаговая инструкция:</h6>
                        <ol class="mb-3">
                            <li><strong>Открыть Telegram</strong> - запустите приложение Telegram</li>
                            <li><strong>Перейти в настройки профиля</strong> - нажмите на аватар в левом верхнем углу</li>
                            <li><strong>Нажать "Edit" или "Редактировать"</strong> - откройте редактирование профиля</li>
                            <li><strong>Найти поле "Username"</strong> - найдите поле для имени пользователя</li>
                            <li><strong>Ввести желаемое имя пользователя</strong> - например, "your_username" (без @)</li>
                            <li><strong>Нажать "Save" или "Сохранить"</strong> - сохраните изменения</li>
                            <li><strong>Скопировать имя пользователя</strong> - скопируйте установленное имя и вставьте в настройки профиля</li>
                        </ol>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Примечание:</strong> Username должен быть уникальным и может содержать только латинские буквы, цифры и подчеркивания. Не забудьте убрать символ @ при вводе в настройки.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Notion -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="notionHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#notionCollapse">
                        <i class="fas fa-file-alt me-2"></i>
                        <strong>Notion API</strong>
                        <span class="badge bg-secondary ms-2">Documentation</span>
                    </button>
                </h2>
                <div id="notionCollapse" class="accordion-collapse collapse" data-bs-parent="#integrationAccordion">
                    <div class="accordion-body">
                        <div class="mb-3">
                            <h6><i class="fas fa-link me-2"></i>Ссылка для начала:</h6>
                            <a href="https://www.notion.so/my-integrations" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-external-link-alt me-1"></i>
                                https://www.notion.so/my-integrations
                            </a>
                        </div>
                        
                        <h6><i class="fas fa-list-ol me-2"></i>Пошаговая инструкция:</h6>
                        <ol class="mb-3">
                            <li><strong>Войти в Notion аккаунт</strong> - используйте ваш аккаунт Notion</li>
                            <li><strong>Кликнуть "+ New integration"</strong> - создайте новую интеграцию</li>
                            <li><strong>Заполнить форму:</strong>
                                <ul>
                                    <li>Название интеграции (например, "HR Helper")</li>
                                    <li>Выбрать рабочее пространство</li>
                                    <li>Выбрать тип "Internal"</li>
                                </ul>
                            </li>
                            <li><strong>Настроить права доступа</strong> - выберите чтение/запись для нужных баз данных</li>
                            <li><strong>Кликнуть "Submit"</strong> - создайте интеграцию</li>
                            <li><strong>Скопировать "Internal Integration Token"</strong> - сохраните токен и вставьте в настройки профиля</li>
                        </ol>
                        
                        <h6><i class="fas fa-share-alt me-2"></i>Дополнительно - предоставить доступ к страницам:</h6>
                        <ol class="mb-3">
                            <li><strong>Открыть нужную страницу в Notion</strong> - перейдите к странице, которую хотите синхронизировать</li>
                            <li><strong>Кликнуть "..." (три точки)</strong> - найдите меню страницы</li>
                            <li><strong>"Add connections"</strong> - добавьте подключения</li>
                            <li><strong>Выбрать созданную интеграцию</strong> - выберите "HR Helper" или название вашей интеграции</li>
                            <li><strong>"Confirm"</strong> - подтвердите подключение</li>
                        </ol>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Примечание:</strong> Integration Token позволяет интегрироваться с Notion для синхронизации страниц и баз данных. Не забудьте предоставить доступ к нужным страницам.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4 p-3 bg-light rounded">
            <h6><i class="fas fa-question-circle me-2"></i>Нужна помощь?</h6>
            <p class="mb-0">Если у вас возникли проблемы с настройкой интеграций, обратитесь к администратору системы или проверьте документацию соответствующих сервисов.</p>
        </div>
    </div>
</div>
{% endblock %}
