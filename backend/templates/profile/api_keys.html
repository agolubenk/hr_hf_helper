{% extends 'profile/base.html' %}

{% block profile_title %}API ключи - HR Helper{% endblock %}
{% block profile_page_title %}Управление API ключами{% endblock %}

{% block extra_js %}
<script>
function testApiKey(provider, system = null) {
    const apiKeyField = document.getElementById(`${provider}_api_key${system ? '_' + system : ''}`);
    const apiUrlField = system ? document.getElementById(`${provider}_url${system ? '_' + system : ''}`) : null;
    const testButton = document.getElementById(`test_${provider}${system ? '_' + system : ''}`);
    const resultDiv = document.getElementById(`result_${provider}${system ? '_' + system : ''}`);
    
    if (!apiKeyField.value.trim()) {
        resultDiv.innerHTML = '<div class="alert alert-warning">Введите API ключ</div>';
        return;
    }
    
    testButton.disabled = true;
    testButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Тестирование...';
    resultDiv.innerHTML = '';
    
    const formData = new FormData();
    formData.append('api_key', apiKeyField.value);
    if (apiUrlField) {
        formData.append('api_url', apiUrlField.value);
    }
    if (system) {
        formData.append('system', system);
    }
    
    fetch(`/accounts/test-${provider}-api/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = '<div class="alert alert-success">✅ ' + data.message + '</div>';
        } else {
            resultDiv.innerHTML = '<div class="alert alert-danger">❌ ' + data.message + '</div>';
        }
    })
    .catch(error => {
        resultDiv.innerHTML = '<div class="alert alert-danger">❌ Ошибка: ' + error.message + '</div>';
    })
    .finally(() => {
        testButton.disabled = false;
        testButton.innerHTML = '<i class="fas fa-check me-1"></i>Тестировать';
    });
}

// Функции для работы с токенами Huntflow
function loadHuntflowTokenStatus() {
    fetch('{% url "huntflow:huntflow_tokens" %}')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('huntflow-token-status');
            if (data.success) {
                const status = data.status;
                let html = '';
                
                if (status.valid) {
                    html += '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>✅ Токены валидны</div>';
                } else {
                    html += '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>⚠️ Требуется обновление токенов</div>';
                    if (status.issues.length > 0) {
                        html += '<ul class="mb-0">';
                        status.issues.forEach(issue => {
                            html += `<li>${issue}</li>`;
                        });
                        html += '</ul>';
                    }
                }
                
                if (status.access_expires_at) {
                    html += `<small class="text-muted">Access token истекает: ${new Date(status.access_expires_at).toLocaleString()}</small><br>`;
                }
                if (status.refresh_expires_at) {
                    html += `<small class="text-muted">Refresh token истекает: ${new Date(status.refresh_expires_at).toLocaleString()}</small>`;
                }
                
                statusDiv.innerHTML = html;
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки статуса:', error);
        });
}

function saveHuntflowTokens() {
    const accessToken = document.getElementById('huntflow_access_token').value;
    const refreshToken = document.getElementById('huntflow_refresh_token').value;
    
    if (!accessToken || !refreshToken) {
        alert('Необходимо указать оба токена');
        return;
    }
    
    fetch('{% url "huntflow:huntflow_tokens" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            access_token: accessToken,
            refresh_token: refreshToken
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Токены успешно сохранены');
            loadHuntflowTokenStatus();
            document.getElementById('huntflow_access_token').value = '';
            document.getElementById('huntflow_refresh_token').value = '';
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Произошла ошибка при сохранении токенов');
    });
}

function refreshHuntflowToken() {
    fetch('{% url "huntflow:huntflow_refresh_token" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Токен успешно обновлен');
            loadHuntflowTokenStatus();
        } else {
            alert('Ошибка обновления токена: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Произошла ошибка при обновлении токена');
    });
}

function testHuntflowConnection() {
    fetch('{% url "huntflow:huntflow_test_connection" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Подключение успешно!\nПользователь: ${data.user_info.name}\nEmail: ${data.user_info.email}`);
            } else {
                alert('Ошибка подключения: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при тестировании подключения');
        });
}

// Загружаем статус токенов при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadHuntflowTokenStatus();
});
</script>
{% endblock %}


{% block profile_content %}
<form method="post">
    {% csrf_token %}
    
    <!-- Gemini AI -->
    <div class="card profile-card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-robot me-2"></i>
                Gemini AI
            </h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="gemini_api_key" class="form-label">API ключ Gemini</label>
                <div class="input-group">
                    <input type="password" class="form-control" id="gemini_api_key" name="gemini_api_key" 
                           value="{{ user.gemini_api_key }}" placeholder="Введите API ключ Gemini">
                    <button type="button" class="btn btn-outline-secondary" onclick="testApiKey('gemini')" id="test_gemini">
                        <i class="fas fa-check me-1"></i>Тестировать
                    </button>
                </div>
                <div id="result_gemini"></div>
                <div class="form-text">
                    Получите API ключ в <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ClickUp -->
    <div class="card profile-card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-tasks me-2"></i>
                ClickUp
            </h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="clickup_api_key" class="form-label">API ключ ClickUp</label>
                <div class="input-group">
                    <input type="password" class="form-control" id="clickup_api_key" name="clickup_api_key" 
                           value="{{ user.clickup_api_key }}" placeholder="Введите API ключ ClickUp">
                    <button type="button" class="btn btn-outline-secondary" onclick="testApiKey('clickup')" id="test_clickup">
                        <i class="fas fa-check me-1"></i>Тестировать
                    </button>
                </div>
                <div id="result_clickup"></div>
                <div class="form-text">
                    Получите API ключ в <a href="https://app.clickup.com/settings/apps" target="_blank">настройках ClickUp</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notion -->
    <div class="card profile-card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-file-alt me-2"></i>
                Notion
            </h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="notion_integration_token" class="form-label">Integration Token Notion</label>
                <div class="input-group">
                    <input type="password" class="form-control" id="notion_integration_token" name="notion_integration_token" 
                           value="{{ user.notion_integration_token }}" placeholder="Введите Integration Token Notion">
                    <button type="button" class="btn btn-outline-secondary" onclick="testApiKey('notion')" id="test_notion">
                        <i class="fas fa-check me-1"></i>Тестировать
                    </button>
                </div>
                <div id="result_notion"></div>
                <div class="form-text">
                    Получите Integration Token в <a href="https://notion.so/my-integrations" target="_blank">настройках Notion</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Huntflow -->
    <div class="card profile-card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-briefcase me-2"></i>
                Huntflow
            </h5>
        </div>
        <div class="card-body">
            <!-- Песочница -->
            <div class="mb-4">
                <h6 class="text-muted">Песочница (Sandbox)</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="huntflow_sandbox_url" class="form-label">URL</label>
                            <input type="url" class="form-control" id="huntflow_sandbox_url" name="huntflow_sandbox_url" 
                                   value="{{ user.huntflow_sandbox_url }}" placeholder="https://sandbox-api.huntflow.dev">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="huntflow_sandbox_api_key" class="form-label">API ключ</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="huntflow_sandbox_api_key" name="huntflow_sandbox_api_key" 
                                       value="{{ user.huntflow_sandbox_api_key }}" placeholder="API ключ песочницы">
                                <button type="button" class="btn btn-outline-secondary" onclick="testApiKey('huntflow', 'sandbox')" id="test_huntflow_sandbox">
                                    <i class="fas fa-check me-1"></i>Тестировать
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="result_huntflow_sandbox"></div>
            </div>
            
            <!-- Прод -->
            <div class="mb-4">
                <h6 class="text-muted">Продакшн (Production)</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="huntflow_prod_url" class="form-label">URL</label>
                            <input type="url" class="form-control" id="huntflow_prod_url" name="huntflow_prod_url" 
                                   value="{{ user.huntflow_prod_url }}" placeholder="https://api.huntflow.ru">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="huntflow_prod_api_key" class="form-label">API ключ</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="huntflow_prod_api_key" name="huntflow_prod_api_key" 
                                       value="{{ user.huntflow_prod_api_key }}" placeholder="API ключ продакшна">
                                <button type="button" class="btn btn-outline-secondary" onclick="testApiKey('huntflow', 'prod')" id="test_huntflow_prod">
                                    <i class="fas fa-check me-1"></i>Тестировать
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="result_huntflow_prod"></div>
            </div>
            
            <!-- Активная система -->
            <div class="mb-3">
                <label for="active_system" class="form-label">Активная система</label>
                <select class="form-select" id="active_system" name="active_system">
                    <option value="sandbox" {% if user.active_system == 'sandbox' %}selected{% endif %}>Песочница</option>
                    <option value="prod" {% if user.active_system == 'prod' %}selected{% endif %}>Продакшн</option>
                </select>
                <div class="form-text">Выберите, какую систему использовать по умолчанию</div>
            </div>
        </div>
    </div>
    
    <!-- Huntflow Токены (Новая система) -->
    <div class="card profile-card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-key me-2"></i>
                Huntflow Токены
                <span class="badge bg-success ms-2">Рекомендуется</span>
            </h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info mb-3">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Новая токенная система</strong> обеспечивает автоматическое обновление токенов и повышенную безопасность.
            </div>
            
            <!-- Статус токенов -->
            <div id="huntflow-token-status" class="mb-3"></div>
            
            <!-- Форма для токенов -->
            <div class="mb-3">
                <label for="huntflow_access_token" class="form-label">Access Token</label>
                <textarea class="form-control" id="huntflow_access_token" name="huntflow_access_token" rows="3" 
                          placeholder="Вставьте access_token полученный из Huntflow"></textarea>
                <div class="form-text">Access token для API запросов (действует 7 дней)</div>
            </div>
            
            <div class="mb-3">
                <label for="huntflow_refresh_token" class="form-label">Refresh Token</label>
                <textarea class="form-control" id="huntflow_refresh_token" name="huntflow_refresh_token" rows="3"
                          placeholder="Вставьте refresh_token полученный из Huntflow"></textarea>
                <div class="form-text">Refresh token для обновления access token (действует 14 дней)</div>
            </div>
            
            <div class="d-flex gap-2 mb-3">
                <button type="button" class="btn btn-outline-primary" onclick="saveHuntflowTokens()">
                    <i class="fas fa-save me-1"></i>
                    Сохранить токены
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="refreshHuntflowToken()">
                    <i class="fas fa-sync me-1"></i>
                    Обновить токен
                </button>
                <button type="button" class="btn btn-outline-info" onclick="testHuntflowConnection()">
                    <i class="fas fa-plug me-1"></i>
                    Тест подключения
                </button>
            </div>
            
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Важно:</strong> Получите токены в Huntflow: Настройки → API → Добавить токен. 
                <a href="{% url 'accounts:integrations' %}" class="alert-link">Подробные инструкции</a>
            </div>
        </div>
    </div>
    
    <!-- Кнопки -->
    <div class="d-flex justify-content-between">
        <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>
            Отмена
        </a>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>
            Сохранить API ключи
        </button>
    </div>
</form>
{% endblock %}
