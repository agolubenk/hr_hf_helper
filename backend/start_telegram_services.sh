#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -z "$TG_API_ID" ] || [ -z "$TG_API_HASH" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è TG_API_ID –∏ TG_API_HASH"
    echo "   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏—Ö –≤ .env —Ñ–∞–π–ª–µ –∏–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ shell:"
    echo "   export TG_API_ID=your_api_id"
    echo "   export TG_API_HASH=your_api_hash"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Å–µ—Å—Å–∏–π
mkdir -p sessions

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis..."
if ! redis-cli ping > /dev/null 2>&1; then
    echo "‚ùå Redis –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Redis:"
    echo "   brew services start redis  # –Ω–∞ macOS"
    echo "   sudo systemctl start redis # –Ω–∞ Linux"
    exit 1
fi
echo "‚úÖ Redis —Ä–∞–±–æ—Ç–∞–µ—Ç"

# –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
echo "üì¶ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
python3 manage.py migrate

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—á–µ—Ä–µ–¥–∏ –≤ —Ñ–æ–Ω–µ
echo "üîÑ –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏..."
python3 manage.py process_telegram_queue &
QUEUE_PID=$!

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
sleep 2

# –ó–∞–ø—É—Å–∫–∞–µ–º Telethon —Å–µ—Ä–≤–∏—Å –≤ —Ñ–æ–Ω–µ
echo "üì± –ó–∞–ø—É—Å–∫ Telethon —Å–µ—Ä–≤–∏—Å–∞..."
python3 manage.py run_telethon &
TELETHON_PID=$!

# –ó–∞–ø—É—Å–∫–∞–µ–º Django —Å–µ—Ä–≤–µ—Ä
echo "üåê –ó–∞–ø—É—Å–∫ Django —Å–µ—Ä–≤–µ—Ä–∞..."
echo "   –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8000/telegram/ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"
echo "   –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
cleanup() {
    echo ""
    echo "‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
    kill $QUEUE_PID 2>/dev/null
    kill $TELETHON_PID 2>/dev/null
    echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    exit 0
}

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤
trap cleanup SIGINT SIGTERM

# –ó–∞–ø—É—Å–∫–∞–µ–º Django —Å–µ—Ä–≤–µ—Ä –≤ foreground
python3 manage.py runserver 0.0.0.0:8000
