{% load common_filters %}

<ul class="nav flex-column">
    {% for item in menu_items %}
        <!-- Основной элемент меню -->
        <li class="nav-item">
            {% if item.children %}
                <!-- Элемент с подменю - показываем как заголовок с возможностью сворачивания -->
        <span class="nav-link text-white-50 menu-toggle {% if item.active %}active{% endif %}" 
              data-bs-toggle="collapse" 
              data-bs-target="#menu-{{ forloop.counter }}" 
              aria-expanded="{% if item.active %}true{% else %}false{% endif %}" 
              aria-controls="menu-{{ forloop.counter }}"
              style="cursor: pointer;">
          <i class="{{ item.icon }} me-2"></i>
          {{ item.name }}
          <i class="fas fa-chevron-down ms-auto menu-arrow" style="transition: transform 0.3s ease;"></i>
        </span>
            {% else %}
                <!-- Обычная ссылка без подменю -->
                {% if item.url %}
                    {% if item.url_kwargs %}
                        {% if item.url_kwargs.account_id and item.url_kwargs.vacancy_id and item.url_kwargs.applicant_id %}
                            <a class="nav-link {% if item.active %}active{% endif %}" 
                               href="{% url item.url account_id=item.url_kwargs.account_id vacancy_id=item.url_kwargs.vacancy_id applicant_id=item.url_kwargs.applicant_id %}">
                        {% elif item.url_kwargs.account_id and item.url_kwargs.vacancy_id %}
                            <a class="nav-link {% if item.active %}active{% endif %}" 
                               href="{% url item.url account_id=item.url_kwargs.account_id vacancy_id=item.url_kwargs.vacancy_id %}">
                        {% elif item.url_kwargs.account_id and item.url_kwargs.applicant_id %}
                            <a class="nav-link {% if item.active %}active{% endif %}" 
                               href="{% url item.url account_id=item.url_kwargs.account_id applicant_id=item.url_kwargs.applicant_id %}">
                        {% elif item.url_kwargs.account_id %}
                            <a class="nav-link {% if item.active %}active{% endif %}" 
                               href="{% url item.url account_id=item.url_kwargs.account_id %}">
                        {% elif item.url_kwargs.session_id %}
                            <a class="nav-link {% if item.active %}active{% endif %}" 
                               href="{% url item.url session_id=item.url_kwargs.session_id %}">
                        {% else %}
                            <a class="nav-link {% if item.active %}active{% endif %}" 
                               href="{% url item.url %}">
                        {% endif %}
                    {% else %}
                        <a class="nav-link {% if item.active %}active{% endif %}" 
                           href="{% url item.url %}">
                    {% endif %}
                        <i class="{{ item.icon }} me-2"></i>
                        {{ item.name }}
                    </a>
                {% else %}
                    <!-- Элемент без ссылки -->
                    <span class="nav-link {% if item.active %}active{% endif %}">
                        <i class="{{ item.icon }} me-2"></i>
                        {{ item.name }}
                    </span>
                {% endif %}
            {% endif %}
        </li>
        
        <!-- Дочерние элементы в коллапсируемом контейнере -->
        {% if item.children %}
        <div class="collapse {% if item.active %}show{% endif %}" id="menu-{{ forloop.counter }}">
            <ul class="nav flex-column">
                {% for child in item.children %}
            <li class="nav-item ms-3">
                {% if child.url %}
                    {% if child.url_kwargs %}
                        {% if child.url_kwargs.account_id and child.url_kwargs.vacancy_id and child.url_kwargs.applicant_id %}
                            <a class="nav-link {% if child.active %}active{% endif %}" 
                               href="{% url child.url account_id=child.url_kwargs.account_id vacancy_id=child.url_kwargs.vacancy_id applicant_id=child.url_kwargs.applicant_id %}">
                        {% elif child.url_kwargs.account_id and child.url_kwargs.vacancy_id %}
                            <a class="nav-link {% if child.active %}active{% endif %}" 
                               href="{% url child.url account_id=child.url_kwargs.account_id vacancy_id=child.url_kwargs.vacancy_id %}">
                        {% elif child.url_kwargs.account_id and child.url_kwargs.applicant_id %}
                            <a class="nav-link {% if child.active %}active{% endif %}" 
                               href="{% url child.url account_id=child.url_kwargs.account_id applicant_id=child.url_kwargs.applicant_id %}">
                        {% elif child.url_kwargs.account_id %}
                            <a class="nav-link {% if child.active %}active{% endif %}" 
                               href="{% url child.url account_id=child.url_kwargs.account_id %}">
                        {% elif child.url_kwargs.session_id %}
                            <a class="nav-link {% if child.active %}active{% endif %}" 
                               href="{% url child.url session_id=child.url_kwargs.session_id %}">
                        {% else %}
                            <a class="nav-link {% if child.active %}active{% endif %}" 
                               href="{% url child.url %}">
                        {% endif %}
                    {% else %}
                        <a class="nav-link {% if child.active %}active{% endif %}" 
                           href="{% url child.url %}">
                    {% endif %}
                        <i class="{{ child.icon }} me-2"></i>
                        {{ child.name|truncatechars:20 }}
                    </a>
                {% else %}
                    <!-- Элемент без ссылки (например, организация на дашборде) -->
                    <span class="nav-link {% if child.active %}active{% endif %}">
                        <i class="{{ child.icon }} me-2"></i>
                        {{ child.name|truncatechars:20 }}
                    </span>
                {% endif %}
            </li>
            
            <!-- Внутренние дочерние элементы (вакансии/кандидаты) -->
            {% for grandchild in child.children %}
                <li class="nav-item ms-4">
                    {% if grandchild.url %}
                        {% if grandchild.url_kwargs %}
                            {% if grandchild.url_kwargs.account_id and grandchild.url_kwargs.vacancy_id and grandchild.url_kwargs.applicant_id %}
                                <a class="nav-link {% if grandchild.active %}active{% endif %}" 
                                   href="{% url grandchild.url account_id=grandchild.url_kwargs.account_id vacancy_id=grandchild.url_kwargs.vacancy_id applicant_id=grandchild.url_kwargs.applicant_id %}">
                            {% elif grandchild.url_kwargs.account_id and grandchild.url_kwargs.vacancy_id %}
                                <a class="nav-link {% if grandchild.active %}active{% endif %}" 
                                   href="{% url grandchild.url account_id=grandchild.url_kwargs.account_id vacancy_id=grandchild.url_kwargs.vacancy_id %}">
                            {% elif grandchild.url_kwargs.account_id and grandchild.url_kwargs.applicant_id %}
                                <a class="nav-link {% if grandchild.active %}active{% endif %}" 
                                   href="{% url grandchild.url account_id=grandchild.url_kwargs.account_id applicant_id=grandchild.url_kwargs.applicant_id %}">
                            {% elif grandchild.url_kwargs.account_id %}
                                <a class="nav-link {% if grandchild.active %}active{% endif %}" 
                                   href="{% url grandchild.url account_id=grandchild.url_kwargs.account_id %}">
                            {% else %}
                                <a class="nav-link {% if grandchild.active %}active{% endif %}" 
                                   href="{% url grandchild.url %}">
                            {% endif %}
                        {% else %}
                            <a class="nav-link {% if grandchild.active %}active{% endif %}" 
                               href="{% url grandchild.url %}">
                        {% endif %}
                            <i class="{{ grandchild.icon }} me-2"></i>
                            {{ grandchild.name|truncatechars:18 }}
                        </a>
                    {% else %}
                        <!-- Элемент без ссылки -->
                        <span class="nav-link {% if grandchild.active %}active{% endif %}">
                            <i class="{{ grandchild.icon }} me-2"></i>
                            {{ grandchild.name|truncatechars:18 }}
                        </span>
                    {% endif %}
                </li>
                
                <!-- Четвертый уровень (конкретные вакансии/кандидаты) -->
                {% for great_grandchild in grandchild.children %}
                    <li class="nav-item ms-5">
                        {% if great_grandchild.url %}
                            {% if great_grandchild.url_kwargs %}
                                {% if great_grandchild.url_kwargs.account_id and great_grandchild.url_kwargs.vacancy_id and great_grandchild.url_kwargs.applicant_id %}
                                    <a class="nav-link {% if great_grandchild.active %}active{% endif %}" 
                                       href="{% url great_grandchild.url account_id=great_grandchild.url_kwargs.account_id vacancy_id=great_grandchild.url_kwargs.vacancy_id applicant_id=great_grandchild.url_kwargs.applicant_id %}">
                                {% elif great_grandchild.url_kwargs.account_id and great_grandchild.url_kwargs.vacancy_id %}
                                    <a class="nav-link {% if great_grandchild.active %}active{% endif %}" 
                                       href="{% url great_grandchild.url account_id=great_grandchild.url_kwargs.account_id vacancy_id=great_grandchild.url_kwargs.vacancy_id %}">
                                {% elif great_grandchild.url_kwargs.account_id and great_grandchild.url_kwargs.applicant_id %}
                                    <a class="nav-link {% if great_grandchild.active %}active{% endif %}" 
                                       href="{% url great_grandchild.url account_id=great_grandchild.url_kwargs.account_id applicant_id=great_grandchild.url_kwargs.applicant_id %}">
                                {% elif great_grandchild.url_kwargs.account_id %}
                                    <a class="nav-link {% if great_grandchild.active %}active{% endif %}" 
                                       href="{% url great_grandchild.url account_id=great_grandchild.url_kwargs.account_id %}">
                                {% else %}
                                    <a class="nav-link {% if great_grandchild.active %}active{% endif %}" 
                                       href="{% url great_grandchild.url %}">
                                {% endif %}
                            {% else %}
                                <a class="nav-link {% if great_grandchild.active %}active{% endif %}" 
                                   href="{% url great_grandchild.url %}">
                            {% endif %}
                                <i class="{{ great_grandchild.icon }} me-2"></i>
                                {{ great_grandchild.name|truncatechars:16 }}
                            </a>
                        {% else %}
                            <!-- Элемент без ссылки -->
                            <span class="nav-link {% if great_grandchild.active %}active{% endif %}">
                                <i class="{{ great_grandchild.icon }} me-2"></i>
                                {{ great_grandchild.name|truncatechars:16 }}
                            </span>
                        {% endif %}
                    </li>
                 {% endfor %}
             {% endfor %}
             {% endfor %}
                 </ul>
             </div>
         {% endif %}
     {% endfor %}
</ul>

