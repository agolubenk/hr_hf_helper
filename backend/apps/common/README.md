# Common App - Общие компоненты

## Описание
Приложение для общих компонентов, используемых во всем проекте: контекстные процессоры, template tags, фильтры и общие шаблоны.

## Зависимости
- Django 5.2.6+
- apps.huntflow (для получения данных организаций)

## Requirements
```python
# В requirements.txt
Django>=5.2.6
```

## Связи с другими приложениями
- **apps.huntflow**: Получает данные организаций для сайдбара
- **Все приложения**: Предоставляет общие template tags и фильтры

## Компоненты

### Context Processors

#### sidebar_menu_context
**Назначение**: Добавляет данные для сайдбара во все шаблоны
**Файл**: `context_processors.py`

**Логика работы:**
1. Получает данные организаций из Huntflow API
2. Обрабатывает ошибки и возвращает пустые данные при сбоях
3. Добавляет в контекст:
   - `accounts_for_menu` - данные для меню
   - `accounts` - список организаций

**Использование в шаблонах:**
```html
{% load common_filters %}
<!-- Данные доступны автоматически -->
{{ accounts_for_menu.items }}
```

### Template Tags

#### common_filters.py
**Файл**: `templatetags/common_filters.py`

**Доступные фильтры:**

##### get_contrast_color(hex_color)
- **Назначение**: Определяет контрастный цвет текста
- **Параметры**: hex цвет (например, "#FF0000")
- **Возвращает**: "#000000" или "#ffffff"
- **Использование**: `{{ color|get_contrast_color }}`

##### simple_sidebar_test(context)
- **Назначение**: Тестовый template tag для отладки
- **Возвращает**: URL и имя пользователя
- **Использование**: `{% simple_sidebar_test %}`

##### common_sidebar_menu(context)
- **Назначение**: Универсальный сайдбар для всех страниц
- **Возвращает**: Структурированное меню с иерархией
- **Использование**: `{% common_sidebar_menu %}`

**Структура меню:**
1. **Дашборд** - главная страница
2. **Профиль** - профиль пользователя
3. **Организации** - иерархическое меню с:
   - Списком организаций
   - Вакансиями для каждой организации
   - Кандидатами для каждой организации
4. **Интервьюеры** - управление интервьюерами
5. **Локальные данные по вакансиям** - локальные вакансии
6. **Google автоматизация** - Google сервисы
7. **Gemini AI** - с подменю:
   - Дашборд
   - Настройки
   - Активный чат (если есть)
8. **Админ панель** - Django админка

### Шаблоны

#### sidebar_menu.html
**Файл**: `templates/common/sidebar_menu.html`
**Назначение**: Рендеринг сайдбара с поддержкой 4 уровней вложенности

**Особенности:**
- Поддержка активных состояний
- Иконки FontAwesome
- Адаптивная структура
- Обработка различных типов URL

## Логика работы

### Контекстный процессор
1. **Проверка авторизации**: Работает только для авторизованных пользователей
2. **Получение данных**: Запрашивает данные из Huntflow API
3. **Обработка ошибок**: Логирует ошибки и возвращает пустые данные
4. **Кэширование**: Данные кэшируются на уровне запроса

### Template Tags
1. **Инициализация**: Загружаются через `{% load common_filters %}`
2. **Контекст**: Получают доступ к request и другим переменным контекста
3. **Рендеринг**: Генерируют HTML для сайдбара

## Настройка

### Подключение в settings.py
```python
TEMPLATES = [
    {
        'OPTIONS': {
            'context_processors': [
                'apps.common.context_processors.sidebar_menu_context',
            ],
        },
    },
]
```

### Использование в шаблонах
```html
<!-- В base.html -->
{% load common_filters %}
{% common_sidebar_menu %}
```

## Эндпоинты
Приложение не предоставляет собственных эндпоинтов, но используется во всех шаблонах проекта.

## Особенности подключения

### Обязательные настройки
1. **Context processor** должен быть добавлен в `TEMPLATES`
2. **Template tags** должны быть загружены в шаблонах
3. **Huntflow API** должен быть настроен для работы сайдбара

### Зависимости
- Требует работающий Huntflow API для получения данных организаций
- Использует стандартные Django template tags

## Отладка

### Логирование
```python
# В context_processors.py
print(f"DEBUG context_processor: accounts_list = {accounts_list}")
print(f"ERROR in sidebar_menu_context: {str(e)}")
```

### Тестирование
```bash
# Проверка работы context processor
python manage.py shell
>>> from apps.common.context_processors import sidebar_menu_context
>>> # Тестирование с mock request
```

## Troubleshooting

### Проблемы с сайдбаром
1. **Пустой сайдбар**: Проверьте настройки Huntflow API
2. **Ошибки в консоли**: Проверьте логи Django
3. **Неправильные ссылки**: Проверьте URL patterns в приложениях

### Проблемы с template tags
1. **Template tag не найден**: Проверьте `{% load common_filters %}`
2. **Ошибки рендеринга**: Проверьте структуру данных в контексте
3. **Медленная загрузка**: Оптимизируйте запросы к Huntflow API

## Производительность
- Context processor выполняется на каждом запросе
- Рекомендуется кэширование данных Huntflow API
- Template tags оптимизированы для быстрого рендеринга
