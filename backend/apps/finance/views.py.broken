from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.core.management import call_command
from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
from django.views.decorators.http import require_http_methods
from django.db import models
from django.db.models import Count, Avg, Min, Max, Case, When
from io import StringIO
import json
from .models import Grade, CurrencyRate, PLNTax, SalaryRange, Benchmark, BenchmarkType, BenchmarkSettings, DataSource, VacancyField, HHVacancyTemp
from .logic.tax_service import TaxService

# –ò–º–ø–æ—Ä—Ç—ã –∏–∑ –Ω–æ–≤—ã—Ö –º–æ–¥—É–ª–µ–π
from .views_modules.dashboard_views import benchmarks_dashboard, dashboard, pln_taxes_dashboard, hh_analysis_dashboard, ai_analysis_dashboard
from .views_modules.currency_views import update_currency_rates
from .views_modules.grade_views import add_grade, delete_grade
from .views_modules.tax_views import add_pln_tax, update_pln_tax, delete_pln_tax, calculate_pln_taxes

# –ò–º–ø–æ—Ä—Ç—ã –∏–∑ logic
from logic.base.response_handler import UnifiedResponseHandler


# –ó–ê–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–ù–û - –ü–ï–†–ï–ù–ï–°–ï–ù–û –í –ú–û–î–£–õ–¨ views_modules/dashboard_views.py
# @login_required
# def benchmarks_dashboard(request):
#     """–û—Ç–¥–µ–ª—å–Ω—ã–π –¥–∞—à–±–æ—Ä–¥ –¥–ª—è –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π"""
#     from decimal import Decimal
    from django.db.models import Count, Avg, Min, Max, Case, When
    from django.db import models
    
    # –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ GET –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    grade_filter = request.GET.getlist('grades')
    vacancy_filter = request.GET.getlist('vacancies')
    location_filter = request.GET.getlist('locations')
    
    # –ë–∞–∑–æ–≤—ã–π queryset —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
    base_queryset = Benchmark.objects.filter(is_active=True)
    
    if grade_filter:
        base_queryset = base_queryset.filter(grade_id__in=grade_filter)
    if vacancy_filter:
        base_queryset = base_queryset.filter(vacancy_id__in=vacancy_filter)
    if location_filter:
        base_queryset = base_queryset.filter(location__in=location_filter)
    
    # –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    total_benchmarks = base_queryset.count()
    candidate_benchmarks = base_queryset.filter(type='candidate')
    vacancy_benchmarks = base_queryset.filter(type='vacancy')
    
    candidate_count = candidate_benchmarks.count()
    vacancy_count = vacancy_benchmarks.count()
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—É–º–º–∞–º
    if total_benchmarks > 0:
        avg_amount = base_queryset.aggregate(avg=Avg('salary_from'))['avg'] or Decimal('0')
        min_amount = base_queryset.aggregate(min=Min('salary_from'))['min'] or Decimal('0')
        # –î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∑–∞—Ä–ø–ª–∞—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º salary_to, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ salary_from
        from django.db.models import Case, When, Value, IntegerField
        from django.db import models
        max_amount = base_queryset.aggregate(
            max=Max(Case(
                When(salary_to__isnull=False, then='salary_to'),
                default='salary_from',
                output_field=models.DecimalField()
            ))
        )['max'] or Decimal('0')
        
        avg_candidate = candidate_benchmarks.aggregate(avg=Avg('salary_from'))['avg'] or Decimal('0')
        avg_vacancy = vacancy_benchmarks.aggregate(avg=Avg('salary_from'))['avg'] or Decimal('0')
    else:
        avg_amount = min_amount = max_amount = avg_candidate = avg_vacancy = Decimal('0')
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º
    vacancy_stats = base_queryset.values('vacancy__name').annotate(
        count=Count('id'),
        avg_amount=Avg('salary_from')
    ).order_by('-count')[:10]
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥—Ä–µ–π–¥–∞–º
    grade_stats = base_queryset.values('grade__name').annotate(
        count=Count('id'),
        avg_amount=Avg('salary_from')
    ).order_by('-count')[:10]
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º
    location_stats = base_queryset.values('location').annotate(
        count=Count('id'),
        avg_amount=Avg('salary_from')
    ).order_by('-count')[:10]
    
    # –ü–æ—Å–ª–µ–¥–Ω–∏–µ –±–µ–Ω—á–º–∞—Ä–∫–∏
    recent_benchmarks = base_queryset.select_related('vacancy', 'grade').order_by('-date_added')[:6]
    
    # –¢–æ–ø –≤–∞–∫–∞–Ω—Å–∏–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –±–µ–Ω—á–º–∞—Ä–∫–æ–≤
    top_vacancies = base_queryset.values(
        'vacancy__name', 'vacancy__id'
    ).annotate(
        count=Count('id')
    ).order_by('-count')[:5]
    
    # –¢–æ–ø –≥—Ä–µ–π–¥—ã –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –±–µ–Ω—á–º–∞—Ä–∫–æ–≤
    top_grades = base_queryset.values(
        'grade__name', 'grade__id'
    ).annotate(
        count=Count('id')
    ).order_by('-count')[:5]
    
    # –î–∞–Ω–Ω—ã–µ –¥–ª—è –∫—Ä—É–≥–æ–≤—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
    # –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≥—Ä–µ–π–¥–∞–º (–¥–ª—è –∫—Ä—É–≥–æ–≤–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞)
    grade_distribution = base_queryset.values('grade__name').annotate(
        count=Count('id')
    ).order_by('-count')
    
    # –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º (–¥–ª—è –∫—Ä—É–≥–æ–≤–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞)
    vacancy_distribution = base_queryset.values('vacancy__name').annotate(
        count=Count('id')
    ).order_by('-count')[:10]  # –¢–æ–ø 10 –≤–∞–∫–∞–Ω—Å–∏–π
    
    # –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º (–¥–ª—è –∫—Ä—É–≥–æ–≤–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞)
    location_distribution = base_queryset.values('location').annotate(
        count=Count('id')
    ).order_by('-count')[:10]  # –¢–æ–ø 10 –ª–æ–∫–∞—Ü–∏–π
    
    # –î–∞–Ω–Ω—ã–µ –¥–ª—è –ª–∏–Ω–µ–π–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ –º–µ–¥–∏–∞–Ω–Ω–æ–π –∑–∞—Ä–ø–ª–∞—Ç—ã
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –º–µ—Å—è—Ü–∞–º –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 12 –º–µ—Å—è—Ü–µ–≤
    from django.db.models.functions import TruncMonth
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å—è—Ü–µ–≤
    from datetime import datetime, timedelta
    twelve_months_ago = datetime.now() - timedelta(days=365)
    
    # –°—Ä–µ–¥–Ω—è—è –∑–∞—Ä–ø–ª–∞—Ç–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º (–∏—Å–ø–æ–ª—å–∑—É–µ–º Avg –≤–º–µ—Å—Ç–æ Median)
    candidate_avg_by_month = base_queryset.filter(
        type='candidate',
        date_added__gte=twelve_months_ago
    ).annotate(
        month=TruncMonth('date_added')
    ).values('month').annotate(
        avg_salary=Avg('salary_from')
    ).order_by('month')
    
    # –°—Ä–µ–¥–Ω—è—è –∑–∞—Ä–ø–ª–∞—Ç–∞ –≤–∞–∫–∞–Ω—Å–∏–π –ø–æ –º–µ—Å—è—Ü–∞–º (–∏—Å–ø–æ–ª—å–∑—É–µ–º Avg –≤–º–µ—Å—Ç–æ Median)
    vacancy_avg_by_month = base_queryset.filter(
        type='vacancy',
        date_added__gte=twelve_months_ago
    ).annotate(
        month=TruncMonth('date_added')
    ).values('month').annotate(
        avg_salary=Avg('salary_from')
    ).order_by('month')
    
    # –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞-—Å–≤–µ—á–µ–∫ –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –º–µ—Å—è—Ü–∞–º –¥–ª—è –∫–∞–∂–¥–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
    vacancy_candlestick_data = base_queryset.filter(
        type='vacancy',
        date_added__gte=twelve_months_ago
    ).annotate(
        month=TruncMonth('date_added')
    ).values('month', 'vacancy__name', 'vacancy__id').annotate(
        min_salary=Min('salary_from'),
        median_min_salary=Avg('salary_from'),  # –ò—Å–ø–æ–ª—å–∑—É–µ–º Avg –∫–∞–∫ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –∫ –º–µ–¥–∏–∞–Ω–µ
        median_max_salary=Avg(Case(
            When(salary_to__isnull=False, then='salary_to'),
            default='salary_from',
            output_field=models.DecimalField()
        )),
        max_salary=Max(Case(
            When(salary_to__isnull=False, then='salary_to'),
            default='salary_from',
            output_field=models.DecimalField()
        )),
        count=Count('id')
    ).order_by('month', 'vacancy__name')
    
    # –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    available_grades = Benchmark.objects.filter(is_active=True).values_list('grade__id', 'grade__name').distinct().order_by('grade__name')
    available_vacancies = Benchmark.objects.filter(is_active=True).values_list('vacancy__id', 'vacancy__name').distinct().order_by('vacancy__name')
    available_locations = Benchmark.objects.filter(is_active=True).values_list('location', flat=True).distinct().order_by('location')
    
    context = {
        'total_benchmarks': total_benchmarks,
        'candidate_count': candidate_count,
        'vacancy_count': vacancy_count,
        'avg_amount': avg_amount,
        'min_amount': min_amount,
        'max_amount': max_amount,
        'avg_candidate': avg_candidate,
        'avg_vacancy': avg_vacancy,
        'vacancy_stats': vacancy_stats,
        'grade_stats': grade_stats,
        'location_stats': location_stats,
        'recent_benchmarks': recent_benchmarks,
        'top_vacancies': top_vacancies,
        'top_grades': top_grades,
        
        # –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ (—Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤ JSON)
        'grade_distribution': json.dumps([{'grade__name': item['grade__name'], 'count': item['count']} for item in grade_distribution]),
        'vacancy_distribution': json.dumps([{'vacancy__name': item['vacancy__name'], 'count': item['count']} for item in vacancy_distribution]),
        'location_distribution': json.dumps([{'location': item['location'], 'count': item['count']} for item in location_distribution]),
        'type_comparison_data': [
            {'type': '–ö–∞–Ω–¥–∏–¥–∞—Ç—ã', 'count': candidate_count, 'avg_salary': float(avg_candidate) if avg_candidate else 0},
            {'type': '–í–∞–∫–∞–Ω—Å–∏–∏', 'count': vacancy_count, 'avg_salary': float(avg_vacancy) if avg_vacancy else 0}
        ],
        'candidate_avg_by_month': [{'month': item['month'].strftime('%Y-%m-%d') if item['month'] else None, 'avg_salary': float(item['avg_salary']) if item['avg_salary'] else 0} for item in candidate_avg_by_month],
        'vacancy_avg_by_month': [{'month': item['month'].strftime('%Y-%m-%d') if item['month'] else None, 'avg_salary': float(item['avg_salary']) if item['avg_salary'] else 0} for item in vacancy_avg_by_month],
        'vacancy_candlestick_data': [{
            'month': item['month'].strftime('%Y-%m-%d') if item['month'] else None,
            'vacancy__name': item['vacancy__name'],
            'vacancy__id': item['vacancy__id'],
            'min_salary': float(item['min_salary']) if item['min_salary'] else 0,
            'median_min_salary': float(item['median_min_salary']) if item['median_min_salary'] else 0,
            'median_max_salary': float(item['median_max_salary']) if item['median_max_salary'] else 0,
            'max_salary': float(item['max_salary']) if item['max_salary'] else 0,
            'count': item['count']
        } for item in vacancy_candlestick_data],
        
        # –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        'available_grades': available_grades,
        'available_vacancies': available_vacancies,
        'available_locations': available_locations,
    }
    return render(request, 'finance/benchmarks_dashboard.html', context)


@login_required
def dashboard(request):
    """–î–∞—à–±–æ—Ä–¥ —Å –≥—Ä–µ–π–¥–∞–º–∏, –∫—É—Ä—Å–∞–º–∏ –≤–∞–ª—é—Ç, –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã–º–∏ –≤–∏–ª–∫–∞–º–∏ –∏ –Ω–∞–ª–æ–≥–∞–º–∏ PLN"""
    grades = Grade.objects.all().order_by('name')
    currency_rates = CurrencyRate.objects.all().order_by('code')
    pln_taxes = PLNTax.objects.filter(is_active=True).order_by('name')
    salary_ranges = SalaryRange.objects.select_related('vacancy', 'grade').filter(is_active=True).order_by('grade__name', 'vacancy__name')
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    active_salary_ranges_count = salary_ranges.count()
    
    # –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞–ª–æ–≥–æ–≤ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
    from decimal import Decimal
    example_net = Decimal('5000.00')
    example_breakdown = TaxService.get_tax_breakdown(TaxService.calculate_gross_from_net(example_net, "PLN"), "PLN")
    
    context = {
        'grades': grades,
        'currency_rates': currency_rates,
        'pln_taxes': pln_taxes,
        'salary_ranges': salary_ranges,
        'active_salary_ranges_count': active_salary_ranges_count,
        'example_calculation': {
            'net_amount': example_net,
            'breakdown': example_breakdown
        }
    }
    return render(request, 'finance/dashboard.html', context)


@login_required
def update_currency_rates(request):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç –∏–∑ –ù–ë–†–ë"""
    try:
        # –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã
        out = StringIO()
        call_command('update_nbrb_rates', stdout=out, stderr=out)
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        output = out.getvalue()
        if "üéâ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!" in output:
            messages.success(request, "–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ –ù–ë–†–ë!")
        else:
            messages.warning(request, f"–ö—É—Ä—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏")
            
    except Exception as e:
        messages.error(request, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫—É—Ä—Å–æ–≤: {e}")
    
    return redirect('finance:dashboard')


@login_required
@csrf_exempt
@require_http_methods(["POST"])
def add_grade(request):
    """–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –≥—Ä–µ–π–¥"""
    try:
        data = json.loads(request.body)
        grade_name = data.get('name', '').strip()
        
        if not grade_name:
            return JsonResponse({'success': False, 'message': '–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä–µ–π–¥–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'})
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –≥—Ä–µ–π–¥
        if Grade.objects.filter(name=grade_name).exists():
            return JsonResponse({'success': False, 'message': '–ì—Ä–µ–π–¥ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'})
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≥—Ä–µ–π–¥
        grade = Grade.objects.create(name=grade_name)
        
        return JsonResponse({
            'success': True, 
            'message': '–ì—Ä–µ–π–¥ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω',
            'grade': {
                'id': grade.id,
                'name': grade.name
            }
        })
        
    except json.JSONDecodeError:
        return JsonResponse({'success': False, 'message': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö'})
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≥—Ä–µ–π–¥–∞: {str(e)}'})


@login_required
@csrf_exempt
@require_http_methods(["DELETE"])
def delete_grade(request, grade_id):
    """–£–¥–∞–ª—è–µ—Ç –≥—Ä–µ–π–¥"""
    try:
        grade = get_object_or_404(Grade, id=grade_id)
        grade_name = grade.name
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ –≥—Ä–µ–π–¥ –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥–µ–ª—è—Ö
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
        
        grade.delete()
        
        return JsonResponse({
            'success': True, 
            'message': f'–ì—Ä–µ–π–¥ "{grade_name}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω'
        })
        
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≥—Ä–µ–π–¥–∞: {str(e)}'})


@login_required
@csrf_exempt
@require_http_methods(["POST"])
def add_pln_tax(request):
    """–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –Ω–∞–ª–æ–≥ PLN"""
    try:
        data = json.loads(request.body)
        name = data.get('name', '').strip()
        rate = data.get('rate')
        is_active = data.get('is_active', True)
        
        if not name:
            return JsonResponse({'success': False, 'message': '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–ª–æ–≥–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'})
        
        if rate is None:
            return JsonResponse({'success': False, 'message': '–ù–∞–ª–æ–≥–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞'})
        
        try:
            rate = float(rate)
            if rate < 0 or rate > 100:
                return JsonResponse({'success': False, 'message': '–ù–∞–ª–æ–≥–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 0 –¥–æ 100%'})
        except (ValueError, TypeError):
            return JsonResponse({'success': False, 'message': '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞–ª–æ–≥–æ–≤–æ–π —Å—Ç–∞–≤–∫–∏'})
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –Ω–∞–ª–æ–≥
        tax = PLNTax.objects.create(
            name=name,
            rate=rate,
            is_active=is_active
        )
        
        return JsonResponse({
            'success': True, 
            'message': '–ù–∞–ª–æ–≥ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω',
            'tax': {
                'id': tax.id,
                'name': tax.name,
                'rate': float(tax.rate),
                'is_active': tax.is_active
            }
        })
        
    except json.JSONDecodeError:
        return JsonResponse({'success': False, 'message': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö'})
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–∞–ª–æ–≥–∞: {str(e)}'})


@login_required
@csrf_exempt
@require_http_methods(["PUT"])
def update_pln_tax(request, tax_id):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∞–ª–æ–≥ PLN"""
    try:
        tax = get_object_or_404(PLNTax, id=tax_id)
        data = json.loads(request.body)
        
        name = data.get('name', '').strip()
        rate = data.get('rate')
        is_active = data.get('is_active')
        
        if name:
            tax.name = name
        
        if rate is not None:
            try:
                rate = float(rate)
                if rate < 0 or rate > 100:
                    return JsonResponse({'success': False, 'message': '–ù–∞–ª–æ–≥–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 0 –¥–æ 100%'})
                tax.rate = rate
            except (ValueError, TypeError):
                return JsonResponse({'success': False, 'message': '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞–ª–æ–≥–æ–≤–æ–π —Å—Ç–∞–≤–∫–∏'})
        
        if is_active is not None:
            tax.is_active = is_active
        
        tax.save()
        
        return JsonResponse({
            'success': True, 
            'message': '–ù–∞–ª–æ–≥ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω',
            'tax': {
                'id': tax.id,
                'name': tax.name,
                'rate': float(tax.rate),
                'is_active': tax.is_active
            }
        })
        
    except json.JSONDecodeError:
        return JsonResponse({'success': False, 'message': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö'})
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞–ª–æ–≥–∞: {str(e)}'})


@login_required
@csrf_exempt
@require_http_methods(["DELETE"])
def delete_pln_tax(request, tax_id):
    """–£–¥–∞–ª—è–µ—Ç –Ω–∞–ª–æ–≥ PLN"""
    try:
        tax = get_object_or_404(PLNTax, id=tax_id)
        tax_name = tax.name
        tax.delete()
        
        return JsonResponse({
            'success': True, 
            'message': f'–ù–∞–ª–æ–≥ "{tax_name}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω'
        })
        
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –Ω–∞–ª–æ–≥–∞: {str(e)}'})


@login_required
@require_http_methods(["GET"])
def calculate_pln_taxes(request):
    """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–∞–ª–æ–≥–∏ PLN –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–π —Å—É–º–º—ã"""
    try:
        amount = request.GET.get('amount')
        calculation_type = request.GET.get('type', 'gross')  # gross –∏–ª–∏ net
        
        if not amount:
            return JsonResponse({'success': False, 'message': '–°—É–º–º–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞'})
        
        try:
            from decimal import Decimal
            amount = Decimal(str(amount))
        except (ValueError, TypeError):
            return JsonResponse({'success': False, 'message': '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—É–º–º—ã'})
        
        if calculation_type == 'gross':
            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º net –∏–∑ gross
            breakdown = TaxService.get_tax_breakdown(amount, "PLN")
            result = {
                'gross_amount': float(breakdown['gross_amount']),
                'net_amount': float(breakdown['net_amount']),
                'total_tax_amount': float(breakdown['total_tax_amount']),
                'taxes': breakdown['taxes']
            }
        else:
            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º gross –∏–∑ net
            gross_amount = TaxService.calculate_gross_from_net(amount, "PLN")
            breakdown = TaxService.get_tax_breakdown(gross_amount, "PLN")
            result = {
                'gross_amount': float(breakdown['gross_amount']),
                'net_amount': float(breakdown['net_amount']),
                'total_tax_amount': float(breakdown['total_tax_amount']),
                'taxes': breakdown['taxes']
            }
        
        return JsonResponse({
            'success': True,
            'calculation': result
        })
        
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ: {str(e)}'})


@login_required
def pln_taxes_dashboard(request):
    """–î–∞—à–±–æ—Ä–¥ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞–ª–æ–≥–∞–º–∏ PLN"""
    pln_taxes = PLNTax.objects.all().order_by('name')
    active_taxes = PLNTax.objects.filter(is_active=True)
    inactive_taxes = PLNTax.objects.filter(is_active=False)
    
    # –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
    from decimal import Decimal
    example_net = Decimal('5000.00')
    example_gross = TaxService.calculate_gross_from_net(example_net, "PLN")
    example_breakdown = TaxService.get_tax_breakdown(example_gross, "PLN")
    
    context = {
        'pln_taxes': pln_taxes,
        'active_taxes_count': active_taxes.count(),
        'inactive_taxes_count': inactive_taxes.count(),
        'example_calculation': {
            'net_amount': example_net,
            'breakdown': example_breakdown
        }
    }
    
    return render(request, 'finance/pln_taxes_dashboard.html', context)


# Views –¥–ª—è –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã—Ö –≤–∏–ª–æ–∫

@login_required
def salary_ranges_list(request):
    """–°–ø–∏—Å–æ–∫ –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã—Ö –≤–∏–ª–æ–∫"""
    from django.core.paginator import Paginator
    from django.db.models import Q
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
    search_query = request.GET.get('search', '')
    vacancy_filter = request.GET.get('vacancy', '')
    grade_filter = request.GET.get('grade', '')
    status_filter = request.GET.get('is_active', '')
    
    # –ë–∞–∑–æ–≤—ã–π queryset
    salary_ranges = SalaryRange.objects.select_related('grade', 'vacancy').all()
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
    if search_query:
        salary_ranges = salary_ranges.filter(
            Q(grade__name__icontains=search_query) |
            Q(vacancy__name__icontains=search_query)
        )
    
    if vacancy_filter:
        salary_ranges = salary_ranges.filter(vacancy_id=vacancy_filter)
    
    if grade_filter:
        salary_ranges = salary_ranges.filter(grade_id=grade_filter)
    
    if status_filter == 'true':
        salary_ranges = salary_ranges.filter(is_active=True)
    elif status_filter == 'false':
        salary_ranges = salary_ranges.filter(is_active=False)
    
    # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
    paginator = Paginator(salary_ranges, 10)  # 10 –≤–∏–ª–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    from apps.vacancies.models import Vacancy
    vacancies = Vacancy.objects.filter(is_active=True).order_by('name')
    grades = Grade.objects.all().order_by('name')
    
    context = {
        'page_obj': page_obj,
        'search_query': search_query,
        'vacancy_filter': vacancy_filter,
        'grade_filter': grade_filter,
        'status_filter': status_filter,
        'vacancies': vacancies,
        'grades': grades,
        'total_count': salary_ranges.count(),
        'active_count': salary_ranges.filter(is_active=True).count(),
        'inactive_count': salary_ranges.filter(is_active=False).count(),
    }
    
    return render(request, 'finance/salary_ranges_list.html', context)


@login_required
def salary_range_detail(request, pk):
    """–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—Ä–ø–ª–∞—Ç–Ω–æ–π –≤–∏–ª–∫–µ"""
    salary_range = get_object_or_404(SalaryRange, pk=pk)
    
    context = {
        'salary_range': salary_range,
    }
    
    return render(request, 'finance/salary_range_detail.html', context)


@login_required
@csrf_exempt
@require_http_methods(["POST"])
def salary_range_create(request):
    """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞—Ä–ø–ª–∞—Ç–Ω–æ–π –≤–∏–ª–∫–∏"""
    try:
        data = json.loads(request.body)
        
        vacancy_id = data.get('vacancy_id')
        grade_id = data.get('grade_id')
        salary_min_usd = data.get('salary_min_usd')
        salary_max_usd = data.get('salary_max_usd')
        is_active = data.get('is_active', True)
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        if not all([vacancy_id, grade_id, salary_min_usd, salary_max_usd]):
            return JsonResponse({'success': False, 'message': '–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã'})
        
        try:
            salary_min_usd = float(salary_min_usd)
            salary_max_usd = float(salary_max_usd)
            
            if salary_min_usd > salary_max_usd:
                return JsonResponse({'success': False, 'message': '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π'})
                
        except (ValueError, TypeError):
            return JsonResponse({'success': False, 'message': '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∑–∞—Ä–ø–ª–∞—Ç—ã'})
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è –≤–∏–ª–∫–∞
        if SalaryRange.objects.filter(vacancy_id=vacancy_id, grade_id=grade_id).exists():
            return JsonResponse({'success': False, 'message': '–ó–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –≤–∏–ª–∫–∞ –¥–ª—è —ç—Ç–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏ –∏ –≥—Ä–µ–π–¥–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'})
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞—Ä–ø–ª–∞—Ç–Ω—É—é –≤–∏–ª–∫—É
        salary_range = SalaryRange.objects.create(
            vacancy_id=vacancy_id,
            grade_id=grade_id,
            salary_min_usd=salary_min_usd,
            salary_max_usd=salary_max_usd,
            is_active=is_active
        )
        
        return JsonResponse({
            'success': True, 
            'message': '–ó–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –≤–∏–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞',
            'salary_range': {
                'id': salary_range.id,
                'vacancy_name': salary_range.vacancy.name,
                'grade_name': salary_range.grade.name,
                'salary_range_usd': salary_range.salary_range_usd,
                'is_active': salary_range.is_active
            }
        })
        
    except json.JSONDecodeError:
        return JsonResponse({'success': False, 'message': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö'})
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—Ä–ø–ª–∞—Ç–Ω–æ–π –≤–∏–ª–∫–∏: {str(e)}'})


@login_required
@csrf_exempt
@require_http_methods(["PUT"])
def salary_range_update(request, pk):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç–Ω–æ–π –≤–∏–ª–∫–∏"""
    try:
        salary_range = get_object_or_404(SalaryRange, pk=pk)
        data = json.loads(request.body)
        
        salary_min_usd = data.get('salary_min_usd')
        salary_max_usd = data.get('salary_max_usd')
        is_active = data.get('is_active')
        
        if salary_min_usd is not None:
            try:
                salary_min_usd = float(salary_min_usd)
                salary_range.salary_min_usd = salary_min_usd
            except (ValueError, TypeError):
                return JsonResponse({'success': False, 'message': '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞—Ä–ø–ª–∞—Ç—ã'})
        
        if salary_max_usd is not None:
            try:
                salary_max_usd = float(salary_max_usd)
                salary_range.salary_max_usd = salary_max_usd
            except (ValueError, TypeError):
                return JsonResponse({'success': False, 'message': '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∑–∞—Ä–ø–ª–∞—Ç—ã'})
        
        if is_active is not None:
            salary_range.is_active = is_active
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        if salary_range.salary_min_usd and salary_range.salary_max_usd:
            if salary_range.salary_min_usd > salary_range.salary_max_usd:
                return JsonResponse({'success': False, 'message': '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π'})
        
        salary_range.save()
        
        return JsonResponse({
            'success': True, 
            'message': '–ó–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –≤–∏–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞',
            'salary_range': {
                'id': salary_range.id,
                'vacancy_name': salary_range.vacancy.name,
                'grade_name': salary_range.grade.name,
                'salary_range_usd': salary_range.salary_range_usd,
                'is_active': salary_range.is_active
            }
        })
        
    except json.JSONDecodeError:
        return JsonResponse({'success': False, 'message': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö'})
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞—Ä–ø–ª–∞—Ç–Ω–æ–π –≤–∏–ª–∫–∏: {str(e)}'})


@login_required
@csrf_exempt
@require_http_methods(["DELETE"])
def salary_range_delete(request, pk):
    """–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç–Ω–æ–π –≤–∏–ª–∫–∏"""
    try:
        salary_range = get_object_or_404(SalaryRange, pk=pk)
        salary_range_name = f"{salary_range.vacancy.name} - {salary_range.grade.name}"
        salary_range.delete()
        
        return JsonResponse({
            'success': True, 
            'message': f'–ó–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –≤–∏–ª–∫–∞ "{salary_range_name}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞'
        })
        
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞—Ä–ø–ª–∞—Ç–Ω–æ–π –≤–∏–ª–∫–∏: {str(e)}'})


@login_required
@csrf_exempt
@require_http_methods(["POST"])
def update_salary_currency_amounts(request):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É–º–º—ã –≤ –¥—Ä—É–≥–∏—Ö –≤–∞–ª—é—Ç–∞—Ö –¥–ª—è –≤—Å–µ—Ö –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã—Ö –≤–∏–ª–æ–∫"""
    try:
        SalaryRange.update_all_currency_amounts()
        return JsonResponse({
            'success': True, 
            'message': '–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –¥–ª—è –≤—Å–µ—Ö –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã—Ö –≤–∏–ª–æ–∫ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã'
        })
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫—É—Ä—Å–æ–≤: {str(e)}'})


# Views –¥–ª—è –±–µ–Ω—á–º–∞—Ä–∫–æ–≤

@login_required
def benchmarks_list(request):
    """–°–ø–∏—Å–æ–∫ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤"""
    from django.core.paginator import Paginator
    from django.db.models import Q
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    search_query = request.GET.get('search', '')
    type_filter = request.GET.get('type', '')
    vacancy_filter = request.GET.get('vacancy', '')
    grade_filter = request.GET.get('grade', '')
    status_filter = request.GET.get('is_active', '')
    
    # –ë–∞–∑–æ–≤—ã–π queryset
    benchmarks = Benchmark.objects.select_related('grade', 'vacancy').all()
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
    if search_query:
        benchmarks = benchmarks.filter(
            Q(vacancy__name__icontains=search_query) |
            Q(grade__name__icontains=search_query) |
            Q(location__icontains=search_query) |
            Q(notes__icontains=search_query)
        )
    
    if type_filter:
        benchmarks = benchmarks.filter(type=type_filter)
    
    if vacancy_filter:
        benchmarks = benchmarks.filter(vacancy_id=vacancy_filter)
    
    if grade_filter:
        benchmarks = benchmarks.filter(grade_id=grade_filter)
    
    if status_filter == 'true':
        benchmarks = benchmarks.filter(is_active=True)
    elif status_filter == 'false':
        benchmarks = benchmarks.filter(is_active=False)
    
    # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
    paginator = Paginator(benchmarks, 15)  # 15 –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    from apps.vacancies.models import Vacancy
    vacancies = Vacancy.objects.filter(is_active=True).order_by('name')
    grades = Grade.objects.all().order_by('name')
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    candidate_count = Benchmark.objects.filter(type='candidate', is_active=True).count()
    vacancy_count = Benchmark.objects.filter(type='vacancy', is_active=True).count()
    total_count = Benchmark.objects.filter(is_active=True).count()
    
    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
    from apps.finance.models import BenchmarkSettings
    settings = BenchmarkSettings.load()
    
    context = {
        'page_obj': page_obj,
        'search_query': search_query,
        'type_filter': type_filter,
        'vacancy_filter': vacancy_filter,
        'grade_filter': grade_filter,
        'status_filter': status_filter,
        'vacancies': vacancies,
        'grades': grades,
        'total_count': total_count,
        'candidate_count': candidate_count,
        'vacancy_count': vacancy_count,
        'benchmark_types': BenchmarkType.choices,
        'settings': settings,
        'enabled_fields': settings.vacancy_fields if settings.vacancy_fields else [],
    }
    
    return render(request, 'finance/benchmarks_list.html', context)


@login_required
def benchmark_detail(request, pk):
    """–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–µ–Ω—á–º–∞—Ä–∫–µ"""
    benchmark = get_object_or_404(Benchmark, pk=pk)
    
    context = {
        'benchmark': benchmark,
    }
    
    return render(request, 'finance/benchmark_detail.html', context)


@login_required
@csrf_exempt
@require_http_methods(["POST"])
def benchmark_create(request):
    """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –±–µ–Ω—á–º–∞—Ä–∫–∞"""
    try:
        data = json.loads(request.body)
        
        type_value = data.get('type')
        vacancy_id = data.get('vacancy_id')
        grade_id = data.get('grade_id')
        salary_from = data.get('salary_from')
        salary_to = data.get('salary_to')
        location = data.get('location', '').strip()
        notes = data.get('notes', '').strip()
        is_active = data.get('is_active', True)
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        if not all([type_value, vacancy_id, grade_id, salary_from, location]):
            return JsonResponse({'success': False, 'message': '–í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã'})
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø
        if type_value not in ['candidate', 'vacancy']:
            return JsonResponse({'success': False, 'message': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –±–µ–Ω—á–º–∞—Ä–∫–∞'})
        
        try:
            salary_from = float(salary_from)
            if salary_from <= 0:
                return JsonResponse({'success': False, 'message': '–ó–∞—Ä–ø–ª–∞—Ç–∞ "–æ—Ç" –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π'})
        except (ValueError, TypeError):
            return JsonResponse({'success': False, 'message': '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç—ã "–æ—Ç"'})
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ salary_to (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è –≤–∞–∫–∞–Ω—Å–∏–π)
        if salary_to:
            try:
                salary_to = float(salary_to)
                if salary_to <= 0:
                    return JsonResponse({'success': False, 'message': '–ó–∞—Ä–ø–ª–∞—Ç–∞ "–¥–æ" –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π'})
                if salary_to <= salary_from:
                    return JsonResponse({'success': False, 'message': '–ó–∞—Ä–ø–ª–∞—Ç–∞ "–¥–æ" –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –∑–∞—Ä–ø–ª–∞—Ç—ã "–æ—Ç"'})
            except (ValueError, TypeError):
                return JsonResponse({'success': False, 'message': '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç—ã "–¥–æ"'})
        else:
            salary_to = None
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –±–µ–Ω—á–º–∞—Ä–∫
        benchmark = Benchmark.objects.create(
            type=type_value,
            vacancy_id=vacancy_id,
            grade_id=grade_id,
            salary_from=salary_from,
            salary_to=salary_to,
            location=location,
            notes=notes,
            is_active=is_active,
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            work_format=data.get('work_format', '').strip() or None,
            compensation=data.get('compensation', '').strip() or None,
            benefits=data.get('benefits', '').strip() or None,
            development=data.get('development', '').strip() or None,
            technologies=data.get('technologies', '').strip() or None,
            domain=data.get('domain', '').strip() or None,
        )
        
        return JsonResponse({
            'success': True, 
            'message': '–ë–µ–Ω—á–º–∞—Ä–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω',
            'benchmark': {
                'id': benchmark.id,
                'type': benchmark.get_type_display(),
                'vacancy_name': benchmark.vacancy.name,
                'grade_name': benchmark.grade.name,
                'salary': benchmark.get_salary_display(),
                'location': benchmark.location,
                'is_active': benchmark.is_active
            }
        })
        
    except json.JSONDecodeError:
        return JsonResponse({'success': False, 'message': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö'})
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–µ–Ω—á–º–∞—Ä–∫–∞: {str(e)}'})


@login_required
@csrf_exempt
@require_http_methods(["PUT"])
def benchmark_update(request, pk):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–Ω—á–º–∞—Ä–∫–∞"""
    try:
        benchmark = get_object_or_404(Benchmark, pk=pk)
        data = json.loads(request.body)
        
        type_value = data.get('type')
        vacancy_id = data.get('vacancy_id')
        grade_id = data.get('grade_id')
        salary_from = data.get('salary_from')
        salary_to = data.get('salary_to')
        location = data.get('location')
        notes = data.get('notes')
        is_active = data.get('is_active')
        
        if type_value is not None:
            if type_value not in ['candidate', 'vacancy']:
                return JsonResponse({'success': False, 'message': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –±–µ–Ω—á–º–∞—Ä–∫–∞'})
            benchmark.type = type_value
        
        if vacancy_id is not None:
            benchmark.vacancy_id = vacancy_id
        
        if grade_id is not None:
            benchmark.grade_id = grade_id
        
        if salary_from is not None:
            try:
                salary_from = float(salary_from)
                if salary_from <= 0:
                    return JsonResponse({'success': False, 'message': '–ó–∞—Ä–ø–ª–∞—Ç–∞ "–æ—Ç" –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π'})
                benchmark.salary_from = salary_from
            except (ValueError, TypeError):
                return JsonResponse({'success': False, 'message': '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç—ã "–æ—Ç"'})
        
        if salary_to is not None:
            if salary_to == '':
                benchmark.salary_to = None
            else:
                try:
                    salary_to = float(salary_to)
                    if salary_to <= 0:
                        return JsonResponse({'success': False, 'message': '–ó–∞—Ä–ø–ª–∞—Ç–∞ "–¥–æ" –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π'})
                    if salary_to <= benchmark.salary_from:
                        return JsonResponse({'success': False, 'message': '–ó–∞—Ä–ø–ª–∞—Ç–∞ "–¥–æ" –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –∑–∞—Ä–ø–ª–∞—Ç—ã "–æ—Ç"'})
                    benchmark.salary_to = salary_to
                except (ValueError, TypeError):
                    return JsonResponse({'success': False, 'message': '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç—ã "–¥–æ"'})
        
        if location is not None:
            benchmark.location = location.strip()
        
        if notes is not None:
            benchmark.notes = notes.strip()
        
        if is_active is not None:
            benchmark.is_active = is_active
        
        benchmark.save()
        
        return JsonResponse({
            'success': True, 
            'message': '–ë–µ–Ω—á–º–∞—Ä–∫ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω',
            'benchmark': {
                'id': benchmark.id,
                'type': benchmark.get_type_display(),
                'vacancy_name': benchmark.vacancy.name,
                'grade_name': benchmark.grade.name,
                'salary': benchmark.get_salary_display(),
                'location': benchmark.location,
                'is_active': benchmark.is_active
            }
        })
        
    except json.JSONDecodeError:
        return JsonResponse({'success': False, 'message': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö'})
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–µ–Ω—á–º–∞—Ä–∫–∞: {str(e)}'})


@login_required
@csrf_exempt
@require_http_methods(["DELETE"])
def benchmark_delete(request, pk):
    """–£–¥–∞–ª–µ–Ω–∏–µ –±–µ–Ω—á–º–∞—Ä–∫–∞"""
    try:
        benchmark = get_object_or_404(Benchmark, pk=pk)
        benchmark_name = f"{benchmark.get_type_display()} - {benchmark.vacancy.name} ({benchmark.grade.name})"
        benchmark.delete()
        
        return JsonResponse({
            'success': True, 
            'message': f'–ë–µ–Ω—á–º–∞—Ä–∫ "{benchmark_name}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω'
        })
        
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±–µ–Ω—á–º–∞—Ä–∫–∞: {str(e)}'})


@login_required
def benchmark_edit(request, pk):
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–Ω—á–º–∞—Ä–∫–∞"""
    benchmark = get_object_or_404(Benchmark, pk=pk)
    
    if request.method == 'POST':
        try:
            # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–µ–Ω—á–º–∞—Ä–∫–∞
            benchmark.type = request.POST.get('type')
            benchmark.vacancy_id = request.POST.get('vacancy_id')
            benchmark.grade_id = request.POST.get('grade_id')
            benchmark.salary_from = request.POST.get('salary_from')
            benchmark.salary_to = request.POST.get('salary_to') or None
            benchmark.location = request.POST.get('location')
            benchmark.notes = request.POST.get('notes', '')
            benchmark.is_active = request.POST.get('is_active') == 'on'
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            benchmark.work_format = request.POST.get('work_format') or None
            benchmark.compensation = request.POST.get('compensation') or None
            benchmark.benefits = request.POST.get('benefits') or None
            benchmark.development = request.POST.get('development') or None
            benchmark.technologies = request.POST.get('technologies') or None
            benchmark.domain = request.POST.get('domain') or None
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è
            if not benchmark.type or benchmark.type not in ['candidate', 'vacancy']:
                messages.error(request, '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –±–µ–Ω—á–º–∞—Ä–∫–∞')
            elif not benchmark.vacancy_id:
                messages.error(request, '–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–∫–∞–Ω—Å–∏—é')
            elif not benchmark.grade_id:
                messages.error(request, '–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä–µ–π–¥')
            elif not benchmark.salary_from or float(benchmark.salary_from) <= 0:
                messages.error(request, '–ó–∞—Ä–ø–ª–∞—Ç–∞ "–æ—Ç" –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π')
            elif benchmark.salary_to and float(benchmark.salary_to) <= 0:
                messages.error(request, '–ó–∞—Ä–ø–ª–∞—Ç–∞ "–¥–æ" –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π')
            elif benchmark.salary_to and float(benchmark.salary_to) <= float(benchmark.salary_from):
                messages.error(request, '–ó–∞—Ä–ø–ª–∞—Ç–∞ "–¥–æ" –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –∑–∞—Ä–ø–ª–∞—Ç—ã "–æ—Ç"')
            elif not benchmark.location:
                messages.error(request, '–£–∫–∞–∂–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é')
            else:
                benchmark.save()
                messages.success(request, '–ë–µ–Ω—á–º–∞—Ä–∫ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω')
                return redirect('finance:benchmark_detail', pk=benchmark.pk)
                
        except Exception as e:
            messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–µ–Ω—á–º–∞—Ä–∫–∞: {str(e)}')
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–∫–∏ –¥–ª—è —Ñ–æ—Ä–º
    from apps.vacancies.models import Vacancy
    vacancies = Vacancy.objects.filter(is_active=True).order_by('name')
    grades = Grade.objects.all().order_by('name')
    
    context = {
        'benchmark': benchmark,
        'vacancies': vacancies,
        'grades': grades,
        'benchmark_types': BenchmarkType.choices,
    }
    
    return render(request, 'finance/benchmark_edit.html', context)


@login_required
def benchmark_settings(request):
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤"""
    settings_obj = BenchmarkSettings.load()
    
    if request.method == 'POST':
        try:
            # –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            settings_obj.average_calculation_period_days = int(request.POST.get('average_calculation_period_days', 90))
            settings_obj.belarus_tax_rate = float(request.POST.get('belarus_tax_rate', 13.0))
            settings_obj.ai_analysis_prompt = request.POST.get('ai_analysis_prompt', '')
            settings_obj.max_daily_tasks = int(request.POST.get('max_daily_tasks', 100))
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö
            data_sources = request.POST.getlist('data_sources')
            settings_obj.data_sources = data_sources
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä –ø–æ–ª–µ–π –≤–∞–∫–∞–Ω—Å–∏–π
            vacancy_fields = request.POST.getlist('vacancy_fields')
            # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            required_fields = ['vacancy', 'date_added', 'available_grades', 'salary_range', 'location']
            all_fields = list(set(vacancy_fields + required_fields))
            settings_obj.vacancy_fields = all_fields
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è
            settings_obj.clean()
            settings_obj.save()
            messages.success(request, '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!')
            return redirect('finance:benchmark_settings')
            
        except Exception as e:
            messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: {str(e)}')
            print(f"–û—à–∏–±–∫–∞ –≤ benchmark_settings: {e}")  # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    
    context = {
        'settings': settings_obj,
        'data_sources_choices': DataSource.choices,
        'vacancy_fields_choices': VacancyField.choices,
        'required_vacancy_fields': settings_obj.get_required_vacancy_fields(),
        'optional_vacancy_fields': settings_obj.get_optional_vacancy_fields(),
    }
    
    return render(request, 'finance/benchmark_settings.html', context)


# Views –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ hh.ru –∏ –ò–ò

@login_required
def hh_analysis_dashboard(request):
    """–î–∞—à–±–æ—Ä–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ hh.ru"""
    from apps.vacancies.models import Vacancy
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –∏ –≥—Ä–µ–π–¥—ã
    vacancies = Vacancy.objects.filter(is_active=True).order_by('name')
    grades = Grade.objects.all().order_by('name')
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±–µ–Ω—á–º–∞—Ä–∫–∞–º
    total_benchmarks = Benchmark.objects.filter(is_active=True).count()
    hh_benchmarks = Benchmark.objects.filter(
        is_active=True,
        notes__icontains='hh.ru'
    ).count()
    
    # –ü–æ—Å–ª–µ–¥–Ω–∏–µ –±–µ–Ω—á–º–∞—Ä–∫–∏
    recent_benchmarks = Benchmark.objects.filter(
        is_active=True
    ).select_related('vacancy', 'grade').order_by('-date_added')[:10]
    
    context = {
        'vacancies': vacancies,
        'grades': grades,
        'total_benchmarks': total_benchmarks,
        'hh_benchmarks': hh_benchmarks,
        'recent_benchmarks': recent_benchmarks,
    }
    
    return render(request, 'finance/hh_analysis_dashboard.html', context)


@login_required
@csrf_exempt
@require_http_methods(["POST"])
def start_hh_analysis(request):
    """–ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ hh.ru"""
    try:
        data = json.loads(request.body)
        
        vacancy_id = data.get('vacancy_id')
        grade_id = data.get('grade_id')
        search_query = data.get('search_query', '').strip()
        country = data.get('country', 'belarus')
        area = data.get('area', None)
        
        if not vacancy_id or not grade_id:
            return JsonResponse({
                'success': False,
                'message': '–ù–µ —É–∫–∞–∑–∞–Ω—ã –≤–∞–∫–∞–Ω—Å–∏—è –∏–ª–∏ –≥—Ä–µ–π–¥'
            })
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
        try:
            vacancy = Vacancy.objects.get(id=vacancy_id)
            grade = Grade.objects.get(id=grade_id)
        except (Vacancy.DoesNotExist, Grade.DoesNotExist):
            return JsonResponse({
                'success': False,
                'message': '–í–∞–∫–∞–Ω—Å–∏—è –∏–ª–∏ –≥—Ä–µ–π–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'
            })
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º Celery –∑–∞–¥–∞—á—É
        from .tasks import analyze_hh_vacancies
        task = analyze_hh_vacancies.delay(vacancy_id, grade_id, search_query, country, area)
        
        return JsonResponse({
            'success': True,
            'message': f'–ê–Ω–∞–ª–∏–∑ hh.ru –∑–∞–ø—É—â–µ–Ω –¥–ª—è –≤–∞–∫–∞–Ω—Å–∏–∏ "{vacancy.name}" (–≥—Ä–µ–π–¥: {grade.name})',
            'task_id': task.id,
            'vacancy_name': vacancy.name,
            'grade_name': grade.name
        })
        
    except json.JSONDecodeError:
        return JsonResponse({
            'success': False,
            'message': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON'
        })
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∞–Ω–∞–ª–∏–∑–∞ hh.ru: {e}")
        return JsonResponse({
            'success': False,
            'message': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∞–Ω–∞–ª–∏–∑–∞: {str(e)}'
        })


@login_required
@csrf_exempt
@require_http_methods(["POST"])
def start_batch_hh_analysis(request):
    """–ó–∞–ø—É—Å–∫ –º–∞—Å—Å–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ hh.ru"""
    try:
        data = json.loads(request.body)
        
        vacancy_grade_pairs = data.get('vacancy_grade_pairs', [])
        search_queries = data.get('search_queries', {})
        
        if not vacancy_grade_pairs:
            return JsonResponse({
                'success': False,
                'message': '–ù–µ —É–∫–∞–∑–∞–Ω—ã –ø–∞—Ä—ã –≤–∞–∫–∞–Ω—Å–∏—è-–≥—Ä–µ–π–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞'
            })
        
        # –í–∞–ª–∏–¥–∏—Ä—É–µ–º –ø–∞—Ä—ã
        valid_pairs = []
        for pair in vacancy_grade_pairs:
            if isinstance(pair, list) and len(pair) == 2:
                vacancy_id, grade_id = pair
                try:
                    Vacancy.objects.get(id=vacancy_id)
                    Grade.objects.get(id=grade_id)
                    valid_pairs.append((vacancy_id, grade_id))
                except (Vacancy.DoesNotExist, Grade.DoesNotExist):
                    continue
        
        if not valid_pairs:
            return JsonResponse({
                'success': False,
                'message': '–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤–∞–ª–∏–¥–Ω—ã—Ö –ø–∞—Ä –≤–∞–∫–∞–Ω—Å–∏—è-–≥—Ä–µ–π–¥'
            })
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º Celery –∑–∞–¥–∞—á—É
        from .tasks import analyze_hh_vacancies_batch
        task = analyze_hh_vacancies_batch.delay(valid_pairs, search_queries)
        
        return JsonResponse({
            'success': True,
            'message': f'–ú–∞—Å—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ hh.ru –∑–∞–ø—É—â–µ–Ω –¥–ª—è {len(valid_pairs)} –ø–∞—Ä',
            'task_id': task.id,
            'pairs_count': len(valid_pairs)
        })
        
    except json.JSONDecodeError:
        return JsonResponse({
            'success': False,
            'message': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON'
        })
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –º–∞—Å—Å–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ hh.ru: {e}")
        return JsonResponse({
            'success': False,
            'message': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –º–∞—Å—Å–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞: {str(e)}'
        })


@login_required
def ai_analysis_dashboard(request):
    """–î–∞—à–±–æ—Ä–¥ –¥–ª—è –ò–ò –∞–Ω–∞–ª–∏–∑–∞"""
    from .ai_analyzer import AIBenchmarkAnalyzer
    
    analyzer = AIBenchmarkAnalyzer()
    
    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    settings = BenchmarkSettings.load()
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±–µ–Ω—á–º–∞—Ä–∫–∞–º
    total_benchmarks = Benchmark.objects.filter(is_active=True).count()
    candidate_benchmarks = Benchmark.objects.filter(
        type=BenchmarkType.CANDIDATE,
        is_active=True
    ).count()
    vacancy_benchmarks = Benchmark.objects.filter(
        type=BenchmarkType.VACANCY,
        is_active=True
    ).count()
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–º–ø—Ç
    current_prompt = analyzer.get_ai_analysis_prompt()
    
    context = {
        'total_benchmarks': total_benchmarks,
        'candidate_benchmarks': candidate_benchmarks,
        'vacancy_benchmarks': vacancy_benchmarks,
        'current_prompt': current_prompt,
        'settings': settings,
    }
    
    return render(request, 'finance/ai_analysis_dashboard.html', context)


@login_required
@csrf_exempt
@require_http_methods(["POST"])
def run_ai_analysis(request):
    """–ó–∞–ø—É—Å–∫ –ò–ò –∞–Ω–∞–ª–∏–∑–∞ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤"""
    try:
        data = json.loads(request.body)
        
        # –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        filters = data.get('filters', {})
        custom_prompt = data.get('custom_prompt', '').strip()
        save_to_db = data.get('save_to_db', False)
        
        from .ai_analyzer import AIBenchmarkAnalyzer
        analyzer = AIBenchmarkAnalyzer()
        
        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        benchmark_data = analyzer.prepare_benchmark_data_for_ai(filters)
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
        result = analyzer.analyze_with_ai(benchmark_data, custom_prompt)
        
        # –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∞–∑—É –∏ –∞–Ω–∞–ª–∏–∑ —É—Å–ø–µ—à–µ–Ω
        if save_to_db and result.get('success') and result.get('analysis'):
            save_result = analyzer.save_structured_benchmarks_to_db(result['analysis'])
            result['save_result'] = save_result
        
        return JsonResponse(result)
        
    except json.JSONDecodeError:
        return JsonResponse({
            'success': False,
            'error': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON'
        })
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ò–ò –∞–Ω–∞–ª–∏–∑–µ: {e}")
        return JsonResponse({
            'success': False,
            'error': str(e)
        })


@login_required
@csrf_exempt
@require_http_methods(["POST"])
def update_ai_prompt(request):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –ò–ò –∞–Ω–∞–ª–∏–∑–∞"""
    try:
        data = json.loads(request.body)
        
        new_prompt = data.get('prompt', '').strip()
        
        if not new_prompt:
            return JsonResponse({
                'success': False,
                'message': '–ü—Ä–æ–º–ø—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'
            })
        
        from .ai_analyzer import AIBenchmarkAnalyzer
        analyzer = AIBenchmarkAnalyzer()
        
        success = analyzer.update_ai_prompt(new_prompt)
        
        if success:
            return JsonResponse({
                'success': True,
                'message': '–ü—Ä–æ–º–ø—Ç –¥–ª—è –ò–ò –∞–Ω–∞–ª–∏–∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω'
            })
        else:
            return JsonResponse({
                'success': False,
                'message': '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–∞'
            })
        
    except json.JSONDecodeError:
        return JsonResponse({
            'success': False,
            'message': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON'
        })
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–∞: {e}")
        return JsonResponse({
            'success': False,
            'message': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–∞: {str(e)}'
        })


@login_required
def task_status(request, task_id):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏"""
    try:
        from celery.result import AsyncResult
        
        task_result = AsyncResult(task_id)
        
        if task_result.state == 'PENDING':
            response = {
                'state': task_result.state,
                'status': '–ó–∞–¥–∞—á–∞ –æ–∂–∏–¥–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è'
            }
        elif task_result.state == 'PROGRESS':
            response = {
                'state': task_result.state,
                'status': '–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è',
                'progress': task_result.info
            }
        elif task_result.state == 'SUCCESS':
            response = {
                'state': task_result.state,
                'status': '–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ',
                'result': task_result.result
            }
        else:  # FAILURE
            response = {
                'state': task_result.state,
                'status': '–ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π',
                'error': str(task_result.info)
            }
        
        return JsonResponse(response)
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏: {e}")
        return JsonResponse({
            'state': 'ERROR',
            'status': '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏',
            'error': str(e)
        })


@login_required
def benchmarks_settings(request):
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º hh.ru"""
    settings = BenchmarkSettings.load()
    
    if request.method == 'POST':
        # –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ hh.ru
        settings.hh_channel_active = request.POST.get('hh_channel_active') == 'on'
        settings.max_daily_hh_tasks = int(request.POST.get('max_daily_hh_tasks', 100))
        settings.hh_ai_prompt = request.POST.get('hh_ai_prompt', '')
        settings.save()
        
        messages.success(request, '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ hh.ru –æ–±–Ω–æ–≤–ª–µ–Ω—ã')
        return redirect('finance:benchmarks_settings')
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    from datetime import date
    today = date.today()
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ hh.ru
    hh_stats = {
        'temp_vacancies': HHVacancyTemp.objects.count(),
        'processed_today': HHVacancyTemp.objects.filter(
            created_at__date=today,
            processed=True
        ).count(),
        'pending_processing': HHVacancyTemp.objects.filter(processed=False).count(),
        'benchmarks_from_hh': Benchmark.objects.filter(
            hh_vacancy_id__isnull=False,
            is_active=True
        ).count()
    }
    
    context = {
        'settings': settings,
        'hh_stats': hh_stats,
        'available_domains': Domain.choices,
    }
    
    return render(request, 'finance/benchmarks_settings.html', context)


@login_required
@csrf_exempt
@require_http_methods(["POST"])
def start_hh_collection_manual(request):
    """–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å–±–æ—Ä–∞ –≤–∞–∫–∞–Ω—Å–∏–π —Å hh.ru"""
    try:
        from .tasks import fetch_hh_vacancies_task
        
        task = fetch_hh_vacancies_task.delay()
        
        return JsonResponse({
            'success': True,
            'message': '–°–±–æ—Ä –≤–∞–∫–∞–Ω—Å–∏–π —Å hh.ru –∑–∞–ø—É—â–µ–Ω',
            'task_id': task.id
        })
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–±–æ—Ä–∞ hh.ru: {e}")
        return JsonResponse({
            'success': False,
            'message': f'–û—à–∏–±–∫–∞: {str(e)}'
        })
