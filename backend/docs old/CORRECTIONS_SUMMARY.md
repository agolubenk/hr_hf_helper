# Исправления интеграции с Gemini AI

## Проблемы, которые были исправлены

### 1. ❌ **Лишние поля в модели**
**Проблема:** Были созданы ненужные поля для генерации приглашений:
- `gemini_invitation_text` - Текст приглашения от Gemini
- `gemini_meeting_link` - Ссылка на встречу от Gemini  
- `gemini_additional_info` - Дополнительная информация от Gemini
- `gemini_recruiter_notes` - Заметки для рекрутера от Gemini

**Решение:** ✅ Удалены все лишние поля, оставлено только:
- `original_form_data` - Исходный текст из формы
- `gemini_suggested_datetime` - Время, определенное Gemini

### 2. ❌ **Неправильный промпт**
**Проблема:** Использовался шаблонный промпт для генерации приглашений вместо анализа времени.

**Решение:** ✅ Теперь используется промпт из настроек вакансии (`vacancy.invite_prompt`), который может быть разным для каждой вакансии.

### 3. ❌ **Неправильная логика**
**Проблема:** Gemini пытался генерировать приглашения, а не анализировать время.

**Решение:** ✅ Gemini теперь только анализирует время на основе:
- Промпта из вакансии (специфичного для каждой вакансии)
- Исходного текста из формы
- Текущей даты
- Свободных слотов из календаря

## Исправленные файлы

### `apps/google_oauth/models.py`
- ✅ Удалены лишние поля `gemini_invitation_text`, `gemini_meeting_link`, `gemini_additional_info`, `gemini_recruiter_notes`
- ✅ Переименован метод `generate_invite_with_gemini()` → `analyze_time_with_gemini()`
- ✅ Добавлено получение промпта из вакансии: `vacancy.invite_prompt`
- ✅ Исправлен промпт для анализа времени вместо генерации приглашений
- ✅ Упрощена обработка ответа - только извлечение времени
- ✅ **ИСПРАВЛЕНО:** Используется существующая логика календаря для получения свободных слотов
- ✅ **ИСПРАВЛЕНО:** Добавлены вспомогательные методы `_calculate_free_slots()`, `_is_event_on_date()`, `_is_lunch_event()`, `_calculate_available_slots_for_day()`

### `apps/google_oauth/forms.py`
- ✅ Обновлен вызов метода: `invite.analyze_time_with_gemini()`
- ✅ Исправлены сообщения в логах

### `apps/google_oauth/views.py`
- ✅ Переименован endpoint: `get_gemini_invitation` → `get_gemini_time_analysis`
- ✅ Упрощен ответ API - только время

### `apps/google_oauth/urls.py`
- ✅ Обновлен URL: `gemini-invitation/` → `gemini-time-analysis/`

### `apps/google_oauth/admin.py`
- ✅ Удалены лишние поля из админки
- ✅ Обновлен индикатор `has_gemini_data` для проверки только времени
- ✅ Исправлено описание полей

## Миграции

Создана миграция `0011_remove_invite_gemini_additional_info_and_more.py` для удаления лишних полей.

## Тестирование

✅ Создан и выполнен тест `test_prompt_from_vacancy.py`, который подтвердил:
- Промпт успешно получается из вакансии
- Промпт содержит правильные инструкции для анализа времени
- Промпт может быть разным для разных вакансий
- Формат ответа соответствует требованиям

## Итоговая логика

Теперь система работает правильно:

1. **Пользователь вводит** в комбинированную форму: URL + текст с временем (например, "завтра 15")
2. **Форма извлекает** только URL, весь текст сохраняется в `original_form_data`
3. **Система получает** промпт из настроек вакансии (`vacancy.invite_prompt`)
4. **Система получает события календаря** используя существующую логику (`GoogleCalendarService.get_events()`)
5. **Система вычисляет свободные слоты** используя ту же логику, что и на странице `/google-oauth/calendar/`:
   - Рабочие часы: 11:00-18:00
   - Исключает события "Обед"
   - Учитывает пересечения событий (минимум 30 минут)
   - Формирует диапазоны свободного времени
6. **Gemini анализирует** время на основе:
   - Промпта из вакансии (специфичного для каждой вакансии)
   - Исходного текста пользователя
   - Текущей даты
   - Реальных свободных слотов из календаря
7. **Gemini возвращает** только время в формате `"suggested_datetime": "DD.MM.YYYY HH:MM"`
8. **Система сохраняет** определенное время в `gemini_suggested_datetime`

## Преимущества исправленной версии

- ✅ **Гибкость:** Каждая вакансия может иметь свой специфичный промпт для анализа времени
- ✅ **Простота:** Gemini выполняет только одну задачу - анализ времени
- ✅ **Точность:** Используется промпт, настроенный под конкретную вакансию
- ✅ **Масштабируемость:** Легко добавлять новые типы вакансий с разными промптами
- ✅ **Переиспользование:** Используется существующая логика календаря вместо создания новой
- ✅ **Консистентность:** Свободные слоты рассчитываются так же, как на странице календаря
- ✅ **Надежность:** Проверенная логика расчета слотов из production кода
